<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Usuários • Maxximus Telecom</title>
    <link rel="icon" href="data:,">
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <main class="container">
        <div class="card">
            <div class="card-head">
                <div class="card-title">
                    <span>Usuários</span>
                    <span class="chip">Somente Admin</span>
                </div>
                <div class="muted">
                    <button type="button" class="btn btn-primary" onclick="abrirCadastroUsuario()"><i data-lucide="user-plus"></i><span>Novo Usuário</span></button>
                </div>
            </div>
            <div class="card-body">
                <section class="section" style="margin-top:1rem;">
                    <div id="usersList" class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th>Nome</th>
                                    <th>Email</th>
                                    <th>Perfil</th>
                                    <th class="col-actions">Ações</th>
                                </tr>
                            </thead>
                            <tbody id="usersTbody"></tbody>
                        </table>
                    </div>
                </section>
            </div>
        </div>
    </main>
    <div id="cadastroUserModal" class="modal">
        <div class="modal-card">
            <div class="modal-head">
                <span>Cadastrar usuário</span>
                <button type="button" class="btn btn-ghost btn-icon" onclick="fecharCadastroUsuario()"><i data-lucide="x"></i></button>
            </div>
            <div class="modal-body">
                <div class="grid-2">
                    <div>
                        <div class="label">Nome</div>
                        <input id="uName" class="input" type="text" placeholder="Nome completo" autocomplete="off">
                    </div>
                    <div>
                        <div class="label">Email</div>
                        <input id="uEmail" class="input" type="email" placeholder="email@empresa.com" autocomplete="off">
                    </div>
                </div>
                <div class="grid-2" style="margin-top:0.75rem;">
                    <div>
                        <div class="label">Senha</div>
                        <input id="uPassword" class="input" type="password" placeholder="••••••••">
                    </div>
                    <div>
                        <div class="label">Perfil</div>
                        <select id="uRole" class="select">
                            <option value="user">Usuário</option>
                            <option value="admin">Admin</option>
                        </select>
                    </div>
                </div>
            </div>
            <div class="modal-actions">
                <button type="button" class="btn btn-ghost" onclick="limparFormulario()">Limpar</button>
                <button type="button" class="btn btn-primary" onclick="salvarUsuario()">Cadastrar</button>
            </div>
        </div>
    </div>
    <div id="editUserModal" class="modal">
        <div class="modal-card">
            <div class="modal-head">
                <span>Editar usuário</span>
                <button type="button" class="btn btn-ghost btn-icon" onclick="fecharEditarUsuario()"><i data-lucide="x"></i></button>
            </div>
            <div class="modal-body">
                <div class="section" style="padding:0.8rem;">
                    <div class="label">Nome</div>
                    <input id="editName" class="input" type="text" placeholder="Nome completo">
                </div>
                <div class="section" style="padding:0.8rem; margin-top:0.6rem;">
                    <div class="label">Email</div>
                    <input id="editEmail" class="input" type="email" placeholder="email@empresa.com">
                </div>
                <div class="section" style="padding:0.8rem; margin-top:0.6rem;">
                    <div class="label">Perfil</div>
                    <select id="editRole" class="select">
                        <option value="user">Usuário</option>
                        <option value="admin">Admin</option>
                    </select>
                </div>
                <div class="section" style="padding:0.8rem; margin-top:0.6rem;">
                    <div class="label">Nova senha (opcional)</div>
                    <input id="editPassword" class="input" type="password" placeholder="Definir nova senha">
                </div>
            </div>
            <div class="modal-actions">
                <button type="button" class="btn btn-ghost" onclick="fecharEditarUsuario()">Cancelar</button>
                <button type="button" class="btn btn-primary" onclick="salvarEdicaoUsuario()">Salvar</button>
            </div>
        </div>
    </div>
    <div id="deleteUserModal" class="modal">
        <div class="modal-card">
            <div class="modal-head">
                <span>Confirmar exclusão</span>
                <button type="button" class="btn btn-ghost btn-icon" onclick="fecharExcluirUsuario()"><i data-lucide="x"></i></button>
            </div>
            <div class="modal-body">
                <div id="deleteUserText" class="muted">Tem certeza que deseja excluir?</div>
                <div style="margin-top:0.6rem; color:#FCA5A5;">Ao excluir, todos os dados de vendas associados serão removidos.</div>
            </div>
            <div class="modal-actions">
                <button type="button" class="btn btn-ghost" onclick="fecharExcluirUsuario()">Cancelar</button>
                <button type="button" class="btn btn-primary" onclick="confirmarExcluirUsuario()">Excluir</button>
            </div>
        </div>
    </div>
    <script src="script.js"></script>
    <div id="toast" class="toast"></div>
    <script>
        const API_BASE = 'https://others-maxximus-backend.pvuzyy.easypanel.host';
        async function api(path, options) {
            const auth = localStorage.getItem('authUser');
            let headers = { 'Content-Type': 'application/json' };
            try {
                const u = JSON.parse(auth || '{}');
                if (u && u.id) headers['x-user-id'] = String(u.id);
                if (u && u.role) headers['x-user-role'] = String(u.role);
                if (u && u.name) headers['x-user-name'] = String(u.name);
            } catch {}
            const res = await fetch(API_BASE + path, { headers, ...options });
            if (!res.ok) {
                const err = await res.json().catch(() => ({}));
                throw new Error(err.error || ('HTTP ' + res.status));
            }
            return res.json();
        }
        function toast(msg, type) {
            const el = document.getElementById('toast');
            el.textContent = msg;
            el.style.borderColor = type === 'error' ? 'rgba(239,68,68,0.35)' : 'rgba(16,185,129,0.35)';
            el.style.display = 'block';
            clearTimeout(window.__toastTimer);
            window.__toastTimer = setTimeout(() => { el.style.display = 'none'; }, 2500);
        }
        function isAdminUser() {
            try {
                const raw = localStorage.getItem('authUser');
                const u = JSON.parse(raw || '{}');
                return u && u.role === 'admin';
            } catch { return false; }
        }
        let __usersCache = [];
        let __editUserId = null;
        let __deleteUserId = null;
        function abrirCadastroUsuario() {
            document.getElementById('cadastroUserModal').classList.add('show');
        }
        function fecharCadastroUsuario() {
            document.getElementById('cadastroUserModal').classList.remove('show');
            limparFormulario();
        }
        function renderUsersTable(users) {
            const tbody = document.getElementById('usersTbody');
            __usersCache = Array.isArray(users) ? users.slice() : [];
            tbody.innerHTML = (__usersCache || []).map(u => `
                <tr>
                    <td>${u.name}</td>
                    <td>${u.email}</td>
                    <td>${u.role}</td>
                    <td class="col-actions" style="min-width:140px;">
                        <button type="button" class="btn btn-ghost btn-icon" title="Editar" onclick="abrirEditarUsuario(${u.id})"><i data-lucide="edit-3"></i></button>
                        ${String(u.role) === 'admin' ? '' : `<button type="button" class="btn btn-primary btn-icon" title="Excluir" onclick="abrirExcluirUsuario(${u.id})"><i data-lucide='trash-2'></i></button>`}
                    </td>
                </tr>
            `).join('');
            if (window.lucide && typeof window.lucide.createIcons === 'function') { window.lucide.createIcons(); }
        }
        async function carregarUsuarios() {
            try {
                const list = await api('/auth/users', { method: 'GET' });
                renderUsersTable(Array.isArray(list) ? list : []);
            } catch {
                renderUsersTable([]);
            }
        }
        function getUserById(id) {
            return (__usersCache || []).find(u => Number(u.id) === Number(id));
        }
        function limparFormulario() {
            document.getElementById('uName').value = '';
            document.getElementById('uEmail').value = '';
            document.getElementById('uPassword').value = '';
            document.getElementById('uRole').value = 'user';
        }
        function abrirEditarUsuario(id) {
            const u = getUserById(id);
            if (!u) return;
            __editUserId = Number(id);
            document.getElementById('editName').value = u.name || '';
            document.getElementById('editEmail').value = u.email || '';
            document.getElementById('editRole').value = u.role || 'user';
            document.getElementById('editPassword').value = '';
            document.getElementById('editUserModal').classList.add('show');
        }
        function fecharEditarUsuario() {
            __editUserId = null;
            document.getElementById('editUserModal').classList.remove('show');
        }
        async function salvarEdicaoUsuario() {
            if (!__editUserId) return;
            const name = (document.getElementById('editName').value || '').trim();
            const email = (document.getElementById('editEmail').value || '').trim();
            const role = document.getElementById('editRole').value || 'user';
            const password = (document.getElementById('editPassword').value || '').trim();
            if (!name || !email) { toast('Preencha nome e email', 'error'); return; }
            const payload = { name, email, role };
            if (password) payload.password = password;
            try {
                await api('/auth/users/' + __editUserId, { method: 'PUT', body: JSON.stringify(payload) });
                toast('Usuário atualizado', 'success');
                fecharEditarUsuario();
                await carregarUsuarios();
            } catch {
                toast('Erro ao atualizar usuário', 'error');
            }
        }
        function abrirExcluirUsuario(id) {
            const u = getUserById(id);
            if (!u) return;
            if (String(u.role) === 'admin') { toast('Usuário admin não pode ser excluído', 'error'); return; }
            __deleteUserId = Number(id);
            const el = document.getElementById('deleteUserText');
            if (el) el.textContent = `Deseja excluir o usuário "${u.name}"? Esta ação removerá também os dados de vendas associados.`;
            document.getElementById('deleteUserModal').classList.add('show');
        }
        function fecharExcluirUsuario() {
            __deleteUserId = null;
            document.getElementById('deleteUserModal').classList.remove('show');
        }
        async function confirmarExcluirUsuario() {
            if (!__deleteUserId) return;
            try {
                await api('/auth/users/' + __deleteUserId, { method: 'DELETE' });
                toast('Usuário excluído', 'success');
                fecharExcluirUsuario();
                await carregarUsuarios();
            } catch {
                toast('Erro ao excluir usuário', 'error');
            }
        }
        async function salvarUsuario() {
            const name = (document.getElementById('uName').value || '').trim();
            const email = (document.getElementById('uEmail').value || '').trim();
            const password = (document.getElementById('uPassword').value || '').trim();
            const role = document.getElementById('uRole').value || 'user';
            if (!name || !email || !password) {
                toast('Preencha nome, email e senha', 'error');
                return;
            }
            try {
                await api('/auth/register', { method: 'POST', body: JSON.stringify({ name, email, password, role }) });
                toast('Usuário cadastrado', 'success');
                limparFormulario();
                try { document.getElementById('cadastroUserModal').classList.remove('show'); } catch {}
                await carregarUsuarios();
            } catch (e) {
                toast('Erro ao cadastrar usuário', 'error');
            }
        }
        document.addEventListener('DOMContentLoaded', async () => {
            const auth = localStorage.getItem('authUser');
            if (!auth) { window.location.href = 'login.html'; return; }
            if (!isAdminUser()) { window.location.href = 'dashboard.html'; return; }
            try {
                const user = JSON.parse(auth);
                const label = document.getElementById('userNameLabel');
                if (label && user && user.name) label.textContent = user.name + ' • Admin';
            } catch {}
            const umb = document.getElementById('userMenuBtn');
            if (umb) {
                umb.addEventListener('click', () => {
                    const menu = document.getElementById('userMenu');
                    if (menu) menu.classList.toggle('show');
                });
            }
            const lb = document.getElementById('logoutBtn');
            if (lb) {
                lb.addEventListener('click', (e) => {
                    e.preventDefault();
                    localStorage.removeItem('authUser');
                    window.location.href = 'login.html';
                });
            }
            await carregarUsuarios();
            if (window.lucide && typeof window.lucide.createIcons === 'function') { window.lucide.createIcons(); }
        });
    </script>
</body>
</html>
