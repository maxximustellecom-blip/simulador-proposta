<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Registrar Venda ‚Ä¢ Maxximus Telecom</title>
    <link rel="icon" href="data:,">
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <main class="container">
        <div class="card">
            <div class="card-head">
                <div class="card-title">
                    <span>Registrar Venda</span>
                    <span class="chip">R√°pido e intuitivo</span>
                </div>
            </div>
            <form id="vendaForm">
                <div class="card-body">
                    <section class="section">
                        <h3>Dados do Cliente</h3>
                        <div class="field">
                            <label class="label">Nome</label>
                            <input id="clienteNome" class="input" type="text" placeholder="RAZ√ÉO SOCIAL" autocomplete="off">
                        </div>
                        <div class="grid-2">
                            <div class="field">
                                <label class="label">CNPJ</label>
                                <input id="clienteCnpj" class="input" type="text" placeholder="00.000.000/0000-00" autocomplete="off">
                            </div>
                        </div>
                    </section>
                    <section class="section">
                        <h3>Dados da Venda</h3>
                        <div class="grid-2">
                            <div class="field">
                                <label class="label">Vendedor</label>
                                <select id="vendedor" class="select">
                                    <option>Carregando...</option>
                                </select>
                            </div>
                            <div class="field">
                                <label class="label">Tipo</label>
                                <select id="tipo" class="select">
                                    <option value="novos">Novos</option>
                                    <option value="renovacao">Renova√ß√£o</option>
                                    <option value="ultraFibra">Ultra Fibra</option>
                                    <option value="wttx">WTTx</option>
                                    <option value="m2m">M2M</option>
                                </select>
                            </div>
                        </div>
                        <div class="grid-2" style="margin-top:0.75rem;">
                            <div class="field">
                                <label class="label">P2B</label>
                                <input id="p2b" class="input" type="number" step="1" min="0" placeholder="0">
                            </div>
                            <div class="field">
                                <label class="label">Receita (R$)</label>
                                <input id="receita" class="input" type="number" step="0.01" min="0" placeholder="0,00">
                            </div>
                        </div>
                        <div class="actions" style="justify-content:flex-start; padding:0; border-top:none;">
                            <button type="button" id="addItemBtn" class="btn btn-ghost">Adicionar item</button>
                        </div>
                    </section>
                </div>
                <div style="padding: 1.2rem;">
                    <div id="vendasList" class="section" style="display:none;">
                        <h3>Itens adicionados</h3>
                        <div id="vendasListContent"></div>
                    </div>
                    <div id="summary" class="summary" style="display:none;">
                        <div class="summary-row"><span>N√≠vel</span><strong id="sumNivel">-</strong></div>
                        <div class="summary-row"><span>Receita Novos</span><strong id="sumNovos">-</strong></div>
                        <div class="summary-row"><span>Receita Total</span><strong id="sumTotal">-</strong></div>
                        <div class="summary-row"><span>Comiss√£o Total</span><strong id="sumComissao">-</strong></div>
                    </div>
                </div>
                <div class="actions">
                    <button type="button" id="limparBtn" class="btn btn-ghost">Limpar</button>
                    <button type="submit" class="btn btn-primary">Salvar Venda</button>
                </div>
            </form>
        </div>
        <div class="card" style="max-width: 960px; margin: 1rem auto 0;">
        <div style="padding: 1.2rem;">
            <h3 class="card-title">üìä Tabela 1: N√≠veis e Fator de Comissionamento</h3>
            <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th>VENDEDOR</th>
                            <th>Receita Gerada</th>
                            <th>ELEGIBILIDADE</th>
                            <th>% Fator</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td><strong style="color: #3182ce;">BLUE</strong></td>
                            <td>At√© R$699</td>
                            <td style="text-align: left;">N/D</td>
                            <td style="text-align: left; font-weight: 600; color: #3182ce;">60%</td>
                        </tr>
                        <tr>
                            <td><strong style="color: #94A3B8;">SILVER</strong></td>
                            <td>R$700 a R$899</td>
                            <td style="text-align: left;">N/D</td>
                            <td style="text-align: left; font-weight: 600; color: #94A3B8;">80%</td>
                        </tr>
                        <tr>
                            <td><strong style="color: #A855F7;">PLATINUM</strong></td>
                            <td>R$900 a R$1.499</td>
                            <td style="text-align: left;">1 Fibra/ 1 WTTX</td>
                            <td style="text-align: left; font-weight: 600; color: #A855F7;">100%</td>
                        </tr>
                        <tr>
                            <td><strong style="color: #1F2937;">BLACK</strong></td>
                            <td>R$1.500 a R$1.899</td>
                            <td style="text-align: left;">1 Fibra/ 1 WTTX</td>
                            <td style="text-align: left; font-weight: 600; color: #1F2937;">150%</td>
                        </tr>
                        <tr>
                            <td><strong style="color: #000000;">BLACK+</strong></td>
                            <td>R$ 1.900 ou mais</td>
                            <td style="text-align: left;">1 Fibra/ 1 WTTX</td>
                            <td style="text-align: left; font-weight: 600; color: #000000;">200%</td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <h3 class="card-title" style="margin-top: 2rem;">üìä Tabela 2: Comissionamento por Tipo de Produto</h3>
            <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th>VENDEDOR</th>
                            <th style="text-align: center;">RENOVA√á√ÉO</th>
                            <th style="text-align: center;">ULTRA FIBRA</th>
                            <th style="text-align: center;">WTTX</th>
                            <th style="text-align: center;">M2M</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td><strong>BLUE/SILVER</strong></td>
                            <td style="text-align: center; font-weight: 600;">30%</td>
                            <td style="text-align: center; font-weight: 600;">30%</td>
                            <td style="text-align: center; font-weight: 600;">60%</td>
                            <td style="text-align: center; font-weight: 600;">60%</td>
                        </tr>
                        <tr>
                            <td><strong style="color: #A855F7;">PLATINUM</strong></td>
                            <td style="text-align: center; font-weight: 600;">40%</td>
                            <td style="text-align: center; font-weight: 600;">50%</td>
                            <td style="text-align: center; font-weight: 600;">100%</td>
                            <td style="text-align: center; font-weight: 600;">60%</td>
                        </tr>
                        <tr>
                            <td><strong style="color: #1F2937;">BLACK</strong></td>
                            <td style="text-align: center; font-weight: 600;">50%</td>
                            <td style="text-align: center; font-weight: 600;">70%</td>
                            <td style="text-align: center; font-weight: 600;">150%</td>
                            <td style="text-align: center; font-weight: 600;">60%</td>
                        </tr>
                        <tr>
                            <td><strong style="color: #000000;">BLACK+</strong></td>
                            <td style="text-align: center; font-weight: 600;">60%</td>
                            <td style="text-align: center; font-weight: 600;">80%</td>
                            <td style="text-align: center; font-weight: 600;">200%</td>
                            <td style="text-align: center; font-weight: 600;">60%</td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <div class="nota-importante">
                <p>
                    <strong>Observa√ß√£o Importante:</strong> Apenas <strong>Novos Acessos e Aditivos</strong> contribuem
                    para a classifica√ß√£o do n√≠vel do vendedor. Os servi√ßos de <strong>Renova√ß√£o, Ultra Fibra, WTTX e M2M</strong> s√£o
                    remunerados de acordo com o n√≠vel obtido atrav√©s das vendas de Novos Acessos e Aditivos, mas n√£o influenciam
                    na defini√ß√£o do n√≠vel.
                </p>
            </div>
        </div>
        </div>
    </main>
    </div>
    <div id="toast" class="toast"></div>
    <script>
        const API_BASE = 'https://others-maxximus-backend.pvuzyy.easypanel.host';
        async function api(path, options) {
            const auth = localStorage.getItem('authUser');
            let headers = { 'Content-Type': 'application/json' };
            try {
                const u = JSON.parse(auth || '{}');
                if (u && u.id) headers['x-user-id'] = String(u.id);
                if (u && u.role) headers['x-user-role'] = String(u.role);
                if (u && u.name) headers['x-user-name'] = String(u.name);
            } catch {}
            if (options && typeof options.overrideUserId !== 'undefined') {
                headers['x-user-id'] = String(options.overrideUserId);
                delete options.overrideUserId;
            }
            const res = await fetch(API_BASE + path, { headers, ...options });
            if (!res.ok) {
                const err = await res.json().catch(() => ({}));
                throw new Error(err.error || ('HTTP ' + res.status));
            }
            return res.json();
        }
        function toast(msg, type) {
            const el = document.getElementById('toast');
            el.textContent = msg;
            el.style.borderColor = type === 'error' ? 'rgba(239,68,68,0.35)' : 'rgba(16,185,129,0.35)';
            el.style.display = 'block';
            clearTimeout(window.__toastTimer);
            window.__toastTimer = setTimeout(() => { el.style.display = 'none'; }, 2500);
        }
        let usuarios = [];
        let __usuariosByName = {};
        async function carregarUsuarios() {
            try {
                let list = await api('/auth/users?role=user', { method: 'GET' });
                if (!Array.isArray(list) || list.length === 0) list = await api('/auth/users', { method: 'GET' });
                usuarios = Array.isArray(list) ? list : [];
                __usuariosByName = {};
                const sel = document.getElementById('vendedor');
                if (sel) {
                    sel.innerHTML = usuarios.map(u => {
                        __usuariosByName[String(u.name)] = Number(u.id);
                        return `<option value="${u.name}">${u.name}</option>`;
                    }).join('');
                }
            } catch { usuarios = []; }
        }
        function toUpperInput(el) { el.value = (el.value || '').toUpperCase(); }
        function formatCnpj(value) {
            const v = String(value || '').replace(/\D/g, '').slice(0,14);
            const p = [v.slice(0,2), v.slice(2,5), v.slice(5,8), v.slice(8,12), v.slice(12,14)].filter(Boolean);
            if (p.length >= 5) return `${p[0]}.${p[1]}.${p[2]}/${p[3]}-${p[4]}`;
            if (p.length >= 4) return `${p[0]}.${p[1]}.${p[2]}/${p[3]}`;
            if (p.length >= 3) return `${p[0]}.${p[1]}.${p[2]}`;
            if (p.length >= 2) return `${p[0]}.${p[1]}`;
            return p[0] || '';
        }
        function limparFormulario() {
            document.getElementById('clienteNome').value = '';
            document.getElementById('clienteCnpj').value = '';
            document.getElementById('receita').value = '';
            document.getElementById('p2b').value = '';
            document.getElementById('summary').style.display = 'none';
            vendasTemp = [];
            renderItens();
        }
        function preencherResumo(sim) {
            document.getElementById('sumNivel').textContent = sim.nivel?.nome || '-';
            document.getElementById('sumNovos').textContent = Number(sim.receitaNovos || 0).toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
            document.getElementById('sumTotal').textContent = Number(sim.receitaTotal || 0).toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
            document.getElementById('sumComissao').textContent = Number((sim.comissaoTotal ?? sim.comissao_total ?? 0)).toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
            document.getElementById('summary').style.display = 'block';
        }
        function calcularNivelLocal(receitaNovos) {
            if (receitaNovos < 700) return { nome: 'BLUE', fator: 0.6 };
            if (receitaNovos < 900) return { nome: 'SILVER', fator: 0.8 };
            if (receitaNovos < 1500) return { nome: 'PLATINUM', fator: 1.0 };
            if (receitaNovos < 1900) return { nome: 'BLACK', fator: 1.5 };
            return { nome: 'BLACK+', fator: 2.0 };
        }
        function calcularComissaoProdutoLocal(receitaBase, tipo, valorVenda) {
            const nivel = calcularNivelLocal(receitaBase);
            const taxas = {
                'BLUE': { novos: 0.6, renovacao: 0.3, ultraFibra: 0.3, wttx: 0.6, m2m: 0.6 },
                'SILVER': { novos: 0.8, renovacao: 0.3, ultraFibra: 0.3, wttx: 0.6, m2m: 0.6 },
                'PLATINUM': { novos: 1.0, renovacao: 0.4, ultraFibra: 0.5, wttx: 1.0, m2m: 0.6 },
                'BLACK': { novos: 1.5, renovacao: 0.5, ultraFibra: 0.7, wttx: 1.5, m2m: 0.6 },
                'BLACK+': { novos: 2.0, renovacao: 0.6, ultraFibra: 0.8, wttx: 2.0, m2m: 0.6 }
            };
            const taxa = (taxas[nivel.nome] && taxas[nivel.nome][tipo]) ? taxas[nivel.nome][tipo] : 0;
            return Number(valorVenda || 0) * taxa;
        }
        let vendasTemp = [];
        function renderItens() {
            const list = document.getElementById('vendasList');
            const content = document.getElementById('vendasListContent');
            if (!list || !content) return;
            if (!vendasTemp.length) {
                list.style.display = 'none';
                document.getElementById('summary').style.display = 'none';
                content.innerHTML = '';
                return;
            }
            list.style.display = 'block';
            content.innerHTML = vendasTemp.map((v, i) => `
                <div style="display:flex; align-items:center; justify-content:space-between; padding:0.6rem; border:1px solid rgba(255,255,255,0.06); border-radius:10px; margin-bottom:0.5rem;">
                    <div style="display:flex; gap:0.75rem; align-items:center;">
                        <span style="color:#93C5FD; font-weight:600;">${v.vendedor}</span>
                        <span style="color:#A7F3D0; background:rgba(16,185,129,0.12); border:1px solid rgba(16,185,129,0.35); border-radius:999px; padding:0.2rem 0.5rem; font-size:0.8rem;">${v.tipo}</span>
                        <span style="color:#FCD34D;">${Number(v.receita || 0).toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' })}</span>
                    </div>
                    <button type="button" class="btn btn-ghost" onclick="removerItem(${i})">Remover</button>
                </div>
            `).join('');
            const receitaNovos = vendasTemp.filter(v => v.tipo === 'novos').reduce((a, b) => a + Number(b.receita || 0), 0);
            const receitaTotal = vendasTemp.reduce((a, b) => a + Number(b.receita || 0), 0);
            const nivel = calcularNivelLocal(receitaNovos);
            document.getElementById('sumNivel').textContent = nivel.nome;
            document.getElementById('sumNovos').textContent = Number(receitaNovos || 0).toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
            document.getElementById('sumTotal').textContent = Number(receitaTotal || 0).toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
            const comissaoTotal = vendasTemp.reduce((acc, v) => acc + calcularComissaoProdutoLocal(receitaNovos, v.tipo, Number(v.receita || 0)), 0);
            document.getElementById('sumComissao').textContent = Number(comissaoTotal || 0).toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
            document.getElementById('summary').style.display = 'block';
        }
        function adicionarItem() {
            const vendedor = document.getElementById('vendedor').value;
            const tipo = document.getElementById('tipo').value;
            const receita = Number(document.getElementById('receita').value || 0);
            const p2b = Number(document.getElementById('p2b').value || 0);
            if (!vendedor || !tipo || receita <= 0) {
                toast('Informe vendedor, tipo e receita', 'error');
                return;
            }
            vendasTemp.push({ vendedor, tipo, receita, p2b });
            document.getElementById('receita').value = '';
            document.getElementById('p2b').value = '';
            renderItens();
        }
        function removerItem(i) {
            vendasTemp.splice(i, 1);
            renderItens();
        }
        async function updateHeaderLevelLabel() {
            try {
                const auth = localStorage.getItem('authUser');
                const u = JSON.parse(auth || '{}');
                const label = document.getElementById('userNameLabel');
                if (!label || !u || !u.name) return;
                const isAdmin = (u && u.role === 'admin');
                if (isAdmin) { label.textContent = u.name + ' ‚Ä¢ Admin'; return; }
                const sales = await api('/sales', { method: 'GET' });
                const receitaNovos = (Array.isArray(sales) ? sales : []).filter(s => String(s.tipo).toLowerCase() === 'novos')
                    .reduce((acc, s) => acc + Number(s.receita || 0), 0);
                const nivel = calcularNivelLocal(receitaNovos);
                label.textContent = u.name + ' ‚Ä¢ ' + nivel.nome;
            } catch {}
        }
        document.addEventListener('DOMContentLoaded', async () => {
            const auth = localStorage.getItem('authUser');
            if (!auth) { window.location.href = 'login.html'; return; }
            try {
                const user = JSON.parse(auth);
                const label = document.getElementById('userNameLabel');
                if (label && user && user.name) label.textContent = user.name;
            } catch {}
            await updateHeaderLevelLabel();
            carregarUsuarios();
            const nome = document.getElementById('clienteNome');
            const cnpj = document.getElementById('clienteCnpj');
            const receita = document.getElementById('receita');
            nome.addEventListener('input', () => toUpperInput(nome));
            cnpj.addEventListener('input', () => { cnpj.value = formatCnpj(cnpj.value); });
            const umb = document.getElementById('userMenuBtn');
            if (umb) {
                umb.addEventListener('click', () => {
                    const menu = document.getElementById('userMenu');
                    if (menu) menu.classList.toggle('show');
                });
            }
            const lb = document.getElementById('logoutBtn');
            if (lb) {
                lb.addEventListener('click', (e) => {
                    e.preventDefault();
                    localStorage.removeItem('authUser');
                    window.location.href = 'login.html';
                });
            }
            try {
                const u = JSON.parse(localStorage.getItem('authUser') || '{}');
                const isAdmin = (u && u.role === 'admin');
                const navUsers = document.getElementById('navUsers');
                const bottomUsers = document.getElementById('bottomUsers');
                if (navUsers) navUsers.style.display = isAdmin ? 'flex' : 'none';
                if (bottomUsers) bottomUsers.style.display = isAdmin ? 'inline-flex' : 'none';
            } catch {}
            document.getElementById('limparBtn').addEventListener('click', () => limparFormulario());
            document.getElementById('addItemBtn').addEventListener('click', () => adicionarItem());
            document.getElementById('vendaForm').addEventListener('submit', async (e) => {
                e.preventDefault();
                const nomeVal = (nome.value || '').trim();
                const cnpjVal = (cnpj.value || '').replace(/\D/g, '');
                if (!nomeVal || !cnpjVal) {
                    toast('Preencha todos os campos obrigat√≥rios', 'error');
                    return;
                }
                if (!vendasTemp.length) {
                    toast('Adicione ao menos um item de venda', 'error');
                    return;
                }
                const payload = {
                    cliente: { name: nomeVal.toUpperCase(), cnpj: cnpjVal },
                    vendas: vendasTemp.map(v => ({ tipo: v.tipo, receita: Number(v.receita || 0), vendedor: v.vendedor, p2b: Number(v.p2b || 0) }))
                };
                try {
                    let overrideUserId;
                    try {
                        const u = JSON.parse(localStorage.getItem('authUser') || '{}');
                        const isAdmin = (u && u.role === 'admin');
                        if (isAdmin) {
                            const vendName = (vendasTemp[0]?.vendedor) || (document.getElementById('vendedor')?.value) || '';
                            const mappedId = __usuariosByName[String(vendName)] || undefined;
                            if (typeof mappedId !== 'undefined') overrideUserId = mappedId;
                        }
                    } catch {}
                    const options = { method: 'POST', body: JSON.stringify(payload) };
                    if (typeof overrideUserId !== 'undefined') options.overrideUserId = overrideUserId;
                    const sim = await api('/simulations', options);
                    preencherResumo(sim);
                    document.getElementById('clienteNome').value = '';
                    document.getElementById('clienteCnpj').value = '';
                    document.getElementById('receita').value = '';
                    document.getElementById('p2b').value = '';
                    vendasTemp = [];
                    const list = document.getElementById('vendasList');
                    if (list) list.style.display = 'none';
                    toast('Venda registrada com sucesso', 'success');
                } catch {
                    toast('Erro ao salvar venda', 'error');
                }
            });
            if (window.lucide && typeof window.lucide.createIcons === 'function') { window.lucide.createIcons(); }
        });
    </script>
    <script src="script.js"></script>
</body>
</html>
