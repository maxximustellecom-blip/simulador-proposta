<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Histórico de Vendas • Maxximus Telecom</title>
    <link rel="icon" href="data:,">
    <link rel="stylesheet" href="style.css">
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
</head>
<body>
    <main class="container">
        <div class="card">
            <div class="card-head">
                <div class="card-title">
                    <span>Histórico de Vendas</span>
                    <span class="chip">Visão consolidada</span>
                </div>
                <div class="muted" id="scopeLabel"></div>
            </div>
            <div id="filtersHistorico" class="filters">
                <div>
                    <div class="label">Vendedor</div>
                    <select id="fVendedor" class="select"><option value="Todos">Todos</option></select>
                </div>
                <div>
                    <div class="label">Razão social</div>
                    <input id="fRazao" class="input" type="text" placeholder="Empresa">
                </div>
                <div>
                    <div class="label">CNPJ</div>
                    <input id="fCnpj" class="input" type="text" placeholder="00.000.000/0000-00">
                </div>
                <div>
                    <div class="label">Data</div>
                    <input id="fData" class="input" type="date">
                </div>
                <div style="display:flex; align-items:flex-end; gap:0.5rem;">
                    <button id="buscarBtn" class="btn btn-ghost btn-icon" type="button" title="Buscar"><i data-lucide="search"></i></button>
                    <button id="limparBtn" class="btn btn-ghost btn-icon" type="button" title="Limpar"><i data-lucide="x"></i></button>
                </div>
            </div>
            <div class="list" id="historyList"></div>
        </div>
</main>
<script src="script.js"></script>
    <div id="editModal" class="modal">
        <div class="modal-card">
            <div class="modal-head">
                <span id="editModalTitle">Editar venda</span>
                <button type="button" class="btn btn-ghost" onclick="closeEditModal()"><i data-lucide="x"></i></button>
            </div>
            <div class="modal-body">
                <div class="section" style="padding:0.8rem;">
                    <div class="label">Vendedor</div>
                    <select id="editVendedor" class="select"></select>
                </div>
                <div class="section" style="padding:0.8rem; margin-top:0.8rem;">
                    <div class="label">Tipo</div>
                    <select id="editTipo" class="select">
                        <option value="novos">Novos</option>
                        <option value="renovacao">Renovação</option>
                        <option value="ultraFibra">Ultra Fibra</option>
                        <option value="wttx">WTTx</option>
                        <option value="m2m">M2M</option>
                    </select>
                </div>
                <div class="section" style="padding:0.8rem; margin-top:0.8rem;">
                    <div class="label">Receita (R$)</div>
                    <input id="editReceita" class="input" type="number" step="0.01" min="0" placeholder="0,00">
                </div>
                <div class="section" style="padding:0.8rem; margin-top:0.8rem;">
                    <div class="label">P2B</div>
                    <input id="editP2b" class="input" type="number" step="1" min="0" placeholder="0">
                </div>
            </div>
            <div class="modal-actions">
                <button type="button" class="btn btn-ghost" onclick="closeEditModal()">Cancelar</button>
                <button type="button" class="btn btn-primary" onclick="saveEditSale()">Salvar</button>
            </div>
        </div>
    </div>
    <div id="confirmDeleteModal" class="modal">
        <div class="modal-card">
            <div class="modal-head">
                <span>Confirmar exclusão</span>
                <button type="button" class="btn btn-ghost" onclick="closeDeleteModal()"><i data-lucide="x"></i></button>
            </div>
            <div class="modal-body">
                Tem certeza que deseja excluir esta venda? Esta ação não pode ser desfeita.
            </div>
            <div class="modal-actions">
                <button type="button" class="btn btn-ghost" onclick="closeDeleteModal()">Cancelar</button>
                <button type="button" class="btn btn-primary" onclick="confirmDelete()">Excluir</button>
            </div>
        </div>
    </div>
    <script>
        const API_BASE = 'https://others-maxximus-backend.pvuzyy.easypanel.host';
        async function api(path, options = {}) {
            const authRaw = localStorage.getItem('authUser');
            let headers = { 'Content-Type': 'application/json' };
            try {
                const u = JSON.parse(authRaw || '{}');
                if (u && u.id) headers['x-user-id'] = String(u.id);
                if (u && u.role) headers['x-user-role'] = String(u.role);
                if (u && u.name) headers['x-user-name'] = String(u.name);
            } catch {}
            const res = await fetch(API_BASE + path, { headers, ...options });
            if (!res.ok) {
                const err = await res.json().catch(() => ({}));
                throw new Error(err.error || ('HTTP ' + res.status));
            }
            return res.json();
        }
        let __currentSales = [];
        function initIcons() {
            try {
                if (window.lucide && typeof window.lucide.createIcons === 'function') {
                    window.lucide.createIcons();
                }
            } catch {}
        }
        let __isAdminGlobal = false;
        function currency(n) {
            return Number(n || 0).toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
        }
        function calcularNivelLocal(receitaNovos) {
            if (receitaNovos < 700) return { nome: 'BLUE', fator: 0.6 };
            if (receitaNovos < 900) return { nome: 'SILVER', fator: 0.8 };
            if (receitaNovos < 1500) return { nome: 'PLATINUM', fator: 1.0 };
            if (receitaNovos < 1900) return { nome: 'BLACK', fator: 1.5 };
            return { nome: 'BLACK+', fator: 2.0 };
        }
        function calcularComissaoProdutoLocal(receitaBase, tipo, valorVenda) {
            const nivel = calcularNivelLocal(receitaBase);
            const taxas = {
                'BLUE': { novos: 0.6, renovacao: 0.3, ultraFibra: 0.3, wttx: 0.6, m2m: 0.6 },
                'SILVER': { novos: 0.8, renovacao: 0.3, ultraFibra: 0.3, wttx: 0.6, m2m: 0.6 },
                'PLATINUM': { novos: 1.0, renovacao: 0.4, ultraFibra: 0.5, wttx: 1.0, m2m: 0.6 },
                'BLACK': { novos: 1.5, renovacao: 0.5, ultraFibra: 0.7, wttx: 1.5, m2m: 0.6 },
                'BLACK+': { novos: 2.0, renovacao: 0.6, ultraFibra: 0.8, wttx: 2.0, m2m: 0.6 }
            };
            const taxa = taxas[nivel.nome][String(tipo || '').toLowerCase()] || 0;
            return Number(valorVenda || 0) * Number(taxa || 0);
        }
        function iconNameForTipo(tipo) {
            switch (String(tipo || '').toLowerCase()) {
                case 'novos': return 'plus-circle';
                case 'renovacao': return 'refresh-ccw';
                case 'ultrafibra': return 'bolt';
                case 'wttx': return 'wifi';
                case 'm2m': return 'link';
                default: return 'circle';
            }
        }
        function renderAvatarIcon(tipo) {
            const name = iconNameForTipo(tipo);
            return `<i data-lucide="${name}"></i>`;
        }
        function getMonthLabel(dateStr) {
            const s = String(dateStr || '');
            const parts = s.split(' ')[0].split('/');
            if (parts.length >= 3) {
                const m = Number(parts[1]);
                const y = parts[2];
                const names = ['janeiro','fevereiro','março','abril','maio','junho','julho','agosto','setembro','outubro','novembro','dezembro'];
                const name = names[m - 1] || '';
                return name ? (name + ' ' + y) : s;
            }
            return s || '-';
        }
        function groupSales(sales) {
            const byMonth = {};
            (sales || []).forEach(s => {
                const key = getMonthLabel(s.data);
                if (!byMonth[key]) byMonth[key] = [];
                byMonth[key].push(s);
            });
            return byMonth;
        }
        function renderHistory(sales, isAdmin) {
            __currentSales = Array.isArray(sales) ? sales.slice() : [];
            const list = document.getElementById('historyList');
            const scopeLabel = document.getElementById('scopeLabel');
            scopeLabel.textContent = isAdmin ? 'Administrador: todas as vendas' : 'Usuário: suas vendas';
            if (!sales || sales.length === 0) {
                list.innerHTML = `<div class="empty">Nenhum registro encontrado</div>`;
                return;
            }
            const byMonth = groupSales(sales);
            const html = Object.keys(byMonth).sort((a,b) => a.localeCompare(b)).map(monthKey => {
                const monthSales = byMonth[monthKey];
                const byVendor = {};
                monthSales.forEach(s => {
                    const v = s.vendedor || '-';
                    if (!byVendor[v]) byVendor[v] = [];
                    byVendor[v].push(s);
                });
                const vendorsHtml = Object.keys(byVendor).sort((a,b) => a.localeCompare(b)).map(v => {
                    const vs = byVendor[v];
                    const total = vs.reduce((acc, s) => acc + Number(s.receita || 0), 0);
                    const receitaNovos = vs.filter(s => s.tipo === 'novos').reduce((acc, s) => acc + Number(s.receita || 0), 0);
                    const nivel = calcularNivelLocal(receitaNovos);
                    const comissaoTotal = vs.reduce((acc, s) => acc + calcularComissaoProdutoLocal(receitaNovos, s.tipo, Number(s.receita || 0)), 0);
                    const vendKey = String(v).trim().toLowerCase().replace(/\s+/g,'-').replace(/[^a-z0-9\-]/g,'');
                    const sectionId = `vend-items-${monthKey}-${vendKey}`;
                    const btnId = `vend-btn-${monthKey}-${vendKey}`;
                    return `
                        <div class="vendor">
                            <div class="vendor-title">
                                <div class="vendor-left">
                                    <div class="vendor-heading">
                                        <span class="vendor-name">${v}</span>
                                        <span class="level-pill">${nivel.nome}</span>
                                    </div>
                                    <div class="vendor-meta">
                                        <span>Receita Novos: ${currency(receitaNovos)}</span>
                                        <span>Fator: ${nivel.fator}</span>
                                        <span>Comissão: ${currency(comissaoTotal)}</span>
                                    </div>
                                </div>
                                <span class="amount">Comissão: ${currency(comissaoTotal)}</span>
                            </div>
                            <div class="vendor-toggle">
                                <button class="accordion-btn" type="button" id="${btnId}" onclick="toggleVendor('${sectionId}','${btnId}')">
                                    <span class="acc-label">ver itens</span>
                                    <span class="acc-chevron"><i data-lucide="chevron-down"></i></span>
                                </button>
                            </div>
                            <div id="${sectionId}" class="accordion-content hidden">
                                ${vs.map(s => `
                                    <div class="item">
                                        <div class="item-left">
                                            <div class="avatar">${renderAvatarIcon(s.tipo)}</div>
                                            <div class="item-info">
                                                <div class="item-line">
                                                    <span class="pill">${s.tipo}</span>
                                                    <span class="item-name">${s.nome || '-'}</span>
                                                    <span class="level-inline">${nivel.nome}</span>
                                                </div>
                                                <div class="item-meta">
                                                    <span class="muted">Vendedor: ${s.vendedor || '-'}</span>
                                                    <span class="muted">• Data: ${s.data || '-'}</span>
                                                    <span class="muted">• CNPJ: ${s.cnpj || '-'}</span>
                                                    <span class="muted">• P2B: ${s.p2b ?? '-'}</span>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="item-right">
                                            ${ isAdmin ? `<div class="amount">${currency(s.receita)}</div>` : ``}
                                            ${ isAdmin ? `<button class="btn btn-ghost btn-icon" type="button" onclick='openEditModal(${JSON.stringify({id:""+s.id,tipo:s.tipo,receita:Number(s.receita||0),vendedor:s.vendedor||"",p2b:Number(s.p2b||0)})})'><i data-lucide="pencil"></i></button>` : ``}
                                            ${ isAdmin ? `<button class="btn btn-ghost btn-icon" type="button" onclick="openDeleteModal(${s.id})"><i data-lucide='trash-2'></i></button>` : ``}
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    `;
                }).join('');
                return `
                    <div class="month">
                        <div class="month-head">
                            <div>${monthKey.replace(",", "")}</div>
                            <div class="muted">${monthSales.length} ${monthSales.length === 1 ? 'item' : 'itens'}</div>
                        </div>
                        ${vendorsHtml}
                    </div>
                `;
            }).join('');
            list.innerHTML = html;
            if (window.lucide && typeof window.lucide.createIcons === 'function') {
                window.lucide.createIcons();
            }
        }
        function toggleVendor(sectionId, btnId) {
            const el = document.getElementById(sectionId);
            const btn = document.getElementById(btnId);
            if (!el || !btn) return;
            const hidden = el.classList.contains('hidden');
            if (hidden) {
                el.classList.remove('hidden');
                btn.classList.add('open');
                const label = btn.querySelector('.acc-label');
                if (label) label.textContent = 'ocultar';
            } else {
                el.classList.add('hidden');
                btn.classList.remove('open');
                const label = btn.querySelector('.acc-label');
                if (label) label.textContent = 'ver itens';
            }
        }
        function getOpenAccordionIds() {
            const nodes = Array.from(document.querySelectorAll('.accordion-content'));
            return nodes.filter(n => !n.classList.contains('hidden')).map(n => n.id);
        }
        function restoreAccordionOpen(openIds = []) {
            (openIds || []).forEach(id => {
                const el = document.getElementById(id);
                if (!el) return;
                el.classList.remove('hidden');
                const btnId = String(id || '').replace(/^vend-items-/, 'vend-btn-');
                const btn = document.getElementById(btnId);
                if (btn) {
                    btn.classList.add('open');
                    const label = btn.querySelector('.acc-label');
                    if (label) label.textContent = 'ocultar';
                }
            });
        }
        function rerenderPreservingState() {
            const openIds = getOpenAccordionIds();
            const scrollY = window.scrollY || 0;
            renderHistory(__currentSales, __isAdminGlobal);
            restoreAccordionOpen(openIds);
            window.scrollTo(0, scrollY);
        }
        async function buscarPreservandoEstado() {
            const openIds = getOpenAccordionIds();
            const scrollY = window.scrollY || 0;
            const vendedor = document.getElementById('fVendedor').value;
            const razao = document.getElementById('fRazao').value.trim();
            const cnpj = document.getElementById('fCnpj').value.replace(/\D/g,'');
            const data = document.getElementById('fData').value;
            const params = [];
            if (vendedor && vendedor !== 'Todos') params.push('vendedor=' + encodeURIComponent(vendedor));
            if (razao) params.push('razao=' + encodeURIComponent(razao));
            if (cnpj) params.push('cnpj=' + encodeURIComponent(cnpj));
            if (data) params.push('data=' + encodeURIComponent(data));
            const qs = params.length ? ('?' + params.join('&')) : '';
            try {
                const sales = await api('/sales' + qs, { method: 'GET' });
                __currentSales = Array.isArray(sales) ? sales : [];
                renderHistory(__currentSales, __isAdminGlobal);
                restoreAccordionOpen(openIds);
                window.scrollTo(0, scrollY);
            } catch {
                renderHistory([], __isAdminGlobal);
            }
        }
        let __usuariosCache = [];
        function renderUsuarioOptions(selected) {
            if (!__usuariosCache || __usuariosCache.length === 0) return '<option value="">Selecione</option>';
            return __usuariosCache.map(u => {
                const sel = (u.name === selected) ? 'selected' : '';
                return `<option value="${u.name}" ${sel}>${u.name}</option>`;
            }).join('');
        }
        let __editingSaleId = null;
        function openEditModal(payload) {
            __editingSaleId = payload?.id ? Number(payload.id) : null;
            const vendEl = document.getElementById('editVendedor');
            const tipoEl = document.getElementById('editTipo');
            const recEl = document.getElementById('editReceita');
            const p2bEl = document.getElementById('editP2b');
            vendEl.innerHTML = renderUsuarioOptions(payload?.vendedor || '');
            tipoEl.value = payload?.tipo || 'novos';
            recEl.value = payload?.receita || 0;
            p2bEl.value = payload?.p2b || 0;
            const modal = document.getElementById('editModal');
            modal.classList.add('show');
            if (window.lucide && typeof window.lucide.createIcons === 'function') {
                window.lucide.createIcons();
            }
        }
        function closeEditModal() {
            const modal = document.getElementById('editModal');
            modal.classList.remove('show');
            __editingSaleId = null;
        }
        let __pendingDeleteId = null;
        function openDeleteModal(id) {
            __pendingDeleteId = Number(id);
            const modal = document.getElementById('confirmDeleteModal');
            modal.classList.add('show');
            if (window.lucide && typeof window.lucide.createIcons === 'function') {
                window.lucide.createIcons();
            }
        }
        function closeDeleteModal() {
            const modal = document.getElementById('confirmDeleteModal');
            modal.classList.remove('show');
            __pendingDeleteId = null;
        }
        async function saveEditSale() {
            if (!__editingSaleId) return;
            const tipo = document.getElementById('editTipo').value;
            const vendedor = document.getElementById('editVendedor').value;
            const receita = Number(document.getElementById('editReceita').value || 0);
            const p2b = Number(document.getElementById('editP2b').value || 0);
            try {
                await api('/sales/' + __editingSaleId, { method: 'PUT', body: JSON.stringify({ tipo, vendedor, receita, p2b }) });
                closeEditModal();
                await buscarPreservandoEstado();
            } catch {}
        }
        async function confirmDelete() {
            if (!__pendingDeleteId) return;
            const id = __pendingDeleteId;
            try {
                await api('/sales/' + id, { method: 'DELETE' });
                closeDeleteModal();
                await buscarPreservandoEstado();
            } catch {}
        }
        document.addEventListener('DOMContentLoaded', async () => {
            initIcons();
            const auth = localStorage.getItem('authUser');
            if (!auth) { window.location.href = 'login.html'; return; }
            let isAdmin = false;
            try {
                const user = JSON.parse(auth);
                const label = document.getElementById('userNameLabel');
                if (label && user && user.name) label.textContent = user.name;
                isAdmin = (user && user.role === 'admin');
            } catch {}
            __isAdminGlobal = isAdmin;
            const umb = document.getElementById('userMenuBtn');
            if (umb) {
                umb.addEventListener('click', () => {
                    const menu = document.getElementById('userMenu');
                    if (menu) menu.classList.toggle('show');
                });
            }
            const lb = document.getElementById('logoutBtn');
            if (lb) {
                lb.addEventListener('click', (e) => {
                    e.preventDefault();
                    localStorage.removeItem('authUser');
                    window.location.href = 'login.html';
                });
            }
            async function carregarUsuarios() {
                const sel = document.getElementById('fVendedor');
                try {
                    let list = await api('/auth/users?role=user', { method: 'GET' });
                    if (!Array.isArray(list) || list.length === 0) list = await api('/auth/users', { method: 'GET' });
                    __usuariosCache = Array.isArray(list) ? list : [];
                    const opts = ['<option value="Todos">Todos</option>'].concat((list || []).map(u => `<option value="${u.name}">${u.name}</option>`));
                    sel.innerHTML = opts.join('');
                } catch {
                    __usuariosCache = [];
                    sel.innerHTML = '<option value="Todos">Todos</option>';
                }
            }
            function formatCnpj(value) {
                const v = String(value || '').replace(/\D/g, '').slice(0,14);
                const p = [v.slice(0,2), v.slice(2,5), v.slice(5,8), v.slice(8,12), v.slice(12,14)].filter(Boolean);
                if (p.length >= 5) return `${p[0]}.${p[1]}.${p[2]}/${p[3]}-${p[4]}`;
                if (p.length >= 4) return `${p[0]}.${p[1]}.${p[2]}/${p[3]}`;
                if (p.length >= 3) return `${p[0]}.${p[1]}.${p[2]}`;
                if (p.length >= 2) return `${p[0]}.${p[1]}`;
                return p[0] || '';
            }
        function updateHeaderLevelLabelFromSales(sales, isAdmin) {
            try {
                const label = document.getElementById('userNameLabel');
                const authRaw = localStorage.getItem('authUser');
                const u = JSON.parse(authRaw || '{}');
                if (!label || !u || !u.name) return;
                if (isAdmin) {
                    label.textContent = u.name + ' • Admin';
                    return;
                }
                const receitaNovosTotal = (sales || []).filter(s => String(s.tipo).toLowerCase() === 'novos')
                    .reduce((acc, s) => acc + Number(s.receita || 0), 0);
                const nivel = calcularNivelLocal(receitaNovosTotal);
                label.textContent = u.name + ' • ' + nivel.nome;
            } catch {}
        }
        async function buscar() {
            const vendedor = document.getElementById('fVendedor').value;
            const razao = document.getElementById('fRazao').value.trim();
            const cnpj = document.getElementById('fCnpj').value.replace(/\D/g,'');
            const data = document.getElementById('fData').value;
            const params = [];
            if (vendedor && vendedor !== 'Todos') params.push('vendedor=' + encodeURIComponent(vendedor));
            if (razao) params.push('razao=' + encodeURIComponent(razao));
            if (cnpj) params.push('cnpj=' + encodeURIComponent(cnpj));
            if (data) params.push('data=' + encodeURIComponent(data));
            const qs = params.length ? ('?' + params.join('&')) : '';
            try {
                const sales = await api('/sales' + qs, { method: 'GET' });
                const arr = Array.isArray(sales) ? sales : [];
                renderHistory(arr, isAdmin);
                updateHeaderLevelLabelFromSales(arr, isAdmin);
            } catch {
                renderHistory([], isAdmin);
            }
        }
            document.getElementById('fCnpj').addEventListener('input', (e) => {
                e.target.value = formatCnpj(e.target.value);
            });
            document.getElementById('buscarBtn').addEventListener('click', buscar);
            document.getElementById('limparBtn').addEventListener('click', () => {
                document.getElementById('fVendedor').value = 'Todos';
                document.getElementById('fRazao').value = '';
                document.getElementById('fCnpj').value = '';
                document.getElementById('fData').value = '';
                buscar();
            });
            await carregarUsuarios();
            try {
                const sales = await api('/sales', { method: 'GET' });
                __currentSales = Array.isArray(sales) ? sales : [];
                renderHistory(__currentSales, isAdmin);
                updateHeaderLevelLabelFromSales(__currentSales, isAdmin);
            } catch {
                renderHistory([], isAdmin);
            }
            const navUsers = document.getElementById('navUsers');
            const bottomUsers = document.getElementById('bottomUsers');
            if (navUsers) navUsers.style.display = isAdmin ? 'flex' : 'none';
            if (bottomUsers) bottomUsers.style.display = isAdmin ? 'inline-flex' : 'none';
            initIcons();
            setTimeout(initIcons, 200);
        });
    </script>
    <script src="script.js"></script>
</body>
</html>
