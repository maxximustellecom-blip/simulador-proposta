<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pedidos de Vendas • Maxximus Telecom</title>
    <link rel="icon" href="data:,">
    <link rel="stylesheet" href="style.css">
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
    <style>
        :root {
            --blue-50: #eff6ff;
            --blue-100: #dbeafe;
            --blue-400: #60a5fa;
            --blue-600: #2563eb;
            --blue-800: #1e40af;
            --green-50: #f0fdf4;
            --green-100: #dcfce7;
            --green-400: #4ade80;
            --green-600: #16a34a;
            --green-800: #166534;
            --purple-50: #faf5ff;
            --purple-100: #f3e8ff;
            --purple-400: #c084fc;
            --purple-600: #9333ea;
            --purple-800: #6b21a8;
            --red-50: #fef2f2;
            --red-100: #fee2e2;
            --red-400: #f87171;
            --red-800: #991b1b;
            --yellow-50: #fefce8;
            --yellow-100: #fef9c3;
            --yellow-400: #facc15;
            --yellow-800: #854d0e;
        }

        .filters-container {
            display: flex;
            gap: 1rem;
            margin-bottom: 1rem;
            flex-wrap: wrap;
            align-items: end;
        }
        .filter-group {
            display: flex;
            flex-direction: column;
            gap: 0.3rem;
            flex: 1;
            min-width: 200px;
        }
        
        .action-buttons {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
        }

        .table-container {
            overflow-x: auto;
            border-radius: var(--radius);
            border: 1px solid var(--border);
            background: white;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }
        table {
            width: 100%;
            border-collapse: separate; 
            border-spacing: 0;
            font-size: 0.75rem;
            white-space: nowrap;
        }
        th, td {
            padding: 0.5rem 0.75rem;
            border-bottom: 1px solid var(--border);
            text-align: left;
            vertical-align: middle;
        }
        th {
            background: var(--blue-600);
            color: white;
            font-weight: 600;
            position: sticky;
            top: 0;
            z-index: 10;
        }
        
        /* Sticky Actions Column */
        th:last-child, td:last-child {
            position: sticky;
            right: 0;
            background: inherit; /* Matches row background */
            z-index: 5;
            border-left: 1px solid var(--border);
        }
        th:last-child {
            background: var(--blue-600);
            z-index: 15;
        }

        tr { transition: background-color 0.2s; }
        tr:hover { filter: brightness(0.98); }

        /* Input styling within table */
        table input, table select {
            width: 100%;
            padding: 0.25rem 0.5rem;
            border: 1px solid transparent;
            border-radius: 0.25rem;
            background: transparent;
            font-size: 0.75rem;
            color: inherit;
            transition: all 0.2s;
        }
        table input:disabled, table select:disabled {
            cursor: default;
        }
        /* Edit mode styles */
        tr.editing input, tr.editing select {
            background: white;
            border-color: #d1d5db;
        }
        tr.editing input:focus, tr.editing select:focus {
            outline: 2px solid var(--blue-400);
            border-color: transparent;
        }

        /* Status Badges */
        .status-badge {
            padding: 0.25rem 0.5rem;
            border-radius: 999px;
            font-weight: 600;
            display: inline-block;
        }

        /* Utility Classes matching React example */
        .bg-blue-50 { background-color: var(--blue-50); }
        .bg-green-50 { background-color: var(--green-50); }
        .bg-purple-50 { background-color: var(--purple-50); }
        .bg-red-50 { background-color: var(--red-50); }
        .bg-yellow-50 { background-color: var(--yellow-50); }
        
        .border-l-4 { border-left-width: 4px; border-left-style: solid; }
        .border-blue-400 { border-left-color: var(--blue-400); }
        .border-green-400 { border-left-color: var(--green-400); }
        .border-purple-400 { border-left-color: var(--purple-400); }
        .border-red-400 { border-left-color: var(--red-400); }
        .border-yellow-400 { border-left-color: var(--yellow-400); }

        .text-blue-800 { color: var(--blue-800); }
        .text-green-800 { color: var(--green-800); }
        .text-purple-800 { color: var(--purple-800); }
        .text-red-800 { color: var(--red-800); }
        .text-yellow-800 { color: var(--yellow-800); }

        .btn-sm { padding: 0.25rem 0.5rem; font-size: 0.75rem; }
        .btn-blue { background: var(--blue-600); color: white; }
        .btn-green { background: var(--green-600); color: white; }
        .btn-purple { background: var(--purple-600); color: white; }
        
        .btn-blue:hover { background: var(--blue-800); }
        .btn-green:hover { background: var(--green-800); }
        .btn-purple:hover { background: var(--purple-800); }

        /* Consolidados Table */
        .consolidados-container {
            margin-bottom: 1.5rem;
            border-radius: var(--radius);
            border: 1px solid var(--purple-400);
            overflow: hidden;
        }
        .consolidados-header {
            background: var(--purple-50);
            padding: 1rem;
            border-bottom: 1px solid var(--purple-400);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .consolidados-table th {
            background: var(--purple-600);
        }
    </style>
</head>
<body>
    <main class="container">
        <!-- Header Section -->
        <div class="card mb-6" style="background: linear-gradient(to right, var(--blue-600), var(--blue-800));">

            <div class="card-head">
                <div class="card-title">
                    <span>Pedidos de Vendas</span>
                    <span class="chip" id="totalVendasCount">0</span>
                    <span class="chip">Somente Admin</span>
                </div>

            </div>

            <!-- Filters -->
            <section class="section" style="margin-top: 20px;">
                <div class="filters-container">
                    <div class="filter-group" style="flex: 2;">
                        <label class="label"><i data-lucide="search" size="14"></i> Buscar</label>
                        <input type="text" id="filtroBusca" class="input" placeholder="Buscar por Razão Social, CNPJ, P2B, Radar ou Contato" oninput="filtrarVendas()">
                    </div>
                    <div class="filter-group">
                        <label class="label"><i data-lucide="filter" size="14"></i> Status</label>
                        <select id="filtroStatus" class="select" onchange="filtrarVendas()">
                            <option value="Todos">Todos os Status</option>
                            <!-- Populated by JS -->
                        </select>
                    </div>
                </div>
            </section>

            
        </div>

        <!-- Card Pedidos Backend (Concluídos) -->
        <div class="card mb-6">
            <div class="card-head">
                <div class="card-title">
                    <i data-lucide="database" class="text-blue-600"></i>
                    <span>Pedidos de Venda (Backend - Concluídos)</span>
                </div>
            </div>
            <div class="table-container" style="max-height: 300px; overflow-y: auto;">
                <table id="tabelaBackend">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>CNPJ</th>
                            <th>Tipo</th>
                            <th>Proposta</th>
                            <th>Valor</th>
                            <th>Status</th>
                            <th>Data</th>
                        </tr>
                    </thead>
                    <tbody id="tbodyBackend">
                        <tr><td colspan="7" class="text-center p-4">Carregando...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Contract Filter Banner -->
        <div id="filtroContratoBanner" class="bg-purple-50 border-l-4 border-purple-400 p-4 mb-6 rounded-lg shadow-lg" style="display: none;">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-purple-800 font-semibold flex items-center gap-2">
                        <i data-lucide="eye" size="20"></i>
                        Visualizando linhas do contrato
                    </p>
                    <p id="nomeContratoFiltro" class="text-sm text-purple-700 mt-1 font-medium"></p>
                    <p id="countContratoFiltro" class="text-xs text-purple-600 mt-1"></p>
                </div>
                <button onclick="limparFiltroContrato()" class="btn btn-purple btn-sm">
                    <i data-lucide="x" size="18"></i> Mostrar Todos
                </button>
            </div>
        </div>

        <!-- Messages -->
        <div id="mensagemContainer"></div>

        <!-- Action Buttons -->
        <div class="action-buttons mb-6">
            <button class="btn btn-blue" onclick="adicionarVenda()">
                <i data-lucide="plus" size="18"></i> Nova Venda
            </button>
            <button class="btn btn-green" onclick="exportarDados()">
                <i data-lucide="download" size="18"></i> Exportar CSV
            </button>
        </div>

        <!-- Consolidated Table (Hidden by default) -->
        <div id="consolidadosContainer" class="consolidados-container">
            <div class="consolidados-header">
                <h2 class="text-purple-800 font-bold flex items-center gap-2" style="margin:0;">
                    <i data-lucide="bar-chart-3" class="text-purple-600"></i>
                    Contratos Consolidados
                </h2>
                <span id="totalContratosCount" class="text-sm text-purple-800 bg-white px-3 py-1 rounded-full font-semibold"></span>
            </div>
            <div class="table-container">
                <table class="consolidados-table">
                    <thead>
                        <tr>
                            <th>Razão Social</th>
                            <th>CNPJ</th>
                            <th class="text-center">Nº de Linhas</th>
                            <th class="text-center">Total Acessos</th>
                            <th class="text-right">Fatura Total</th>
                            <th class="text-center">Ações</th>
                        </tr>
                    </thead>
                    <tbody id="tbodyConsolidados"></tbody>
                    <tfoot class="bg-purple-800 text-white font-bold">
                        <tr id="tfootConsolidados"></tr>
                    </tfoot>
                </table>
            </div>
        </div>

        <!-- Main Table -->
        <div class="table-container">
            <table id="tabelaVendas">
                <thead>
                    <tr>
                        <th style="min-width: 80px;">Linha</th>
                        <th style="min-width: 180px;">Status do Pedido</th>
                        <th style="min-width: 120px;">Data Entrada</th>
                        <th style="min-width: 120px;">Data Input</th>
                        <th style="min-width: 120px;">Data Ativação</th>
                        <th style="min-width: 100px;">Nº P2B</th>
                        <th style="min-width: 100px;">Nº Radar</th>
                        <th style="min-width: 100px;">Tipo</th>
                        <th style="min-width: 200px;">Razão Social</th>
                        <th style="min-width: 140px;">CNPJ</th>
                        <th style="min-width: 130px;">Telefone</th>
                        <th style="min-width: 150px;">Contato</th>
                        <th style="min-width: 150px;">Consultor</th>
                        <th style="min-width: 100px;">Sede</th>
                        <th style="min-width: 80px;">Qtd</th>
                        <th style="min-width: 200px;">Plano</th>
                        <th style="min-width: 150px;">Região</th>
                        <th style="min-width: 200px;">Oferta</th>
                        <th style="min-width: 80px;">Pct</th>
                        <th style="min-width: 100px;">Valor</th>
                        <th style="min-width: 100px;">Total</th>
                        <th style="min-width: 80px;">Port-in</th>
                        <th style="min-width: 100px;">Op. Doadora</th>
                        <th style="min-width: 100px;">Acesso</th>
                        <th style="min-width: 120px;">Data Port-in</th>
                        <th style="min-width: 80px;">Fast Chip</th>
                        <th style="min-width: 150px;">ICCID</th>
                        <th style="min-width: 150px;">Aparelhos</th>
                        <th style="min-width: 200px;">Observação</th>
                        <th style="min-width: 100px;">Ações</th>
                    </tr>
                </thead>
                <tbody id="tbodyVendas"></tbody>
            </table>
        </div>
    </main>
    <script src="script.js"></script>
    <div id="toast" class="toast"></div>
    <script>
        const API_BASE = 'https://others-maxximus-backend.pvuzyy.easypanel.host';
        // const API_BASE = 'http://localhost:3001';
        async function api(path, options = {}) {
            const authRaw = localStorage.getItem('authUser');
            let headers = { 'Content-Type': 'application/json' };
            try {
                const u = JSON.parse(authRaw || '{}');
                if (u && u.id) headers['x-user-id'] = String(u.id);
                if (u && u.role) headers['x-user-role'] = String(u.role);
                if (u && u.name) headers['x-user-name'] = String(u.name);
            } catch {}
            const res = await fetch(API_BASE + path, { headers, ...options });
            if (!res.ok) {
                const err = await res.json().catch(() => ({}));
                throw new Error(err.error || ('HTTP ' + res.status));
            }
            return res.json();
        }

        // --- DATA & CONSTANTS ---
        const statusPedido = [
            '1-Entrada', '2-Pendente (P2B Status)', '0-Aguardando Assinatura',
            '1-Entrada (Análise Boc)', '2-Pendente Sistema P2B (Aguardando Status)',
            '3-Validado Documentação (TIM)', '4-Pendência Documentação (Aguardando)',
            '5-Emissão de documentos (LMS)', '7-Contratos Ativos',
            '8-Reprovado (Crédito ou Erro)', '9-Devolver para consultor (Correções)'
        ];

        const tipoVenda = ['Novo', 'Aditivo', 'Renovação'];

        const planosTIM = {
            'TIM Black Empresa': {
                'Todas as UFs, exceto PR e SC': [
                    'NV/ADP B 1GB + 5GB V0625 (Até 6GB)', 'NV/ADP B 2GB + 10GB V0625 (Até 12GB)',
                    'NV/ADP B 10GB + 20GB V0325 (Até 30GB)', 'NV/ADP B 20GB + 20GB V0925 (Até 40GB)',
                    'NV/ADP B 30GB + 20GB V0325 (Até 50GB)', 'NV/ADP B 30GB + 50GB V0325 (Até 80GB)',
                    'NV/ADP B 50GB + 50GB V0325 (Até 100GB)', 'NV/ADP B 100GB + 50GB V0325 (Até 150GB)'
                ],
                'PR e SC': [
                    'NV/ADP B 1GB + 5GB V0625 (Até 6GB)', 'NV/ADP B 2GB + 10GB V0625 (Até 12GB)',
                    'NV/ADP B 10GB + 20GB V0325 (Até 30GB)', 'NV/ADP B 20GB + 20GB V0925 (Até 40GB)',
                    'NV/ADP B 30GB + 20GB V0325 (Até 50GB)', 'NV/ADP B 30GB + 50GB V0325 (Até 80GB)',
                    'NV/ADP B 50GB + 50GB V0325 (Até 100GB)', 'NV/ADP B 100GB + 50GB V0325 (Até 150GB)'
                ]
            },
            'TIM Controle': {
                'DDDs 11,12,13,14,15,16,17,18,19,21,24,44,61,63,67,68,71,74,77,86,95': ['TIM Controle J Express 35GB', 'TIM Controle C Express 46GB'],
                'DDDs 22,27,28,31,32,33,34,35,37,38,41,42,43,45,46,47,48,49,51,53,54,55,62,64,65,66,69,73,75,79,81,82,83,84,85,87,88,89,91,92,93,94,96,97,98,99': ['TIM Controle C Express 46GB'],
                'DDDs 71,74,77,86': ['TIM Controle OFERTA FOCO 35GB', 'TIM Controle REDES SOCIAIS 54GB', 'TIM Controle PLUS 55GB', 'TIM Controle PREMIUM 61GB'],
                'DDDs 73,75,79,81,82,83,84,85,87,88,89': ['TIM Controle OFERTA FOCO 35GB', 'TIM Controle REDES SOCIAIS 54GB', 'TIM Controle PLUS 55GB', 'TIM Controle PREMIUM 61GB'],
                'DDDs 21,24,44,61,63,67,68,95': ['TIM Controle OFERTA FOCO 35GB', 'TIM Controle REDES SOCIAIS 54GB', 'TIM Controle PLUS 55GB', 'TIM Controle PREMIUM 61GB'],
                'DDDs 11,12,13,14,15,16,17,18,19': ['TIM Controle OFERTA FOCO 35GB', 'TIM Controle REDES SOCIAIS 54GB', 'TIM Controle PLUS 55GB', 'TIM Controle PREMIUM 61GB'],
                'DDDs 22,41,42,43,45,46,62,64,69,91,92,93,94,96,97,98,99': ['TIM Controle OFERTA FOCO 35GB', 'TIM Controle REDES SOCIAIS 54GB', 'TIM Controle PLUS 55GB', 'TIM Controle PREMIUM 61GB'],
                'DDDs 27,28,31,32,33,34,35,37,38,47,48,49,51,53,54,55,66': ['TIM Controle OFERTA FOCO 35GB', 'TIM Controle REDES SOCIAIS 54GB', 'TIM Controle PLUS 55GB', 'TIM Controle PREMIUM 61GB'],
                'TSP, TSE, TSU, TCN, TNE (Portabilidade)': ['Portabilidade 27GB (3GB Core + 20GB Promo + 4GB Especial) + Redes Sociais Inclusas'],
                'Nacional (Migração, Gross ou Troca)': ['Migração, Gross ou Troca 19GB (3GB Core + 10GB Promo + 6GB Especial) + Redes Sociais Inclusas']
            },
            'TIM Ultrafibra': {
                'SP / RS (exceto Caxias do Sul e Passo Fundo)': ['400 MEGA', '600 MEGA+', '1 GIGA', '2 GIGA+'],
                'AC, AM, BA, CE, DF, GO, MA, MT, MS MG, PA, PR, PE, RJ, RO (Porto Velho), RR, RS (Caxias/Passo Fundo), SC': ['400 MEGA', '600 MEGA+', '1 GIGA', '2 GIGA+'],
                'Exclusiva TO (Juiz de Fora... e São José (SC))': ['300 MEGA'],
                'Exclusiva AN (Ilhéus (BA)... e Chapecó (SC))': ['300 MEGA', '600 MEGA', 'OFERTA FOCO RN 500 MEGA']
            },
            'Serviços': {
                'Válido para Todas as UFs (Geral)': [
                    'NV/ADP 6 1GB + 20GB V0625 (Até 21GB)', 'NV/ADP 6 20GB + 20GB V0524 (Até 40GB)',
                    'NV/ADP 6 20GB + 50GB V0564 (Até 70GB)', 'AGL 3GB (Liberty Web Empresa 3GB)',
                    'AGL 10GB (Liberty Web Empresa 10GB)', 'AGL 40GB (Liberty Web Empresa 40GB)',
                    'AGL 100GB (Liberty Web Empresa 100GB)', 'WTTX 2MB_40GB', 'WTTX 5MB_80GB',
                    'WTTX 5MB_100GB', 'WTTX 5MB_500GB', 'TIM Liberty Web até 150GB + Roteador Intelbrás GX 3000 – 5G',
                    'TIM Black Empresas até 150GB + Roteador Intelbrás GX 3000 – 5G', 'TBP M2M 20MB',
                    'TBP M2M 50MB', 'TBP M2M 100MB', 'TBP M2M 2.5GB', 'SMS Avulso', 'PACOTE 50 SMS',
                    'PACOTE 100 SMS', 'PACOTE 200 SMS', 'PACOTE 800 SMS', 'PACOTE 5.000 SMS',
                    'TIM Monitor', 'TIM Segurança Digital Combo 1', 'TIM Segurança Digital Combo 2',
                    'TIM Segurança (Avulso)', 'RP 6GB 2024 (TIM BLACK 6GB)', 'RP 10GB 2024 (TIM BLACK 10GB)',
                    'RP 15GB 2024 (TIM BLACK 15GB)', 'RP 25GB 2024 (TIM BLACK 25GB)',
                    'RP 40GB 2024 (TIM BLACK 40GB)', 'RP 60GB 2024 (TIM BLACK 60GB)',
                    'RP 110GB 2024 (TIM BLACK 110GB)', 'RP 20GB 2024 (TIM BLACK 20GB)',
                    'RP 30GB 2024 (TIM BLACK 30GB)', 'RP 50GB 2024 (TIM BLACK 50GB)',
                    'RP 70GB 2024 (TIM BLACK 70GB)'
                ]
            }
        };

        // --- STATE ---
        let vendas = [];
        let editando = {}; // Map of id -> boolean
        let filtroContrato = '';

        // --- HELPERS ---
        const getRegioesPorPlano = (plano) => Object.keys(planosTIM[plano] || {});
        const getOfertasPorPlanoRegiao = (plano, regiao) => (planosTIM[plano] && planosTIM[plano][regiao]) ? planosTIM[plano][regiao] : [];

        const getStatusColor = (status) => {
            if (!status) return 'bg-gray-100 text-gray-800';
            if (status.includes('Entrada')) return 'bg-blue-100 text-blue-800';
            if (status.includes('Pendente')) return 'bg-yellow-100 text-yellow-800';
            if (status.includes('Validado') || status.includes('Ativos')) return 'bg-green-100 text-green-800';
            if (status.includes('Reprovado')) return 'bg-red-100 text-red-800';
            return 'bg-gray-100 text-gray-800';
        };

        const isVendaMatch = (v, busca, statusFiltro) => {
            const matchBusca = !busca || 
                (v.razaoSocial || '').toLowerCase().includes(busca) ||
                (v.cnpj || '').includes(busca) ||
                (v.numP2B || '').includes(busca) ||
                (v.numRadar || '').includes(busca) ||
                (v.contato || '').toLowerCase().includes(busca);
            const matchStatus = statusFiltro === 'Todos' || v.status === statusFiltro;
            return matchBusca && matchStatus;
        };

        const getCorContrato = (cnpj) => {
            const cores = [
                'bg-blue-50 border-l-4 border-blue-400', 'bg-green-50 border-l-4 border-green-400',
                'bg-purple-50 border-l-4 border-purple-400', 'bg-red-50 border-l-4 border-red-400',
                'bg-yellow-50 border-l-4 border-yellow-400'
            ];
            // Simple hash for consistent color
            let hash = 0;
            const str = cnpj || 'Sem identificação';
            for (let i = 0; i < str.length; i++) hash = str.charCodeAt(i) + ((hash << 5) - hash);
            return cores[Math.abs(hash) % cores.length];
        };

        const showMessage = (msg, type = 'success') => {
            const container = document.getElementById('mensagemContainer');
            const color = type === 'success' ? 'green' : 'red';
            container.innerHTML = `
                <div class="bg-${color}-50 border-l-4 border-${color}-400 p-4 mb-6 rounded-lg shadow">
                    <p class="text-${color}-800 font-semibold">${msg}</p>
                </div>
            `;
            setTimeout(() => container.innerHTML = '', 3000);
        };

        // --- BACKEND INTEGRATION ---
        async function fetchPedidosBackend() {
            try {
                // Endpoint updated to use the dedicated route for concluded sales
                const data = await api('/pedidos-venda/concluidos');
                renderBackendTable(data);
            } catch (error) {
                console.error(error);
                document.getElementById('tbodyBackend').innerHTML = 
                    '<tr><td colspan="7" class="text-center p-4 text-red-600">Erro ao carregar dados do backend.</td></tr>';
            }
        }

        function renderBackendTable(data) {
            const tbody = document.getElementById('tbodyBackend');
            if (!data || data.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" class="text-center p-4">Nenhum pedido concluído encontrado.</td></tr>';
                return;
            }
            tbody.innerHTML = data.map(item => `
                <tr>
                    <td>${item.id}</td>
                    <td>${item.cnpj}</td>
                    <td>${item.tipo}</td>
                    <td>${item.proposta}</td>
                    <td>${(item.valor || 0).toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' })}</td>
                    <td><span class="status-badge bg-green-100 text-green-800">${item.status}</span></td>
                    <td>${item.data}</td>
                </tr>
            `).join('');
        }

        // --- CORE LOGIC ---
        function init() {
            fetchPedidosBackend();
            const stored = localStorage.getItem('vendas_data');
            if (stored) vendas = JSON.parse(stored);
            
            // Populate Status Filter
            const select = document.getElementById('filtroStatus');
            statusPedido.forEach(s => {
                const opt = document.createElement('option');
                opt.value = s;
                opt.textContent = s;
                select.appendChild(opt);
            });

            renderTable();
            lucide.createIcons();
        }

        function salvarVendas() {
            localStorage.setItem('vendas_data', JSON.stringify(vendas));
            renderTable(); // Re-render to update grouping/colors
        }

        function adicionarVenda() {
            const novaVenda = {
                id: Date.now(),
                status: '1-Entrada',
                dataEntrada: new Date().toISOString().split('T')[0],
                dataInput: '', dataAtivacao: '', numP2B: '', numRadar: '',
                linha: '1', tipoVenda: 'Novo', razaoSocial: '', cnpj: '',
                telefone: '', contato: '', consultorSupervisor: '', sede: '',
                qtdAcessos: '', plano: 'TIM Black Empresa', regiaoValidade: '',
                oferta: '', pct: '', valorPlano: '', faturaTotal: '0,00',
                portabilidade: 'NÃO', operadora: '', acesso: '', dataAgendamento: '',
                fastChip: 'NÃO', iccid: '', aparelhos: 'COMODATO', observacao: ''
            };
            vendas.unshift(novaVenda);
            editando[novaVenda.id] = true;
            salvarVendas();
        }

        function duplicarVenda(id) {
            const original = vendas.find(v => v.id === id);
            if (!original) return;
            const nova = { ...original, id: Date.now(), dataEntrada: new Date().toISOString().split('T')[0], linha: String((parseInt(original.linha)||0) + 1) };
            vendas.unshift(nova);
            editando[nova.id] = true;
            salvarVendas();
            showMessage('Venda duplicada com sucesso!');
        }

        function removerVenda(id) {
            if (!confirm('Deseja realmente excluir esta venda?')) return;
            vendas = vendas.filter(v => v.id !== id);
            delete editando[id];
            salvarVendas();
            showMessage('Venda excluída com sucesso!');
        }

        function toggleEditar(id) {
            editando[id] = !editando[id];
            renderTable();
        }

        function salvarEdicao(id) {
            editando[id] = false;
            salvarVendas();
            showMessage('Venda salva com sucesso!');
        }

        function atualizarVenda(id, campo, valor) {
            const venda = vendas.find(v => v.id === id);
            if (!venda) return;

            venda[campo] = valor;

            // Logic dependencies
            if (campo === 'plano') {
                venda.regiaoValidade = '';
                venda.oferta = '';
            }
            if (campo === 'regiaoValidade') {
                venda.oferta = '';
            }
            if (campo === 'valorPlano' || campo === 'qtdAcessos') {
                const vPlano = parseFloat((String(venda.valorPlano || '0')).replace(/[^\d,.-]/g, '').replace(',', '.')) || 0;
                const qtd = parseInt(venda.qtdAcessos || '0') || 0;
                venda.faturaTotal = (vPlano * qtd).toFixed(2).replace('.', ',');
            }
            if (campo === 'portabilidade' && valor === 'NÃO') {
                venda.operadora = '';
            }
            // CNPJ/Phone masking could be done here or in input event. 
            // For simplicity, we assume value passed is raw or handled by input.

            salvarVendas(); // This re-renders, which might lose focus. 
            // Optimization: Update DOM directly or only re-render if necessary.
            // For now, full re-render is safer for consistency but bad for UX.
            // Improved: Don't re-render full table on every keystroke, only on blur or specific events.
            // However, React example updates state on change.
            // To keep focus, we need to locate the element and restore it, or just update the data array and NOT re-render immediately if it's a text input.
            // But 'salvarVendas' calls 'renderTable'. We should separate 'persist' from 'render'.
        }
        
        // Revised persistence to avoid focus loss
        function persistirDados() {
            localStorage.setItem('vendas_data', JSON.stringify(vendas));
            updateConsolidados(); // Update stats/consolidados without killing table inputs
        }

        function handleInputChange(id, campo, element) {
            let valor = element.value;
            
            // Masking logic
            if (campo === 'cnpj') {
                valor = valor.replace(/\D/g, '');
                if (valor.length > 14) valor = valor.substring(0, 14);
                // Apply mask for display?
                // For simplicity, store raw or apply simple formatting
                element.value = valor; 
            }

            // Update data model
            const venda = vendas.find(v => v.id === id);
            if (venda) {
                venda[campo] = valor;
                
                // Dependencies logic that affects OTHER fields
                if (campo === 'plano' || campo === 'regiaoValidade' || campo === 'valorPlano' || campo === 'qtdAcessos' || campo === 'portabilidade') {
                     atualizarVenda(id, campo, valor); // Use the main function for complex logic
                     return; // It will re-render
                }
                
                persistirDados();
            }
        }

        function exportarDados() {
            let csv = 'Status,Data Entrada,Data Input,Data Ativação,Nº P2B,Nº Radar,Tipo Venda,Razão Social,CNPJ,Telefone,Contato,Consultor/Supervisor,Sede,Qtd Acessos,Plano,Região de Validade,Oferta,Pct,Valor Plano,Fatura Total,Port-in,Op. Doadora,Acesso,Data Port-in,Fast Chip,ICCID,Aparelhos,Observação\n';
            vendas.forEach(v => {
                const row = [
                    v.status, v.dataEntrada, v.dataInput, v.dataAtivacao, 
                    v.numP2B || v.numPedido, v.numRadar || v.numPropostaVenda, v.tipoVenda,
                    v.razaoSocial, v.cnpj, v.telefone, v.contato, v.consultorSupervisor,
                    v.sede, v.qtdAcessos, v.plano, v.regiaoValidade, v.oferta,
                    v.pct, v.valorPlano, v.faturaTotal, v.portabilidade, v.operadora,
                    v.acesso, v.dataAgendamento, v.fastChip, v.iccid, v.aparelhos, v.observacao
                ].map(f => `"${(f || '').toString().replace(/"/g, '""')}"`).join(',');
                csv += row + '\n';
            });
            
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `vendas_tim_${new Date().toISOString().split('T')[0]}.csv`;
            link.click();
            showMessage('Dados exportados com sucesso!');
        }

        function updateConsolidados() {
            const grupos = {};
            const filtroBusca = document.getElementById('filtroBusca').value.toLowerCase();
            const filtroStatus = document.getElementById('filtroStatus').value;
            
            // Filter logic reused
            const filtered = vendas.filter(v => isVendaMatch(v, filtroBusca, filtroStatus));

            filtered.forEach(venda => {
                const chave = venda.cnpj || venda.razaoSocial || 'Sem identificação';
                if (!grupos[chave]) {
                    grupos[chave] = {
                        razaoSocial: venda.razaoSocial,
                        cnpj: venda.cnpj,
                        linhas: [],
                        totalAcessos: 0,
                        totalFatura: 0
                    };
                }
                grupos[chave].linhas.push(venda);
                grupos[chave].totalAcessos += parseInt(venda.qtdAcessos) || 0;
                const fatura = parseFloat((String(venda.faturaTotal || '0')).replace(',', '.')) || 0;
                grupos[chave].totalFatura += fatura;
            });

            const tbody = document.getElementById('tbodyConsolidados');
            tbody.innerHTML = '';
            
            let totalLinhas = 0, totalAcessos = 0, totalFatura = 0;

            Object.entries(grupos).forEach(([chave, dados]) => {
                totalLinhas += dados.linhas.length;
                totalAcessos += dados.totalAcessos;
                totalFatura += dados.totalFatura;

                const tr = document.createElement('tr');
                if (filtroContrato === chave) tr.className = 'bg-purple-100';
                
                tr.innerHTML = `
                    <td class="font-bold">${dados.razaoSocial || 'Sem nome'}</td>
                    <td class="text-sm font-mono text-gray-600">${dados.cnpj || 'Sem CNPJ'}</td>
                    <td class="text-center"><span class="bg-blue-100 text-blue-800 rounded-full px-2 py-1 text-xs font-bold">${dados.linhas.length}</span></td>
                    <td class="text-center"><span class="bg-green-100 text-green-800 rounded-full px-2 py-1 text-xs font-bold">${dados.totalAcessos}</span></td>
                    <td class="text-right font-bold text-purple-800">R$ ${dados.totalFatura.toFixed(2).replace('.', ',')}</td>
                    <td class="text-center">
                        <button onclick="filtrarPorContrato('${chave.replace(/'/g, "\\'")}')" class="btn btn-purple btn-sm" title="Ver Linhas">
                            <i data-lucide="eye" size="14"></i>
                        </button>
                    </td>
                `;
                tbody.appendChild(tr);
            });

            document.getElementById('totalContratosCount').textContent = `${Object.keys(grupos).length} contrato(s)`;
            
            const tfoot = document.getElementById('tfootConsolidados');
            tfoot.innerHTML = `
                <td colspan="2" class="text-right">TOTAIS GERAIS:</td>
                <td class="text-center">${totalLinhas}</td>
                <td class="text-center">${totalAcessos}</td>
                <td class="text-right">R$ ${totalFatura.toFixed(2).replace('.', ',')}</td>
                <td></td>
            `;
            
            lucide.createIcons();
        }

        function filtrarPorContrato(chave) {
            filtroContrato = chave;
            renderTable();
        }

        function limparFiltroContrato() {
            filtroContrato = '';
            renderTable();
        }

        function filtrarVendas() {
            renderTable();
        }

        function renderTable() {
            const tbody = document.getElementById('tbodyVendas');
            tbody.innerHTML = '';
            
            const busca = document.getElementById('filtroBusca').value.toLowerCase();
            const statusFiltro = document.getElementById('filtroStatus').value;
            
            let filtered = vendas.filter(v => {
                if (!isVendaMatch(v, busca, statusFiltro)) return false;
                return !filtroContrato || (v.cnpj || v.razaoSocial || 'Sem identificação') === filtroContrato;
            });

            document.getElementById('totalVendasCount').textContent = filtered.length;

            // Update Contrato Banner
            const banner = document.getElementById('filtroContratoBanner');
            if (filtroContrato) {
                banner.style.display = 'block';
                document.getElementById('nomeContratoFiltro').textContent = filtroContrato;
                document.getElementById('countContratoFiltro').textContent = `${filtered.length} linha(s) encontrada(s)`;
            } else {
                banner.style.display = 'none';
            }

            if (filtered.length === 0) {
                tbody.innerHTML = '<tr><td colspan="30" class="text-center p-6 text-gray-500">Nenhuma venda encontrada</td></tr>';
                return;
            }

            // Grouping to count lines per contract for display
            const counts = {};
            filtered.forEach(v => {
                const k = v.cnpj || v.razaoSocial || 'Sem identificação';
                counts[k] = (counts[k] || 0) + 1;
            });

            filtered.forEach(v => {
                const isEditing = editando[v.id];
                const tr = document.createElement('tr');
                const chaveContrato = v.cnpj || v.razaoSocial || 'Sem identificação';
                tr.className = `${getCorContrato(chaveContrato)} ${isEditing ? 'editing' : ''}`;
                
                // Helper to create input/select
                const createInput = (field, type='text', extraProps='') => `
                    <input type="${type}" value="${v[field] || ''}" 
                        onchange="handleInputChange(${v.id}, '${field}', this)"
                        ${!isEditing ? 'disabled' : ''} ${extraProps}>
                `;
                
                const createSelect = (field, options, extraProps='') => `
                    <select onchange="handleInputChange(${v.id}, '${field}', this)"
                        ${!isEditing ? 'disabled' : ''} ${extraProps}>
                        <option value="" ${!v[field] ? 'selected' : ''}>Selecione</option>
                        ${options.map(o => `<option value="${o}" ${v[field] === o ? 'selected' : ''}>${o}</option>`).join('')}
                    </select>
                `;

                // Columns matching React example
                tr.innerHTML = `
                    <td>
                        <div class="flex items-center gap-1">
                            <input type="text" value="${v.linha || '1'}" class="w-12 text-center" 
                                onchange="handleInputChange(${v.id}, 'linha', this)" ${!isEditing ? 'disabled' : ''}>
                            ${counts[chaveContrato] > 1 ? `<span class="text-xs text-gray-500">/${counts[chaveContrato]}</span>` : ''}
                        </div>
                    </td>
                    <td>
                        <select class="status-badge ${getStatusColor(v.status)}" 
                            onchange="handleInputChange(${v.id}, 'status', this)" ${!isEditing ? 'disabled' : ''}>
                            ${statusPedido.map(s => `<option value="${s}" ${v.status === s ? 'selected' : ''}>${s}</option>`).join('')}
                        </select>
                    </td>
                    <td>${createInput('dataEntrada', 'date')}</td>
                    <td>${createInput('dataInput', 'date')}</td>
                    <td>${createInput('dataAtivacao', 'date')}</td>
                    <td>${createInput('numP2B')}</td>
                    <td>${createInput('numRadar')}</td>
                    <td>${createSelect('tipoVenda', tipoVenda)}</td>
                    <td>${createInput('razaoSocial')}</td>
                    <td>${createInput('cnpj')}</td>
                    <td>${createInput('telefone')}</td>
                    <td>${createInput('contato')}</td>
                    <td>${createInput('consultorSupervisor')}</td>
                    <td>${createInput('sede')}</td>
                    <td>${createInput('qtdAcessos', 'number')}</td>
                    <td>${createSelect('plano', Object.keys(planosTIM))}</td>
                    <td>${createSelect('regiaoValidade', getRegioesPorPlano(v.plano))}</td>
                    <td>${createSelect('oferta', getOfertasPorPlanoRegiao(v.plano, v.regiaoValidade))}</td>
                    <td>${createInput('pct')}</td>
                    <td>${createInput('valorPlano')}</td>
                    <td><input type="text" value="${v.faturaTotal || '0,00'}" disabled class="bg-transparent font-bold"></td>
                    <td>${createSelect('portabilidade', ['SIM', 'NÃO'])}</td>
                    <td>${createInput('operadora')}</td>
                    <td>${createInput('acesso')}</td>
                    <td>${createInput('dataAgendamento', 'date')}</td>
                    <td>${createSelect('fastChip', ['SIM', 'NÃO'])}</td>
                    <td>${createInput('iccid')}</td>
                    <td>${createInput('aparelhos')}</td>
                    <td>${createInput('observacao')}</td>
                    <td>
                        <div class="flex gap-1 justify-center">
                            ${isEditing ? `
                                <button onclick="salvarEdicao(${v.id})" class="btn btn-green btn-sm" title="Salvar"><i data-lucide="check"></i></button>
                            ` : `
                                <button onclick="toggleEditar(${v.id})" class="btn btn-blue btn-sm" title="Editar"><i data-lucide="edit-2"></i></button>
                            `}
                            <button onclick="duplicarVenda(${v.id})" class="btn btn-purple btn-sm" title="Duplicar"><i data-lucide="copy"></i></button>
                            <button onclick="removerVenda(${v.id})" class="btn btn-red btn-sm" style="background:var(--red-600); color:white;" title="Excluir"><i data-lucide="trash-2"></i></button>
                        </div>
                    </td>
                `;
                tbody.appendChild(tr);
            });
            
            updateConsolidados();
            lucide.createIcons();
        }

        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
