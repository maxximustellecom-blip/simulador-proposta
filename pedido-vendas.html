<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pedidos de Vendas • Maxximus Telecom</title>
    <link rel="icon" href="data:,">
    <link rel="stylesheet" href="style.css">
    <script>
        (function() {
            var saved = localStorage.getItem('theme');
            var prefersLight = window.matchMedia && window.matchMedia('(prefers-color-scheme: light)').matches;
            if (saved === 'light' || (!saved && prefersLight)) {
                document.documentElement.setAttribute('data-theme', 'light');
            }
        })();
    </script>
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
    <style>
        :root {
            --blue-50: #eff6ff;
            --blue-100: #dbeafe;
            --blue-400: #60a5fa;
            --blue-600: #2563eb;
            --blue-800: #1e40af;
            --green-50: #f0fdf4;
            --green-100: #dcfce7;
            --green-400: #4ade80;
            --green-600: #16a34a;
            --green-800: #166534;
            --purple-50: #faf5ff;
            --purple-100: #f3e8ff;
            --purple-400: #c084fc;
            --purple-600: #9333ea;
            --purple-800: #6b21a8;
            --red-50: #fef2f2;
            --red-100: #fee2e2;
            --red-400: #f87171;
            --red-800: #991b1b;
            --yellow-50: #fefce8;
            --yellow-100: #fef9c3;
            --yellow-400: #facc15;
            --yellow-800: #854d0e;
        }

        .filters-container {
            display: flex;
            gap: 1rem;
            margin-bottom: 1rem;
            flex-wrap: wrap;
            align-items: end;
        }
        .filter-group {
            display: flex;
            flex-direction: column;
            gap: 0.3rem;
            flex: 1;
            min-width: 200px;
        }
        
        .action-buttons {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
        }

        .table-container {
            overflow-x: auto;
            border-radius: var(--radius);
            border: 1px solid var(--border);
            background: white;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }

        .table-container-principal {
            overflow-x: auto;
        }

        table {
            width: 100%;
            border-collapse: separate; 
            border-spacing: 0;
            font-size: 0.75rem;
            white-space: nowrap;
        }
        th, td {
            padding: 0.5rem 0.75rem;
            border-bottom: 1px solid var(--border);
            text-align: left;
            vertical-align: middle;
        }
        th {
            background: var(--blue-600);
            color: white;
            font-weight: 600;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        tr { transition: background-color 0.2s; }
        tr:hover { filter: brightness(0.98); }

        /* Input styling within table */
        table input, table select {
            width: 100%;
            padding: 0.25rem 0.5rem;
            border: 1px solid transparent;
            border-radius: 0.25rem;
            background: transparent;
            font-size: 0.75rem;
            color: inherit;
            transition: all 0.2s;
        }
        table input:disabled, table select:disabled {
            cursor: default;
        }
        /* Edit mode styles */
        tr.editing input, tr.editing select {
            background: white;
            border-color: #d1d5db;
        }
        tr.editing input:focus, tr.editing select:focus {
            outline: 2px solid var(--blue-400);
            border-color: transparent;
        }

        /* Status Badges */
        .status-badge {
            padding: 0.25rem 0.5rem;
            border-radius: 999px;
            font-weight: 600;
            display: inline-block;
        }

        /* Utility Classes matching React example */
        .bg-blue-50 { background-color: var(--blue-50); }
        .bg-green-50 { background-color: var(--green-50); }
        .bg-purple-50 { background-color: var(--purple-50); }
        .bg-red-50 { background-color: var(--red-50); }
        .bg-yellow-50 { background-color: var(--yellow-50); }
        
        .border-l-4 { border-left-width: 4px; border-left-style: solid; }
        .border-blue-400 { border-left-color: var(--blue-400); }
        .border-green-400 { border-left-color: var(--green-400); }
        .border-purple-400 { border-left-color: var(--purple-400); }
        .border-red-400 { border-left-color: var(--red-400); }
        .border-yellow-400 { border-left-color: var(--yellow-400); }

        .text-blue-800 { color: var(--blue-800); }
        .text-green-800 { color: var(--green-800); }
        .text-purple-800 { color: var(--purple-800); }
        .text-red-800 { color: var(--red-800); }
        .text-yellow-800 { color: var(--yellow-800); }

        .btn-sm { padding: 0.25rem 0.5rem; font-size: 0.75rem; }
        .btn-blue { background: var(--blue-600); color: white; }
        .btn-green { background: var(--green-600); color: white; }
        .btn-purple { background: var(--purple-600); color: white; }
        
        .btn-blue:hover { background: var(--blue-800); }
        .btn-green:hover { background: var(--green-800); }
        .btn-purple:hover { background: var(--purple-800); }

        /* Consolidados Table */
        .consolidados-container {
            margin-bottom: 1.5rem;
            border-radius: var(--radius);
            border: 1px solid var(--purple-400);
            overflow: hidden;
        }
        .consolidados-header {
            background: var(--purple-50);
            padding: 1rem;
            border-bottom: 1px solid var(--purple-400);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .consolidados-table th {
            background: var(--purple-600);
        }
    </style>
</head>
<body>
    <main class="container">
        <!-- Header Section -->
        <div class="card mb-6" style="background: linear-gradient(to right, var(--blue-600), var(--blue-800));">

            <div class="card-head">
                <div class="card-title">
                    <span>Pedidos de Vendas</span>
                    <span class="chip">Somente Admin</span>
                </div>

            </div>

            <!-- Filters -->
            <section class="section" style="margin-top: 20px;">
                <div class="filters-container">
                    <div class="filter-group" style="flex: 2;">
                        <label class="label"><i data-lucide="search" size="14"></i> Buscar</label>
                        <input type="text" id="filtroBusca" class="input" placeholder="Buscar por Razão Social ou CNPJ" oninput="filtrarBackend()">
                    </div>
                </div>
            </section>

            <!-- Backend Table (Moved Inside Card) -->
            <section class="section" style="margin-top: 20px;">
                <div class="table-container-principal">
                    <table id="tabelaPrincipal">
                        <thead>
                            <tr>
                                <th style="min-width: 200px;">Razão Social</th>
                                <th style="min-width: 100px;">Total Acessos</th>
                                <th style="min-width: 100px;">Fatura Total</th>
                                <th style="min-width: 120px;">Status Proposta</th>
                                <th style="min-width: 120px;">Status Pedido</th>
                                <th style="min-width: 120px;">Data</th>
                                <th style="min-width: 100px;">Ações</th>
                            </tr>
                        </thead>
                        <tbody id="tbodyBackend">
                            <tr><td colspan="8" class="text-center p-4">Carregando...</td></tr>
                        </tbody>
                    </table>
                </div>
            </section> 
        </div>

        <div id="cardConfiguracao" class="card mb-6" style="display: none;">
            <div class="card-head">
                <div class="card-title">
                    <span>Configuração do Cliente: <span id="nomeClienteConfiguracao">[cliente]</span></span>
                </div>
            </div>
            <div class="card-body">
                <div class="action-buttons mb-6">
                    <button class="btn btn-blue" onclick="adicionarVenda()">
                        <i data-lucide="plus" size="18"></i> Nova Venda
                    </button>
                    <button class="btn btn-green" onclick="exportarDados()">
                        <i data-lucide="download" size="18"></i> Exportar CSV
                    </button>
                </div>

                <div class="table-container">
                    <table id="tabelaVendas">
                        <thead>
                            <tr>
                                <th style="min-width: 180px;">Status do Pedido</th>
                                <th style="min-width: 120px;">Data Entrada</th>
                                <th style="min-width: 120px;">Data Input</th>
                                <th style="min-width: 120px;">Data Ativação</th>
                                <th style="min-width: 100px;">Nº P2B</th>
                                <th style="min-width: 100px;">Nº Radar</th>
                                <th style="min-width: 100px;">Tipo</th>
                                <th style="min-width: 200px;">Razão Social</th>
                                <th style="min-width: 140px;">CNPJ</th>
                                <th style="min-width: 130px;">Telefone</th>
                                <th style="min-width: 150px;">Contato</th>
                                <th style="min-width: 150px;">Consultor</th>
                                <th style="min-width: 100px;">Sede</th>
                                <th style="min-width: 80px;">Qtd</th>
                                <th style="min-width: 200px;">Plano</th>
                                <th style="min-width: 150px;">Região</th>
                                <th style="min-width: 200px;">Oferta</th>
                                <th style="min-width: 80px;">Pct</th>
                                <th style="min-width: 100px;">Valor</th>
                                <th style="min-width: 100px;">Total</th>
                                <th style="min-width: 80px;">Port-in</th>
                                <th style="min-width: 100px;">Op. Doadora</th>
                                <th style="min-width: 100px;">Acesso</th>
                                <th style="min-width: 120px;">Data Port-in</th>
                                <th style="min-width: 80px;">Fast Chip</th>
                                <th style="min-width: 150px;">ICCID</th>
                                <th style="min-width: 150px;">Aparelhos</th>
                                <th style="min-width: 200px;">Observação</th>
                                <th style="min-width: 100px;">Ações</th>
                            </tr>
                        </thead>
                        <tbody id="tbodyVendas"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </main>
    <script src="script.js"></script>
    <div id="toast" class="toast"></div>
    <script>
        const API_BASE = 'https://others-maxximus-backend.pvuzyy.easypanel.host';
        // const API_BASE = 'http://localhost:3001';
        let backendData = []; // Store fetched data for filtering

        async function api(path, options = {}) {
            const authRaw = localStorage.getItem('authUser');
            let headers = { 'Content-Type': 'application/json' };
            try {
                const u = JSON.parse(authRaw || '{}');
                if (u && u.id) headers['x-user-id'] = String(u.id);
                if (u && u.role) headers['x-user-role'] = String(u.role);
                if (u && u.name) headers['x-user-name'] = String(u.name);
            } catch {}
            const res = await fetch(API_BASE + path, { headers, ...options });
            if (!res.ok) {
                const err = await res.json().catch(() => ({}));
                throw new Error(err.error || ('HTTP ' + res.status));
            }
            return res.json();
        }

        // --- DATA & CONSTANTS ---
        const statusPedido = [
            '1-Entrada', '2-Pendente (P2B Status)', '0-Aguardando Assinatura',
            '1-Entrada (Análise Boc)', '2-Pendente Sistema P2B (Aguardando Status)',
            '3-Validado Documentação (TIM)', '4-Pendência Documentação (Aguardando)',
            '5-Emissão de documentos (LMS)', '7-Contratos Ativos',
            '8-Reprovado (Crédito ou Erro)', '9-Devolver para consultor (Correções)'
        ];

        const tipoVenda = ['Novo', 'Aditivo', 'Renovação'];

        const planosTIM = {
            'TIM Black Empresa': {
                'Todas as UFs, exceto PR e SC': [
                    'NV/ADP B 1GB + 5GB V0625 (Até 6GB)', 'NV/ADP B 2GB + 10GB V0625 (Até 12GB)',
                    'NV/ADP B 10GB + 20GB V0325 (Até 30GB)', 'NV/ADP B 20GB + 20GB V0925 (Até 40GB)',
                    'NV/ADP B 30GB + 20GB V0325 (Até 50GB)', 'NV/ADP B 30GB + 50GB V0325 (Até 80GB)',
                    'NV/ADP B 50GB + 50GB V0325 (Até 100GB)', 'NV/ADP B 100GB + 50GB V0325 (Até 150GB)'
                ],
                'PR e SC': [
                    'NV/ADP B 1GB + 5GB V0625 (Até 6GB)', 'NV/ADP B 2GB + 10GB V0625 (Até 12GB)',
                    'NV/ADP B 10GB + 20GB V0325 (Até 30GB)', 'NV/ADP B 20GB + 20GB V0925 (Até 40GB)',
                    'NV/ADP B 30GB + 20GB V0325 (Até 50GB)', 'NV/ADP B 30GB + 50GB V0325 (Até 80GB)',
                    'NV/ADP B 50GB + 50GB V0325 (Até 100GB)', 'NV/ADP B 100GB + 50GB V0325 (Até 150GB)'
                ]
            },
            'TIM Controle': {
                'DDDs 11,12,13,14,15,16,17,18,19,21,24,44,61,63,67,68,71,74,77,86,95': ['TIM Controle J Express 35GB', 'TIM Controle C Express 46GB'],
                'DDDs 22,27,28,31,32,33,34,35,37,38,41,42,43,45,46,47,48,49,51,53,54,55,62,64,65,66,69,73,75,79,81,82,83,84,85,87,88,89,91,92,93,94,96,97,98,99': ['TIM Controle C Express 46GB'],
                'DDDs 71,74,77,86': ['TIM Controle OFERTA FOCO 35GB', 'TIM Controle REDES SOCIAIS 54GB', 'TIM Controle PLUS 55GB', 'TIM Controle PREMIUM 61GB'],
                'DDDs 73,75,79,81,82,83,84,85,87,88,89': ['TIM Controle OFERTA FOCO 35GB', 'TIM Controle REDES SOCIAIS 54GB', 'TIM Controle PLUS 55GB', 'TIM Controle PREMIUM 61GB'],
                'DDDs 21,24,44,61,63,67,68,95': ['TIM Controle OFERTA FOCO 35GB', 'TIM Controle REDES SOCIAIS 54GB', 'TIM Controle PLUS 55GB', 'TIM Controle PREMIUM 61GB'],
                'DDDs 11,12,13,14,15,16,17,18,19': ['TIM Controle OFERTA FOCO 35GB', 'TIM Controle REDES SOCIAIS 54GB', 'TIM Controle PLUS 55GB', 'TIM Controle PREMIUM 61GB'],
                'DDDs 22,41,42,43,45,46,62,64,69,91,92,93,94,96,97,98,99': ['TIM Controle OFERTA FOCO 35GB', 'TIM Controle REDES SOCIAIS 54GB', 'TIM Controle PLUS 55GB', 'TIM Controle PREMIUM 61GB'],
                'DDDs 27,28,31,32,33,34,35,37,38,47,48,49,51,53,54,55,66': ['TIM Controle OFERTA FOCO 35GB', 'TIM Controle REDES SOCIAIS 54GB', 'TIM Controle PLUS 55GB', 'TIM Controle PREMIUM 61GB'],
                'TSP, TSE, TSU, TCN, TNE (Portabilidade)': ['Portabilidade 27GB (3GB Core + 20GB Promo + 4GB Especial) + Redes Sociais Inclusas'],
                'Nacional (Migração, Gross ou Troca)': ['Migração, Gross ou Troca 19GB (3GB Core + 10GB Promo + 6GB Especial) + Redes Sociais Inclusas']
            },
            'TIM Ultrafibra': {
                'SP / RS (exceto Caxias do Sul e Passo Fundo)': ['400 MEGA', '600 MEGA+', '1 GIGA', '2 GIGA+'],
                'AC, AM, BA, CE, DF, GO, MA, MT, MS MG, PA, PR, PE, RJ, RO (Porto Velho), RR, RS (Caxias/Passo Fundo), SC': ['400 MEGA', '600 MEGA+', '1 GIGA', '2 GIGA+'],
                'Exclusiva TO (Juiz de Fora... e São José (SC))': ['300 MEGA'],
                'Exclusiva AN (Ilhéus (BA)... e Chapecó (SC))': ['300 MEGA', '600 MEGA', 'OFERTA FOCO RN 500 MEGA']
            },
            'Serviços': {
                'Válido para Todas as UFs (Geral)': [
                    'NV/ADP 6 1GB + 20GB V0625 (Até 21GB)', 'NV/ADP 6 20GB + 20GB V0524 (Até 40GB)',
                    'NV/ADP 6 20GB + 50GB V0564 (Até 70GB)', 'AGL 3GB (Liberty Web Empresa 3GB)',
                    'AGL 10GB (Liberty Web Empresa 10GB)', 'AGL 40GB (Liberty Web Empresa 40GB)',
                    'AGL 100GB (Liberty Web Empresa 100GB)', 'WTTX 2MB_40GB', 'WTTX 5MB_80GB',
                    'WTTX 5MB_100GB', 'WTTX 5MB_500GB', 'TIM Liberty Web até 150GB + Roteador Intelbrás GX 3000 – 5G',
                    'TIM Black Empresas até 150GB + Roteador Intelbrás GX 3000 – 5G', 'TBP M2M 20MB',
                    'TBP M2M 50MB', 'TBP M2M 100MB', 'TBP M2M 2.5GB', 'SMS Avulso', 'PACOTE 50 SMS',
                    'PACOTE 100 SMS', 'PACOTE 200 SMS', 'PACOTE 800 SMS', 'PACOTE 5.000 SMS',
                    'TIM Monitor', 'TIM Segurança Digital Combo 1', 'TIM Segurança Digital Combo 2',
                    'TIM Segurança (Avulso)', 'RP 6GB 2024 (TIM BLACK 6GB)', 'RP 10GB 2024 (TIM BLACK 10GB)',
                    'RP 15GB 2024 (TIM BLACK 15GB)', 'RP 25GB 2024 (TIM BLACK 25GB)',
                    'RP 40GB 2024 (TIM BLACK 40GB)', 'RP 60GB 2024 (TIM BLACK 60GB)',
                    'RP 110GB 2024 (TIM BLACK 110GB)', 'RP 20GB 2024 (TIM BLACK 20GB)',
                    'RP 30GB 2024 (TIM BLACK 30GB)', 'RP 50GB 2024 (TIM BLACK 50GB)',
                    'RP 70GB 2024 (TIM BLACK 70GB)'
                ]
            }
        };

        // --- STATE ---
        let vendas = [];
        let editando = {}; // Map of id -> boolean
        let filtroContrato = '';

        // --- HELPERS ---
        const getRegioesPorPlano = (plano) => Object.keys(planosTIM[plano] || {});
        const getOfertasPorPlanoRegiao = (plano, regiao) => (planosTIM[plano] && planosTIM[plano][regiao]) ? planosTIM[plano][regiao] : [];

        const getStatusClass = (status) => {
            if (!status) return 'chip-status neutral';
            const s = status.toLowerCase();
            if (s.includes('entrada') || s.includes('andamento')) return 'chip-status in-progress';
            if (s.includes('pendente') || s.includes('pendência') || s.includes('pendencia') || s.includes('aguardando')) return 'chip-status pending';
            if (s.includes('validado') || s.includes('ativos') || s.includes('concluído') || s.includes('concluido') || s.includes('concluída')) return 'chip-status concluded';
            if (s.includes('reprovado') || s.includes('cancelado') || s.includes('cancelada') || s.includes('devolver')) return 'chip-status canceled';
            return 'chip-status neutral';
        };

        const isVendaMatch = (v, busca, statusFiltro) => {
            const matchBusca = !busca || 
                (v.razaoSocial || '').toLowerCase().includes(busca) ||
                (v.cnpj || '').includes(busca) ||
                (v.numP2B || '').includes(busca) ||
                (v.numRadar || '').includes(busca) ||
                (v.contato || '').toLowerCase().includes(busca);
            const matchStatus = statusFiltro === 'Todos' || v.status === statusFiltro;
            return matchBusca && matchStatus;
        };

        const getCorContrato = (cnpj) => {
            const cores = [
                'bg-blue-50 border-l-4 border-blue-400', 'bg-green-50 border-l-4 border-green-400',
                'bg-purple-50 border-l-4 border-purple-400', 'bg-red-50 border-l-4 border-red-400',
                'bg-yellow-50 border-l-4 border-yellow-400'
            ];
            // Simple hash for consistent color
            let hash = 0;
            const str = cnpj || 'Sem identificação';
            for (let i = 0; i < str.length; i++) hash = str.charCodeAt(i) + ((hash << 5) - hash);
            return cores[Math.abs(hash) % cores.length];
        };

        const toast = (msg, type = 'success') => {
            const t = document.getElementById('toast');
            if (!t) return;
            // Reset classes but keep 'toast'
            t.className = 'toast';
            t.style.display = 'block';
            
            // Icon and Color based on type
            const icon = type === 'success' ? 'check-circle' : 'alert-circle';
            const colorClass = type === 'success' ? 'text-green-600' : 'text-red-600';
            
            t.innerHTML = `
                <div class="flex items-center gap-2" style='align-items: center; display: flex;'>
                    <div style='font-size: 10pt; align-items: center; display: flex;'><i data-lucide="${icon}" class="${colorClass}"></i></div>&nbsp;
                    <div class="font-medium">${msg}</div>
                </div>
            `;
            
            if (window.lucide) window.lucide.createIcons();

            setTimeout(() => {
                t.style.display = 'none';
            }, 3000);
        };

        // --- BACKEND INTEGRATION ---
        async function fetchPedidosBackend() {
            try {
                // Endpoint updated to use the dedicated route for concluded sales
                const data = await api('/pedidos-venda/concluidos');
                backendData = data || []; // Store data
                renderBackendTable(backendData);
            } catch (error) {
                console.error(error);
                document.getElementById('tbodyBackend').innerHTML = 
                    '<tr><td colspan="8" class="text-center p-4 text-red-600">Erro ao carregar dados do backend.</td></tr>';
            }
        }

        function renderBackendTable(data) {
            const tbody = document.getElementById('tbodyBackend');
            if (!data || data.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8" class="text-center p-4">Nenhum pedido concluído encontrado.</td></tr>';
                return;
            }
            tbody.innerHTML = data.map(item => `
                <tr>
                    <td>${item.razaoSocial || item.cliente || '-'}</td>
                    <td>${item.totalAcessos || 0}</td>
                    <td>${(item.valor || 0).toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' })}</td>
                    <td><span class="${getStatusClass(item.status)}">${item.status || '-'}</span></td>
                    <td><span class="chip-status in-progress">Entrada</span></td>
                    <td>${item.data || '-'}</td>
                    <td>
                        <button class="btn btn-ghost btn-sm" title="Configurar" style="gap: 5px;" onclick="configurarPedido('${item.id}')">
                            <i data-lucide="settings"></i>Configurar
                        </button>
                    </td>
                </tr>
            `).join('');
            if (window.lucide) window.lucide.createIcons();
        }

        function filtrarBackend() {
            const busca = document.getElementById('filtroBusca').value.toLowerCase();
            const filtered = backendData.filter(item => {
                const searchStr = (
                    (item.razaoSocial || '') + 
                    (item.cliente || '') + 
                    (item.cnpj || '') + 
                    (item.status || '') +
                    (item.tipo || '')
                ).toLowerCase();
                return searchStr.includes(busca);
            });
            renderBackendTable(filtered);
        }

        async function configurarPedido(id) {
            const item = backendData.find(i => String(i.id) === String(id));
            if (!item) {
                toast('Pedido não encontrado', 'error');
                return;
            }

            try {
                const detalhes = await api(`/pedidos-venda/${id}/detalhes`);
                
                if (detalhes.linhas && detalhes.linhas.length > 0) {
                    vendas = detalhes.linhas.map((linha, index) => {
                        const qtd = parseFloat(linha.quantidade || 1);
                        // Determine valorPlano
                        let valorPlano = 0;
                        if (linha.valorPlano) valorPlano = parseFloat(linha.valorPlano);
                        else if (linha.valorNaoFidelizado) valorPlano = parseFloat(linha.valorNaoFidelizado);

                        // If customization and has discount
                        if (linha.desconto) {
                             const v = parseFloat(linha.valorNaoFidelizado || 0);
                             const d = parseFloat(linha.desconto) || 0;
                             valorPlano = v * (1 - d/100);
                        }
                        
                        const fatura = (valorPlano * qtd).toFixed(2).replace('.', ',');
                        const valorPlanoStr = valorPlano.toFixed(2).replace('.', ',');

                        return {
                            id: Date.now() + index,
                            status: '1-Entrada',
                            dataEntrada: new Date().toISOString().split('T')[0],
                            dataInput: '', dataAtivacao: '', numP2B: '', numRadar: '',
                            linha: String(index + 1), 
                            tipoVenda: detalhes.tipo || 'Novo', 
                            razaoSocial: detalhes.razaoSocial || '', 
                            cnpj: detalhes.cnpj || '',
                            telefone: '', contato: '', consultorSupervisor: '', sede: '',
                            qtdAcessos: String(qtd), 
                            plano: linha.plano || linha.servico || '', 
                            regiaoValidade: '',
                            oferta: '', 
                            pct: linha.desconto ? String(linha.desconto) : '', 
                            valorPlano: valorPlanoStr, 
                            faturaTotal: fatura,
                            portabilidade: 'NÃO', operadora: '', acesso: '', dataAgendamento: '',
                            fastChip: 'NÃO', iccid: '', aparelhos: linha.temAparelho === 'Sim' ? (linha.aparelho || 'Sim') : '', 
                            observacao: ''
                        };
                    });
                    
                    toast('Dados carregados com sucesso!');
                } else {
                    vendas = [];
                    toast('Nenhum detalhe encontrado (linhas vazias).', 'error');
                }

                salvarVendas(); // Update UI

                const card = document.getElementById('cardConfiguracao');
                const titulo = document.getElementById('nomeClienteConfiguracao');
                
                if (titulo) {
                    titulo.textContent = detalhes.razaoSocial || 'Cliente';
                }
                
                if (card) {
                    card.style.display = 'block';
                    setTimeout(() => card.scrollIntoView({ behavior: 'smooth', block: 'start' }), 100);
                }

            } catch (e) {
                console.error(e);
                toast('Erro ao carregar detalhes: ' + e.message, 'error');
            }
        }

        // --- CORE LOGIC ---
        function init() {
            fetchPedidosBackend();
            const stored = localStorage.getItem('vendas_data');
            if (stored) vendas = JSON.parse(stored);
            
            renderTable();
            lucide.createIcons();
        }

        function salvarVendas() {
            localStorage.setItem('vendas_data', JSON.stringify(vendas));
            renderTable(); // Re-render to update grouping/colors
        }

        function adicionarVenda() {
            const novaVenda = {
                id: Date.now(),
                status: '1-Entrada',
                dataEntrada: new Date().toISOString().split('T')[0],
                dataInput: '', dataAtivacao: '', numP2B: '', numRadar: '',
                linha: '1', tipoVenda: 'Novo', razaoSocial: '', cnpj: '',
                telefone: '', contato: '', consultorSupervisor: '', sede: '',
                qtdAcessos: '', plano: 'TIM Black Empresa', regiaoValidade: '',
                oferta: '', pct: '', valorPlano: '', faturaTotal: '0,00',
                portabilidade: 'NÃO', operadora: '', acesso: '', dataAgendamento: '',
                fastChip: 'NÃO', iccid: '', aparelhos: 'COMODATO', observacao: ''
            };
            vendas.unshift(novaVenda);
            editando[novaVenda.id] = true;
            salvarVendas();
        }

        function duplicarVenda(id) {
            const original = vendas.find(v => v.id === id);
            if (!original) return;
            const nova = { ...original, id: Date.now(), dataEntrada: new Date().toISOString().split('T')[0], linha: String((parseInt(original.linha)||0) + 1) };
            vendas.unshift(nova);
            editando[nova.id] = true;
            salvarVendas();
            toast('Venda duplicada com sucesso!');
        }

        function removerVenda(id) {
            if (!confirm('Deseja realmente excluir esta venda?')) return;
            vendas = vendas.filter(v => v.id !== id);
            delete editando[id];
            salvarVendas();
            showMessage('Venda excluída com sucesso!');
        }

        function toggleEditar(id) {
            editando[id] = !editando[id];
            renderTable();
        }

        function salvarEdicao(id) {
            editando[id] = false;
            salvarVendas();
            showMessage('Venda salva com sucesso!');
        }

        function atualizarVenda(id, campo, valor) {
            const venda = vendas.find(v => v.id === id);
            if (!venda) return;

            venda[campo] = valor;

            // Logic dependencies
            if (campo === 'plano') {
                venda.regiaoValidade = '';
                venda.oferta = '';
            }
            if (campo === 'regiaoValidade') {
                venda.oferta = '';
            }
            if (campo === 'valorPlano' || campo === 'qtdAcessos') {
                const vPlano = parseFloat((String(venda.valorPlano || '0')).replace(/[^\d,.-]/g, '').replace(',', '.')) || 0;
                const qtd = parseInt(venda.qtdAcessos || '0') || 0;
                venda.faturaTotal = (vPlano * qtd).toFixed(2).replace('.', ',');
            }
            if (campo === 'portabilidade' && valor === 'NÃO') {
                venda.operadora = '';
            }
            // CNPJ/Phone masking could be done here or in input event. 
            // For simplicity, we assume value passed is raw or handled by input.

            salvarVendas(); // This re-renders, which might lose focus. 
            // Optimization: Update DOM directly or only re-render if necessary.
            // For now, full re-render is safer for consistency but bad for UX.
            // Improved: Don't re-render full table on every keystroke, only on blur or specific events.
            // However, React example updates state on change.
            // To keep focus, we need to locate the element and restore it, or just update the data array and NOT re-render immediately if it's a text input.
            // But 'salvarVendas' calls 'renderTable'. We should separate 'persist' from 'render'.
        }
        
        // Revised persistence to avoid focus loss
        function persistirDados() {
            localStorage.setItem('vendas_data', JSON.stringify(vendas));
            updateConsolidados(); // Update stats/consolidados without killing table inputs
        }

        function handleInputChange(id, campo, element) {
            let valor = element.value;
            
            // Masking logic
            if (campo === 'cnpj') {
                valor = valor.replace(/\D/g, '');
                if (valor.length > 14) valor = valor.substring(0, 14);
                // Apply mask for display?
                // For simplicity, store raw or apply simple formatting
                element.value = valor; 
            }

            // Update data model
            const venda = vendas.find(v => v.id === id);
            if (venda) {
                venda[campo] = valor;
                
                // Dependencies logic that affects OTHER fields
                if (campo === 'plano' || campo === 'regiaoValidade' || campo === 'valorPlano' || campo === 'qtdAcessos' || campo === 'portabilidade') {
                     atualizarVenda(id, campo, valor); // Use the main function for complex logic
                     return; // It will re-render
                }
                
                persistirDados();
            }
        }

        function exportarDados() {
            let csv = 'Status,Data Entrada,Data Input,Data Ativação,Nº P2B,Nº Radar,Tipo Venda,Razão Social,CNPJ,Telefone,Contato,Consultor/Supervisor,Sede,Qtd Acessos,Plano,Região de Validade,Oferta,Pct,Valor Plano,Fatura Total,Port-in,Op. Doadora,Acesso,Data Port-in,Fast Chip,ICCID,Aparelhos,Observação\n';
            vendas.forEach(v => {
                const row = [
                    v.status, v.dataEntrada, v.dataInput, v.dataAtivacao, 
                    v.numP2B || v.numPedido, v.numRadar || v.numPropostaVenda, v.tipoVenda,
                    v.razaoSocial, v.cnpj, v.telefone, v.contato, v.consultorSupervisor,
                    v.sede, v.qtdAcessos, v.plano, v.regiaoValidade, v.oferta,
                    v.pct, v.valorPlano, v.faturaTotal, v.portabilidade, v.operadora,
                    v.acesso, v.dataAgendamento, v.fastChip, v.iccid, v.aparelhos, v.observacao
                ].map(f => `"${(f || '').toString().replace(/"/g, '""')}"`).join(',');
                csv += row + '\n';
            });
            
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `vendas_tim_${new Date().toISOString().split('T')[0]}.csv`;
            link.click();
            toast('Dados exportados com sucesso!');
}

        function updateConsolidados() {
            // Functionality removed as per user request (consolidadosContainer removed)
            // Keeping empty function if called elsewhere to prevent errors, 
            // or we can remove calls to it.
        }

        function filtrarPorContrato(chave) {
            filtroContrato = chave;
            renderTable();
        }

        function limparFiltroContrato() {
            filtroContrato = '';
            renderTable();
        }

        function filtrarVendas() {
            // Deprecated for main table filtering, but kept if needed for other logic
            renderTable();
        }

        function renderTable() {
            const tbody = document.getElementById('tbodyVendas');
            tbody.innerHTML = '';
            
            // Removed filtering logic as requested
            let filtered = vendas.filter(v => {
                return !filtroContrato || (v.cnpj || v.razaoSocial || 'Sem identificação') === filtroContrato;
            });


            // Banner removed

            if (filtered.length === 0) {
                tbody.innerHTML = '<tr><td colspan="30" class="text-center p-6 text-gray-500">Nenhuma venda encontrada</td></tr>';
                return;
            }

            // Grouping to count lines per contract for display
            const counts = {};
            filtered.forEach(v => {
                const k = v.cnpj || v.razaoSocial || 'Sem identificação';
                counts[k] = (counts[k] || 0) + 1;
            });

            filtered.forEach(v => {
                const isEditing = editando[v.id];
                const tr = document.createElement('tr');
                const chaveContrato = v.cnpj || v.razaoSocial || 'Sem identificação';
                tr.className = `${getCorContrato(chaveContrato)} ${isEditing ? 'editing' : ''}`;
                
                // Helper to create input/select
                const createInput = (field, type='text', extraProps='') => `
                    <input type="${type}" value="${v[field] || ''}" 
                        onchange="handleInputChange(${v.id}, '${field}', this)"
                        ${!isEditing ? 'disabled' : ''} ${extraProps}>
                `;
                
                const createSelect = (field, options, extraProps='') => `
                    <select onchange="handleInputChange(${v.id}, '${field}', this)"
                        ${!isEditing ? 'disabled' : ''} ${extraProps}>
                        <option value="" ${!v[field] ? 'selected' : ''}>Selecione</option>
                        ${options.map(o => `<option value="${o}" ${v[field] === o ? 'selected' : ''}>${o}</option>`).join('')}
                    </select>
                `;

                // Columns matching React example
                tr.innerHTML = `
                    <td>
                        ${!isEditing 
                            ? `<span class="${getStatusClass(v.status)}">${v.status}</span>`
                            : `<select style="width:100%; padding: 4px;" 
                                onchange="handleInputChange(${v.id}, 'status', this)">
                                ${statusPedido.map(s => `<option value="${s}" ${v.status === s ? 'selected' : ''}>${s}</option>`).join('')}
                               </select>`
                        }
                    </td>
                    <td>${createInput('dataEntrada', 'date')}</td>
                    <td>${createInput('dataInput', 'date')}</td>
                    <td>${createInput('dataAtivacao', 'date')}</td>
                    <td>${createInput('numP2B')}</td>
                    <td>${createInput('numRadar')}</td>
                    <td>${createSelect('tipoVenda', tipoVenda)}</td>
                    <td>${createInput('razaoSocial')}</td>
                    <td>${createInput('cnpj')}</td>
                    <td>${createInput('telefone')}</td>
                    <td>${createInput('contato')}</td>
                    <td>${createInput('consultorSupervisor')}</td>
                    <td>${createInput('sede')}</td>
                    <td>${createInput('qtdAcessos', 'number')}</td>
                    <td>${createSelect('plano', Object.keys(planosTIM))}</td>
                    <td>${createSelect('regiaoValidade', getRegioesPorPlano(v.plano))}</td>
                    <td>${createSelect('oferta', getOfertasPorPlanoRegiao(v.plano, v.regiaoValidade))}</td>
                    <td>${createInput('pct')}</td>
                    <td>${createInput('valorPlano')}</td>
                    <td><input type="text" value="${v.faturaTotal || '0,00'}" disabled class="bg-transparent font-bold"></td>
                    <td>${createSelect('portabilidade', ['SIM', 'NÃO'])}</td>
                    <td>${createInput('operadora')}</td>
                    <td>${createInput('acesso')}</td>
                    <td>${createInput('dataAgendamento', 'date')}</td>
                    <td>${createSelect('fastChip', ['SIM', 'NÃO'])}</td>
                    <td>${createInput('iccid')}</td>
                    <td>${createInput('aparelhos')}</td>
                    <td>${createInput('observacao')}</td>
                    <td>
                        <div class="flex gap-1 justify-center">
                            ${isEditing ? `
                                <button onclick="salvarEdicao(${v.id})" class="btn btn-green btn-sm" title="Salvar"><i data-lucide="check"></i></button>
                            ` : `
                                <button onclick="toggleEditar(${v.id})" class="btn btn-blue btn-sm" title="Editar"><i data-lucide="edit-2"></i></button>
                            `}
                            <button onclick="duplicarVenda(${v.id})" class="btn btn-purple btn-sm" title="Duplicar"><i data-lucide="copy"></i></button>
                            <button onclick="removerVenda(${v.id})" class="btn btn-red btn-sm" style="background:var(--red-600); color:white;" title="Excluir"><i data-lucide="trash-2"></i></button>
                        </div>
                    </td>
                `;
                tbody.appendChild(tr);
            });
            
            updateConsolidados();
            lucide.createIcons();
        }

        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
