<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Configura√ß√£o Padr√£o ‚Ä¢ Maxximus Telecom</title>
    <link rel="icon" href="data:,">
    <link rel="stylesheet" href="style.css">
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jspdf-autotable@3.8.2/dist/jspdf.plugin.autotable.min.js"></script>
</head>
<body>
    <main class="container">
        <div class="card">
            <div class="card-head">
                <div class="card-title">
                    <span>Configura√ß√£o Padr√£o</span>
                    <span class="chip">Negocia√ß√£o</span>
                </div>
                <div class="muted">
                    <button id="addLinhaBtn" class="btn btn-primary" type="button"><i data-lucide="plus"></i><span>Adicionar linha</span></button>
                </div>
            </div>
            <div class="card-body">
                <section class="section" style="margin-top: 20px;">
                    <div class="label">Dados b√°sicos do cliente</div>
                    <div style="padding:0.4rem 0.0rem; display:flex; align-items:center; gap:0.75rem; flex-wrap:wrap;">
                        <span class="muted">Cliente:</span>
                        <span id="clienteNome" style="font-weight:600;">-</span>
                        <span class="muted">CNPJ:</span>
                        <span id="clienteCnpj">-</span>
                        <span class="muted">Tipo:</span>
                        <span id="negTipo">-</span>
                        <span class="muted">Status:</span>
                        <span id="negStatusLabel">-</span>
                    </div>
                </section>
                <section class="section" style="margin-top: 20px;">
                    <div style="display:flex; align-items:center; justify-content:space-between; margin-top: 20px;">
                        <div class="label">Itens da proposta</div>
                        <div class="muted" id="countItensLabel">0 itens</div>
                    </div>
                    <div class="table-container" style="margin-top:0.5rem;">
                        <table>
                            <thead>
                                <tr>
                                    <th>Linha</th>
                                    <th>Qtd</th>
                                    <th>DDD</th>
                                    <th>Tipo</th>
                                    <th>Plano Atual</th>
                                    <th>Pre√ßo Atual</th>
                                    <th>Portabilidade</th>
                                    <th>Operadora Doadora</th>
                                    <th>N√∫mero a Portar</th>
                                    <th>Categoria</th>
                                    <th>Plano</th>
                                    <th>Pct</th>
                                    <th>Valor Plano</th>
                                    <th>Total Linha</th>
                                    <th>Valor N√£o Fid.</th>
                                    <th>% Desc.</th>
                                    <th>Valor c/Desc.</th>
                                    <th>Aparelho</th>
                                    <th>Tipo Aparelho</th>
                                    <th>Modelo</th>
                                    <th>R$ Total Aparelho</th>
                                    <th>R$ da Parcela</th>
                                    <th class="col-actions" style="min-width:140px;">A√ß√µes</th>
                                </tr>
                            </thead>
                            <tbody id="itensTbody">
                                <tr><td colspan="16">
                                    <div class="skeleton skel-row"></div>
                                    <div class="skeleton skel-row"></div>
                                    <div class="skeleton skel-row"></div>
                                </td></tr>
                            </tbody>
                        </table>
                    </div>
                </section>
                <section class="section" style="margin-top:1rem;">
                    <div style="display:flex; align-items:center; gap:0.75rem;">
                        <div class="label">Status da negocia√ß√£o</div>
                        <select id="fStatus" class="select" style="width:220px;">
                            <option value="Em andamento">Em andamento</option>
                            <option value="Conclu√≠da">Conclu√≠da</option>
                            <option value="Cancelada">Cancelada</option>
                        </select>
                    </div>
                </section>
                <section class="section" style="margin-top:1rem;">
                    <div class="label">Resumo</div>
                    <div class="grid-2" style="margin-top:0.5rem;">
                        <div class="card" style="padding:0.75rem;">
                            <div class="muted">Valor total mensal</div>
                            <div id="resumoTotal" style="font-size:1.6rem; font-weight:700; color: var(--primary);">R$¬†0,00</div>
                            <div id="resumoAcessos" class="muted" style="margin-top:0.3rem;">0 acessos</div>
                        </div>
                        <div class="card" style="padding:0.75rem;">
                            <div class="muted">Itens inclu√≠dos</div>
                            <div id="resumoItens" class="muted" style="margin-top:0.3rem;">-</div>
                        </div>
                    </div>
                </section>
                <section style="margin-top:1rem;">
                    <div style="display:flex; gap:0.5rem; flex-wrap:wrap; justify-content:flex-end;">
                        <button id="copiarBtn" class="btn btn-ghost" type="button" title="Copiar proposta"><i data-lucide="copy"></i><span>Copiar Proposta</span></button>
                        <button id="relatorioBtn" class="btn btn-ghost" type="button" title="Gerar Relat√≥rio"><i data-lucide="file-text"></i><span>Gerar Relat√≥rio</span></button>
                        <button id="salvarBtn" class="btn btn-primary" type="button" title="Salvar"><i data-lucide="save"></i><span>Salvar</span></button>
                    </div>
                </section>
            </div>
        </div>
    </main>
    <div id="toast" class="toast"></div>
    <script src="script.js"></script>
    <script>
        const API_BASE = 'https://others-maxximus-backend.pvuzyy.easypanel.host';
        async function api(path, options = {}) {
            const authRaw = localStorage.getItem('authUser');
            let headers = { 'Content-Type': 'application/json' };
            try {
                const u = JSON.parse(authRaw || '{}');
                if (u && u.id) headers['x-user-id'] = String(u.id);
                if (u && u.role) headers['x-user-role'] = String(u.role);
                if (u && u.name) headers['x-user-name'] = String(u.name);
            } catch {}
            const res = await fetch(API_BASE + path, { headers, ...options });
            if (!res.ok) {
                const err = await res.json().catch(() => ({}));
                throw new Error(err.error || ('HTTP ' + res.status));
            }
            return res.json();
        }
        function toast(msg, type) {
            const el = document.getElementById('toast');
            if (!el) return;
            el.textContent = msg;
            if (type === 'success') {
                el.style.background = 'linear-gradient(135deg, #10B981 0%, #059669 100%)';
                el.style.color = '#FFFFFF';
                el.style.borderColor = 'transparent';
            } else if (type === 'error') {
                el.style.background = 'linear-gradient(135deg, #EF4444 0%, #DC2626 100%)';
                el.style.color = '#FFFFFF';
                el.style.borderColor = 'transparent';
            } else {
                el.style.background = 'linear-gradient(135deg, #3B82F6 0%, #2563EB 100%)';
                el.style.color = '#FFFFFF';
                el.style.borderColor = 'transparent';
            }
            el.style.display = 'block';
            clearTimeout(window.__toastTimer);
            window.__toastTimer = setTimeout(() => { el.style.display = 'none'; }, 2500);
        }
        document.addEventListener('DOMContentLoaded', async () => {
            const auth = localStorage.getItem('authUser');
            if (!auth) { window.location.href = 'login.html'; return; }
            try {
                const params = new URLSearchParams(window.location.search || '');
                const idParam = Number(params.get('id') || 0);
                if (!idParam) { window.location.href = 'negociar.html'; return; }
                const list = await api('/negotiations', { method: 'GET' }).catch(() => []);
                const arr = Array.isArray(list) ? list : [];
                const exists = arr.find(n => Number(n.id) === Number(idParam));
                if (!exists) { window.location.href = 'negociar.html'; return; }
                __negociacaoId = idParam;
                __negociacaoStatus = exists && exists.status ? String(exists.status) : 'Em andamento';
                __negociacaoInfo = exists || null;
                await initConfiguracao();
            } catch {
                window.location.href = 'negociar.html';
            }
        });
        async function carregarPropostaSalva() {
            try {
                if (!__negociacaoId) return;
                const data = await api(`/negotiations/${__negociacaoId}/proposal`, { method: 'GET' }).catch(() => null);
                if (data && Array.isArray(data.linhas)) {
                    const linhas = data.linhas.map((l, idx) => {
                        const cat = l.categoria || (__categorias[0]?.nome || '');
                        const planoNome = l.plano || '';
                        const planos = __map[cat] || [];
                        const sel = planos.find(p => p.nome === planoNome);
                        const baseTxt = sel ? (sel.descricao || sel.nome || '') : '';
                        let pctNorm = parsePctFromText(baseTxt);
                        if (!pctNorm) pctNorm = l.pct || '';
                        const valorAp = Number(l.valorAparelho || 0);
                        const parcela = (l.tipoAparelho === 'VF 24x' && valorAp > 0) ? (valorAp / 24) : 0;
                        return {
                            id: Number(l.id || idx + 1),
                            portabilidade: l.portabilidade || 'N√£o',
                            operadoraDoadora: l.operadoraDoadora || '',
                            ddd: l.ddd || '',
                            tipoNegociacao: l.tipoNegociacao || 'Novo',
                            numeroPortar: l.numeroPortar || '',
                            quantidade: Number(l.quantidade || 1),
                            categoria: cat,
                            plano: planoNome,
                            pct: pctNorm,
                            valorPlano: Number(l.valorPlano || (sel ? Number(sel.preco || 0) : 0)),
                            valorNaoFidelizado: Number(l.valorNaoFidelizado || 0),
                            desconto: Number(l.desconto || 0),
                            temAparelho: l.temAparelho || 'N√£o',
                            modeloAparelho: l.modeloAparelho || '',
                            tipoAparelho: l.tipoAparelho || '',
                            valorAparelho: valorAp,
                            valorParcela: parcela
                        };
                    });
                    __linhas = linhas.length ? linhas : __linhas;
                }
            } catch {}
        }
        function currency(v) {
            try { return (new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' })).format(Number(v || 0)); } catch { return 'R$¬†0,00'; }
        }
        function formatCnpj(s) {
            const d = String(s || '').replace(/\D/g, '');
            if (d.length !== 14) return d;
            return d.replace(/^(\d{2})(\d{3})(\d{3})(\d{4})(\d{2})$/, '$1.$2.$3/$4-$5');
        }
        function formatPhone(s) {
            const d = String(s || '').replace(/\D/g, '');
            if (d.length === 11) return d.replace(/^(\d{2})(\d{5})(\d{4})$/, '($1) $2-$3');
            if (d.length === 10) return d.replace(/^(\d{2})(\d{4})(\d{4})$/, '($1) $2-$3');
            return s || '';
        }
        async function carregarClienteBasico() {
            try {
                const cnpj = __negociacaoInfo ? (__negociacaoInfo.cnpj || '') : '';
                if (!cnpj) { __clienteInfo = null; return; }
                const list = await api('/clients?cnpj=' + encodeURIComponent(String(cnpj).replace(/\D/g, '')), { method: 'GET' }).catch(() => []);
                __clienteInfo = Array.isArray(list) && list.length ? list[0] : null;
            } catch { __clienteInfo = null; }
        }
        function renderClienteBasico() {
            const nomeEl = document.getElementById('clienteNome');
            const cnpjEl = document.getElementById('clienteCnpj');
            const emailEl = document.getElementById('clienteEmail');
            const phoneEl = document.getElementById('clientePhone');
            const tipoEl = document.getElementById('negTipo');
            const propEl = document.getElementById('negProposta');
            const dataEl = document.getElementById('negData');
            const statusEl = document.getElementById('negStatusLabel');
            const n = __negociacaoInfo || {};
            const c = __clienteInfo || {};
            if (nomeEl) nomeEl.textContent = c.name || '-';
            if (cnpjEl) cnpjEl.textContent = formatCnpj(n.cnpj || c.cnpj || '');
            if (emailEl) emailEl.textContent = c.email || '-';
            if (phoneEl) phoneEl.textContent = formatPhone(c.phone || '');
            if (tipoEl) tipoEl.textContent = n.tipo || '-';
            if (propEl) propEl.textContent = n.proposta || '-';
            if (dataEl) dataEl.textContent = n.data || '-';
            if (statusEl) statusEl.textContent = __negociacaoStatus || (n.status || '-');
        }
        function parsePctFromText(s) {
            const txt = String(s || '');
            const paren = txt.match(/\(([^)]+)\)/);
            const target = paren ? paren[1] : txt;
            let dataSum = 0;
            let dataUnit = '';
            let smsSum = 0;
            const dataRegex = /(\d+(?:[\.,]\d+)?)\s*(GB|MB|MEGA)\b/gi;
            const smsRegex = /(\d+)\s*SMS\b/gi;
            let dm;
            while ((dm = dataRegex.exec(target)) !== null) {
                const num = Number(String(dm[1] || '0').replace(',', '.'));
                let u = (dm[2] || '').toUpperCase();
                if (u === 'MEGA') u = 'MB';
                if (!dataUnit && u) dataUnit = u;
                const val = dataUnit === 'GB'
                    ? (u === 'MB' ? (num / 1024) : num)
                    : (u === 'GB' ? (num * 1024) : num);
                dataSum += val;
            }
            let sm;
            while ((sm = smsRegex.exec(target)) !== null) {
                smsSum += Number(sm[1] || 0);
            }
            const parts = [];
            if (dataSum > 0 && dataUnit) {
                const rounded = Math.round(dataSum * 100) / 100;
                const out = (rounded % 1 === 0) ? String(Math.round(rounded)) : String(rounded).replace('.', ',');
                parts.push(out + dataUnit);
            }
            if (smsSum > 0) parts.push(String(smsSum) + 'SMS');
            return parts.join(' + ');
        }
        let __categorias = [];
        const pctsDadosDisponiveis = ['100MB','1GB','2GB','3GB','4GB','5GB','6GB','8GB','10GB','12GB','20GB','22GB','30GB','32GB','50GB','52GB','100GB','150GB','Voz (sem dados)'];
        let __produtos = [];
        let __map = {}; // categoria.nome -> produtos
        let __linhas = [];
        let __negociacaoId = null;
        let __negociacaoStatus = 'Em andamento';
        let __negociacaoInfo = null;
        let __clienteInfo = null;
        let __loadingTimer = null;
        let __isLocked = false;
        function normalizeTipo(val) {
            const k = String(val || '').toLowerCase();
            if (k === 'novo') return 'Novo';
            if ((k.includes('1') && k.includes('venda')) || k.includes('primeira')) return 'Novo';
            if (k === 'adtivo') return 'Adtivo';
            if (k === 'renegocia√ß√£o' || k === 'renegociacao' || k === 'renova√ß√£o' || k === 'renovacao') return 'Renegocia√ß√£o';
            return '';
        }
        function tipoOptionsHtml(sel) {
            const opts = ['Novo','Adtivo','Renegocia√ß√£o'];
            return opts.map(o => `<option value="${o}" ${String(sel||'')===o?'selected':''}>${o}</option>`).join('');
        }
        function pctAtualOptionsHtml(sel) {
            return ['<option value="">Selecione</option>'].concat(pctsDadosDisponiveis.map(p => `<option value="${p}" ${String(sel||'')===p?'selected':''}>${p}</option>`)).join('');
        }
        function getNegTipo() {
            const n = __negociacaoInfo || {};
            return normalizeTipo(n.tipo || '');
        }
        function getFilteredCategorias() {
            const neg = getNegTipo();
            if (!neg) return (__categorias || []).slice();
            return (__categorias || []).filter(c => normalizeTipo(c.tipo) === neg);
        }
        function setLoading(active) {
            const el = document.getElementById('loadingDots');
            if (active) {
                if (!el) return;
                let dots = 0;
                clearInterval(__loadingTimer);
                __loadingTimer = setInterval(() => {
                    dots = (dots + 1) % 4;
                    el.textContent = 'Carregando' + '.'.repeat(dots);
                }, 450);
            } else {
                clearInterval(__loadingTimer);
            }
        }
        async function initConfiguracao() {
            await carregarCategorias();
            await carregarProdutos();
            construirMapa();
            __linhas = [{
                id: 1,
                portabilidade: 'N√£o',
                operadoraDoadora: '',
                ddd: '',
                tipoNegociacao: 'Novo',
                planoAtualGB: '',
                precoAtual: 0,
                numeroPortar: '',
                quantidade: 1,
                categoria: (getFilteredCategorias()[0]?.nome || (__categorias[0]?.nome || '')),
                plano: '',
                pct: '',
                valorPlano: 0,
                valorNaoFidelizado: 0,
                desconto: 0,
                temAparelho: 'N√£o',
                modeloAparelho: '',
                tipoAparelho: '',
                valorAparelho: 0,
                valorParcela: 0
            }];
            await carregarClienteBasico();
            await carregarPropostaSalva();
            bindActions();
            renderClienteBasico();
            renderTabela();
            renderResumo();
            if (window.lucide && typeof window.lucide.createIcons === 'function') window.lucide.createIcons();
        }
        async function carregarCategorias() {
            try {
                const list = await api('/categories', { method: 'GET' });
                __categorias = Array.isArray(list) ? list : [];
            } catch { __categorias = []; }
        }
        async function carregarProdutos() {
            try {
                const list = await api('/products', { method: 'GET' });
                __produtos = Array.isArray(list) ? list : [];
            } catch { __produtos = []; }
        }
        function construirMapa() {
            const filteredCats = getFilteredCategorias();
            const allowedIds = {};
            filteredCats.forEach(c => { allowedIds[c.id] = true; });
            const byId = {};
            filteredCats.forEach(c => { byId[c.id] = c.nome; });
            const map = {};
            __produtos.forEach(p => {
                if (!allowedIds[p.categoria_id]) return;
                const catName = byId[p.categoria_id] || 'Sem categoria';
                if (!map[catName]) map[catName] = [];
                map[catName].push(p);
            });
            __map = map;
        }
        function bindActions() {
            const addBtn = document.getElementById('addLinhaBtn');
            const salvarBtn = document.getElementById('salvarBtn');
            const copiarBtn = document.getElementById('copiarBtn');
            const relatorioBtn = document.getElementById('relatorioBtn');
            try {
                const u = JSON.parse(localStorage.getItem('authUser') || '{}');
                const role = String(u && u.role ? u.role : '');
                __isLocked = (role !== 'admin' && __negociacaoStatus === 'Conclu√≠da');
            } catch { __isLocked = false; }
            if (addBtn) addBtn.addEventListener('click', () => {
                const nextId = (__linhas.reduce((acc, l) => Math.max(acc, Number(l.id)), 0) || 0) + 1;
                __linhas.push({
                    id: nextId,
                    quantidade: 1,
                    ddd: '',
                    tipoNegociacao: 'Novo',
                    planoAtualGB: '',
                    precoAtual: 0,
                    categoria: (__categorias[0]?.nome || ''),
                    plano: '',
                    pct: '',
                    valorPlano: 0,
                    valorNaoFidelizado: 0,
                    desconto: 0,
                    temAparelho: 'N√£o',
                    modeloAparelho: '',
                    tipoAparelho: '',
                    valorAparelho: 0,
                    valorParcela: 0
                });
                renderTabela();
                renderResumo();
            });
            if (salvarBtn) salvarBtn.addEventListener('click', salvarProposta);
            if (copiarBtn) copiarBtn.addEventListener('click', copiarProposta);
            if (relatorioBtn) relatorioBtn.addEventListener('click', gerarRelatorioPdf);
            const statusSel = document.getElementById('fStatus');
            if (statusSel) {
                statusSel.value = __negociacaoStatus || 'Em andamento';
                statusSel.addEventListener('change', async (e) => {
                    const val = String(e.currentTarget.value || '');
                        if (!__negociacaoId) return;
                        if (val === 'Todos') { toast('Selecione um status v√°lido', 'error'); statusSel.value = __negociacaoStatus; return; }
                        try {
                            await api(`/negotiations/${__negociacaoId}`, { method: 'PUT', body: JSON.stringify({ status: val }) });
                            __negociacaoStatus = val;
                            toast('Status atualizado', 'success');
                            const statusEl = document.getElementById('negStatusLabel');
                            if (statusEl) statusEl.textContent = __negociacaoStatus;
                            try {
                                const u = JSON.parse(localStorage.getItem('authUser') || '{}');
                                const role = String(u && u.role ? u.role : '');
                                __isLocked = (role !== 'admin' && __negociacaoStatus === 'Conclu√≠da');
                            } catch { __isLocked = false; }
                            if (__isLocked) {
                                statusSel.disabled = true;
                                const addBtn = document.getElementById('addLinhaBtn');
                                const salvarBtn = document.getElementById('salvarBtn');
                                if (addBtn) addBtn.disabled = true;
                                if (salvarBtn) salvarBtn.disabled = true;
                                renderTabela();
                            }
                        } catch {
                            toast('Erro ao atualizar status', 'error');
                            statusSel.value = __negociacaoStatus;
                        }
                    });
                if (__isLocked) statusSel.disabled = true;
            }
            if (__isLocked) {
                if (addBtn) addBtn.disabled = true;
                if (salvarBtn) salvarBtn.disabled = true;
            }
        }
        function atualizarLinha(id, campo, valor) {
            __linhas = __linhas.map(l => {
                if (Number(l.id) !== Number(id)) return l;
                const novo = { ...l, [campo]: valor };
                if (campo === 'categoria') {
                    novo.plano = '';
                    novo.pct = '';
                    novo.valorPlano = 0;
                }
                if (campo === 'plano') {
                    const planos = __map[l.categoria] || [];
                    const sel = planos.find(p => p.nome === valor);
                    if (sel) {
                        const baseTxt = sel.descricao || sel.nome || '';
                        novo.pct = parsePctFromText(baseTxt);
                        novo.valorPlano = Number(sel.preco || 0);
                        if (!novo.valorNaoFidelizado) novo.valorNaoFidelizado = novo.valorPlano;
                    } else {
                        novo.pct = '';
                        novo.valorPlano = 0;
                        novo.valorNaoFidelizado = 0;
                    }
                }
                if (campo === 'quantidade') {
                    const q = Number(valor || 1);
                    novo.quantidade = (isFinite(q) && q > 0) ? q : 1;
                }
                if (campo === 'precoAtual') {
                    const v = Number(valor || 0);
                    novo.precoAtual = (isFinite(v) && v >= 0) ? v : 0;
                }
                if (campo === 'portabilidade') {
                    const v = String(valor || 'N√£o');
                    if (v !== 'Sim') {
                        novo.portabilidade = 'N√£o';
                        novo.operadoraDoadora = '';
                        // novo.ddd = ''; // DDD mantido
                        novo.numeroPortar = '';
                    } else {
                        novo.portabilidade = 'Sim';
                    }
                }
                if (campo === 'numeroPortar') {
                    novo.numeroPortar = formatNumeroPortar(valor);
                }
                if (campo === 'valorNaoFidelizado') {
                    const v = Number(valor || 0);
                    novo.valorNaoFidelizado = (isFinite(v) && v >= 0) ? v : 0;
                }
                if (campo === 'desconto') {
                    const v = Number(valor || 0);
                    novo.desconto = (isFinite(v) && v >= 0) ? v : 0;
                }
                if (campo === 'temAparelho') {
                    if (valor !== 'Sim') {
                        novo.temAparelho = 'N√£o';
                        novo.modeloAparelho = '';
                        novo.tipoAparelho = '';
                        novo.valorAparelho = 0;
                        novo.valorParcela = 0;
                    } else {
                        novo.temAparelho = 'Sim';
                    }
                }
                if (campo === 'tipoAparelho') {
                    if (valor === 'Comodato') {
                        novo.valorAparelho = 0;
                        novo.valorParcela = 0;
                    } else if (valor === 'VF 24x') {
                         if (novo.valorAparelho > 0) {
                             novo.valorParcela = novo.valorAparelho / 24;
                         }
                    }
                }
                if (campo === 'valorAparelho') {
                    const v = Number(valor || 0);
                    novo.valorAparelho = (isFinite(v) && v >= 0) ? v : 0;
                    if (novo.tipoAparelho === 'VF 24x') {
                        novo.valorParcela = novo.valorAparelho / 24;
                    }
                }
                return novo;
            });
            renderTabela();
            renderResumo();
        }
        function removerLinha(id) {
            if (__linhas.length <= 1) return;
            __linhas = __linhas.filter(l => Number(l.id) !== Number(id));
            renderTabela();
            renderResumo();
        }
        function totalLinha(l) {
            const q = Number(l.quantidade || 1);
            const v = Number(l.valorPlano || 0);
            const base = q * v;
            // O valor do aparelho n√£o deve somar no total da linha (solicita√ß√£o do usu√°rio)
            return base;
        }
        function totalGeral() {
            return __linhas.reduce((acc, l) => acc + (calcularValorComDesconto(l) * (Number(l.quantidade) || 1)), 0);
        }
        function formatNumeroPortar(valor) {
            const digs = String(valor || '').replace(/\D/g, '').slice(0, 9);
            if (digs.length <= 5) return digs;
            return digs.slice(0, 5) + '-' + digs.slice(5);
        }
        function copiarLinha(id) {
            const src = __linhas.find(x => Number(x.id) === Number(id));
            if (!src) return;
            const nextId = (__linhas.reduce((acc, l) => Math.max(acc, Number(l.id)), 0) || 0) + 1;
            __linhas.push({
                id: nextId,
                portabilidade: src.portabilidade || 'N√£o',
                operadoraDoadora: src.operadoraDoadora || '',
                ddd: src.ddd || '',
                tipoNegociacao: src.tipoNegociacao || 'Novo',
                planoAtualGB: src.planoAtualGB || '',
                precoAtual: Number(src.precoAtual || 0),
                numeroPortar: src.numeroPortar || '',
                quantidade: Number(src.quantidade || 1),
                categoria: src.categoria || (__categorias[0]?.nome || ''),
                plano: src.plano || '',
                pct: src.pct || '',
                valorPlano: src.valorPlano || 0,
                valorNaoFidelizado: src.valorNaoFidelizado || 0,
                desconto: src.desconto || 0,
                temAparelho: src.temAparelho || 'N√£o',
                modeloAparelho: src.modeloAparelho || '',
                tipoAparelho: src.tipoAparelho || '',
                valorAparelho: Number(src.valorAparelho || 0),
                valorParcela: Number(src.valorParcela || 0)
            });
            renderTabela();
            renderResumo();
        }
        function renderTabela() {
            const tbody = document.getElementById('itensTbody');
            const cats = getFilteredCategorias().map(c => c.nome);
            if (!__categorias.length && !__produtos.length) {
                tbody.innerHTML = `
                    <tr><td colspan="16">
                        <div id="loadingDots" class="muted" style="padding:0.8rem; text-align:center; font-weight:600;">Carregando</div>
                    </td></tr>
                `;
                setLoading(true);
                return;
            }
            setLoading(false);
            const rows = __linhas.map((l, idx) => {
                const planos = __map[l.categoria] || [];
                const planoOpts = ['<option value="">Selecione um plano...</option>'].concat(
                    planos.map(p => `<option value="${p.nome}" ${p.nome === l.plano ? 'selected' : ''}>${p.nome}</option>`)
                ).join('');
                const catOpts = cats.map(n => `<option value="${n}" ${n === l.categoria ? 'selected' : ''}>${n}</option>`).join('');
                const ops = ['Claro','Vivo','TIM','Oi'];
                const opOpts = ['<option value="">Selecione...</option>'].concat(ops.map(o => `<option value="${o}" ${o === l.operadoraDoadora ? 'selected' : ''}>${o}</option>`)).join('');
                const ddds = [11,12,13,14,15,16,17,18,19,21,22,24,27,28,31,32,33,34,35,37,38,41,42,43,44,45,46,47,48,49,51,53,54,55,61,62,63,64,65,66,67,68,69,71,73,74,75,77,79,81,82,83,84,85,86,87,88,89,91,92,93,94,95,96,97,98,99];
                const dddOpts = ['<option value="">DDD</option>'].concat(ddds.map(d => `<option value="${d}" ${String(d) === String(l.ddd || '') ? 'selected' : ''}>${d}</option>`)).join('');
                
                const isVF24x = l.tipoAparelho === 'VF 24x';
                const isComodato = l.tipoAparelho === 'Comodato';
                const hasAparelho = l.temAparelho === 'Sim';
                const isPort = l.portabilidade === 'Sim';
                
                // Styles for validation
                const styleNumPortar = (isPort && !l.numeroPortar) ? 'border-color:#EF4444;' : '';
                const styleValorAp = (isVF24x && !Number(l.valorAparelho)) ? 'border-color:#EF4444;' : '';
                const styleValorParc = (isVF24x && !Number(l.valorParcela)) ? 'border-color:#EF4444; background-color:#f3f4f6;' : 'background-color:#f3f4f6;';

                return `
                    <tr>
                        <td>${idx + 1}</td>
                        <td>
                            <input type="number" min="1" class="input" style="width:90px; text-align:center;" value="${l.quantidade}"
                                   data-id="${l.id}" data-field="quantidade">
                        </td>
                        <td>
                            <select class="select" data-id="${l.id}" data-field="ddd" style="width:110px;">
                                ${dddOpts}
                            </select>
                        </td>
                        <td>
                            <select class="select" data-id="${l.id}" data-field="tipoNegociacao" style="width:110px;">${tipoOptionsHtml(l.tipoNegociacao)}</select>
                        </td>
                        <td>
                            <select class="select" data-id="${l.id}" data-field="planoAtualGB" style="width:110px;">${pctAtualOptionsHtml(l.planoAtualGB)}</select>
                        </td>
                        <td>
                            <input type="number" class="input" step="0.01" min="0" value="${l.precoAtual || ''}" data-id="${l.id}" data-field="precoAtual" style="width:100px; text-align:center;">
                        </td>
                        <td>
                            <select class="select" data-id="${l.id}" data-field="portabilidade" style="width:110px;">
                                <option value="N√£o" ${l.portabilidade === 'N√£o' ? 'selected' : ''}>N√£o</option>
                                <option value="Sim" ${l.portabilidade === 'Sim' ? 'selected' : ''}>Sim</option>
                            </select>
                        </td>
                        <td>
                            <select class="select" data-id="${l.id}" data-field="operadoraDoadora" style="width:160px;" ${!isPort ? 'disabled' : ''}>
                                ${opOpts}
                            </select>
                        </td>
                        <td>
                            <input type="text" class="input" placeholder="00000-0000" style="width:140px; text-align:center; ${styleNumPortar}"
                                   value="${l.numeroPortar || ''}" data-id="${l.id}" data-field="numeroPortar" ${!isPort ? 'disabled' : ''} maxlength="10">
                        </td>
                        <td>
                            <select class="select" data-id="${l.id}" data-field="categoria">${catOpts}</select>
                        </td>
                        <td>
                            <select class="select" data-id="${l.id}" data-field="plano" style="width:240px;">${planoOpts}</select>
                        </td>
                        <td><span class="muted">${l.pct || '-'}</span></td>
                        <td><span class="muted">${currency(l.valorPlano)}</span></td>
                        <td><strong style="color: var(--primary);">${currency(totalLinha(l))}</strong></td>
                        <td>
                            <input type="number" class="input" step="0.01" min="0" value="${l.valorNaoFidelizado || ''}" data-id="${l.id}" data-field="valorNaoFidelizado" style="width:100px; text-align:center;">
                        </td>
                        <td>
                            <input type="number" class="input" step="0.01" min="0" value="${l.desconto || 0}" data-id="${l.id}" data-field="desconto" style="width:80px; text-align:center;">
                        </td>
                        <td>
                            <span class="muted">${currency(calcularValorComDesconto(l))}</span>
                        </td>
                        <td>
                            <select class="select" data-id="${l.id}" data-field="temAparelho" style="width:90px;">
                                <option value="N√£o" ${!hasAparelho ? 'selected' : ''}>N√£o</option>
                                <option value="Sim" ${hasAparelho ? 'selected' : ''}>Sim</option>
                            </select>
                        </td>
                        <td>
                            <select class="select" data-id="${l.id}" data-field="tipoAparelho" style="width:140px;" ${!hasAparelho ? 'disabled' : ''}>
                                <option value="Comodato" ${isComodato ? 'selected' : ''}>Comodato</option>
                                <option value="VF 24x" ${isVF24x ? 'selected' : ''}>VF 24x</option>
                            </select>
                        </td>
                        <td>
                            <input type="text" class="input" placeholder="Ex: iPhone 15" style="width:160px;"
                                   value="${l.modeloAparelho || ''}" data-id="${l.id}" data-field="modeloAparelho" ${!hasAparelho ? 'disabled' : ''}>
                        </td>
                        <td>
                            <input type="number" step="0.01" min="0" class="input" placeholder="0,00" style="width:110px; text-align:center; ${styleValorAp}"
                                   value="${Number(l.valorAparelho || 0)}" data-id="${l.id}" data-field="valorAparelho" ${!hasAparelho || isComodato ? 'disabled' : ''}>
                        </td>
                        <td>
                            <input type="text" class="input" placeholder="0,00" style="width:110px; text-align:center; ${styleValorParc}"
                                   value="${currency(l.valorParcela)}" readonly disabled>
                        </td>
                        <td class="col-actions">
                            <div class="table-actions">
                                <button type="button" class="btn btn-ghost btn-icon" title="Copiar" onclick="copiarLinha(${l.id})"><i data-lucide="copy"></i></button>
                                <button type="button" class="btn btn-ghost btn-icon" title="Remover" data-id="${l.id}" data-action="remover"><i data-lucide="trash-2"></i></button>
                            </div>
                        </td>
                    </tr>
                `;
            }).join('');
            document.getElementById('countItensLabel').textContent = `${__linhas.length} ${__linhas.length === 1 ? 'item' : 'itens'}`;
            tbody.innerHTML = rows || '<tr><td colspan="16" class="muted">Sem itens</td></tr>';
            Array.from(tbody.querySelectorAll('input[data-field], select[data-field]')).forEach(el => {
                el.addEventListener('change', (e) => {
                    const id = Number(e.currentTarget.getAttribute('data-id') || 0);
                    const field = e.currentTarget.getAttribute('data-field');
                    const val = e.currentTarget.value;
                    atualizarLinha(id, field, val);
                });
            });
            if (__isLocked) {
                Array.from(tbody.querySelectorAll('input[data-field], select[data-field]')).forEach(el => { el.disabled = true; });
                Array.from(tbody.querySelectorAll('button[data-action="remover"], button[title="Copiar"]')).forEach(btn => { btn.disabled = true; });
            }
            Array.from(tbody.querySelectorAll('input[data-field="numeroPortar"]')).forEach(el => {
                el.addEventListener('input', (e) => {
                    const id = Number(e.currentTarget.getAttribute('data-id') || 0);
                    const masked = formatNumeroPortar(e.currentTarget.value);
                    e.currentTarget.value = masked;
                    __linhas = __linhas.map(l => Number(l.id) === id ? ({ ...l, numeroPortar: masked }) : l);
                });
            });
            Array.from(tbody.querySelectorAll('button[data-action="remover"]')).forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const id = Number(e.currentTarget.getAttribute('data-id') || 0);
                    removerLinha(id);
                });
            });
            if (window.lucide && typeof window.lucide.createIcons === 'function') window.lucide.createIcons();
        }
        function calcularValorComDesconto(l) {
            const v = Number(l.valorNaoFidelizado || 0);
            const d = Number(l.desconto || 0);
            return v * (1 - d / 100);
        }
        function calcularPrecoFinal(linha) { return calcularValorComDesconto(linha); } // Alias for compatibility
        function renderResumo() {
            const total = totalGeral();
            const acessos = __linhas.reduce((acc, l) => acc + Number(l.quantidade || 0), 0);
            const itens = __linhas.map((l, idx) => `${idx + 1}. ${l.plano || '-'}`).join(' ‚Ä¢ ') || '-';
            const elTotal = document.getElementById('resumoTotal');
            const elAcessos = document.getElementById('resumoAcessos');
            const elItens = document.getElementById('resumoItens');
            if (elTotal) elTotal.textContent = currency(total);
            if (elAcessos) elAcessos.textContent = `${acessos} ${acessos === 1 ? 'acesso' : 'acessos'}`;
            if (elItens) elItens.textContent = itens;
        }
        function validar() {
            const erros = [];
            __linhas.forEach((l, idx) => {
                const q = Number(l.quantidade || 0);
                if (!q || q < 1) erros.push(`Linha ${idx + 1}: Quantidade deve ser pelo menos 1`);
                if (!l.plano) erros.push(`Linha ${idx + 1}: Selecione um plano`);
            });
            return erros;
        }
        function gerarResumoTexto() {
            const linhasTxt = __linhas.map((l, idx) => {
                return [
                    `[ITEM ${idx + 1}]`,
                    `Qtd: ${Number(l.quantidade || 1)}`,
                    `Categoria: ${l.categoria || '-'}`,
                    `Plano: ${l.plano || '-'}`,
                    `Pacote: ${l.pct || 'N/A'}`,
                    `Valor unit√°rio: ${currency(l.valorPlano)}`,
                    `Total da linha: ${currency(totalLinha(l))}`
                ].join('\n');
            }).join('\n' + '‚îÄ'.repeat(50) + '\n');
            const total = currency(totalGeral());
            const acessos = __linhas.reduce((acc, l) => acc + Number(l.quantidade || 0), 0);
            const header = [
                '=== PROPOSTA PADR√ÉO ===',
                `Data: ${new Date().toLocaleString('pt-BR')}`,
                `Total de linhas: ${__linhas.length}`,
                ''
            ].join('\n');
            const resumo = [
                '\n--- RESUMO FINANCEIRO ---',
                `Valor Total Mensal: ${total}`,
                `Total de Acessos: ${acessos}`
            ].join('\n');
            return header + linhasTxt + '\n' + resumo;
        }
        function gerarMensagemBonita() {
            const total = currency(totalGeral());
            const acessos = __linhas.reduce((acc, l) => acc + Number(l.quantidade || 0), 0);
            const header = [
                'üßæ Proposta Padr√£o',
                `üìÖ ${new Date().toLocaleString('pt-BR')}`,
                `üî¢ Linhas: ${__linhas.length}`,
                ''
            ].join('\n');
            const linhasTxt = __linhas.map((l, idx) => {
                const dddTxt = l.ddd ? ` (DDD ${l.ddd})` : '';
                return `üîπ Item ${idx + 1}: ${Number(l.quantidade || 1)}x${dddTxt} ${l.plano || '-'} (${l.categoria || '-'}) ‚Ä¢ ${l.pct || 'N/A'} ‚Ä¢ ${currency(l.valorPlano)} ‚Ä¢ Total: ${currency(totalLinha(l))}`;
            }).join('\n');
            const counts = {};
            __linhas.forEach(l => {
                const k = l.categoria || '-';
                const q = Number(l.quantidade || 0);
                counts[k] = (counts[k] || 0) + q;
            });
            const itens = Object.entries(counts).map(([k, v]) => `‚Ä¢ ${k}: ${v}`).join('\n') || '-';
            const resumo = [
                '',
                'üí∞ Resumo Financeiro',
                `   ‚Ä¢ Valor Total Mensal: ${total}`,
                `   ‚Ä¢ Total de Acessos: ${acessos}`,
                '',
                'üìã Itens',
                itens
            ].join('\n');
            return header + linhasTxt + '\n' + resumo + '\n‚úÖ Proposta copiada!';
        }
        function gerarRelatorioPdf() {
            try {
                const lib = window.jspdf || {};
                const jsPDF = lib.jsPDF;
                if (!jsPDF || !document || !document.body) { toast('Biblioteca de PDF indispon√≠vel', 'error'); return; }
                const doc = new jsPDF({ unit: 'pt', format: 'a4' });
                const n = __negociacaoInfo || {};
                const c = __clienteInfo || {};
                const acessos = __linhas.reduce((acc, l) => acc + Number(l.quantidade || 0), 0);
                const total = currency(totalGeral());
                doc.setFontSize(14);
                doc.text('Relat√≥rio da Proposta', 40, 40);
                doc.setFontSize(9);
                doc.text('Gerado em ' + new Date().toLocaleString('pt-BR'), 40, 56);
                try {
                    const u = JSON.parse(localStorage.getItem('authUser') || '{}');
                    if (u && u.name) {
                        doc.text('Consultor: ' + u.name, 40, 68);
                    }
                } catch {}
                doc.setFontSize(10);
                doc.text('Total mensal: ' + total, 450, 40, { align: 'right' });
                doc.autoTable({
                    startY: 80,
                    head: [['Campo', 'Valor']],
                    body: [
                        ['Nome', c.name || '-'],
                        ['CNPJ', formatCnpj(n.cnpj || c.cnpj || '')],
                        ['Email', c.email || '-'],
                        ['Telefone', formatPhone(c.phone || '') || '-']
                    ],
                    styles: { fontSize: 9 },
                    headStyles: { fillColor: [243, 244, 246], textColor: [55, 65, 81] },
                    theme: 'grid',
                    margin: { left: 40, right: 40 }
                });
                doc.autoTable({
                    startY: doc.lastAutoTable.finalY + 12,
                    head: [['Campo', 'Valor']],
                    body: [
                        ['Tipo', n.tipo || '-'],
                        ['Proposta', n.proposta || '-'],
                        ['Data', n.data || '-'],
                        ['Status', __negociacaoStatus || (n.status || '-')]
                    ],
                    styles: { fontSize: 9 },
                    headStyles: { fillColor: [243, 244, 246], textColor: [55, 65, 81] },
                    theme: 'grid',
                    margin: { left: 40, right: 40 }
                });
                const head = [['#','Qtd','DDD','Tipo','Portabilidade','Operadora Doadora','N√∫mero a Portar','Categoria','Plano','Pct','Valor Plano','Total Linha','Aparelho','Modelo','Tipo Aparelho','Valor Aparelho']];
                const body = (__linhas || []).map((l, idx) => ([
                    String(idx + 1),
                    String(Number(l.quantidade || 0)),
                    String(l.ddd || '-'),
                    String(l.tipoNegociacao || '-'),
                    String(l.portabilidade || '-'),
                    String(l.operadoraDoadora || '-'),
                    String(l.numeroPortar || '-'),
                    String(l.categoria || '-'),
                    String(l.plano || '-'),
                    String(l.pct || '-'),
                    String(currency(l.valorPlano)),
                    String(currency(totalLinha(l))),
                    String(l.temAparelho || '-'),
                    String(l.modeloAparelho || '-'),
                    String(l.tipoAparelho || '-'),
                    String(currency(l.valorAparelho))
                ]));
                doc.setFontSize(12);
                const pageHeight = doc.internal.pageSize.getHeight();
                let startY = (doc.lastAutoTable && doc.lastAutoTable.finalY ? doc.lastAutoTable.finalY : 80) + 24;
                doc.text('Itens da Proposta', 40, startY - 12);
                let currentY = startY;
                const linhasArr = Array.isArray(__linhas) ? __linhas : [];
                if (!linhasArr.length) {
                    doc.setFontSize(9);
                    doc.text('Sem itens', 40, currentY + 6);
                    currentY += 20;
                } else {
                    linhasArr.forEach((l, idx) => {
                        if (currentY > pageHeight - 160) {
                            doc.addPage();
                            currentY = 80;
                            doc.setFontSize(12);
                            doc.text('Itens da Proposta (cont.)', 40, currentY - 12);
                        }
                        doc.autoTable({
                            startY: currentY,
                            head: [['Campo', 'Valor']],
                            body: [
                                ['Item', String(idx + 1)],
                                ['Qtd', String(Number(l.quantidade || 0))],
                                ['DDD', String(l.ddd || '-')],
                                ['Tipo', String(l.tipoNegociacao || '-')],
                                ['Plano Atual', String(l.planoAtualGB || '-')],
                                ['Pre√ßo Atual', String(currency(l.precoAtual))],
                                ['Portabilidade', String(l.portabilidade || '-')],
                                ['Operadora Doadora', String(l.operadoraDoadora || '-')],
                                ['N√∫mero a Portar', String(l.numeroPortar || '-')],
                                ['Categoria', String(l.categoria || '-')],
                                ['Plano', String(l.plano || '-')],
                                ['Pct', String(l.pct || '-')],
                                ['Valor Plano', String(currency(l.valorPlano))],
                                ['Total Linha', String(currency(totalLinha(l)))],
                                ['Aparelho', String(l.temAparelho || '-')],
                                ['Modelo', String(l.modeloAparelho || '-')],
                                ['Tipo Aparelho', String(l.tipoAparelho || '-')],
                                ['R$ Total Aparelho', String(currency(l.valorAparelho))],
                                ['R$ da Parcela', String(currency(l.valorParcela))]
                            ],
                            styles: { fontSize: 9, cellPadding: 3 },
                            headStyles: { fillColor: [243, 244, 246], textColor: [55, 65, 81] },
                            showHead: 'firstPage',
                            theme: 'grid',
                            margin: { left: 40, right: 40 }
                        });
                        currentY = (doc.lastAutoTable && doc.lastAutoTable.finalY ? doc.lastAutoTable.finalY : currentY) + 10;
                    });
                }
                if (currentY > pageHeight - 40) {
                    doc.addPage();
                    currentY = 40;
                }
                doc.setFontSize(9);
                doc.text('Total de acessos: ' + String(acessos) + ' ‚Ä¢ Valor total mensal: ' + total, 40, currentY + 14);
                const nomeArquivo = 'Relatorio_Proposta_' + String((n.cnpj || c.cnpj || '').replace(/\D/g, '') || 'sem-cnpj') + '_' + String(new Date().toISOString().slice(0,10)) + '.pdf';
                doc.save(nomeArquivo);
            } catch {
                toast('Erro ao gerar relat√≥rio', 'error');
            }
        }
        function salvarProposta() {
            const erros = validar();
            if (erros.length) {
                toast('Corrija os seguintes problemas: ' + erros.join('; '), 'error');
                return;
            }
            try {
                if (!__negociacaoId) return;
                api(`/negotiations/${__negociacaoId}/proposal`, {
                    method: 'POST',
                    body: JSON.stringify({ linhas: __linhas })
                }).then(async () => {
                    toast('Proposta salva', 'success');
                    await carregarPropostaSalva();
                    renderTabela();
                    renderResumo();
                }).catch(() => { toast('Erro ao salvar proposta', 'error'); });
            } catch {}
        }
        function copiarProposta() {
            const erros = validar();
            if (erros.length) {
                toast('Corrija os seguintes problemas: ' + erros.join('; '), 'error');
                return;
            }
            try {
                const txt = gerarMensagemBonita();
                if (navigator && navigator.clipboard && typeof navigator.clipboard.writeText === 'function') {
                    navigator.clipboard.writeText(txt);
                }
            } catch {}
        }
    </script>
</body>
</html>
