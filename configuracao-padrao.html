<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Configuração Padrão • Maxximus Telecom</title>
    <link rel="icon" href="data:,">
    <link rel="stylesheet" href="style.css">
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jspdf-autotable@3.8.2/dist/jspdf.plugin.autotable.min.js"></script>
    <style>
        .modal-body {
            padding: 1.5rem;
            background-color: var(--bg);
            color: var(--text);
        }
        .section-block {
            margin-bottom: 1rem;
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 1rem;
            box-shadow: 0 1px 2px rgba(0,0,0,0.05);
        }
        .section-header {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            margin-bottom: 1rem;
            padding-bottom: 0.75rem;
            border-bottom: 1px solid var(--border);
        }
        .section-icon {
            width: 20px;
            height: 20px;
            color: var(--primary);
        }
        .section-title {
            font-weight: 600;
            color: var(--text);
            font-size: 0.95rem;
        }
        .section-desc {
            font-size: 0.8rem;
            color: var(--muted);
            line-height: 1.2;
        }
        .info-badge {
            display: inline-flex;
            align-items: center;
            padding: 0.25rem 0.75rem;
            background: var(--surface-strong);
            border-radius: 999px;
            font-size: 0.85rem;
            font-weight: 500;
            color: var(--text);
        }
    </style>
</head>
<body>
    <main class="container">
        <div class="card">
            <div class="card-head">
                <div class="card-title">
                    <span>Configuração Padrão</span>&nbsp;
                    <span class="chip">Negociação</span>
                </div>
                <div class="muted">
                    <button id="addLinhaBtn" class="btn btn-primary" type="button"><i data-lucide="plus"></i><span>Adicionar linha</span></button>
                </div>
            </div>
            <div class="card-body">
                <section class="section" style="margin-top: 20px;">
                    <div class="label">Dados básicos do cliente</div>
                    <div style="padding:0.4rem 0.0rem; display:flex; align-items:center; gap:0.75rem; flex-wrap:wrap;">
                        <span class="muted">Cliente:</span>
                        <span id="clienteNome" style="font-weight:600;">-</span>
                        <span class="muted">CNPJ:</span>
                        <span id="clienteCnpj">-</span>
                        <span class="muted">Tipo:</span>
                        <span id="negTipo">-</span>
                        <span class="muted">Status:</span>
                        <span id="negStatusLabel">-</span>
                    </div>
                </section>
                <section class="section" style="margin-top: 20px;">
                    <div style="display:flex; align-items:center; justify-content:space-between; margin-top: 20px;">
                        <div class="label">Itens da proposta</div>
                        <div class="muted" id="countItensLabel">0 itens</div>
                    </div>
                    <div class="table-container" style="margin-top:0.5rem;">
                        <table>
                            <thead>
                                <tr>
                                    <th>Linha</th>
                                    <th>Tipo</th>
                                    <th>Qtd</th>
                                    <th>Total</th>
                                    <th class="col-actions" style="min-width:140px;">Ações</th>
                                </tr>
                            </thead>
                            <tbody id="itensTbody">
                                <tr><td colspan="5">
                                    <div class="skeleton skel-row"></div>
                                    <div class="skeleton skel-row"></div>
                                    <div class="skeleton skel-row"></div>
                                </td></tr>
                            </tbody>
                        </table>
                    </div>
                </section>
                <section class="section" style="margin-top:1rem;">
                    <div style="display:flex; align-items:center; gap:0.75rem;">
                        <div class="label">Status da negociação</div>
                        <select id="fStatus" class="select" style="width:220px;">
                            <option value="Em andamento">Em andamento</option>
                            <option value="Concluída">Concluída</option>
                            <option value="Cancelada">Cancelada</option>
                        </select>
                    </div>
                </section>
                <section class="section" style="margin-top:1rem;">
                    <div class="label">Resumo</div>
                    <div class="grid-2" style="margin-top:0.5rem;">
                        <div class="card" style="padding:0.75rem;">
                            <div class="muted">Valor total mensal</div>
                            <div id="resumoTotal" style="font-size:1.6rem; font-weight:700; color: var(--primary);">R$ 0,00</div>
                            <div id="resumoAcessos" class="muted" style="margin-top:0.3rem;">0 acessos</div>
                        </div>
                        <div class="card" style="padding:0.75rem;">
                            <div class="muted">Itens incluídos</div>
                            <div id="resumoItens" class="muted" style="margin-top:0.3rem;">-</div>
                        </div>
                    </div>
                </section>
                <section class="section" style="margin-top:1rem;">
                    <div class="label">Anotações</div>
                    <textarea id="fAnotacoes" class="input" style="width:100%; min-height:80px; margin-top:0.5rem; padding: 0px; resize: none;" placeholder="Observações gerais sobre a proposta..."></textarea>
                </section>
                <section class="section" style="margin-top:1rem;">
                    <div class="label">Anexos</div>
                    <div style="margin-top:0.5rem;">
                        <div id="attachmentsList" style="display:flex; flex-wrap:wrap; gap:0.5rem; margin-bottom:0.5rem;"></div>
                        <label class="btn btn-ghost" style="cursor:pointer; display:inline-flex; align-items:center; gap:0.5rem;">
                            <i data-lucide="paperclip"></i><span>Adicionar anexo</span>
                            <input type="file" id="fileInput" style="display:none;">
                        </label>
                    </div>
                </section>
                <section style="margin-top:1rem;">
                    <div style="display:flex; gap:0.5rem; flex-wrap:wrap; justify-content:flex-end;">
                        <button id="novaBtn" class="btn btn-ghost" type="button"><i data-lucide="rotate-ccw"></i><span>Resetar Proposta</span></button>
                        <button id="copiarBtn" class="btn btn-ghost" type="button" title="Copiar proposta"><i data-lucide="copy"></i><span>Copiar Proposta</span></button>
                        <button id="relatorioBtn" class="btn btn-ghost" type="button" title="Gerar Relatório"><i data-lucide="file-text"></i><span>Gerar Relatório</span></button>
                        <button id="salvarBtn" class="btn btn-primary" type="button" title="Salvar"><i data-lucide="save"></i><span>Salvar</span></button>
                    </div>
                </section>
            </div>
        </div>
    </main>
    <div id="toast" class="toast"></div>
    <div id="confirmResetModal" class="modal">
        <div class="modal-card">
            <div class="modal-head"><div>Confirmar Reset</div><button id="confirmResetClose" class="btn btn-ghost btn-icon"><i data-lucide="x"></i></button></div>
            <div class="modal-body">
                <div class="label">Tem certeza que deseja resetar a proposta?</div>
                <div class="muted" style="margin-top:0.5rem;">Esta ação limpa todas as linhas atuais.</div>
            </div>
            <div class="modal-actions">
                <button id="confirmResetCancel" class="btn btn-ghost" type="button"><i data-lucide="x"></i><span>Cancelar</span></button>
                <button id="confirmResetConfirm" class="btn btn-ghost" type="button" style="border-color: rgba(239,68,68,0.35); color: #FCA5A5;"><i data-lucide="rotate-ccw"></i><span>Resetar</span></button>
            </div>
        </div>
    </div>
    <div id="confirmAttachmentDeleteModal" class="modal">
        <div class="modal-card">
            <div class="modal-head"><div>Excluir Anexo</div><button id="confirmAttachmentDeleteClose" class="btn btn-ghost btn-icon"><i data-lucide="x"></i></button></div>
            <div class="modal-body">
                <div class="label">Tem certeza que deseja excluir este anexo?</div>
                <div class="muted" style="margin-top:0.5rem;">Esta ação não poderá ser desfeita.</div>
            </div>
            <div class="modal-actions">
                <button id="confirmAttachmentDeleteCancel" class="btn btn-ghost" type="button"><i data-lucide="x"></i><span>Cancelar</span></button>
                <button id="confirmAttachmentDeleteConfirm" class="btn btn-ghost" type="button" style="border-color: rgba(239,68,68,0.35); color: #FCA5A5;"><i data-lucide="trash-2"></i><span>Excluir</span></button>
            </div>
        </div>
    </div>

    <!-- Edit Line Modal -->
    <div id="editLineModal" class="modal">
        <div class="modal-card" style="max-width: 900px; width: 95%;">
            <div class="modal-head">
                <div>Editar Linha</div>
                <button id="editLineClose" class="btn btn-ghost btn-icon"><i data-lucide="x"></i></button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="editLineId">
                
                <!-- 1. Dados da Linha -->
                <div class="section-block">
                    <div class="section-header">
                        <i data-lucide="phone" class="section-icon"></i>
                        <div>
                            <div class="section-title">Dados da Linha</div>
                            <div class="section-desc">Informações básicas do número</div>
                        </div>
                    </div>
                    <div class="grid-3">
                        <div>
                            <div class="label">DDD</div>
                            <select id="editDdd" class="select"></select>
                        </div>
                        <div>
                            <div class="label">Tipo</div>
                            <select id="editTipo" class="select"></select>
                        </div>
                        <div>
                            <div class="label">Número</div>
                            <input id="editNumero" type="text" class="input" placeholder="00000-0000" maxlength="10">
                        </div>
                    </div>
                </div>

                <!-- 2. Plano Atual (Condicional) -->
                <div class="section-block" id="secPlanoAtual">
                    <div class="section-header">
                        <i data-lucide="file-text" class="section-icon"></i>
                        <div>
                            <div class="section-title">Plano Atual</div>
                            <div class="section-desc">Detalhes do plano em uso</div>
                        </div>
                    </div>
                    <div class="grid-2">
                        <div>
                            <div class="label">Plano Atual</div>
                            <select id="editPlanoAtual" class="select"></select>
                        </div>
                        <div>
                            <div class="label">Preço Atual</div>
                            <input id="editPrecoAtual" type="number" step="0.01" min="0" class="input">
                        </div>
                    </div>
                </div>

                <!-- 3. Portabilidade -->
                <div class="section-block">
                    <div class="section-header">
                        <i data-lucide="arrow-left-right" class="section-icon"></i>
                        <div>
                            <div class="section-title">Portabilidade</div>
                            <div class="section-desc">Trazer número de outra operadora</div>
                        </div>
                    </div>
                    <div>
                        <div class="label">Deseja realizar portabilidade?</div>
                        <select id="editPortabilidade" class="select">
                            <option value="Não">Não</option>
                            <option value="Sim">Sim</option>
                        </select>
                    </div>
                    <div id="areaPortabilidadeDetails" class="grid-2" style="margin-top: 1rem; display: none;">
                        <div>
                            <div class="label">Operadora Doadora</div>
                            <select id="editOperadora" class="select"></select>
                        </div>
                        <div>
                            <div class="label">Número a Portar</div>
                            <input id="editNumeroPortar" type="text" class="input" placeholder="00000-0000" maxlength="10">
                        </div>
                    </div>
                </div>

                <!-- 4. Novo Plano -->
                <div class="section-block">
                    <div class="section-header">
                        <i data-lucide="package" class="section-icon"></i>
                        <div>
                            <div class="section-title">Novo Plano</div>
                            <div class="section-desc">Selecione o plano desejado</div>
                        </div>
                    </div>
                    <div class="grid-2" style="margin-bottom: 1rem;">
                        <div>
                            <div class="label">Categoria</div>
                            <select id="editCategoria" class="select"></select>
                        </div>
                        <div>
                            <div class="label">Plano</div>
                            <select id="editPlano" class="select"></select>
                        </div>
                    </div>
                    <div style="display:none;">
                        <div class="label">Pacote de Dados</div>
                        <div id="editPct" class="info-badge">-</div>
                    </div>
                    <div style="margin-top: 1rem;">
                        <div class="label">Valor do Plano</div>
                        <div id="editValorPlano" class="info-badge" style="background: #ecfdf5; color: #047857;">R$ 0,00</div>
                    </div>
                </div>

                <!-- 5. Aparelho -->
                <div class="section-block">
                    <div class="section-header">
                        <i data-lucide="smartphone" class="section-icon"></i>
                        <div>
                            <div class="section-title">Aparelho</div>
                            <div class="section-desc">Adicionar dispositivo à linha</div>
                        </div>
                    </div>
                    <div>
                        <div class="label">Incluir aparelho?</div>
                        <select id="editTemAparelho" class="select">
                            <option value="Não">Não</option>
                            <option value="Sim">Sim</option>
                        </select>
                    </div>
                    <div id="areaAparelhoDetails" style="margin-top: 1rem; display: none;">
                        <div class="grid-2" style="margin-bottom: 1rem;">
                            <div>
                                <div class="label">Tipo Aparelho</div>
                                <select id="editTipoAparelho" class="select">
                                    <option value="Comodato">Comodato</option>
                                    <option value="VF 24x">VF 24x</option>
                                </select>
                            </div>
                            <div>
                                <div class="label">Modelo</div>
                                <input id="editModeloAparelho" type="text" class="input" placeholder="Ex: iPhone 15">
                            </div>
                        </div>
                        <div class="grid-2">
                            <div>
                                <div class="label">Valor Aparelho</div>
                                <input id="editValorAparelho" type="number" class="input" step="0.01">
                            </div>
                            <div>
                                <div class="label">Valor Parcela (24x)</div>
                                <div id="editValorParcela" class="info-badge">R$ 0,00</div>
                            </div>
                        </div>
                    </div>
                </div>

            </div>
            <div class="modal-actions">
                <button id="editLineCancel" class="btn btn-ghost" type="button"><i data-lucide="x"></i><span>Cancelar</span></button>
                <button id="editLineSave" class="btn btn-primary" type="button"><i data-lucide="check"></i><span>Salvar</span></button>
            </div>
        </div>
    </div>
    <script src="script.js"></script>
    <script>
        const API_BASE = 'https://others-maxximus-backend.pvuzyy.easypanel.host';
        async function api(path, options = {}) {
            const authRaw = localStorage.getItem('authUser');
            let headers = { 'Content-Type': 'application/json' };
            try {
                const u = JSON.parse(authRaw || '{}');
                if (u && u.id) headers['x-user-id'] = String(u.id);
                if (u && u.role) headers['x-user-role'] = String(u.role);
                if (u && u.name) headers['x-user-name'] = String(u.name);
            } catch {}
            
            if (options.headers) {
                headers = { ...headers, ...options.headers };
            }
            if (options.body instanceof FormData) {
                delete headers['Content-Type'];
            }
            
            const res = await fetch(API_BASE + path, { ...options, headers });
            if (!res.ok) {
                const err = await res.json().catch(() => ({}));
                throw new Error(err.error || ('HTTP ' + res.status));
            }
            return res.json();
        }
        function toast(msg, type) {
            const el = document.getElementById('toast');
            if (!el) return;
            el.textContent = msg;
            if (type === 'success') {
                el.style.background = 'linear-gradient(135deg, #10B981 0%, #059669 100%)';
                el.style.color = '#FFFFFF';
                el.style.borderColor = 'transparent';
            } else if (type === 'error') {
                el.style.background = 'linear-gradient(135deg, #EF4444 0%, #DC2626 100%)';
                el.style.color = '#FFFFFF';
                el.style.borderColor = 'transparent';
            } else {
                el.style.background = 'linear-gradient(135deg, #3B82F6 0%, #2563EB 100%)';
                el.style.color = '#FFFFFF';
                el.style.borderColor = 'transparent';
            }
            el.style.display = 'block';
            clearTimeout(window.__toastTimer);
            window.__toastTimer = setTimeout(() => { el.style.display = 'none'; }, 2500);
        }
        async function loadAttachments() {
            try {
                const list = await api(`/negotiations/${__negociacaoId}/attachments`, { method: 'GET' }).catch(() => []);
                renderAttachments(list);
            } catch { toast('Erro ao carregar anexos', 'error'); }
        }

        function renderAttachments(list) {
            const container = document.getElementById('attachmentsList');
            if (!container) return;
            container.innerHTML = '';
            
            if (!Array.isArray(list) || list.length === 0) {
                return;
            }

            list.forEach(att => {
                const div = document.createElement('div');
                div.className = 'chip';
                div.style.display = 'inline-flex';
                div.style.alignItems = 'center';
                div.style.gap = '0.5rem';
                div.style.padding = '0.5rem';
                div.style.border = '1px solid #e5e7eb';
                div.style.borderRadius = '6px';
                
                const iconName = getIconForType(att.file_type);
                
                div.innerHTML = `
                    <i data-lucide="${iconName}" style="width:16px; height:16px;"></i>
                    <a href="${API_BASE}/negotiations/${__negociacaoId}/attachments/${att.id}/content" target="_blank" style="text-decoration:none; color:inherit; font-size:0.9rem;">${att.file_name}</a>
                    <button type="button" class="btn btn-ghost btn-icon" style="width:20px; height:20px; min-height:20px; padding:0;" onclick="deleteAttachment(${att.id})">
                        <i data-lucide="x" style="width:14px; height:14px;"></i>
                    </button>
                `;
                container.appendChild(div);
            });
            if (window.lucide && typeof window.lucide.createIcons === 'function') window.lucide.createIcons();
        }

        function getIconForType(type) {
            if (type.includes('image')) return 'image';
            if (type.includes('pdf')) return 'file-text';
            if (type.includes('excel') || type.includes('spreadsheet')) return 'sheet';
            return 'file';
        }

        async function handleFileUpload(e) {
            const file = e.target.files[0];
            if (!file) return;

            const formData = new FormData();
            formData.append('file', file);
            formData.append('fileName', file.name);
            formData.append('fileType', file.type);

            try {
                await api(`/negotiations/${__negociacaoId}/attachments`, {
                    method: 'POST',
                    body: formData
                });
                toast('Anexo enviado com sucesso', 'success');
                loadAttachments();
            } catch {
                toast('Erro ao enviar anexo', 'error');
            } finally {
                e.target.value = '';
            }
        }

        async function deleteAttachment(id) {
            const modal = document.getElementById('confirmAttachmentDeleteModal');
            const btnClose = document.getElementById('confirmAttachmentDeleteClose');
            const btnCancel = document.getElementById('confirmAttachmentDeleteCancel');
            const btnConfirm = document.getElementById('confirmAttachmentDeleteConfirm');

            if (!modal) {
                if (confirm('Deseja excluir este anexo?')) {
                    proceedDelete(id);
                }
                return;
            }

            const closeModal = () => {
                modal.classList.remove('show');
                // Clean up listeners to avoid duplicates
                btnConfirm.replaceWith(btnConfirm.cloneNode(true));
            };

            const openModal = () => {
                modal.classList.add('show');
                if (window.lucide && typeof window.lucide.createIcons === 'function') window.lucide.createIcons();
            };

            // Re-select confirm button after clone
            const newBtnConfirm = document.getElementById('confirmAttachmentDeleteConfirm');
            
            newBtnConfirm.addEventListener('click', () => {
                closeModal();
                proceedDelete(id);
            });
            
            // Add listeners for closing (using replaceWith to avoid duplicates not strictly necessary for close buttons but good practice if reusing)
             if (btnClose) {
                btnClose.onclick = closeModal;
            }
            if (btnCancel) {
                btnCancel.onclick = closeModal;
            }

            openModal();
        }

        async function proceedDelete(id) {
            try {
                await api(`/negotiations/${__negociacaoId}/attachments/${id}`, { method: 'DELETE' });
                toast('Anexo excluído', 'success');
                loadAttachments();
            } catch {
                toast('Erro ao excluir anexo', 'error');
            }
        }

        document.addEventListener('DOMContentLoaded', async () => {
            const auth = localStorage.getItem('authUser');
            if (!auth) { window.location.href = 'login.html'; return; }
            try {
                const params = new URLSearchParams(window.location.search || '');
                const idParam = Number(params.get('id') || 0);
                if (!idParam) { window.location.href = 'negociar.html'; return; }
                const list = await api('/negotiations', { method: 'GET' }).catch(() => []);
                const arr = Array.isArray(list) ? list : [];
                const exists = arr.find(n => Number(n.id) === Number(idParam));
                if (!exists) { window.location.href = 'negociar.html'; return; }
                __negociacaoId = idParam;
                __negociacaoStatus = exists && exists.status ? String(exists.status) : 'Em andamento';
                __negociacaoInfo = exists || null;
                await initConfiguracao();
                await loadAttachments();
                const fileInput = document.getElementById('fileInput');
                if (fileInput) fileInput.addEventListener('change', handleFileUpload);
            } catch (e) {
                console.error(e);
                toast('Erro ao carregar negociação: ' + e.message, 'error');
            }
        });
        async function carregarPropostaSalva() {
            try {
                if (!__negociacaoId) return;
                const data = await api(`/negotiations/${__negociacaoId}/proposal`, { method: 'GET' }).catch(() => null);
                if (data && Array.isArray(data.linhas)) {
                    const anotacoesEl = document.getElementById('fAnotacoes');
                    if (anotacoesEl) anotacoesEl.value = data.anotacoes || '';
                    const linhas = data.linhas.map((l, idx) => {
                        const cat = l.categoria || (__categorias[0]?.nome || '');
                        const tipoNeg = l.tipoNegociacao || 'Novo';
                        const planoNome = l.plano || '';

                        const catsByTipo = getFilteredCategorias(tipoNeg);
                        const catObj = catsByTipo.find(c => c.nome === cat);
                        const planos = catObj ? (__map[catObj.id] || []) : [];

                        const sel = planos.find(p => p.nome === planoNome);
                        const baseTxt = sel ? (sel.descricao || sel.nome || '') : '';
                        let pctNorm = parsePctFromText(baseTxt);
                        if (!pctNorm) pctNorm = l.pct || '';
                        const valorAp = Number(l.valorAparelho || 0);
                        const parcela = (l.tipoAparelho === 'VF 24x' && valorAp > 0) ? (valorAp / 24) : 0;
                        return {
                            id: Number(l.id || idx + 1),
                            portabilidade: l.portabilidade || 'Não',
                            operadoraDoadora: l.operadoraDoadora || '',
                            ddd: l.ddd || '',
                            tipoNegociacao: tipoNeg,
                            numero: l.numero || '',
                            planoAtualGB: l.planoAtualGB || '',
                            precoAtual: Number(l.precoAtual || 0),
                            numeroPortar: l.numeroPortar || '',
                            quantidade: Number(l.quantidade || 1),
                            categoria: cat,
                            plano: planoNome,
                            pct: pctNorm,
                            valorPlano: Number(l.valorPlano || (sel ? Number(sel.preco || 0) : 0)),
                            temAparelho: l.temAparelho || 'Não',
                            modeloAparelho: l.modeloAparelho || '',
                            tipoAparelho: l.tipoAparelho || '',
                            valorAparelho: valorAp,
                            valorParcela: parcela
                        };
                    });
                    __linhas = linhas.length ? linhas : __linhas;
                }
            } catch {}
        }
        function currency(v) {
            try { return (new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' })).format(Number(v || 0)); } catch { return 'R$ 0,00'; }
        }
        function formatCnpj(s) {
            const d = String(s || '').replace(/\D/g, '');
            if (d.length !== 14) return d;
            return d.replace(/^(\d{2})(\d{3})(\d{3})(\d{4})(\d{2})$/, '$1.$2.$3/$4-$5');
        }
        function formatPhone(s) {
            const d = String(s || '').replace(/\D/g, '');
            if (d.length === 11) return d.replace(/^(\d{2})(\d{5})(\d{4})$/, '($1) $2-$3');
            if (d.length === 10) return d.replace(/^(\d{2})(\d{4})(\d{4})$/, '($1) $2-$3');
            return s || '';
        }
        async function carregarClienteBasico() {
            try {
                const cnpj = __negociacaoInfo ? (__negociacaoInfo.cnpj || '') : '';
                if (!cnpj) { __clienteInfo = null; return; }
                const list = await api('/clients?cnpj=' + encodeURIComponent(String(cnpj).replace(/\D/g, '')), { method: 'GET' }).catch(() => []);
                __clienteInfo = Array.isArray(list) && list.length ? list[0] : null;
            } catch { __clienteInfo = null; }
        }
        function renderClienteBasico() {
            const nomeEl = document.getElementById('clienteNome');
            const cnpjEl = document.getElementById('clienteCnpj');
            const emailEl = document.getElementById('clienteEmail');
            const phoneEl = document.getElementById('clientePhone');
            const tipoEl = document.getElementById('negTipo');
            const propEl = document.getElementById('negProposta');
            const dataEl = document.getElementById('negData');
            const statusEl = document.getElementById('negStatusLabel');
            const n = __negociacaoInfo || {};
            const c = __clienteInfo || {};
            if (nomeEl) nomeEl.textContent = c.name || '-';
            if (cnpjEl) cnpjEl.textContent = formatCnpj(n.cnpj || c.cnpj || '');
            if (emailEl) emailEl.textContent = c.email || '-';
            if (phoneEl) phoneEl.textContent = formatPhone(c.phone || '');
            if (tipoEl) tipoEl.textContent = n.tipo || '-';
            if (propEl) propEl.textContent = n.proposta || '-';
            if (dataEl) dataEl.textContent = n.data || '-';
            if (statusEl) statusEl.textContent = __negociacaoStatus || (n.status || '-');
        }
        function parsePctFromText(s) {
            const txt = String(s || '');
            const paren = txt.match(/\(([^)]+)\)/);
            const target = paren ? paren[1] : txt;
            let dataSum = 0;
            let dataUnit = '';
            let smsSum = 0;
            const dataRegex = /(\d+(?:[\.,]\d+)?)\s*(GB|MB|MEGA)\b/gi;
            const smsRegex = /(\d+)\s*SMS\b/gi;
            let dm;
            while ((dm = dataRegex.exec(target)) !== null) {
                const num = Number(String(dm[1] || '0').replace(',', '.'));
                let u = (dm[2] || '').toUpperCase();
                if (u === 'MEGA') u = 'MB';
                if (!dataUnit && u) dataUnit = u;
                const val = dataUnit === 'GB'
                    ? (u === 'MB' ? (num / 1024) : num)
                    : (u === 'GB' ? (num * 1024) : num);
                dataSum += val;
            }
            let sm;
            while ((sm = smsRegex.exec(target)) !== null) {
                smsSum += Number(sm[1] || 0);
            }
            const parts = [];
            if (dataSum > 0 && dataUnit) {
                const rounded = Math.round(dataSum * 100) / 100;
                const out = (rounded % 1 === 0) ? String(Math.round(rounded)) : String(rounded).replace('.', ',');
                parts.push(out + dataUnit);
            }
            if (smsSum > 0) parts.push(String(smsSum) + 'SMS');
            return parts.join(' + ');
        }
        let __categorias = [];
        const pctsDadosDisponiveis = ['100MB','1GB','2GB','3GB','4GB','5GB','6GB','8GB','10GB','12GB','20GB','22GB','30GB','32GB','50GB','52GB','100GB','150GB','Voz (sem dados)'];
        let __produtos = [];
        let __map = {}; // categoria.nome -> produtos
        let __linhas = [];
        let __negociacaoId = null;
        let __negociacaoStatus = 'Em andamento';
        let __negociacaoInfo = null;
        let __clienteInfo = null;
        let __loadingTimer = null;
        let __isLocked = false;
        let __tiposBackend = [];
        function normalizeTipo(val) {
            const k = String(val || '').toLowerCase();
            if (k === 'novo') return 'Novo';
            if ((k.includes('1') && k.includes('venda')) || k.includes('primeira')) return 'Novo';
            if (k === 'aditivo') return 'Aditivo';
            if (k === 'renegociação' || k === 'renegociacao' || k === 'renovação' || k === 'renovacao') return 'Renegociação';
            if (k === 'tt' || k === 'transferência') return 'Renegociação';
            return 'Novo';
        }
        function tipoOptionsHtml(sel) {
            if (!__tiposBackend || __tiposBackend.length === 0) {
                return '<option value="" disabled selected>Carregando...</option>';
            }
            return __tiposBackend.map(t => `<option value="${t.nome}" ${String(sel||'')===t.nome?'selected':''}>${t.nome}</option>`).join('');
        }
        function pctAtualOptionsHtml(sel) {
            return ['<option value="">Selecione</option>'].concat(pctsDadosDisponiveis.map(p => `<option value="${p}" ${String(sel||'')===p?'selected':''}>${p}</option>`)).join('');
        }
        function getNegTipo() {
            const n = __negociacaoInfo || {};
            return normalizeTipo(n.tipo || '');
        }
        function getFilteredCategorias(tipoLinha) {
            const key = normalizeTipo(tipoLinha || '');
            if (!key) return (__categorias || []).slice();
            return (__categorias || []).filter(c => normalizeTipo(c.tipo) === key);
        }
        function setLoading(active) {
            const el = document.getElementById('loadingDots');
            if (active) {
                if (!el) return;
                let dots = 0;
                clearInterval(__loadingTimer);
                __loadingTimer = setInterval(() => {
                    dots = (dots + 1) % 4;
                    el.textContent = 'Carregando' + '.'.repeat(dots);
                }, 450);
            } else {
                clearInterval(__loadingTimer);
            }
        }
        async function initConfiguracao() {
            await carregarTiposBackend();
            await carregarCategorias();
            await carregarProdutos();
            construirMapa();
            __linhas = [{
                id: 1,
                portabilidade: 'Não',
                operadoraDoadora: '',
                ddd: '',
                tipoNegociacao: 'Novo',
                numero: '',
                planoAtualGB: '',
                precoAtual: 0,
                numeroPortar: '',
                quantidade: 1,
                categoria: (getFilteredCategorias('Novo')[0]?.nome || (__categorias[0]?.nome || '')),
                plano: '',
                pct: '',
                valorPlano: 0,
                temAparelho: 'Não',
                modeloAparelho: '',
                tipoAparelho: '',
                valorAparelho: 0,
                valorParcela: 0
            }];
            await carregarClienteBasico();
            await carregarPropostaSalva();
            bindActions();
            bindEditModalEvents();
            renderClienteBasico();
            renderTabela();
            renderResumo();
            if (window.lucide && typeof window.lucide.createIcons === 'function') window.lucide.createIcons();
        }
        async function carregarTiposBackend() {
            try {
                const list = await api('/types', { method: 'GET' });
                __tiposBackend = Array.isArray(list) ? list : [];
            } catch { __tiposBackend = []; }
        }
        async function carregarCategorias() {
            try {
                const list = await api('/categories', { method: 'GET' });
                __categorias = Array.isArray(list) ? list : [];
            } catch { __categorias = []; }
        }
        async function carregarProdutos() {
            try {
                const list = await api('/products', { method: 'GET' });
                __produtos = Array.isArray(list) ? list : [];
            } catch { __produtos = []; }
        }
        function construirMapa() {
            const map = {};
            __produtos.forEach(p => {
                const catId = p.categoria_id;
                if (!map[catId]) map[catId] = [];
                map[catId].push(p);
            });
            __map = map;
        }
        function bindActions() {
            const addBtn = document.getElementById('addLinhaBtn');
            const salvarBtn = document.getElementById('salvarBtn');
            const copiarBtn = document.getElementById('copiarBtn');
            const relatorioBtn = document.getElementById('relatorioBtn');
            const novaBtn = document.getElementById('novaBtn');
            try {
                const u = JSON.parse(localStorage.getItem('authUser') || '{}');
                const role = String(u && u.role ? u.role : '');
                __isLocked = (role !== 'admin' && __negociacaoStatus === 'Concluída');
            } catch { __isLocked = false; }
            if (addBtn) addBtn.addEventListener('click', () => {
                const nextId = (__linhas.reduce((acc, l) => Math.max(acc, Number(l.id)), 0) || 0) + 1;
                __linhas.push({
                    id: nextId,
                    quantidade: 1,
                    ddd: '',
                    tipoNegociacao: 'Novo',
                    numero: '',
                    planoAtualGB: '',
                    precoAtual: 0,
                    categoria: (getFilteredCategorias('Novo')[0]?.nome || (__categorias[0]?.nome || '')),
                    plano: '',
                    pct: '',
                    valorPlano: 0,
                    temAparelho: 'Não',
                    modeloAparelho: '',
                    tipoAparelho: '',
                    valorAparelho: 0,
                    valorParcela: 0
                });
                renderTabela();
                renderResumo();
                salvarProposta(null, false);
            });
            if (salvarBtn) salvarBtn.addEventListener('click', salvarProposta);
            if (copiarBtn) copiarBtn.addEventListener('click', copiarProposta);
            if (relatorioBtn) relatorioBtn.addEventListener('click', gerarRelatorioPdf);
            if (novaBtn) {
                const modal = document.getElementById('confirmResetModal');
                const btnClose = document.getElementById('confirmResetClose');
                const btnCancel = document.getElementById('confirmResetCancel');
                const btnConfirm = document.getElementById('confirmResetConfirm');
                const open = () => { if (modal) { modal.classList.add('show'); if (window.lucide && typeof window.lucide.createIcons === 'function') window.lucide.createIcons(); } };
                const close = () => { if (modal) modal.classList.remove('show'); };
                novaBtn.addEventListener('click', open);
                if (btnClose) btnClose.addEventListener('click', close);
                if (btnCancel) btnCancel.addEventListener('click', close);
                if (btnConfirm) btnConfirm.addEventListener('click', () => { close(); novaProposta(); });
            }
            const anotacoesEl = document.getElementById('fAnotacoes');
            if (anotacoesEl) anotacoesEl.addEventListener('blur', () => salvarProposta(null, false));
            const statusSel = document.getElementById('fStatus');
            if (statusSel) {
                statusSel.value = __negociacaoStatus || 'Em andamento';
                statusSel.addEventListener('change', async (e) => {
                    const val = String(e.currentTarget.value || '');
                        if (!__negociacaoId) return;
                        if (val === 'Todos') { toast('Selecione um status válido', 'error'); statusSel.value = __negociacaoStatus; return; }
                        try {
                            await api(`/negotiations/${__negociacaoId}`, { method: 'PUT', body: JSON.stringify({ status: val }) });
                            __negociacaoStatus = val;
                            toast('Status atualizado', 'success');
                            const statusEl = document.getElementById('negStatusLabel');
                            if (statusEl) statusEl.textContent = __negociacaoStatus;
                            try {
                                const u = JSON.parse(localStorage.getItem('authUser') || '{}');
                                const role = String(u && u.role ? u.role : '');
                                __isLocked = (role !== 'admin' && __negociacaoStatus === 'Concluída');
                            } catch { __isLocked = false; }
                            if (__isLocked) {
                                statusSel.disabled = true;
                                const addBtn = document.getElementById('addLinhaBtn');
                                const salvarBtn = document.getElementById('salvarBtn');
                                const novaBtn = document.getElementById('novaBtn');
                                if (addBtn) addBtn.disabled = true;
                                if (salvarBtn) salvarBtn.disabled = true;
                                if (novaBtn) novaBtn.disabled = true;
                                renderTabela();
                            }
                        } catch {
                            toast('Erro ao atualizar status', 'error');
                            statusSel.value = __negociacaoStatus;
                        }
                    });
                if (__isLocked) statusSel.disabled = true;
            }
            if (__isLocked) {
                if (addBtn) addBtn.disabled = true;
                if (salvarBtn) salvarBtn.disabled = true;
                if (novaBtn) novaBtn.disabled = true;
            }
        }
        function atualizarLinha(id, campo, valor) {
            __linhas = __linhas.map(l => {
                if (Number(l.id) !== Number(id)) return l;
                const novo = { ...l, [campo]: valor };
                if (campo === 'tipoNegociacao') {
                    const catsByTipo = getFilteredCategorias(valor);
                    novo.categoria = (catsByTipo[0]?.nome || '');
                    novo.plano = '';
                    novo.pct = '';
                    novo.valorPlano = 0;
                }
                if (campo === 'categoria') {
                    novo.plano = '';
                    novo.pct = '';
                    novo.valorPlano = 0;
                }
                if (campo === 'plano') {
                    const catsByTipo = getFilteredCategorias(l.tipoNegociacao);
                    const catObj = catsByTipo.find(c => c.nome === l.categoria);
                    const planos = catObj ? (__map[catObj.id] || []) : [];
                    const sel = planos.find(p => p.nome === valor);
                    if (sel) {
                        const baseTxt = sel.descricao || sel.nome || '';
                        novo.pct = parsePctFromText(baseTxt);
                        novo.valorPlano = Number(sel.preco || 0);
                    } else {
                        novo.pct = '';
                        novo.valorPlano = 0;
                    }
                }
                if (campo === 'quantidade') {
                    const q = Number(valor || 1);
                    novo.quantidade = (isFinite(q) && q > 0) ? q : 1;
                }
                if (campo === 'precoAtual') {
                    const v = Number(valor || 0);
                    novo.precoAtual = (isFinite(v) && v >= 0) ? v : 0;
                }
                if (campo === 'portabilidade') {
                    const v = String(valor || 'Não');
                    if (v !== 'Sim') {
                        novo.portabilidade = 'Não';
                        novo.operadoraDoadora = '';
                        // novo.ddd = ''; // DDD mantido
                        novo.numeroPortar = '';
                    } else {
                        novo.portabilidade = 'Sim';
                    }
                }
                if (campo === 'numeroPortar') {
                    novo.numeroPortar = formatNumeroPortar(valor);
                }
                if (campo === 'numero') {
                    novo.numero = formatNumeroPortar(valor);
                }
                if (campo === 'temAparelho') {
                    if (valor !== 'Sim') {
                        novo.temAparelho = 'Não';
                        novo.modeloAparelho = '';
                        novo.tipoAparelho = '';
                        novo.valorAparelho = 0;
                        novo.valorParcela = 0;
                    } else {
                        novo.temAparelho = 'Sim';
                    }
                }
                if (campo === 'tipoAparelho') {
                    if (valor === 'Comodato') {
                        novo.valorAparelho = 0;
                        novo.valorParcela = 0;
                    } else if (valor === 'VF 24x') {
                         if (novo.valorAparelho > 0) {
                             novo.valorParcela = novo.valorAparelho / 24;
                         }
                    }
                }
                if (campo === 'valorAparelho') {
                    const v = Number(valor || 0);
                    novo.valorAparelho = (isFinite(v) && v >= 0) ? v : 0;
                    if (novo.tipoAparelho === 'VF 24x') {
                        novo.valorParcela = novo.valorAparelho / 24;
                    }
                }
                return novo;
            });
            renderTabela();
            renderResumo();
            salvarProposta(null, false);
        }
        function removerLinha(id) {
            if (__linhas.length <= 1) {
                toast('Não é possível excluir a única linha.', 'error');
                return;
            }
            __linhas = __linhas.filter(l => Number(l.id) !== Number(id));
            renderTabela();
            renderResumo();
            salvarProposta(null, false);
        }
        function totalLinha(l) {
            const q = Number(l.quantidade || 1);
            const v = Number(l.valorPlano || 0);
            const base = q * v;
            // O valor do aparelho não deve somar no total da linha (solicitação do usuário)
            return base;
        }
        function totalGeral() {
            return __linhas.reduce((acc, l) => acc + totalLinha(l), 0);
        }
        function formatNumeroPortar(valor) {
            const digs = String(valor || '').replace(/\D/g, '').slice(0, 9);
            if (digs.length <= 5) return digs;
            return digs.slice(0, 5) + '-' + digs.slice(5);
        }
        let __currentEditId = null;

        function openEditModal(id) {
            const line = __linhas.find(l => Number(l.id) === Number(id));
            if (!line) return;
            __currentEditId = id;

            const modal = document.getElementById('editLineModal');
            if (!modal) return;
            document.getElementById('editLineId').value = id;

            // Helper to populate select
            const populate = (id, opts, val) => {
                const el = document.getElementById(id);
                if (el) {
                    el.innerHTML = opts;
                    el.value = val;
                }
            };

            // DDD
            const ddds = [11,12,13,14,15,16,17,18,19,21,22,24,27,28,31,32,33,34,35,37,38,41,42,43,44,45,46,47,48,49,51,53,54,55,61,62,63,64,65,66,67,68,69,71,73,74,75,77,79,81,82,83,84,85,86,87,88,89,91,92,93,94,95,96,97,98,99];
            const dddOpts = ['<option value="">DDD</option>'].concat(ddds.map(d => `<option value="${d}">${d}</option>`)).join('');
            populate('editDdd', dddOpts, line.ddd);

            // Tipo
            populate('editTipo', tipoOptionsHtml(line.tipoNegociacao), line.tipoNegociacao);
            
            // Numero
            const numEl = document.getElementById('editNumero');
            if (numEl) numEl.value = line.numero || '';

            // Plano Atual
            populate('editPlanoAtual', pctAtualOptionsHtml(line.planoAtualGB), line.planoAtualGB);

            // Preco Atual
            const precoEl = document.getElementById('editPrecoAtual');
            if (precoEl) precoEl.value = line.precoAtual || 0;

            // Portabilidade
            populate('editPortabilidade', '<option value="Não">Não</option><option value="Sim">Sim</option>', line.portabilidade);

            // Operadora Doadora
            const ops = ['Claro','Vivo','TIM','Oi'];
            const opOpts = ['<option value="">Selecione...</option>'].concat(ops.map(o => `<option value="${o}">${o}</option>`)).join('');
            populate('editOperadora', opOpts, line.operadoraDoadora);

            // Numero Portar
            const numPortEl = document.getElementById('editNumeroPortar');
            if (numPortEl) numPortEl.value = line.numeroPortar || '';

            // Categoria (Filtered by Tipo)
            const catsByTipo = getFilteredCategorias(line.tipoNegociacao);
            const catOpts = catsByTipo.map(c => `<option value="${c.nome}">${c.nome}</option>`).join('');
            populate('editCategoria', catOpts, line.categoria);

            // Plano (Filtered by Categoria)
            const currentCat = catsByTipo.find(c => c.nome === line.categoria);
            const planos = currentCat ? (__map[currentCat.id] || []) : [];
            const planoOpts = ['<option value="">Selecione um plano...</option>'].concat(
                planos.map(p => `<option value="${p.nome}">${p.nome}</option>`)
            ).join('');
            populate('editPlano', planoOpts, line.plano);

            // Read-only fields
            const pctEl = document.getElementById('editPct');
            if (pctEl) pctEl.textContent = line.pct || '-';
            
            const valPlanoEl = document.getElementById('editValorPlano');
            if (valPlanoEl) valPlanoEl.textContent = currency(line.valorPlano);

            // Aparelho
            populate('editTemAparelho', '<option value="Não">Não</option><option value="Sim">Sim</option>', line.temAparelho);
            populate('editTipoAparelho', '<option value="Comodato">Comodato</option><option value="VF 24x">VF 24x</option>', line.tipoAparelho);
            
            const modeloEl = document.getElementById('editModeloAparelho');
            if (modeloEl) modeloEl.value = line.modeloAparelho || '';
            
            const valApEl = document.getElementById('editValorAparelho');
            if (valApEl) valApEl.value = line.valorAparelho || 0;

            const valParcEl = document.getElementById('editValorParcela');
            if (valParcEl) valParcEl.textContent = currency(line.valorParcela);

            // Recalculo automatico se houver portabilidade e VF 24x
            if (line.portabilidade === 'Sim' && line.tipoAparelho === 'VF 24x') {
                const valAp = Number(line.valorAparelho || 0);
                if (valParcEl) valParcEl.textContent = currency(valAp / 24);
            }

            // Update UI state (enable/disable fields)
            updateEditModalState();

            modal.classList.add('show');
            if (window.lucide && typeof window.lucide.createIcons === 'function') window.lucide.createIcons();
        }

        function updateEditModalState() {
            if (!__currentEditId) return;
            const line = __linhas.find(l => Number(l.id) === Number(__currentEditId));
            
            const tipo = document.getElementById('editTipo').value;
            const isReneg = normalizeTipo(tipo).toLowerCase().includes('reneg');
            const port = document.getElementById('editPortabilidade').value;
            const temAp = document.getElementById('editTemAparelho').value;
            const tipoAp = document.getElementById('editTipoAparelho').value;

            const numEl = document.getElementById('editNumero');
            if (numEl) numEl.disabled = !isReneg;

            const isNovo = ['Novo','Aditivo'].includes(normalizeTipo(tipo));
            const paEl = document.getElementById('editPlanoAtual');
            if (paEl) paEl.disabled = isNovo;
            const praEl = document.getElementById('editPrecoAtual');
            if (praEl) praEl.disabled = isNovo;

            const portDetails = document.getElementById('areaPortabilidadeDetails');
            if (portDetails) portDetails.style.display = (port === 'Sim') ? 'grid' : 'none';

            const opEl = document.getElementById('editOperadora');
            if (opEl) opEl.disabled = (port !== 'Sim');
            const npEl = document.getElementById('editNumeroPortar');
            if (npEl) npEl.disabled = (port !== 'Sim');

            const apDetails = document.getElementById('areaAparelhoDetails');
            if (apDetails) apDetails.style.display = (temAp === 'Sim') ? 'block' : 'none';

            const tipoApEl = document.getElementById('editTipoAparelho');
            if (tipoApEl) tipoApEl.disabled = (temAp !== 'Sim');
            const modApEl = document.getElementById('editModeloAparelho');
            if (modApEl) modApEl.disabled = (temAp !== 'Sim');
            const valApEl = document.getElementById('editValorAparelho');
            if (valApEl) valApEl.disabled = (temAp !== 'Sim' || tipoAp === 'Comodato');
        }

        function bindEditModalEvents() {
            const modal = document.getElementById('editLineModal');
            if (!modal) return;

            const close = () => { modal.classList.remove('show'); __currentEditId = null; };
            document.getElementById('editLineClose').onclick = close;
            document.getElementById('editLineCancel').onclick = close;

            const fields = ['editTipo', 'editPortabilidade', 'editTemAparelho', 'editTipoAparelho', 'editCategoria', 'editPlano', 'editValorAparelho'];
            fields.forEach(fid => {
                const el = document.getElementById(fid);
                if (el) el.addEventListener('change', () => handleEditModalChange(fid));
            });
            
            // Adicionar input listener para cálculo em tempo real do valor do aparelho
            const valApInput = document.getElementById('editValorAparelho');
            if (valApInput) {
                valApInput.addEventListener('input', () => handleEditModalChange('editValorAparelho'));
            }
            
            ['editNumero', 'editNumeroPortar'].forEach(fid => {
                const el = document.getElementById(fid);
                if (el) el.addEventListener('input', (e) => {
                    e.target.value = formatNumeroPortar(e.target.value);
                });
            });

            document.getElementById('editLineSave').onclick = () => {
                if (saveEditModal()) {
                    close();
                }
            };
        }

        function handleEditModalChange(fieldId) {
            const getValue = (id) => document.getElementById(id).value;
            const setValue = (id, v) => { const el = document.getElementById(id); if (el) el.value = v; };
            const setHTML = (id, h) => { const el = document.getElementById(id); if (el) el.innerHTML = h; };

            if (fieldId === 'editTipo') {
                const val = getValue('editTipo');
                const catsByTipo = getFilteredCategorias(val);
                const firstCat = catsByTipo[0]?.nome || '';
                
                const catOpts = catsByTipo.map(c => `<option value="${c.nome}">${c.nome}</option>`).join('');
                setHTML('editCategoria', catOpts);
                setValue('editCategoria', firstCat);
                handleEditModalChange('editCategoria');
            }

            if (fieldId === 'editCategoria') {
                const catVal = getValue('editCategoria');
                const tipoVal = getValue('editTipo');
                const catsByTipo = getFilteredCategorias(tipoVal);
                const catObj = catsByTipo.find(c => c.nome === catVal);
                const planos = catObj ? (__map[catObj.id] || []) : [];
                
                const planoOpts = ['<option value="">Selecione um plano...</option>'].concat(
                    planos.map(p => `<option value="${p.nome}">${p.nome}</option>`)
                ).join('');
                setHTML('editPlano', planoOpts);
                setValue('editPlano', '');
                handleEditModalChange('editPlano');
            }

            if (fieldId === 'editPlano') {
                const planoVal = getValue('editPlano');
                const catVal = getValue('editCategoria');
                const tipoVal = getValue('editTipo');
                const catsByTipo = getFilteredCategorias(tipoVal);
                const catObj = catsByTipo.find(c => c.nome === catVal);
                const planos = catObj ? (__map[catObj.id] || []) : [];
                const sel = planos.find(p => p.nome === planoVal);

                if (sel) {
                    const baseTxt = sel.descricao || sel.nome || '';
                    document.getElementById('editPct').textContent = parsePctFromText(baseTxt);
                    document.getElementById('editValorPlano').textContent = currency(sel.preco || 0);
                } else {
                    document.getElementById('editPct').textContent = '-';
                    document.getElementById('editValorPlano').textContent = currency(0);
                }
            }

            if (fieldId === 'editTipoAparelho' || fieldId === 'editTemAparelho' || fieldId === 'editValorAparelho') {
                const tem = getValue('editTemAparelho');
                const tipo = getValue('editTipoAparelho');
                if (tem !== 'Sim') {
                    setValue('editTipoAparelho', '');
                    setValue('editModeloAparelho', '');
                    setValue('editValorAparelho', 0);
                    document.getElementById('editValorParcela').textContent = currency(0);
                } else {
                     if (fieldId === 'editTemAparelho' && !tipo) {
                         setValue('editTipoAparelho', 'Comodato');
                         // Atualizar tipo localmente pois mudou
                     }
                     
                     const currentTipo = getValue('editTipoAparelho');
                     if (currentTipo === 'Comodato') {
                        setValue('editValorAparelho', 0);
                        document.getElementById('editValorParcela').textContent = currency(0);
                     } else if (currentTipo === 'VF 24x') {
                        const valAp = Number(getValue('editValorAparelho') || 0);
                        document.getElementById('editValorParcela').textContent = currency(valAp / 24);
                     }
                }
            }
            
            updateEditModalState();
        }

        function saveEditModal() {
            if (!__currentEditId) return false;
            const getValue = (id) => document.getElementById(id).value;
            
            const tipoVal = getValue('editTipo');
            const catVal = getValue('editCategoria');
            const planoVal = getValue('editPlano');
            
            // Validation Logic
            const erros = [];
            const normalize = (s) => String(s || '').toLowerCase();
            const isReneg = normalize(tipoVal).includes('reneg');
            
            if (isReneg) {
                const pa = getValue('editPlanoAtual');
                const pra = Number(getValue('editPrecoAtual') || 0);
                if (!pa || !pra) erros.push('Renegociações exigem Plano Atual e Preço Atual');
                
                const num = getValue('editNumero');
                if (!num || num.length < 8) erros.push('Renegociações exigem o número da linha');
            }
            
            const port = getValue('editPortabilidade');
            if (port === 'Sim') {
                const op = getValue('editOperadora');
                const np = getValue('editNumeroPortar');
                if (!op) erros.push('Selecione a Operadora Doadora para portabilidade');
                if (!np || np.length < 8) erros.push('Informe o Número a Portar válido');
            }
            
            const temAp = getValue('editTemAparelho');
            if (temAp === 'Sim') {
                const mod = getValue('editModeloAparelho');
                const valAp = Number(getValue('editValorAparelho') || 0);
                if (!mod) erros.push('Informe o modelo do aparelho');
                if (valAp <= 0 && getValue('editTipoAparelho') !== 'Comodato') erros.push('Informe o valor do aparelho');
            }

            if (!planoVal) erros.push('Selecione um plano');

            if (erros.length > 0) {
                toast('Corrija os erros: ' + erros.join('; '), 'error');
                return false;
            }

            const catsByTipo = getFilteredCategorias(tipoVal);
            const catObj = catsByTipo.find(c => c.nome === catVal);
            const planos = catObj ? (__map[catObj.id] || []) : [];
            const selPlano = planos.find(p => p.nome === planoVal);
            
            const valorPlano = selPlano ? Number(selPlano.preco || 0) : 0;
            const pct = document.getElementById('editPct').textContent;

            const valorAp = Number(getValue('editValorAparelho') || 0);
            const tipoAp = getValue('editTipoAparelho');
            let valorParcela = 0;
            if (tipoAp === 'VF 24x') valorParcela = valorAp / 24;

            __linhas = __linhas.map(l => {
                if (Number(l.id) !== Number(__currentEditId)) return l;
                return {
                    ...l,
                    ddd: getValue('editDdd'),
                    tipoNegociacao: tipoVal,
                    numero: getValue('editNumero'),
                    planoAtualGB: getValue('editPlanoAtual'),
                    precoAtual: Number(getValue('editPrecoAtual') || 0),
                    portabilidade: getValue('editPortabilidade'),
                    operadoraDoadora: getValue('editOperadora'),
                    numeroPortar: getValue('editNumeroPortar'),
                    categoria: catVal,
                    plano: planoVal,
                    pct: pct === '-' ? '' : pct,
                    valorPlano: valorPlano,
                    temAparelho: getValue('editTemAparelho'),
                    tipoAparelho: tipoAp,
                    modeloAparelho: getValue('editModeloAparelho'),
                    valorAparelho: valorAp,
                    valorParcela: valorParcela
                };
            });
            
            renderTabela();
            renderResumo();
            salvarProposta(null, false);
            return true;
        }

        function copiarLinha(id) {
            const src = __linhas.find(x => Number(x.id) === Number(id));
            if (!src) return;
            const nextId = (__linhas.reduce((acc, l) => Math.max(acc, Number(l.id)), 0) || 0) + 1;
            __linhas.push({
                id: nextId,
                portabilidade: src.portabilidade || 'Não',
                operadoraDoadora: src.operadoraDoadora || '',
                ddd: src.ddd || '',
                tipoNegociacao: src.tipoNegociacao || 'Novo',
                numero: src.numero || '',
                planoAtualGB: src.planoAtualGB || '',
                precoAtual: Number(src.precoAtual || 0),
                numeroPortar: src.numeroPortar || '',
                quantidade: Number(src.quantidade || 1),
                categoria: src.categoria || (__categorias[0]?.nome || ''),
                plano: src.plano || '',
                pct: src.pct || '',
                valorPlano: src.valorPlano || 0,
                temAparelho: src.temAparelho || 'Não',
                modeloAparelho: src.modeloAparelho || '',
                tipoAparelho: src.tipoAparelho || '',
                valorAparelho: Number(src.valorAparelho || 0),
                valorParcela: Number(src.valorParcela || 0)
            });
            renderTabela();
            renderResumo();
            salvarProposta(null, false);
        }
        function renderTabela() {
            const tbody = document.getElementById('itensTbody');
            if (!__categorias.length && !__produtos.length) {
                tbody.innerHTML = `
                    <tr><td colspan="5">
                        <div id="loadingDots" class="muted" style="padding:0.8rem; text-align:center; font-weight:600;">Carregando</div>
                    </td></tr>
                `;
                setLoading(true);
                return;
            }
            setLoading(false);
            const rows = __linhas.map((l, idx) => {
                return `
                    <tr>
                        <td>${idx + 1}</td>
                        <td>${l.tipoNegociacao || '-'}</td>
                        <td>
                            <input type="number" min="1" class="input" style="width:90px; text-align:center;" value="${l.quantidade}"
                                   data-id="${l.id}" data-field="quantidade">
                        </td>
                        <td>${currency(totalLinha(l))}</td>
                        <td class="col-actions">
                            <div class="table-actions">
                                <button type="button" class="btn btn-ghost btn-icon" title="Editar" onclick="openEditModal(${l.id})"><i data-lucide="settings"></i></button>
                                <button type="button" class="btn btn-ghost btn-icon" title="Copiar" onclick="copiarLinha(${l.id})"><i data-lucide="copy"></i></button>
                                <button type="button" class="btn btn-ghost btn-icon" title="Remover" data-id="${l.id}" data-action="remover" style="border-color: rgba(239,68,68,0.35); color: #FCA5A5;" ${__linhas.length <= 1 ? 'disabled' : ''}><i data-lucide="trash-2"></i></button>
                            </div>
                        </td>
                    </tr>
                `;
            }).join('');
            document.getElementById('countItensLabel').textContent = `${__linhas.length} ${__linhas.length === 1 ? 'item' : 'itens'}`;
            tbody.innerHTML = rows || '<tr><td colspan="5" class="muted">Sem itens</td></tr>';
            
            Array.from(tbody.querySelectorAll('input[data-field="quantidade"]')).forEach(el => {
                el.addEventListener('change', (e) => {
                    const id = Number(e.currentTarget.getAttribute('data-id') || 0);
                    const val = e.currentTarget.value;
                    atualizarLinha(id, 'quantidade', val);
                });
            });

            if (__isLocked) {
                Array.from(tbody.querySelectorAll('input[data-field]')).forEach(el => { el.disabled = true; });
                Array.from(tbody.querySelectorAll('button')).forEach(btn => { btn.disabled = true; });
            }
            
            Array.from(tbody.querySelectorAll('button[data-action="remover"]')).forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const id = Number(e.currentTarget.getAttribute('data-id') || 0);
                    removerLinha(id);
                });
            });
            if (window.lucide && typeof window.lucide.createIcons === 'function') window.lucide.createIcons();
        }
        function renderResumo() {
            const total = totalGeral();
            const acessos = __linhas.reduce((acc, l) => acc + Number(l.quantidade || 0), 0);
            const itens = __linhas.map((l, idx) => `${idx + 1}. ${l.plano || '-'}`).join(' • ') || '-';
            const elTotal = document.getElementById('resumoTotal');
            const elAcessos = document.getElementById('resumoAcessos');
            const elItens = document.getElementById('resumoItens');
            if (elTotal) elTotal.textContent = currency(total);
            if (elAcessos) elAcessos.textContent = `${acessos} ${acessos === 1 ? 'acesso' : 'acessos'}`;
            if (elItens) elItens.textContent = itens;
        }
        function validar() {
            const erros = [];
            __linhas.forEach((l, idx) => {
                const q = Number(l.quantidade || 0);
                if (!q || q < 1) erros.push(`Linha ${idx + 1}: Quantidade deve ser pelo menos 1`);
                if (!l.plano) erros.push(`Linha ${idx + 1}: Selecione um plano`);
            });
            return erros;
        }
        function gerarResumoTexto() {
            const linhasTxt = __linhas.map((l, idx) => {
                return [
                    `[ITEM ${idx + 1}]`,
                    `Qtd: ${Number(l.quantidade || 1)}`,
                    `Categoria: ${l.categoria || '-'}`,
                    `Plano: ${l.plano || '-'}`,
                    `Pacote: ${l.pct || 'N/A'}`,
                    `Valor unitário: ${currency(l.valorPlano)}`,
                    `Total da linha: ${currency(totalLinha(l))}`
                ].join('\n');
            }).join('\n' + '─'.repeat(50) + '\n');
            const total = currency(totalGeral());
            const acessos = __linhas.reduce((acc, l) => acc + Number(l.quantidade || 0), 0);
            const header = [
                '=== PROPOSTA PADRÃO ===',
                `Data: ${new Date().toLocaleString('pt-BR')}`,
                `Total de linhas: ${__linhas.length}`,
                ''
            ].join('\n');
            const resumo = [
                '\n--- RESUMO FINANCEIRO ---',
                `Valor Total Mensal: ${total}`,
                `Total de Acessos: ${acessos}`
            ].join('\n');
            return header + linhasTxt + '\n' + resumo;
        }
        function gerarMensagemBonita() {
            const total = currency(totalGeral());
            
            const extractMB = (str) => {
                if (!str) return 0;
                const match = str.match(/(\d+(?:[.,]\d+)?)\s*(GB|MB|KB)/i);
                if (!match) return 0;
                let val = parseFloat(match[1].replace(',', '.'));
                const unit = match[2].toUpperCase();
                if (unit === 'GB') return val * 1024;
                if (unit === 'MB') return val;
                if (unit === 'KB') return val / 1024;
                return 0;
            };
            const formatMB = (mb) => {
                if (mb <= 0) return '0 GB';
                if (mb >= 1024) {
                    const gb = mb / 1024;
                    return (gb % 1 === 0 ? gb.toFixed(0) + ' GB' : gb.toFixed(1).replace('.', ',') + ' GB');
                }
                return Math.round(mb) + ' MB';
            };

            let totalDadosNovoMB = 0;
            let totalDadosAtualMB = 0;
            __linhas.forEach(l => {
                const qtd = Number(l.quantidade || 1);
                totalDadosNovoMB += extractMB(l.plano) * qtd;
                totalDadosAtualMB += extractMB(l.planoAtualGB) * qtd;
            });

            const c = __clienteInfo || {};
            const endParts = [];
            if (c.street) endParts.push(c.street);
            if (c.number) endParts.push(c.number);
            if (c.neighborhood) endParts.push(c.neighborhood);
            if (c.city) endParts.push(c.city + (c.state ? '-' + c.state : ''));
            if (c.cep) endParts.push(c.cep);
            const endereco = endParts.join(', ');

            const contatoParts = [];
            if (c.phone) contatoParts.push(formatPhone(c.phone));
            if (c.email) contatoParts.push(c.email);
            const contato = contatoParts.join(' • ');

            const header = [
                '✨ Proposta Padrão • Maxximus Telecom',
                '🏢 Cliente: ' + ((document.getElementById('clienteNome').textContent) || '-'),
                '🧾 CNPJ: ' + ((document.getElementById('clienteCnpj').textContent) || '-'),
                (endereco ? '📍 Endereço: ' + endereco : ''),
                (contato ? '📞 Contato: ' + contato : ''),
                '� Tipo: ' + ((document.getElementById('negTipo').textContent) || '-'),
                '� Status: ' + ((document.getElementById('negStatusLabel').textContent) || '-'),
                '───────────────────────────────────'
            ].filter(l => l !== '').join('\n');
            const linhasTxt = __linhas.map((l, idx) => {
                const tipo = String(l.tipoNegociacao || 'Novo').toLowerCase();
                const em = tipo.includes('reneg') ? '🔁' : (tipo.includes('adti') || tipo.includes('adit') ? '➕' : '🌟');
                const dddTxt = l.ddd ? `DDD ${l.ddd}` : '-';
                const numTxt = l.numero ? `\n    Número: ${l.numero}` : '';
                
                // Na proposta padrão não temos "Atual" detalhado, então omitimos ou deixamos traço
                const atual = `- R$ 0,00`; 
                const proposto = `${l.plano || '-'} ${l.pct || '-'}`;
                const desc = '0%'; // Padrão não tem calculo explicito de desconto visualizado na tabela da mesma forma, mas se tiver pct, poderia ser. Vamos deixar fixo ou ajustavel se precisar.
                // Ajustando para o template solicitado
                // Campos solicitados anteriormente: Quantidade, Unitário, Total.
                // O template do usuário mostra: Tipo, Atual, Proposto, Não Fid, Desconto, Preço Final, Economia.
                // Mas o usuário pediu "ajuste os textos que te falei" (colocar quantidade, preço unitario, preço total, retirar valor nao fidelizado, retirar economia...).
                // Então vou mesclar o DESIGN do template com os DADOS que ele pediu.
                
                /*
                   Pedido anterior:
                   - colocar quantidade
                   - colocar preço unitario
                   - colocar preço total
                   - retirar valor nao fidelizado
                   - retirar economia
                   - resumo: receita atual -> plano atual
                   - resumo: proposta -> nova proposta
                   - resumo: retirar economia
                   - resumo: retirar total de acessos
                   - resumo: colocar total de dados atual
                   - resumo: colocar total de dados nova proposta
                */

                const unitario = currency(l.valorPlano);
                const totalLinhaVal = currency(totalLinha(l));
                
                return `${em} Linha ${idx + 1}
    Qtd: ${l.quantidade}
    DDD: ${dddTxt}${numTxt}
    Tipo: ${l.tipoNegociacao || '-'}
    Proposto: ${proposto}
    Unitário: ${unitario}
    Total: ${totalLinhaVal}`;
            }).join('\n\n');
            
            const resumo = [
                '',
                '📊 Resumo',
                `   💰 Proposta Atual: R$ 0,00`, // Na padrão não temos valor atual detalhado
                `   🧾 Nova Proposta: ${total}`,
                `   📦 Total de dados atual: ${formatMB(totalDadosAtualMB)}`,
                `   🔢 Total de dados da nova proposta: ${formatMB(totalDadosNovoMB)}`,
                '',
                '🚀 Maxximus Telecom • Conectando sua empresa ao futuro'
            ].join('\n');
            return header + '\n\n' + linhasTxt + '\n\n' + resumo;
        }
        function gerarRelatorioPdf() {
            try {
                const lib = window.jspdf || {};
                const jsPDF = lib.jsPDF;
                if (!jsPDF || !document || !document.body) { toast('Biblioteca de PDF indisponível', 'error'); return; }
                const doc = new jsPDF({ unit: 'pt', format: 'a4' });
                const n = __negociacaoInfo || {};
                const c = __clienteInfo || {};
                const acessos = __linhas.reduce((acc, l) => acc + Number(l.quantidade || 0), 0);
                const total = currency(totalGeral());
                doc.setFontSize(14);
                doc.text('Relatório da Proposta', 40, 40);
                doc.setFontSize(9);
                doc.text('Gerado em ' + new Date().toLocaleString('pt-BR'), 40, 56);
                try {
                    const u = JSON.parse(localStorage.getItem('authUser') || '{}');
                    if (u && u.name) {
                        doc.text('Consultor: ' + u.name, 40, 68);
                    }
                } catch {}
                doc.setFontSize(10);
                doc.text('Total mensal: ' + total, 450, 40, { align: 'right' });
                doc.autoTable({
                    startY: 80,
                    head: [['Campo', 'Valor']],
                    body: [
                        ['Nome', c.name || '-'],
                        ['CNPJ', formatCnpj(n.cnpj || c.cnpj || '')],
                        ['Email', c.email || '-'],
                        ['Telefone', formatPhone(c.phone || '') || '-']
                    ],
                    styles: { fontSize: 9 },
                    headStyles: { fillColor: [243, 244, 246], textColor: [55, 65, 81] },
                    theme: 'grid',
                    margin: { left: 40, right: 40 }
                });
                doc.autoTable({
                    startY: doc.lastAutoTable.finalY + 12,
                    head: [['Campo', 'Valor']],
                    body: [
                        ['Tipo', n.tipo || '-'],
                        ['Proposta', n.proposta || '-'],
                        ['Data', n.data || '-'],
                        ['Status', __negociacaoStatus || (n.status || '-')]
                    ],
                    styles: { fontSize: 9 },
                    headStyles: { fillColor: [243, 244, 246], textColor: [55, 65, 81] },
                    theme: 'grid',
                    margin: { left: 40, right: 40 }
                });
                const head = [['#','Qtd','DDD','Tipo','Portabilidade','Operadora Doadora','Número a Portar','Categoria','Plano','Pct','Valor Plano','Total Linha','Aparelho','Modelo','Tipo Aparelho','Valor Aparelho']];
                const body = (__linhas || []).map((l, idx) => ([
                    String(idx + 1),
                    String(Number(l.quantidade || 0)),
                    String(l.ddd || '-'),
                    String(l.tipoNegociacao || '-'),
                    String(l.numero || '-'),
                    String(l.portabilidade || '-'),
                    String(l.operadoraDoadora || '-'),
                    String(l.numeroPortar || '-'),
                    String(l.categoria || '-'),
                    String(l.plano || '-'),
                    String(l.pct || '-'),
                    String(currency(l.valorPlano)),
                    String(currency(totalLinha(l))),
                    String(l.temAparelho || '-'),
                    String(l.modeloAparelho || '-'),
                    String(l.tipoAparelho || '-'),
                    String(currency(l.valorAparelho))
                ]));
                doc.setFontSize(12);
                const pageHeight = doc.internal.pageSize.getHeight();
                let startY = (doc.lastAutoTable && doc.lastAutoTable.finalY ? doc.lastAutoTable.finalY : 80) + 24;
                doc.text('Itens da Proposta', 40, startY - 12);
                let currentY = startY;
                const linhasArr = Array.isArray(__linhas) ? __linhas : [];
                if (!linhasArr.length) {
                    doc.setFontSize(9);
                    doc.text('Sem itens', 40, currentY + 6);
                    currentY += 20;
                } else {
                    linhasArr.forEach((l, idx) => {
                        if (currentY > pageHeight - 160) {
                            doc.addPage();
                            currentY = 80;
                            doc.setFontSize(12);
                            doc.text('Itens da Proposta (cont.)', 40, currentY - 12);
                        }
                        doc.autoTable({
                            startY: currentY,
                            head: [['Campo', 'Valor']],
                            body: [
                                ['Item', String(idx + 1)],
                                ['Qtd', String(Number(l.quantidade || 0))],
                                ['DDD', String(l.ddd || '-')],
                                ['Tipo', String(l.tipoNegociacao || '-')],
                                ['Plano Atual', String(l.planoAtualGB || '-')],
                                ['Preço Atual', String(currency(l.precoAtual))],
                                ['Portabilidade', String(l.portabilidade || '-')],
                                ['Operadora Doadora', String(l.operadoraDoadora || '-')],
                                ['Número a Portar', String(l.numeroPortar || '-')],
                                ['Categoria', String(l.categoria || '-')],
                                ['Plano', String(l.plano || '-')],
                                ['Pct', String(l.pct || '-')],
                                ['Valor Plano', String(currency(l.valorPlano))],
                                ['Total Linha', String(currency(totalLinha(l)))],
                                ['Aparelho', String(l.temAparelho || '-')],
                                ['Modelo', String(l.modeloAparelho || '-')],
                                ['Tipo Aparelho', String(l.tipoAparelho || '-')],
                                ['R$ Total Aparelho', String(currency(l.valorAparelho))],
                                ['R$ da Parcela', String(currency(l.valorParcela))]
                            ],
                            styles: { fontSize: 9, cellPadding: 3 },
                            headStyles: { fillColor: [243, 244, 246], textColor: [55, 65, 81] },
                            showHead: 'firstPage',
                            theme: 'grid',
                            margin: { left: 40, right: 40 }
                        });
                        currentY = (doc.lastAutoTable && doc.lastAutoTable.finalY ? doc.lastAutoTable.finalY : currentY) + 10;
                    });
                }
                if (currentY > pageHeight - 40) {
                    doc.addPage();
                    currentY = 40;
                }
                doc.setFontSize(9);
                doc.text('Total de acessos: ' + String(acessos) + ' • Valor total mensal: ' + total, 40, currentY + 14);
                const nomeArquivo = 'Relatorio_Proposta_' + String((n.cnpj || c.cnpj || '').replace(/\D/g, '') || 'sem-cnpj') + '_' + String(new Date().toISOString().slice(0,10)) + '.pdf';
                doc.save(nomeArquivo);
            } catch {
                toast('Erro ao gerar relatório', 'error');
            }
        }
        function salvarProposta(evt, shouldReload = true, skipValidation = false) {
            if (!skipValidation) {
                const erros = validar();
                if (erros.length) {
                    toast('Corrija os seguintes problemas: ' + erros.join('; '), 'error');
                    return;
                }
            }
            try {
                if (!__negociacaoId) return;
                const anotacoes = document.getElementById('fAnotacoes').value || '';
                api(`/negotiations/${__negociacaoId}/proposal`, {
                    method: 'POST',
                    body: JSON.stringify({ linhas: __linhas, anotacoes })
                }).then(async () => {
                    const totalNeg = __linhas.reduce((acc, l) => {
                        const q = Number(l.quantidade || 1);
                        const v = Number(l.valorPlano || 0);
                        // const p = Number(l.valorParcela || 0); // Removido para bater com o totalGeral visual
                        return acc + (q * v);
                    }, 0);
                    await api(`/negotiations/${__negociacaoId}`, { method: 'PUT', body: JSON.stringify({ valor: totalNeg }) }).catch(() => {});
                    if (__negociacaoInfo) __negociacaoInfo.valor = totalNeg;

                    toast('Proposta salva', 'success');
                    if (shouldReload) {
                        await carregarPropostaSalva();
                        renderTabela();
                    }
                    renderResumo();
                }).catch(() => { toast('Erro ao salvar proposta', 'error'); });
            } catch {}
        }
        function novaProposta() {
            __linhas = [{
                id: 1,
                portabilidade: 'Não',
                operadoraDoadora: '',
                ddd: '',
                tipoNegociacao: 'Novo',
                numero: '',
                planoAtualGB: '',
                precoAtual: 0,
                numeroPortar: '',
                quantidade: 1,
                categoria: (getFilteredCategorias('Novo')[0]?.nome || (__categorias[0]?.nome || '')),
                plano: '',
                pct: '',
                valorPlano: 0,
                temAparelho: 'Não',
                modeloAparelho: '',
                tipoAparelho: '',
                valorAparelho: 0,
                valorParcela: 0
            }];
            const anotacoesEl = document.getElementById('fAnotacoes');
            if (anotacoesEl) anotacoesEl.value = '';
            renderTabela();
            renderResumo();
            salvarProposta(null, false, true);
        }
        function copiarProposta() {
            const erros = validar();
            if (erros.length) {
                toast('Corrija os seguintes problemas: ' + erros.join('; '), 'error');
                return;
            }
            try {
                const txt = gerarMensagemBonita();
                if (navigator && navigator.clipboard && typeof navigator.clipboard.writeText === 'function') {
                    navigator.clipboard.writeText(txt);
                    toast('Proposta copiada', 'success');
                }
            } catch {}
        }
    </script>
</body>
</html>
