<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Clientes • Maxximus Telecom</title>
    <link rel="icon" href="data:,">
    <link rel="stylesheet" href="style.css">
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
</head>
<body>
    <main class="container">
        <div class="card">
            <div class="card-head">
                <div class="card-title">
                    <span>Clientes</span>
                    <span class="chip" id="roleChip">Leitura para todos • Edição admin</span>
                </div>
                <div class="muted">
                    <button id="openModalBtn" class="btn btn-primary" type="button"><i data-lucide="user-plus"></i><span>Novo Cliente</span></button>
                </div>
            </div>
            <div class="card-body">
                <section class="section" style="margin-top: 20px;">
                    <div id="filtersClientes" class="filters">
                        <div>
                            <div class="label">Nome</div>
                            <input id="fNome" class="input" type="text" placeholder="Razão social" autocomplete="off">
                        </div>
                        <div>
                            <div class="label">CNPJ</div>
                            <input id="fCnpj" class="input" type="text" placeholder="00.000.000/0000-00" autocomplete="off">
                        </div>
                        <div style="display:flex; align-items:flex-end; gap:0.5rem;">
                            <button id="buscarBtn" class="btn btn-primary" type="button" title="Buscar"><i data-lucide="search"></i><span>Buscar</span></button>
                            <button id="limparBtn" class="btn btn-ghost" type="button" title="Limpar"><i data-lucide="rotate-ccw"></i><span>Limpar</span></button>
                        </div>
                    </div>
                </section>
                <section class="section" style="margin-top:1rem;">
                    <div style="display:flex; align-items:center; justify-content:space-between;">
                        <div class="label">Lista de clientes</div>
                        <div class="muted" id="countLabel">0 itens</div>
                    </div>
                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th>Nome</th>
                                    <th>CNPJ</th>
                                    <th class="col-actions" style="min-width:140px;">Ações</th>
                                </tr>
                            </thead>
                            <tbody id="clientsTbody">
                                <tr><td colspan="3">
                                    <div class="skeleton skel-row"></div>
                                    <div class="skeleton skel-row"></div>
                                    <div class="skeleton skel-row"></div>
                                    <div class="skeleton skel-row"></div>
                                    <div class="skeleton skel-row"></div>
                                </td></tr>
                            </tbody>
                        </table>
                    </div>
                </section>
            </div>
        </div>
    </main>
    <script src="script.js"></script>
    <div id="clienteModal" class="modal">
        <div class="modal-card">
            <div class="modal-head"><div id="modalTitle">Adicionar Cliente</div><button id="closeModalBtn" class="btn btn-ghost btn-icon"><i data-lucide="x"></i></button></div>
            <div class="modal-body">
                <div class="grid-3-modal">
                    <div class="field"><span class="label-inline">CNPJ</span><input id="mCnpj" class="input" type="text" placeholder="00.000.000/0000-00"></div>
                    <div class="field"><span class="label-inline">Razão Social</span><input id="mNome" class="input" type="text" placeholder="Razão Social"></div>
                    <div class="field"><span class="label-inline">Nome Fantasia</span><input id="mFantasia" class="input" type="text" placeholder="Nome Fantasia"></div>
                </div>
                <div class="grid-3-modal" style="margin-top:0.5rem;">
                    <div class="field"><span class="label-inline">Email</span><input id="mEmail" class="input" type="email" placeholder="email@empresa.com"></div>
                    <div class="field"><span class="label-inline">Telefone</span><input id="mPhone" class="input" type="text" placeholder="(00) 0000-0000"></div>
                    <div class="field"><span class="label-inline">Abertura</span><input id="mAbertura" class="input" type="text" placeholder="AAAA-MM-DD"></div>
                </div>
                <div class="grid-3-modal" style="margin-top:0.5rem;">
                    <div class="field"><span class="label-inline">CEP</span><input id="mCep" class="input" type="text" placeholder="00000-000"></div>
                    <div class="field"><span class="label-inline">UF</span><input id="mUf" class="input" type="text" placeholder="SP"></div>
                    <div class="field"><span class="label-inline">Cidade</span><input id="mCidade" class="input" type="text" placeholder="Cidade"></div>
                </div>
                <div class="grid-3-modal" style="margin-top:0.5rem;">
                    <div class="field"><span class="label-inline">Bairro</span><input id="mBairro" class="input" type="text" placeholder="Bairro"></div>
                    <div class="field"><span class="label-inline">Logradouro</span><input id="mLogradouro" class="input" type="text" placeholder="Rua, Av."></div>
                    <div class="field"><span class="label-inline">Número</span><input id="mNumero" class="input" type="text" placeholder="Número"></div>
                </div>
                <div class="grid-2-modal" style="margin-top:0.5rem;">
                    <div class="field"><span class="label-inline">Complemento</span><input id="mComplemento" class="input" type="text" placeholder="Complemento"></div>
                </div>
            </div>
            <div class="modal-actions">
                <button id="mSalvar" class="btn btn-primary" type="button"><i data-lucide="save"></i><span>Salvar</span></button>
            </div>
        </div>
    </div>
    <div id="confirmDeleteModal" class="modal">
        <div class="modal-card">
            <div class="modal-head"><div>Confirmar Exclusão</div><button id="confirmDeleteClose" class="btn btn-ghost btn-icon"><i data-lucide="x"></i></button></div>
            <div class="modal-body">
                <div class="label">Tem certeza que deseja excluir este cliente?</div>
                <div id="confirmDeleteText" class="muted" style="margin-top:0.5rem;"></div>
            </div>
            <div class="modal-actions">
                <button id="confirmDeleteCancel" class="btn btn-ghost" type="button"><i data-lucide="x"></i><span>Cancelar</span></button>
                <button id="confirmDeleteConfirm" class="btn btn-ghost" type="button" style="border-color: rgba(239,68,68,0.35); color: #FCA5A5;"><i data-lucide="trash-2"></i><span>Excluir</span></button>
            </div>
        </div>
    </div>
    <script>
        const API_BASE = 'https://others-maxximus-backend.pvuzyy.easypanel.host';
        async function api(path, options = {}) {
            const authRaw = localStorage.getItem('authUser');
            let headers = { 'Content-Type': 'application/json' };
            try {
                const u = JSON.parse(authRaw || '{}');
                if (u && u.id) headers['x-user-id'] = String(u.id);
                if (u && u.role) headers['x-user-role'] = String(u.role);
                if (u && u.name) headers['x-user-name'] = String(u.name);
            } catch {}
            const res = await fetch(API_BASE + path, { headers, ...options });
            if (!res.ok) {
                const err = await res.json().catch(() => ({}));
                throw new Error(err.error || ('HTTP ' + res.status));
            }
            return res.json();
        }
        function toast(msg, type) {
            const el = document.getElementById('toast');
            if (!el) return;
            el.textContent = msg;
            el.style.borderColor = type === 'error' ? 'rgba(239,68,68,0.35)' : 'rgba(16,185,129,0.35)';
            el.style.display = 'block';
            clearTimeout(window.__toastTimer);
            window.__toastTimer = setTimeout(() => { el.style.display = 'none'; }, 2500);
        }
        function isAdminUser() {
            try {
                const raw = localStorage.getItem('authUser');
                const u = JSON.parse(raw || '{}');
                return u && u.role === 'admin';
            } catch { return false; }
        }
        function renderClientsTable(clients) {
            const tbody = document.getElementById('clientsTbody');
            const arr = Array.isArray(clients) ? clients : [];
            const countLabel = document.getElementById('countLabel');
            const suffix = window.__isAdmin ? '' : ' • seus clientes';
            countLabel.textContent = arr.length + ' ' + (arr.length === 1 ? 'item' : 'itens') + suffix;
            window.__clientsCache = arr.slice();
            tbody.innerHTML = arr.map(c => `
                <tr>
                    <td>${c.name}</td>
                    <td>${c.cnpj}</td>
                    <td class="col-actions">
                        <div class="table-actions">
                            <button type="button" class="btn btn-ghost btn-icon" title="Editar" onclick="abrirEditar(${c.id})"><i data-lucide="edit-3"></i></button>
                            ${window.__isAdmin ? `<button type="button" class="btn btn-ghost btn-icon" title="Excluir" onclick="excluirCliente(${c.id})" style="border-color: rgba(239,68,68,0.35); color: #FCA5A5;"><i data-lucide="trash-2"></i></button>` : ``}
                            <button type="button" class="btn btn-ghost" title="Negociar" onclick="irNegociar(${c.id})" style="border-color: rgba(59,130,246,0.35); color: #93C5FD;"><i data-lucide="arrow-right"></i><span>Negociar</span></button>
                        </div>
                    </td>
                </tr>
            `).join('') || '<tr><td colspan="3" class="muted">Sem resultados</td></tr>';
        }
        async function buscar() {
            try {
                const nome = String(document.getElementById('fNome').value || '').trim();
                const cnpj = String(document.getElementById('fCnpj').value || '').trim();
                const qs = cnpj ? ('?cnpj=' + encodeURIComponent(cnpj)) : '';
                const list = await api('/clients' + qs, { method: 'GET' });
                let arr = Array.isArray(list) ? list : [];
                if (nome) {
                    const needle = nome.toUpperCase();
                    arr = arr.filter(c => String(c.name || '').toUpperCase().includes(needle));
                }
                renderClientsTable(arr);
                if (window.lucide && typeof window.lucide.createIcons === 'function') window.lucide.createIcons();
            } catch {
                renderClientsTable([]);
            }
        }
        document.addEventListener('DOMContentLoaded', async () => {
            const auth = localStorage.getItem('authUser');
            if (!auth) { window.location.href = 'login.html'; return; }
            let isAdmin = false;
            try {
                const user = JSON.parse(auth);
                const label = document.getElementById('userNameLabel');
                if (label && user && user.name) {
                    isAdmin = (user && user.role === 'admin');
                    window.__isAdmin = isAdmin;
                    label.textContent = isAdmin ? (user.name + ' • Admin') : user.name;
                }
                const roleChip = document.getElementById('roleChip');
                if (roleChip) {
                    roleChip.textContent = isAdmin ? 'Leitura para todos • Edição admin' : 'Leitura dos seus clientes • Edição admin';
                }
            } catch {}
            const umb = document.getElementById('userMenuBtn');
            if (umb) {
                umb.addEventListener('click', () => {
                    const menu = document.getElementById('userMenu');
                    if (menu) menu.classList.toggle('show');
                });
            }
            const lb = document.getElementById('logoutBtn');
            if (lb) {
                lb.addEventListener('click', (e) => {
                    e.preventDefault();
                    localStorage.removeItem('authUser');
                    window.location.href = 'login.html';
                });
            }
            try {
                const navUsers = document.getElementById('navUsers');
                if (navUsers) navUsers.style.display = isAdmin ? 'flex' : 'none';
            } catch {}
            const adminSection = document.getElementById('adminSection');
            if (adminSection) adminSection.style.display = 'block';
            const modal = document.getElementById('clienteModal');
            const openBtn = document.getElementById('openModalBtn');
            const closeBtn = document.getElementById('closeModalBtn');
            const salvarBtn = document.getElementById('mSalvar');
            const modalTitle = document.getElementById('modalTitle');
            const confirmModal = document.getElementById('confirmDeleteModal');
            const confirmClose = document.getElementById('confirmDeleteClose');
            const confirmCancel = document.getElementById('confirmDeleteCancel');
            const confirmConfirm = document.getElementById('confirmDeleteConfirm');
            const confirmText = document.getElementById('confirmDeleteText');
            function openModal() { modal.classList.add('show'); }
            function closeModal() { modal.classList.remove('show'); }
            function openConfirm() { confirmModal.classList.add('show'); }
            function closeConfirm() { confirmModal.classList.remove('show'); }
            function onlyDigits(s) { return String(s || '').replace(/\D/g, ''); }
            function formatCnpj(s) {
                const d = onlyDigits(s);
                const len = d.length;
                if (len <= 2) return d;
                if (len <= 5) return `${d.slice(0,2)}.${d.slice(2)}`;
                if (len <= 8) return `${d.slice(0,2)}.${d.slice(2,5)}.${d.slice(5)}`;
                if (len <= 12) return `${d.slice(0,2)}.${d.slice(2,5)}.${d.slice(5,8)}/${d.slice(8)}`;
                return `${d.slice(0,2)}.${d.slice(2,5)}.${d.slice(5,8)}/${d.slice(8,12)}-${d.slice(12,14)}`;
            }
            function formatCep(s) {
                const p = onlyDigits(s).split('');
                if (p.length >= 8) return `${p[0]}${p[1]}${p[2]}${p[3]}${p[4]}-${p[5]}${p[6]}${p[7]}`;
                return p.join('');
            }
            function formatPhone(s) {
                const p = onlyDigits(s);
                if (p.length >= 11) return `(${p.slice(0,2)}) ${p.slice(2,7)}-${p.slice(7,11)}`;
                if (p.length >= 10) return `(${p.slice(0,2)}) ${p.slice(2,6)}-${p.slice(6,10)}`;
                return p;
            }
            async function buscarCnpjAuto() {
                try {
                    const cnpj = onlyDigits(document.getElementById('mCnpj').value);
                    if (!cnpj || cnpj.length !== 14) return;
                    const res = await fetch('https://brasilapi.com.br/api/cnpj/v1/' + cnpj);
                    if (!res.ok) return;
                    const data = await res.json();
                    document.getElementById('mNome').value = data.razao_social || document.getElementById('mNome').value;
                    document.getElementById('mFantasia').value = data.nome_fantasia || document.getElementById('mFantasia').value;
                    document.getElementById('mEmail').value = data.email || document.getElementById('mEmail').value;
                    document.getElementById('mPhone').value = formatPhone((data.telefone || data.telefone1 || '') || document.getElementById('mPhone').value);
                    document.getElementById('mAbertura').value = data.data_inicio_atividade || document.getElementById('mAbertura').value;
                    document.getElementById('mCep').value = formatCep(data.cep || document.getElementById('mCep').value);
                    document.getElementById('mUf').value = data.uf || document.getElementById('mUf').value;
                    document.getElementById('mCidade').value = data.municipio || document.getElementById('mCidade').value;
                    document.getElementById('mBairro').value = data.bairro || document.getElementById('mBairro').value;
                    document.getElementById('mLogradouro').value = data.logradouro || document.getElementById('mLogradouro').value;
                    document.getElementById('mNumero').value = data.numero || document.getElementById('mNumero').value;
                    document.getElementById('mComplemento').value = data.complemento || document.getElementById('mComplemento').value;
                } catch {}
            }
            async function salvarClienteModal() {
                try {
                    const payload = {
                        name: String(document.getElementById('mNome').value || '').trim(),
                        cnpj: onlyDigits(document.getElementById('mCnpj').value || ''),
                        fantasy_name: String(document.getElementById('mFantasia').value || '').trim() || null,
                        email: String(document.getElementById('mEmail').value || '').trim() || null,
                        phone: String(document.getElementById('mPhone').value || '').trim() || null,
                        cep: String(document.getElementById('mCep').value || '').trim() || null,
                        state: String(document.getElementById('mUf').value || '').trim() || null,
                        city: String(document.getElementById('mCidade').value || '').trim() || null,
                        neighborhood: String(document.getElementById('mBairro').value || '').trim() || null,
                        street: String(document.getElementById('mLogradouro').value || '').trim() || null,
                        number: String(document.getElementById('mNumero').value || '').trim() || null,
                        complement: String(document.getElementById('mComplemento').value || '').trim() || null,
                        opening_date: String(document.getElementById('mAbertura').value || '').trim() || null
                    };
                    if (!payload.name || !payload.cnpj) { toast('Nome e CNPJ são obrigatórios', 'error'); return; }
                    await api('/clients', { method: 'POST', body: JSON.stringify(payload) });
                    toast('Cliente salvo', 'success');
                    closeModal();
                    buscar();
                } catch {
                    toast('Erro ao salvar cliente', 'error');
                }
            }
            function preencherCampos(c) {
                document.getElementById('mCnpj').value = formatCnpj(c.cnpj || '');
                document.getElementById('mNome').value = c.name || '';
                document.getElementById('mFantasia').value = c.fantasy_name || '';
                document.getElementById('mEmail').value = c.email || '';
                document.getElementById('mPhone').value = formatPhone(c.phone || '');
                document.getElementById('mAbertura').value = c.opening_date || '';
                document.getElementById('mCep').value = formatCep(c.cep || '');
                document.getElementById('mUf').value = c.state || '';
                document.getElementById('mCidade').value = c.city || '';
                document.getElementById('mBairro').value = c.neighborhood || '';
                document.getElementById('mLogradouro').value = c.street || '';
                document.getElementById('mNumero').value = c.number || '';
                document.getElementById('mComplemento').value = c.complement || '';
            }
            function limparCampos() {
                preencherCampos({ cnpj: '', name: '', fantasy_name: '', email: '', phone: '', opening_date: '', cep: '', state: '', city: '', neighborhood: '', street: '', number: '', complement: '' });
            }
            window.abrirDetalhes = function(id) {
                try {
                    const c = (window.__clientsCache || []).find(x => Number(x.id) === Number(id));
                    if (!c) return;
                    modalTitle.textContent = 'Detalhes do Cliente';
                    preencherCampos(c);
                    openModal();
                    if (window.lucide && typeof window.lucide.createIcons === 'function') window.lucide.createIcons();
                } catch {}
            };
            window.abrirEditar = function(id) {
                try {
                    const c = (window.__clientsCache || []).find(x => Number(x.id) === Number(id));
                    if (!c) return;
                    modalTitle.textContent = 'Editar Cliente';
                    preencherCampos(c);
                    openModal();
                    if (window.lucide && typeof window.lucide.createIcons === 'function') window.lucide.createIcons();
                } catch {}
            };
            window.excluirCliente = async function(id) {
                try {
                    if (!isAdmin) { toast('Apenas administradores podem excluir', 'error'); return; }
                    const c = (window.__clientsCache || []).find(x => Number(x.id) === Number(id));
                    if (!c) return;
                    confirmText.textContent = (c.name || '') + ' • ' + (c.cnpj || '');
                    confirmConfirm.dataset.id = String(c.id);
                    openConfirm();
                    if (window.lucide && typeof window.lucide.createIcons === 'function') window.lucide.createIcons();
                } catch {}
            };
            window.irNegociar = function(id) {
                try {
                    window.location.href = 'negociar.html?id=' + String(id);
                } catch {}
            };
            if (openBtn) openBtn.addEventListener('click', () => {
                modalTitle.textContent = 'Adicionar Cliente';
                limparCampos();
                openModal();
                if (window.lucide && typeof window.lucide.createIcons === 'function') window.lucide.createIcons();
            });
            if (closeBtn) closeBtn.addEventListener('click', closeModal);
            if (salvarBtn) salvarBtn.addEventListener('click', salvarClienteModal);
            if (confirmClose) confirmClose.addEventListener('click', closeConfirm);
            if (confirmCancel) confirmCancel.addEventListener('click', closeConfirm);
            if (confirmConfirm) confirmConfirm.addEventListener('click', async () => {
                try {
                    if (!isAdmin) { toast('Apenas administradores podem excluir', 'error'); return; }
                    const id = Number(confirmConfirm.dataset.id || 0);
                    if (!id) { toast('Cliente inválido', 'error'); return; }
                    await api('/clients/' + id, { method: 'DELETE' });
                    toast('Cliente excluído', 'success');
                    closeConfirm();
                    buscar();
                } catch {
                    toast('Erro ao excluir cliente', 'error');
                }
            });
            {
                const cnpjInput = document.getElementById('mCnpj');
                let timer = null;
                let last = '';
                function schedule() {
                    clearTimeout(timer);
                    timer = setTimeout(() => {
                        cnpjInput.value = formatCnpj(cnpjInput.value);
                        const val = onlyDigits(cnpjInput.value);
                        if (val.length === 14 && val !== last) { last = val; buscarCnpjAuto(); return; }
                        if (val !== last) { last = val; buscarCnpjAuto(); }
                    }, 400);
                }
                cnpjInput.addEventListener('input', () => {
                    clearTimeout(timer);
                    cnpjInput.value = formatCnpj(cnpjInput.value);
                    const val = onlyDigits(cnpjInput.value);
                    if (val.length === 14 && val !== last) { last = val; buscarCnpjAuto(); return; }
                    schedule();
                });
                cnpjInput.addEventListener('blur', schedule);
            }
            {
                const cepInput = document.getElementById('mCep');
                const phoneInput = document.getElementById('mPhone');
                if (cepInput) {
                    cepInput.addEventListener('input', () => { cepInput.value = formatCep(cepInput.value); });
                    cepInput.addEventListener('blur', () => { cepInput.value = formatCep(cepInput.value); });
                }
                if (phoneInput) {
                    phoneInput.addEventListener('input', () => { phoneInput.value = formatPhone(phoneInput.value); });
                    phoneInput.addEventListener('blur', () => { phoneInput.value = formatPhone(phoneInput.value); });
                }
            }
            document.getElementById('buscarBtn').addEventListener('click', buscar);
            document.getElementById('limparBtn').addEventListener('click', () => {
                document.getElementById('fNome').value = '';
                document.getElementById('fCnpj').value = '';
                buscar();
            });
            await buscar();
            if (!isAdmin) {
                toast('Mostrando apenas seus clientes', 'success');
            }
            if (window.lucide && typeof window.lucide.createIcons === 'function') {
                window.lucide.createIcons();
            }
        });
    </script>
    <div id="toast" class="toast"></div>
    <script src="script.js"></script>
</body>
</html>
