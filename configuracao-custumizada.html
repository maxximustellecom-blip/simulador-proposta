<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Configuração Costumizada • Maxximus Telecom</title>
    <link rel="icon" href="data:,">
    <link rel="stylesheet" href="style.css">
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jspdf-autotable@3.8.2/dist/jspdf.plugin.autotable.min.js"></script>
    <style>
        .modal-body {
            padding: 1.5rem;
            background-color: var(--bg);
            color: var(--text);
        }
        .section-block {
            margin-bottom: 1rem;
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 1rem;
            box-shadow: 0 1px 2px rgba(0,0,0,0.05);
        }
        .section-header {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            margin-bottom: 1rem;
            padding-bottom: 0.75rem;
            border-bottom: 1px solid var(--border);
        }
        .section-icon {
            width: 20px;
            height: 20px;
            color: var(--primary);
        }
        .section-title {
            font-weight: 600;
            color: var(--text);
            font-size: 0.95rem;
        }
        .section-desc {
            font-size: 0.8rem;
            color: var(--muted);
            line-height: 1.2;
        }
        .info-badge {
            display: inline-flex;
            align-items: center;
            padding: 0.25rem 0.75rem;
            background: var(--surface-strong);
            border-radius: 999px;
            font-size: 0.85rem;
            font-weight: 500;
            color: var(--text);
        }
    </style>
</head>
<body>
    <main class="container">
        <div class="card">
            <div class="card-head">
                <div class="card-title">
                    <span>Configuração Customizada</span>&nbsp;
                    <span class="chip">Negociação</span>
                </div>
                <div class="muted">
                    <button id="addLinhaBtn" class="btn btn-primary" type="button"><i data-lucide="plus"></i><span>Adicionar linha</span></button>
                </div>
            </div>
            <div class="card-body">
                <section class="section" style="margin-top: 20px;">
                    <div class="label">Dados básicos do cliente</div>
                    <div style="padding:0.4rem 0.0rem; display:flex; align-items:center; gap:0.75rem; flex-wrap:wrap;">
                        <span class="muted">Cliente:</span>
                        <span id="clienteNome" style="font-weight:600;">-</span>
                        <span class="muted">CNPJ:</span>
                        <span id="clienteCnpj">-</span>
                        <span class="muted">Tipo:</span>
                        <span id="negTipo">-</span>
                        <span class="muted">Status:</span>
                        <span id="negStatusLabel">-</span>
                    </div>
                </section>
                <section class="section" style="margin-top: 20px;">
                    <div style="display:flex; align-items:center; justify-content:space-between;">
                        <div class="label">Linhas da proposta</div>
                        <div class="muted" id="countLinhasLabel">0 itens</div>
                    </div>
                    <div class="table-container" style="margin-top:0.5rem;">
                        <table>
                            <thead>
                                <tr>
                                    <th>Linha</th>
                                    <th>Tipo</th>
                                    <th>Qtd</th>
                                    <th>Total</th>
                                    <th class="col-actions" style="min-width:140px;">Ações</th>
                                </tr>
                            </thead>
                            <tbody id="tableBody">
                                <tr><td colspan="5">
                                    <div class="skeleton skel-row"></div>
                                    <div class="skeleton skel-row"></div>
                                    <div class="skeleton skel-row"></div>
                                </td></tr>
                            </tbody>
                        </table>
                    </div>
                </section>
                <section class="section" style="margin-top:1rem;">
                    <div style="display:flex; align-items:center; gap:0.75rem;">
                        <div class="label">Status da negociação</div>
                        <select id="fStatus" class="select" style="width:220px;">
                            <option value="Em andamento">Em andamento</option>
                            <option value="Concluída">Concluída</option>
                            <option value="Cancelada">Cancelada</option>
                        </select>
                    </div>
                </section>
                <section class="section" style="margin-top:1rem;">
                    <div class="label">Resumo</div>
                    <div class="grid-2" style="margin-top:0.5rem;">
                        <div class="card" style="padding:0.75rem; border:1px solid #e5e7eb;">
                            <div class="muted" style="font-weight:600;">Plano Atual</div>
                            <div id="resumoAtualList" class="muted" style="margin-top:0.5rem;"></div>
                            <div id="resumoAtualTotal" class="muted" style="margin-top:0.6rem; padding:0.5rem; background:#DBEAFE; color:#1D4ED8; font-weight:700; border-radius:6px;">Total: R$ 0,00</div>
                        </div>
                        <div class="card" style="padding:0.75rem; border:1px solid #86efac;">
                            <div class="muted" style="font-weight:600; color:#15803d;">Nova Proposta</div>
                            <div id="resumoPropostaList" class="muted" style="margin-top:0.5rem;"></div>
                            <div id="resumoPropostaTotal" class="muted" style="margin-top:0.6rem; padding:0.5rem; background:#DCFCE7; color:#166534; font-weight:700; border-radius:6px;">Total: R$ 0,00</div>
                        </div>
                    </div>
                    <div class="grid-2" style="margin-top:0.5rem;">
                        <div class="card" style="padding:0.75rem;">
                            <div class="muted">Total de Acessos</div>
                            <div id="totalAcessos" style="font-size:1.6rem; font-weight:700; color: var(--primary);">0</div>
                        </div>
                        <div class="card" style="padding:0.75rem;">
                            <div class="muted">Economia Total</div>
                            <div id="totalEconomia" style="font-size:1.6rem; font-weight:700; color: var(--primary);">R$ 0,00</div>
                        </div>
                    </div>
                    <div class="grid-2" style="margin-top:0.5rem;">
                        <div class="card" style="padding:0.75rem;">
                            <div class="muted">Percentual Economia</div>
                            <div id="percentualEconomia" style="font-size:1.2rem; font-weight:700; color: var(--primary);">0%</div>
                        </div>
                        <div class="card" style="padding:0.75rem;">
                            <div class="muted">Linhas com Aparelho</div>
                            <div id="linhasAparelho" style="font-size:1.2rem; font-weight:700; color: var(--primary);">0</div>
                        </div>
                    </div>
                </section>
                <section class="section" style="margin-top:1rem;">
                    <div class="label">Anotações</div>
                    <textarea id="fAnotacoes" class="input" style="width:100%; min-height:80px; margin-top:0.5rem; padding: 0px; resize: none;" placeholder="Observações gerais sobre a proposta..."></textarea>
                </section>
                <section class="section" style="margin-top:1rem;">
                    <div class="label">Anexos</div>
                    <div style="margin-top:0.5rem;">
                        <div id="attachmentsList" style="display:flex; flex-wrap:wrap; gap:0.5rem; margin-bottom:0.5rem;"></div>
                        <label class="btn btn-ghost" style="cursor:pointer; display:inline-flex; align-items:center; gap:0.5rem;">
                            <i data-lucide="paperclip"></i><span>Adicionar anexo</span>
                            <input type="file" id="fileInput" style="display:none;">
                        </label>
                    </div>
                </section>
                <section style="margin-top:1rem;">
                    <div id="alertWarning" class="card" style="padding:0.75rem; display:none;">
                        <div id="warningContent" class="muted"></div>
                    </div>
                </section>
                <section style="margin-top:1rem;">
                    <div style="display:flex; gap:0.5rem; flex-wrap:wrap; justify-content:flex-end;">
                        <button id="novaBtn" class="btn btn-ghost" type="button"><i data-lucide="rotate-ccw"></i><span>Resetar Proposta</span></button>
                        <button id="copiarBtn" class="btn btn-ghost" type="button"><i data-lucide="copy"></i><span>Copiar Proposta</span></button>
                        <button id="relatorioBtn" class="btn btn-ghost" type="button" title="Gerar Relatório"><i data-lucide="file-text"></i><span>Gerar Relatório</span></button>
                        <button id="salvarBtn" class="btn btn-primary" type="button"><i data-lucide="save"></i><span>Salvar</span></button>
                    </div>
                </section>
            </div>
        </div>
    </main>
    <script>
        const API_BASE = 'https://others-maxximus-backend.pvuzyy.easypanel.host';
        async function api(path, options = {}) {
            const authRaw = localStorage.getItem('authUser');
            let headers = { 'Content-Type': 'application/json' };
            try {
                const u = JSON.parse(authRaw || '{}');
                if (u && u.id) headers['x-user-id'] = String(u.id);
                if (u && u.role) headers['x-user-role'] = String(u.role);
                if (u && u.name) headers['x-user-name'] = String(u.name);
            } catch {}
            
            if (options.headers) {
                headers = { ...headers, ...options.headers };
            }
            if (options.body instanceof FormData) {
                delete headers['Content-Type'];
            }

            const res = await fetch(API_BASE + path, { ...options, headers });
            if (!res.ok) {
                const err = await res.json().catch(() => ({}));
                throw new Error(err.error || ('HTTP ' + res.status));
            }
            return res.json();
        }
        function toast(msg, type) {
            const el = document.getElementById('toast');
            if (!el) return;
            el.textContent = msg;
            if (type === 'success') {
                el.style.background = 'linear-gradient(135deg, #10B981 0%, #059669 100%)';
                el.style.color = '#FFFFFF';
                el.style.borderColor = 'transparent';
            } else if (type === 'error') {
                el.style.background = 'linear-gradient(135deg, #EF4444 0%, #DC2626 100%)';
                el.style.color = '#FFFFFF';
                el.style.borderColor = 'transparent';
            } else {
                el.style.background = 'linear-gradient(135deg, #3B82F6 0%, #2563EB 100%)';
                el.style.color = '#FFFFFF';
                el.style.borderColor = 'transparent';
            }
            el.style.display = 'block';
            clearTimeout(window.__toastTimer);
            window.__toastTimer = setTimeout(() => { el.style.display = 'none'; }, 2500);
        }
        function onlyDigits(s) { return String(s || '').replace(/\D/g, ''); }
        function currency(v) { try { return (new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' })).format(Number(v || 0)); } catch { return 'R$ 0,00'; } }
        function formatCnpj(s) {
            const d = onlyDigits(s);
            const len = d.length;
            if (len <= 2) return d;
            if (len <= 5) return `${d.slice(0,2)}.${d.slice(2)}`;
            if (len <= 8) return `${d.slice(0,2)}.${d.slice(2,5)}.${d.slice(5)}`;
            if (len <= 12) return `${d.slice(0,2)}.${d.slice(2,5)}.${d.slice(5,8)}/${d.slice(8)}`;
            return `${d.slice(0,2)}.${d.slice(2,5)}.${d.slice(5,8)}/${d.slice(8,12)}-${d.slice(12,14)}`;
        }
        function formatPhone(s) {
            const p = onlyDigits(s);
            if (p.length >= 11) return `(${p.slice(0,2)}) ${p.slice(2,7)}-${p.slice(7,11)}`;
            if (p.length >= 10) return `(${p.slice(0,2)}) ${p.slice(2,6)}-${p.slice(6,10)}`;
            return p;
        }
        let __negociacaoId = null;
        let __negociacaoInfo = null;
        let __clienteInfo = null;
        let __tiposBackend = [];
        let linhas = [];
        let nextId = 1;
        let __isLocked = false;
        const pctsDadosDisponiveis = ['100MB','1GB','2GB','3GB','4GB','5GB','6GB','8GB','10GB','12GB','20GB','22GB','30GB','32GB','50GB','52GB','100GB','150GB','Voz (sem dados)'];
        const ddds = [11,12,13,14,15,16,17,18,19,21,22,24,27,28,31,32,33,34,35,37,38,41,42,43,44,45,46,47,48,49,51,53,54,55,61,62,63,64,65,66,67,68,69,71,73,74,75,77,79,81,82,83,84,85,86,87,88,89,91,92,93,94,95,96,97,98,99];
        let __customCategorias = [];
        let __customProdutos = [];
        let __planosPorTipo = { novo: [], aditivo: [], renegociacao: [] };
        let __pctsPorTipo = { novo: [], aditivo: [], renegociacao: [] };
        let __map = {};
        function normalizeTipoKey(t) {
            const k = String(t || '').toLowerCase();
            if (k.includes('reneg')) return 'renegociacao';
            if (k.includes('adti') || k.includes('adit')) return 'aditivo';
            return 'novo';
        }
        function parsePctFromText(s) {
            const txt = String(s || '');
            const dataRegex = /(\d+(?:[\.,]\d+)?)\s*(GB|MB|MEGA)\b/gi;
            const smsRegex = /(\d+(?:[\.,]\d+)?)\s*SMS\b/gi;
            let dataMatch, smsMatch;
            let dataSum = 0;
            let dataUnit = null;
            let smsSum = 0;
            while ((dataMatch = dataRegex.exec(txt)) !== null) {
                const num = Number(String(dataMatch[1] || '0').replace(',', '.'));
                const u = (dataMatch[2] || '').toUpperCase();
                const normalizedU = u === 'MEGA' ? 'MB' : u;
                if (!dataUnit) dataUnit = normalizedU;
                const val = dataUnit === 'GB' ? (normalizedU === 'MB' ? (num / 1024) : num) : (normalizedU === 'GB' ? (num * 1024) : num);
                dataSum += val;
            }
            while ((smsMatch = smsRegex.exec(txt)) !== null) {
                const num = Number(String(smsMatch[1] || '0').replace(',', '.'));
                smsSum += num;
            }
            const dataOut = dataUnit ? `${Math.round(dataSum * 100) / 100}${dataUnit}` : '';
            const smsOut = smsSum > 0 ? `${Math.round(smsSum * 100) / 100}SMS` : '';
            if (dataOut && smsOut) return `${dataOut} + ${smsOut}`;
            return dataOut || smsOut || '';
        }

        async function carregarTiposBackend() {
            try {
                const list = await api('/types', { method: 'GET' });
                __tiposBackend = Array.isArray(list) ? list : [];
            } catch { __tiposBackend = []; }
        }

        async function carregarCatalogoCustomizado() {
            try {
                const cats = await api('/custom-categories', { method: 'GET' }).catch(() => []);
                const prods = await api('/custom-products', { method: 'GET' }).catch(() => []);
                __customCategorias = Array.isArray(cats) ? cats : [];
                __customProdutos = Array.isArray(prods) ? prods : [];
                __planosPorTipo = { novo: [], aditivo: [], renegociacao: [] };
                __pctsPorTipo = { novo: [], aditivo: [], renegociacao: [] };
                const pctSets = { novo: new Set(), aditivo: new Set(), renegociacao: new Set() };
                __customProdutos.forEach(p => {
                    const tipo = normalizeTipoKey(p.category && p.category.tipo ? p.category.tipo : 'Novo');
                    const nome = String(p.nome || p.name || '-');
                    const baseTxt = p.descricao || p.description || nome;
                    const pct = parsePctFromText(baseTxt);
                    const valor = Number(p.preco || 0);
                    __planosPorTipo[tipo].push({ nome, pct, valor });
                    if (pct) pctSets[tipo].add(pct);
                });
                Object.keys(pctSets).forEach(k => {
                    __pctsPorTipo[k] = Array.from(pctSets[k]);
                });
            } catch {
                __customCategorias = [];
                __customProdutos = [];
                __planosPorTipo = { novo: [], aditivo: [], renegociacao: [] };
                __pctsPorTipo = { novo: [], aditivo: [], renegociacao: [] };
            }
        }
        function construirMapaCustomizado() {
            const map = {};
            (__customProdutos || []).forEach(p => {
                const catObj = p.category || {};
                const catId = catObj.id;
                if (!catId) return;

                if (!map[catId]) map[catId] = [];
                
                const nome = String(p.nome || p.name || '-');
                const baseTxt = p.descricao || p.description || nome;
                const pct = parsePctFromText(baseTxt);
                const valor = Number(p.preco || 0);
                
                map[catId].push({ nome, pct, valor });
            });
            __map = map;
        }
        function calcularPrecoFinal(linha) {
            const v = parseFloat(linha.valorNaoFidelizado) || 0;
            const d = parseFloat(linha.desconto) || 0;
            return v * (1 - d / 100);
        }
        function calcularEconomia(linha) {
            const precoAtual = parseFloat(linha.precoAtual) || 0;
            const precoFinal = calcularPrecoFinal(linha);
            return precoAtual - precoFinal;
        }
        function calcularTotais() {
            const totalAtual = linhas.reduce((sum, l) => sum + ((parseFloat(l.precoAtual) || 0) * (Number(l.quantidade) || 1)), 0);
            const totalProposto = linhas.reduce((sum, l) => {
                const qtd = Number(l.quantidade) || 1;
                const preco = calcularPrecoFinal(l);
                // const parc = Number(l.valorParcela) || 0; // Ajuste: Total não inclui parcelas de aparelhos
                return sum + (qtd * preco);
            }, 0);
            const totalEconomia = totalAtual - totalProposto;
            return { totalAtual, totalProposto, totalEconomia };
        }
        function validarProposta() {
            const totais = calcularTotais();
            const erros = [];
            const avisos = [];
            const numAcessos = linhas.reduce((acc, l) => acc + (Number(l.quantidade) || 1), 0);
            if (numAcessos < 10 && totais.totalProposto < 350) {
                erros.push('Com menos de 10 acessos, o contrato deve atingir mínimo de R$ 350,00');
            }
            if (numAcessos < 20) {
                const temAparelho = linhas.some(l => l.temAparelho === 'Sim');
                if (!temAparelho) {
                    erros.push('Negociações com menos de 20 acessos devem incluir pelo menos um aparelho');
                }
            }
            linhas.forEach((linha, idx) => {
                if (!linha.plano) {
                    erros.push(`Linha ${idx + 1}: Selecione um plano`);
                }
                const qtd = Number(linha.quantidade) || 1;
                if (qtd < 1) {
                    erros.push(`Linha ${idx + 1}: Quantidade deve ser pelo menos 1`);
                }

                const tipo = String(linha.tipoNegociacao || '').toLowerCase();
                const isReneg = (tipo.includes('reneg') || tipo.includes('renegociação') || tipo.includes('renegociacao'));
                if (isReneg) {
                    if (!linha.planoAtualGB || !linha.precoAtual) {
                        erros.push(`Linha ${idx + 1}: Para Renegociação, Plano Atual e Preço Atual são obrigatórios`);
                    }
                    const pctAtual = linha.planoAtualGB ? parseFloat(String(linha.planoAtualGB).replace(/\D/g, '')) : 0;
                    const pctNovo = linha.pct ? parseFloat(String(linha.pct).replace(/\D/g, '')) : 0;
                    if (pctNovo > 0 && pctAtual > 0 && pctNovo < pctAtual) {
                        erros.push(`Linha ${idx + 1}: Não é permitido downgrade de pacote de dados (${linha.planoAtualGB} → ${linha.pct})`);
                    }
                }
                if (!linha.ddd) {
                    avisos.push(`Linha ${idx + 1}: Recomendamos preencher o DDD`);
                }
                if (linha.temAparelho === 'Sim' && !linha.modeloAparelho) {
                    erros.push(`Linha ${idx + 1}: Modelo do aparelho é obrigatório quando há aparelho`);
                }
                if (String(linha.tipoAparelho || '') === 'VF 24x' && !linha.valorAparelho) {
                    erros.push(`Linha ${idx + 1}: Valor do aparelho é obrigatório para VF 24x`);
                }
            });
            const box = document.getElementById('alertWarning');
            const content = document.getElementById('warningContent');
            const todasMensagens = [...erros, ...avisos];

            if (todasMensagens.length) {
                content.innerHTML = '<div style="font-weight:600; margin-bottom:6px; color:#854d0e;">Atenção:</div>' + todasMensagens.map(a => `<div style="font-size:14px; color:#713f12;">${a}</div>`).join('');
                box.style.display = 'block';
            } else {
                content.innerHTML = '';
                box.style.display = 'none';
            }
            return erros;
        }
        function renderResumo() {
            const totais = calcularTotais();
            const acessos = linhas.reduce((acc, l) => acc + (Number(l.quantidade) || 1), 0);
            const economia = totais.totalEconomia;
            const perc = (totais.totalAtual > 0) ? Math.round((economia / (totais.totalAtual)) * 10000) / 100 : 0;
            const withDevice = linhas.filter(l => l.temAparelho === 'Sim').length;
            const lblCount = document.getElementById('countLinhasLabel');
            if (lblCount) lblCount.textContent = acessos + ' ' + (acessos === 1 ? 'item' : 'itens');
            document.getElementById('totalAcessos').textContent = String(acessos);
            document.getElementById('totalEconomia').textContent = currency(economia);
            document.getElementById('percentualEconomia').textContent = String(perc) + '%';
            document.getElementById('linhasAparelho').textContent = String(withDevice);
            const atualListEl = document.getElementById('resumoAtualList');
            const propostaListEl = document.getElementById('resumoPropostaList');
            const atualTotalEl = document.getElementById('resumoAtualTotal');
            const propostaTotalEl = document.getElementById('resumoPropostaTotal');
            const atualItens = linhas.map((l, idx) => {
                const ac = l.ddd ? `DDD ${l.ddd}` : 'N/A';
                const plano = l.planoAtualGB || 'N/A';
                const val = currency(l.precoAtual || 0);
                return `<div style="background:#F3F4F6; padding:8px; border-radius:6px; margin-bottom:6px;">Linha ${idx + 1}: ${ac}<br>Plano: ${plano}<br>Valor: ${val}</div>`;
            }).join('') || '<div class="muted">-</div>';
            const propostaItens = linhas.map((l, idx) => {
                const ac = l.ddd ? `DDD ${l.ddd}` : 'N/A';
                const tipo = l.tipoNegociacao || '-';
                const plano = l.plano || '-';
                const pct = l.pct || '-';
                const final = currency(calcularPrecoFinal(l));
                return `<div style=\"background:#ECFDF5; padding:8px; border-radius:6px; margin-bottom:6px;\">Linha ${idx + 1}: ${ac}<br>Tipo: ${tipo}<br>Plano: ${plano}<br>Pct: ${pct}<br>Final: ${final}</div>`;
            }).join('') || '<div class="muted">-</div>';
            if (atualListEl) atualListEl.innerHTML = atualItens;
            if (propostaListEl) propostaListEl.innerHTML = propostaItens;
            if (atualTotalEl) atualTotalEl.textContent = 'Total: ' + currency(totais.totalAtual);
            if (propostaTotalEl) propostaTotalEl.textContent = 'Total: ' + currency(totais.totalProposto);
        }
        function getFilteredCategorias(tipoNegociacao) {
            const t = normalizeTipoKey(tipoNegociacao);
            return __customCategorias.filter(c => normalizeTipoKey(c.tipo) === t);
        }
        function categoriaOptionsHtml(tipo, sel) {
            const cats = getFilteredCategorias(tipo);
            return ['<option value="">Selecione</option>'].concat(cats.map(c => `<option value="${c.nome}" ${String(sel||'')===c.nome?'selected':''}>${c.nome}</option>`)).join('');
        }

        function tipoOptionsHtml(sel) {
            if (!__tiposBackend || __tiposBackend.length === 0) {
                return '<option value="" disabled selected>Carregando...</option>';
            }
            return __tiposBackend.map(t => `<option value="${t.nome}" ${String(sel||'')===t.nome?'selected':''}>${t.nome}</option>`).join('');
        }
        function pctAtualOptionsHtml(sel) {
            return ['<option value="">Selecione</option>'].concat(pctsDadosDisponiveis.map(p => `<option value="${p}" ${String(sel||'')===p?'selected':''}>${p}</option>`)).join('');
        }
        function pctOptionsHtml(tipo, sel) {
            const key = normalizeTipoKey(tipo);
            const arr = (__pctsPorTipo[key] && __pctsPorTipo[key].length ? __pctsPorTipo[key] : pctsDadosDisponiveis);
            return ['<option value="">Selecione</option>'].concat(arr.map(p => `<option value="${p}" ${String(sel||'')===p?'selected':''}>${p}</option>`)).join('');
        }
        function planoOptionsHtml(tipo, sel) {
            const key = normalizeTipoKey(tipo);
            const arr = __planosPorTipo[key] || [];
            return ['<option value="">Selecione</option>'].concat(arr.map(p => `<option value="${p.nome}" ${String(sel||'')===p.nome?'selected':''}>${p.nome}</option>`)).join('');
        }
        function valorNaoFidByPlano(tipo, planoNome) {
            const key = normalizeTipoKey(tipo);
            const arr = __planosPorTipo[key] || [];
            const sel = arr.find(p => p.nome === planoNome);
            return sel ? Number(sel.valor || 0) : 0;
        }
        function pctByPlano(tipo, planoNome) {
            const key = normalizeTipoKey(tipo);
            const arr = __planosPorTipo[key] || [];
            const sel = arr.find(p => p.nome === planoNome);
            return sel ? String(sel.pct || '') : '';
        }
        let __currentEditId = null;

        function openEditModal(id) {
            const line = linhas.find(l => Number(l.id) === Number(id));
            if (!line) return;
            __currentEditId = id;

            const modal = document.getElementById('editLineModal');
            if (!modal) return;
            document.getElementById('editLineId').value = id;

            const populate = (id, opts, val) => {
                const el = document.getElementById(id);
                if (el) {
                    el.innerHTML = opts;
                    el.value = val;
                }
            };

            const dddOpts = ['<option value="">DDD</option>'].concat(ddds.map(d => `<option value="${d}">${d}</option>`)).join('');
            populate('editDdd', dddOpts, line.ddd);

            populate('editTipo', tipoOptionsHtml(line.tipoNegociacao), line.tipoNegociacao);
            
            const numEl = document.getElementById('editNumero');
            if (numEl) numEl.value = line.numero || '';

            populate('editPlanoAtual', pctAtualOptionsHtml(line.planoAtualGB), line.planoAtualGB);

            const precoEl = document.getElementById('editPrecoAtual');
            if (precoEl) precoEl.value = line.precoAtual || 0;

            populate('editPortabilidade', '<option value="Não">Não</option><option value="Sim">Sim</option>', line.portabilidade);

            const ops = ['Claro','Vivo','TIM','Oi'];
            const opOpts = ['<option value="">Selecione...</option>'].concat(ops.map(o => `<option value="${o}">${o}</option>`)).join('');
            populate('editOperadoraDoadora', opOpts, line.operadoraDoadora);

            const numPortEl = document.getElementById('editNumeroPortar');
            if (numPortEl) numPortEl.value = line.numeroPortar || '';

            const catsByTipo = getFilteredCategorias(line.tipoNegociacao);
            const catOpts = catsByTipo.map(c => `<option value="${c.nome}">${c.nome}</option>`).join('');
            populate('editCategoria', catOpts, line.categoria);

            const currentCat = catsByTipo.find(c => c.nome === line.categoria);
            const planos = currentCat ? (__map[currentCat.id] || []) : [];
            const planoOpts = ['<option value="">Selecione um plano...</option>'].concat(
                planos.map(p => `<option value="${p.nome}">${p.nome}</option>`)
            ).join('');
            populate('editPlano', planoOpts, line.plano);

            const pctEl = document.getElementById('editPct');
            if (pctEl) pctEl.value = line.pct || '-';
            
            const valPlanoEl = document.getElementById('editValorPlano');
            if (valPlanoEl) valPlanoEl.value = line.valorPlano || 0;

            const valNaoFidEl = document.getElementById('editValorNaoFid');
            if (valNaoFidEl) valNaoFidEl.value = line.valorNaoFidelizado || 0;

            const descEl = document.getElementById('editDesconto');
            if (descEl) descEl.value = line.desconto || 0;

            const valFinalEl = document.getElementById('editValorFinal');
            if (valFinalEl) valFinalEl.value = currency(calcularPrecoFinal(line));

            const econEl = document.getElementById('editEconomia');
            if (econEl) econEl.value = currency(calcularEconomia(line));

            populate('editTemAparelho', '<option value="Não">Não</option><option value="Sim">Sim</option>', line.temAparelho);
            populate('editTipoAparelho', '<option value="Comodato">Comodato</option><option value="VF 24x">VF 24x</option>', line.tipoAparelho);
            
            const modeloEl = document.getElementById('editModeloAparelho');
            if (modeloEl) modeloEl.value = line.modeloAparelho || '';
            
            const valApEl = document.getElementById('editValorAparelho');
            if (valApEl) valApEl.value = line.valorAparelho || 0;

            const valParcEl = document.getElementById('editValorParcela');
            if (valParcEl) valParcEl.value = currency(line.valorParcela);

            // Recalculo automatico se houver portabilidade e VF 24x
            if (line.portabilidade === 'Sim' && line.tipoAparelho === 'VF 24x') {
                const valAp = Number(line.valorAparelho || 0);
                if (valParcEl) valParcEl.value = currency(valAp / 24);
            }

            updateEditModalState();

            modal.classList.add('show');
            if (window.lucide && typeof window.lucide.createIcons === 'function') window.lucide.createIcons();
        }

        function updateEditModalState() {
            if (!__currentEditId) return;
            const tipo = document.getElementById('editTipo').value;
            const isReneg = normalizeTipoKey(tipo).includes('reneg');
            const port = document.getElementById('editPortabilidade').value;
            const temAp = document.getElementById('editTemAparelho').value;
            const tipoAp = document.getElementById('editTipoAparelho').value;

            const numEl = document.getElementById('editNumero');
            if (numEl) numEl.disabled = !isReneg;

            const isNovo = ['novo','aditivo'].includes(normalizeTipoKey(tipo));
            const paEl = document.getElementById('editPlanoAtual');
            if (paEl) paEl.disabled = isNovo;
            const praEl = document.getElementById('editPrecoAtual');
            if (praEl) praEl.disabled = isNovo;

            const portDetails = document.getElementById('areaPortabilidadeDetails');
            if (portDetails) portDetails.style.display = (port === 'Sim') ? 'grid' : 'none';

            const opEl = document.getElementById('editOperadoraDoadora');
            if (opEl) opEl.disabled = (port !== 'Sim');
            const npEl = document.getElementById('editNumeroPortar');
            if (npEl) npEl.disabled = (port !== 'Sim');

            const apDetails = document.getElementById('areaAparelhoDetails');
            if (apDetails) apDetails.style.display = (temAp === 'Sim') ? 'block' : 'none';

            const tipoApEl = document.getElementById('editTipoAparelho');
            if (tipoApEl) tipoApEl.disabled = (temAp !== 'Sim');
            const modApEl = document.getElementById('editModeloAparelho');
            if (modApEl) modApEl.disabled = (temAp !== 'Sim');
            const valApEl = document.getElementById('editValorAparelho');
            if (valApEl) valApEl.disabled = (temAp !== 'Sim' || tipoAp === 'Comodato');
        }

        function bindEditModalEvents() {
            const modal = document.getElementById('editLineModal');
            if (!modal) return;

            const close = () => { modal.classList.remove('show'); __currentEditId = null; };
            document.getElementById('editLineClose').onclick = close;
            document.getElementById('editLineCancel').onclick = close;

            const fields = ['editTipo', 'editPortabilidade', 'editTemAparelho', 'editTipoAparelho', 'editCategoria', 'editPlano'];
            fields.forEach(fid => {
                const el = document.getElementById(fid);
                if (el) el.addEventListener('change', () => handleEditModalChange(fid));
            });
            
            ['editNumero', 'editNumeroPortar'].forEach(fid => {
                const el = document.getElementById(fid);
                if (el) el.addEventListener('input', (e) => {
                    const v = e.target.value.replace(/\D/g, '');
                    e.target.value = v.length > 5 ? v.slice(0,5)+'-'+v.slice(5,9) : v;
                });
            });

            ['editValorPlano', 'editValorNaoFid', 'editDesconto', 'editPrecoAtual', 'editValorAparelho'].forEach(fid => {
                const el = document.getElementById(fid);
                if (el) el.addEventListener('input', () => {
                     const desc = Number(document.getElementById('editDesconto').value || 0);
                     const base = Number(document.getElementById('editValorNaoFid').value || 0);
                     const final = base * (1 - desc/100);
                     document.getElementById('editValorFinal').value = currency(final);
                     
                     const pAtual = Number(document.getElementById('editPrecoAtual').value || 0);
                     document.getElementById('editEconomia').value = currency(pAtual - final);

                     const valAp = Number(document.getElementById('editValorAparelho').value || 0);
                     const tipoAp = document.getElementById('editTipoAparelho').value;
                     if (tipoAp === 'VF 24x') {
                        document.getElementById('editValorParcela').value = currency(valAp / 24);
                     } else {
                        document.getElementById('editValorParcela').value = currency(0);
                     }
                });
            });

            document.getElementById('editLineSave').onclick = () => {
                if (saveEditModal()) {
                    close();
                }
            };
        }

        function handleEditModalChange(fieldId) {
            const getValue = (id) => document.getElementById(id).value;
            const setValue = (id, v) => { const el = document.getElementById(id); if (el) el.value = v; };
            const setHTML = (id, h) => { const el = document.getElementById(id); if (el) el.innerHTML = h; };

            if (fieldId === 'editTipo') {
                const val = getValue('editTipo');
                const catsByTipo = getFilteredCategorias(val);
                const firstCat = catsByTipo[0]?.nome || '';
                
                const catOpts = catsByTipo.map(c => `<option value="${c.nome}">${c.nome}</option>`).join('');
                setHTML('editCategoria', catOpts);
                setValue('editCategoria', firstCat);
                handleEditModalChange('editCategoria');
                
                setValue('editPlano', '');
                setValue('editPct', '');
                setValue('editValorPlano', 0);
                setValue('editValorNaoFid', 0);
            }

            if (fieldId === 'editCategoria') {
                const catVal = getValue('editCategoria');
                const tipoVal = getValue('editTipo');
                const catsByTipo = getFilteredCategorias(tipoVal);
                const catObj = catsByTipo.find(c => c.nome === catVal);
                const planos = catObj ? (__map[catObj.id] || []) : [];
                
                const planoOpts = ['<option value="">Selecione um plano...</option>'].concat(
                    planos.map(p => `<option value="${p.nome}">${p.nome}</option>`)
                ).join('');
                setHTML('editPlano', planoOpts);
                setValue('editPlano', '');
                handleEditModalChange('editPlano');
            }

            if (fieldId === 'editPlano') {
                const planoVal = getValue('editPlano');
                const catVal = getValue('editCategoria');
                const tipoVal = getValue('editTipo');
                const catsByTipo = getFilteredCategorias(tipoVal);
                const catObj = catsByTipo.find(c => c.nome === catVal);
                const planos = catObj ? (__map[catObj.id] || []) : [];
                const sel = planos.find(p => p.nome === planoVal);

                if (sel) {
                    const baseTxt = sel.descricao || sel.nome || '';
                    setValue('editPct', parsePctFromText(baseTxt));
                    setValue('editValorPlano', sel.valor || 0);
                    setValue('editValorNaoFid', sel.valor || 0);
                } else {
                    setValue('editPct', '-');
                    setValue('editValorPlano', 0);
                    setValue('editValorNaoFid', 0);
                }
                document.getElementById('editValorPlano').dispatchEvent(new Event('input'));
            }

            if (fieldId === 'editTipoAparelho' || fieldId === 'editTemAparelho') {
                const tem = getValue('editTemAparelho');
                const tipo = getValue('editTipoAparelho');
                if (tem !== 'Sim') {
                    setValue('editTipoAparelho', '');
                    setValue('editModeloAparelho', '');
                    setValue('editValorAparelho', 0);
                    setValue('editValorParcela', currency(0));
                } else {
                     if (fieldId === 'editTemAparelho' && !tipo) {
                         setValue('editTipoAparelho', 'Comodato'); 
                     }
                }
                if (getValue('editTipoAparelho') === 'Comodato') {
                    setValue('editValorAparelho', 0);
                    setValue('editValorParcela', currency(0));
                }
            }
            
            updateEditModalState();
        }

        function saveEditModal() {
            if (!__currentEditId) return false;
            const getValue = (id) => document.getElementById(id).value;
            
            const tipoVal = getValue('editTipo');
            const catVal = getValue('editCategoria');
            const planoVal = getValue('editPlano');

            // Validation Logic
            const erros = [];
            const normalize = (s) => String(s || '').toLowerCase();
            const isReneg = normalize(tipoVal).includes('reneg');
            
            if (isReneg) {
                const pa = getValue('editPlanoAtual');
                const pra = Number(getValue('editPrecoAtual') || 0);
                if (!pa || !pra) erros.push('Renegociações exigem Plano Atual e Preço Atual');
                
                const num = getValue('editNumero');
                if (!num || num.length < 8) erros.push('Renegociações exigem o número da linha');
            }
            
            const port = getValue('editPortabilidade');
            if (port === 'Sim') {
                const op = getValue('editOperadoraDoadora');
                const np = getValue('editNumeroPortar');
                if (!op) erros.push('Selecione a Operadora Doadora para portabilidade');
                if (!np || np.length < 8) erros.push('Informe o Número a Portar válido');
            }
            
            const temAp = getValue('editTemAparelho');
            if (temAp === 'Sim') {
                const mod = getValue('editModeloAparelho');
                const valAp = Number(getValue('editValorAparelho') || 0);
                if (!mod) erros.push('Informe o modelo do aparelho');
                if (valAp <= 0 && getValue('editTipoAparelho') !== 'Comodato') erros.push('Informe o valor do aparelho');
            }

            if (!planoVal) erros.push('Selecione um plano');

            if (erros.length > 0) {
                toast('Corrija os erros: ' + erros.join('; '), 'error');
                return false;
            }
            
            const valorPlano = Number(getValue('editValorPlano') || 0);
            const valorNaoFid = Number(getValue('editValorNaoFid') || 0);
            const desconto = Number(getValue('editDesconto') || 0);
            const pct = getValue('editPct');

            const valorAp = Number(getValue('editValorAparelho') || 0);
            const tipoAp = getValue('editTipoAparelho');
            let valorParcela = 0;
            if (tipoAp === 'VF 24x') valorParcela = valorAp / 24;

            linhas = linhas.map(l => {
                if (Number(l.id) !== Number(__currentEditId)) return l;
                return {
                    ...l,
                    ddd: getValue('editDdd'),
                    tipoNegociacao: tipoVal,
                    numero: getValue('editNumero'),
                    planoAtualGB: getValue('editPlanoAtual'),
                    precoAtual: Number(getValue('editPrecoAtual') || 0),
                    portabilidade: getValue('editPortabilidade'),
                    operadoraDoadora: getValue('editOperadoraDoadora'),
                    numeroPortar: getValue('editNumeroPortar'),
                    categoria: catVal,
                    plano: planoVal,
                    pct: pct === '-' ? '' : pct,
                    valorPlano: valorPlano,
                    valorNaoFidelizado: valorNaoFid,
                    desconto: desconto,
                    temAparelho: getValue('editTemAparelho'),
                    tipoAparelho: tipoAp,
                    modeloAparelho: getValue('editModeloAparelho'),
                    valorAparelho: valorAp,
                    valorParcela: valorParcela
                };
            });
            
            renderTable();
            renderResumo();
            validarProposta();
            salvarProposta(false);
            return true;
        }

        function renderTable() {
            const tbody = document.getElementById('tableBody');
            tbody.innerHTML = linhas.map((l, idx) => {
                const total = currency(calcularPrecoFinal(l) * (Number(l.quantidade) || 1));
                return `
                <tr>
                    <td>${idx + 1}</td>
                    <td>${l.tipoNegociacao || '-'}</td>
                    <td><input type="number" min="1" class="input" style="width:60px; text-align:center;" value="${l.quantidade || 1}" data-id="${l.id}" data-field="quantidade"></td>
                    <td>${total}</td>
                    <td class="col-actions">
                        <div class="table-actions">
                            <button type="button" class="btn btn-ghost btn-icon" title="Editar" onclick="openEditModal(${l.id})"><i data-lucide="settings"></i></button>
                            <button type="button" class="btn btn-ghost btn-icon" title="Duplicar" data-id="${l.id}" data-action="dup"><i data-lucide="copy"></i></button>
                            <button type="button" class="btn btn-ghost btn-icon" title="Excluir" data-id="${l.id}" data-action="del" style="border-color: rgba(239,68,68,0.35); color: #FCA5A5;" ${linhas.length <= 1 ? 'disabled' : ''}><i data-lucide="trash-2"></i></button>
                        </div>
                    </td>
                </tr>
                `;
            }).join('') || '<tr><td colspan="5" class="muted">Sem linhas</td></tr>';
            
            if (window.lucide && typeof window.lucide.createIcons === 'function') window.lucide.createIcons();
            
            Array.from(document.querySelectorAll('#tableBody .input[data-field="quantidade"]')).forEach(el => {
                el.addEventListener('change', onFieldChange);
                el.addEventListener('input', onFieldInput);
            });
            
            if (__isLocked) {
                Array.from(document.querySelectorAll('#tableBody .input')).forEach(el => { el.disabled = true; });
                Array.from(document.querySelectorAll('#tableBody button')).forEach(btn => { btn.disabled = true; });
            }
            
            Array.from(document.querySelectorAll('#tableBody [data-action="dup"]')).forEach(btn => {
                btn.addEventListener('click', () => {
                    const id = Number(btn.getAttribute('data-id') || 0);
                    const idx = linhas.findIndex(x => Number(x.id) === id);
                    const orig = idx >= 0 ? linhas[idx] : null;
                    if (!orig) return;
                    const novo = { ...orig, id: nextId++, ddd: '' };
                    linhas.splice(idx + 1, 0, novo);
                    renderTable();
                    renderResumo();
                    validarProposta();
                    salvarProposta();
                });
            });
            
            Array.from(document.querySelectorAll('#tableBody [data-action="del"]')).forEach(btn => {
                btn.addEventListener('click', () => {
                    if (linhas.length <= 1) {
                        toast('Não é possível excluir a única linha.', 'error');
                        return;
                    }
                    const id = Number(btn.getAttribute('data-id') || 0);
                    linhas = linhas.filter(x => Number(x.id) !== id);
                    renderTable();
                    renderResumo();
                    validarProposta();
                    salvarProposta();
                });
            });
        }

        function onFieldChange(e) {
            const id = Number(e.target.getAttribute('data-id') || 0);
            const field = String(e.target.getAttribute('data-field') || '');
            let val = e.target.value;
            
            linhas = linhas.map(l => {
                if (Number(l.id) !== id) return l;
                return { ...l, [field]: val };
            });
            
            renderTable();
            renderResumo();
            validarProposta();
            salvarProposta();
        }

        function onFieldInput() {
            renderResumo();
            validarProposta();
        }
        function novaProposta() {
            linhas = [];
            nextId = 1;
            linhas.push({
                id: nextId++,
                quantidade: 1,
                ddd: '',
                tipoNegociacao: 'Novo',
                numero: '',
                planoAtualGB: '',
                precoAtual: '',
                portabilidade: 'Não',
                operadoraDoadora: '',
                numeroPortar: '',
                categoria: (getFilteredCategorias('Novo')[0]?.nome || ''),
                plano: '',
                pct: '',
                valorPlano: '',
                valorNaoFidelizado: '',
                desconto: 0,
                temAparelho: 'Não',
                modeloAparelho: '',
                tipoAparelho: 'Comodato',
                valorAparelho: ''
            });
            const anotacoesEl = document.getElementById('fAnotacoes');
            if (anotacoesEl) anotacoesEl.value = '';
            renderTable();
            renderResumo();
            salvarProposta(true);
        }
        function adicionarLinha() {
            linhas.push({
                id: nextId++,
                quantidade: 1,
                ddd: '',
                tipoNegociacao: 'Novo',
                numero: '',
                planoAtualGB: '',
                precoAtual: '',
                portabilidade: 'Não',
                operadoraDoadora: '',
                numeroPortar: '',
                categoria: (getFilteredCategorias('Novo')[0]?.nome || ''),
                plano: '',
                pct: '',
                valorPlano: '',
                valorNaoFidelizado: '',
                desconto: 0,
                temAparelho: 'Não',
                modeloAparelho: '',
                tipoAparelho: 'Comodato',
                valorAparelho: ''
            });
            renderTable();
            renderResumo();
            validarProposta();
            salvarProposta();
        }
        async function carregarNegociacaoBasica() {
            const list = await api('/negotiations', { method: 'GET' }).catch(() => []);
            const arr = Array.isArray(list) ? list : [];
            const n = arr.find(x => Number(x.id) === Number(__negociacaoId));
            __negociacaoInfo = n || null;
        }
        async function carregarClienteBasico() {
            try {
                const cnpj = __negociacaoInfo ? (__negociacaoInfo.cnpj || '') : '';
                if (!cnpj) { __clienteInfo = null; return; }
                const list = await api('/clients?cnpj=' + encodeURIComponent(String(cnpj).replace(/\D/g, '')), { method: 'GET' }).catch(() => []);
                __clienteInfo = Array.isArray(list) && list.length ? list[0] : null;
            } catch { __clienteInfo = null; }
        }
        function renderClienteBasico() {
            const nomeEl = document.getElementById('clienteNome');
            const cnpjEl = document.getElementById('clienteCnpj');
            const tipoEl = document.getElementById('negTipo');
            const statusEl = document.getElementById('negStatusLabel');
            const n = __negociacaoInfo || {};
            const c = __clienteInfo || {};
            if (nomeEl) nomeEl.textContent = c.name || '-';
            if (cnpjEl) cnpjEl.textContent = formatCnpj(n.cnpj || c.cnpj || '');
            if (tipoEl) tipoEl.textContent = n.tipo || '-';
            if (statusEl) statusEl.textContent = n.status || 'Em andamento';
        }
        async function carregarPropostaSalva() {
            try {
                const data = await api(`/negotiations/${__negociacaoId}/custom-proposal`, { method: 'GET' }).catch(() => null);
                const anotacoesEl = document.getElementById('fAnotacoes');
                if (anotacoesEl) anotacoesEl.value = (data && data.anotacoes) ? data.anotacoes : '';
                const arr = (data && Array.isArray(data.linhas)) ? data.linhas : [];
                linhas = arr.map((l, idx) => ({
                    id: Number(l.id || idx + 1),
                    quantidade: Number(l.quantidade) || 1,
                    ddd: l.ddd || '',
                    tipoNegociacao: l.tipoNegociacao || 'Novo',
                    numero: l.numero || '',
                    planoAtualGB: l.planoAtualGB || '',
                    precoAtual: Number(l.precoAtual || 0),
                    portabilidade: l.portabilidade || 'Não',
                    operadoraDoadora: l.operadoraDoadora || '',
                    numeroPortar: l.numeroPortar || '',
                    categoria: l.categoria || '',
                    plano: l.plano || l.planoSelecionado || '',
                    pct: l.pct || l.pctSelecionado || '',
                    valorPlano: l.valorPlano || '',
                    valorNaoFidelizado: l.valorNaoFidelizado || l.valorPlano || '',
                    desconto: l.desconto || 0,
                    temAparelho: l.temAparelho || 'Não',
                    modeloAparelho: l.modeloAparelho || '',
                    tipoAparelho: l.tipoAparelho || 'Comodato',
                    valorAparelho: l.valorAparelho || ''
                }));
                if (linhas.length > 0) {
                    const maxId = linhas.reduce((max, l) => Math.max(max, l.id), 0);
                    nextId = maxId + 1;
                }
                if (!linhas.length) adicionarLinha(); else { renderTable(); renderResumo(); validarProposta(); }
            } catch { adicionarLinha(); }
        }
        async function salvarProposta(skipValidation = false) {
            //if (!skipValidation) {
                const erros = validarProposta();
                if (erros.length) {
                    toast('Corrija os seguintes problemas: ' + erros.join('; '), 'error');
                    return;
                }
           //}
            try {
                if (!__negociacaoId) return;
                const anotacoes = document.getElementById('fAnotacoes').value || '';
                const payload = { linhas, anotacoes };
                const resp = await api(`/negotiations/${__negociacaoId}/custom-proposal`, { method: 'POST', body: JSON.stringify(payload) });
                // Força o uso do cálculo local para garantir consistência com o visual (ignorando possível cálculo divergente do backend)
                const totalProposto = calcularTotais().totalProposto;
                await api('/negotiations/' + __negociacaoId, { method: 'PUT', body: JSON.stringify({ valor: totalProposto }) }).catch(() => {});
                if (__negociacaoInfo) __negociacaoInfo.valor = totalProposto;
                toast('Salvando...', 'success');
            } catch { toast('Erro ao salvar proposta', 'error'); }
        }
        async function atualizarStatusNegociacao() {
            try {
                if (!__negociacaoId) return;
                const el = document.getElementById('fStatus');
                const status = el ? el.value : 'Em andamento';
                await api('/negotiations/' + __negociacaoId, { method: 'PUT', body: JSON.stringify({ status }) });
                if (__negociacaoInfo) __negociacaoInfo.status = status;
                const statusEl = document.getElementById('negStatusLabel');
                if (statusEl) statusEl.textContent = status;
                toast('Status atualizado para ' + status, 'success');
            } catch { toast('Erro ao atualizar status', 'error'); }
        }
        function copiarProposta() {
            const erros = validarProposta();
            if (erros.length) {
                toast('Corrija os seguintes problemas: ' + erros.join('; '), 'error');
                return;
            }
            try {
                const totais = calcularTotais();
                
                const extractMB = (str) => {
                    if (!str) return 0;
                    const match = str.match(/(\d+(?:[.,]\d+)?)\s*(GB|MB|KB)/i);
                    if (!match) return 0;
                    let val = parseFloat(match[1].replace(',', '.'));
                    const unit = match[2].toUpperCase();
                    if (unit === 'GB') return val * 1024;
                    if (unit === 'MB') return val;
                    if (unit === 'KB') return val / 1024;
                    return 0;
                };
                const formatMB = (mb) => {
                    if (mb <= 0) return '0 GB';
                    if (mb >= 1024) {
                        const gb = mb / 1024;
                        return (gb % 1 === 0 ? gb.toFixed(0) + ' GB' : gb.toFixed(1).replace('.', ',') + ' GB');
                    }
                    return Math.round(mb) + ' MB';
                };

                let totalDadosAtualMB = 0;
                let totalDadosNovoMB = 0;

                linhas.forEach(l => {
                    const qtd = Number(l.quantidade || 1);
                    totalDadosAtualMB += extractMB(l.planoAtualGB) * qtd;
                    totalDadosNovoMB += extractMB(l.plano) * qtd;
                });

                const totalAtual = currency(totais.totalAtual);
                const totalProposto = currency(totais.totalProposto);
                
                const c = __clienteInfo || {};
                const endParts = [];
                if (c.street) endParts.push(c.street);
                if (c.number) endParts.push(c.number);
                if (c.neighborhood) endParts.push(c.neighborhood);
                if (c.city) endParts.push(c.city + (c.state ? '-' + c.state : ''));
                if (c.cep) endParts.push(c.cep);
                const endereco = endParts.join(', ');

                const contatoParts = [];
                if (c.phone) contatoParts.push(formatPhone(c.phone));
                if (c.email) contatoParts.push(c.email);
                const contato = contatoParts.join(' • ');

                const header = [
                    '✨ Proposta Customizada • Maxximus Telecom',
                    '🏢 Cliente: ' + ((document.getElementById('clienteNome').textContent) || '-'),
                    '🧾 CNPJ: ' + ((document.getElementById('clienteCnpj').textContent) || '-'),
                    (endereco ? '📍 Endereço: ' + endereco : ''),
                    (contato ? '📞 Contato: ' + contato : ''),
                    '📌 Tipo: ' + ((document.getElementById('negTipo').textContent) || '-'),
                    '🟢 Status: ' + ((document.getElementById('negStatusLabel').textContent) || '-'),
                    '───────────────────────────────────'
                ].filter(l => l !== '').join('\n');
                
                const linhasTxt = linhas.map((l, idx) => {
                    const tipo = String(l.tipoNegociacao || '-').toLowerCase();
                    const em = tipo.includes('reneg') ? '🔁' : (tipo.includes('adti') || tipo.includes('adit') ? '➕' : '🌟');
                    const acessoFmt = l.ddd ? `DDD ${l.ddd}` : '-';
                    const numFmt = l.numero ? `\n    Número: ${l.numero}` : '';
                    const atual = `${l.planoAtualGB || '-'} ${currency(l.precoAtual || 0)}`;
                    const proposto = `${l.plano || '-'} ${l.pct || '-'}`;
                    
                    const unitario = currency(calcularPrecoFinal(l));
                    const totalLinha = currency(calcularPrecoFinal(l) * (Number(l.quantidade) || 1));
                    const desc = Number(l.desconto || 0) + '%';
                    
                    return `${em} Linha ${idx + 1}
    Qtd: ${l.quantidade}
    DDD: ${acessoFmt}${numFmt}
    Tipo: ${l.tipoNegociacao || '-'}
    Atual: ${atual}
    Proposto: ${proposto}
    Desconto: ${desc}
    Unitário: ${unitario}
    Total: ${totalLinha}`;
                }).join('\n\n');
                
                const resumo = [
                    '',
                    '📊 Resumo',
                    `   💰 Proposta Atual: ${totalAtual}`,
                    `   🧾 Nova Proposta: ${totalProposto}`,
                    `   📦 Total de dados atual: ${formatMB(totalDadosAtualMB)}`,
                    `   🔢 Total de dados da nova proposta: ${formatMB(totalDadosNovoMB)}`,
                    '',
                    '🚀 Maxximus Telecom • Conectando sua empresa ao futuro'
                ].join('\n');
                
                const txt = header + '\n\n' + linhasTxt + '\n\n' + resumo;
                navigator.clipboard.writeText(txt).then(() => { toast('Proposta copiada', 'success'); }).catch(() => { toast('Erro ao copiar proposta', 'error'); });
            } catch { toast('Erro ao copiar proposta', 'error'); }
        }
        function gerarRelatorioPdf() {
            try {
                const lib = window.jspdf || {};
                const jsPDF = lib.jsPDF;
                if (!jsPDF || !document || !document.body) { toast('Biblioteca de PDF indisponível', 'error'); return; }
                const doc = new jsPDF({ unit: 'pt', format: 'a4' });
                const n = __negociacaoInfo || {};
                const c = __clienteInfo || {};
                const totais = calcularTotais();
                const acessos = linhas.length;
                doc.setFontSize(14);
                doc.text('Relatório da Proposta Customizada', 40, 40);
                doc.setFontSize(9);
                doc.text('Gerado em ' + new Date().toLocaleString('pt-BR'), 40, 56);
                try {
                    const u = JSON.parse(localStorage.getItem('authUser') || '{}');
                    if (u && u.name) {
                        doc.text('Consultor: ' + u.name, 40, 68);
                    }
                } catch {}
                doc.setFontSize(10);
                doc.text('Total Proposto: ' + currency(totais.totalProposto), 450, 40, { align: 'right' });
                doc.autoTable({
                    startY: 80,
                    head: [['Campo', 'Valor']],
                    body: [
                        ['Nome', c.name || '-'],
                        ['CNPJ', formatCnpj(n.cnpj || c.cnpj || '')],
                        ['Telefone', formatPhone(c.phone || '') || '-'],
                        ['Email', c.email || '-'],
                        ['Tipo', n.tipo || '-'],
                        ['Proposta', n.proposta || '-'],
                        ['Status', n.status || 'Em andamento']
                    ],
                    styles: { fontSize: 9 },
                    headStyles: { fillColor: [243, 244, 246], textColor: [55, 65, 81] },
                    theme: 'grid',
                    margin: { left: 40, right: 40 }
                });
                doc.autoTable({
                    startY: doc.lastAutoTable.finalY + 12,
                    head: [['Linha', 'DDD', 'Número', 'Plano Atual', 'Preço Atual', 'Portabilidade', 'Op. Doadora', 'Num. Portar']],
                    body: linhas.map((l, idx) => [
                        String(idx + 1),
                        String(l.ddd || '-'),
                        String(l.numero || '-'),
                        String(l.planoAtualGB || '-'),
                        String(currency(l.precoAtual || 0)),
                        String(l.portabilidade || '-'),
                        String(l.operadoraDoadora || '-'),
                        String(l.numeroPortar || '-')
                    ]),
                    styles: { fontSize: 9 },
                    headStyles: { fillColor: [243, 244, 246], textColor: [55, 65, 81] },
                    theme: 'grid',
                    margin: { left: 40, right: 40 }
                });
                doc.autoTable({
                    startY: doc.lastAutoTable.finalY + 12,
                    head: [['Linha', 'Qtd', 'Tipo', 'Categoria', 'Plano', 'Pct', 'Valor Plano', 'Total Linha', 'Valor Não Fid.', '% Desc.', 'Valor c/Desc.', 'Economia', 'Aparelho', 'Modelo', 'Tipo Aparelho', 'R$ Total Aparelho', 'R$ da Parcela']],
                    body: linhas.map((l, idx) => [
                        String(idx + 1),
                        String(l.quantidade || 1),
                        String(l.tipoNegociacao || '-'),
                        String(l.categoria || '-'),
                        String(l.plano || '-'),
                        String(l.pct || '-'),
                        String(currency(l.valorPlano || 0)),
                        String(currency((Number(l.quantidade)||1) * (Number(l.valorPlano)||0))),
                        String(currency(l.valorNaoFidelizado || 0)),
                        String(Number(l.desconto || 0) + '%'),
                        String(currency(calcularPrecoFinal(l))),
                        String(currency(calcularEconomia(l))),
                        String(l.temAparelho || '-'),
                        String(l.modeloAparelho || '-'),
                        String(l.tipoAparelho || '-'),
                        String(currency(l.valorAparelho || 0)),
                        String(currency(l.valorParcela || 0))
                    ]),
                    styles: { fontSize: 9, cellPadding: 3 },
                    headStyles: { fillColor: [243, 244, 246], textColor: [55, 65, 81] },
                    showHead: 'firstPage',
                    theme: 'grid',
                    margin: { left: 40, right: 40 }
                });
                const y = doc.lastAutoTable.finalY + 16;
                doc.setFontSize(9);
                doc.text('Total de acessos: ' + String(acessos) + ' • Receita Atual: ' + currency(totais.totalAtual) + ' • Receita Proposta: ' + currency(totais.totalProposto) + ' • Economia: ' + currency(totais.totalEconomia), 40, y);
                doc.save('relatorio_proposta_customizada.pdf');
            } catch { toast('Erro ao gerar relatório', 'error'); }
        }
        async function loadAttachments() {
            try {
                const list = await api(`/negotiations/${__negociacaoId}/custom-attachments`, { method: 'GET' }).catch(() => []);
                renderAttachments(list);
            } catch { toast('Erro ao carregar anexos', 'error'); }
        }

        function renderAttachments(list) {
            const container = document.getElementById('attachmentsList');
            if (!container) return;
            container.innerHTML = '';
            
            if (!Array.isArray(list) || list.length === 0) {
                return;
            }

            list.forEach(att => {
                const div = document.createElement('div');
                div.className = 'chip';
                div.style.display = 'inline-flex';
                div.style.alignItems = 'center';
                div.style.gap = '0.5rem';
                div.style.padding = '0.5rem';
                div.style.border = '1px solid #e5e7eb';
                div.style.borderRadius = '6px';
                
                const iconName = getIconForType(att.file_type);
                
                div.innerHTML = `
                    <i data-lucide="${iconName}" style="width:16px; height:16px;"></i>
                    <a href="${API_BASE}/negotiations/${__negociacaoId}/custom-attachments/${att.id}/content" target="_blank" style="text-decoration:none; color:inherit; font-size:0.9rem;">${att.file_name}</a>
                    <button type="button" class="btn btn-ghost btn-icon" style="width:20px; height:20px; min-height:20px; padding:0;" onclick="deleteAttachment(${att.id})">
                        <i data-lucide="x" style="width:14px; height:14px;"></i>
                    </button>
                `;
                container.appendChild(div);
            });
            if (window.lucide && typeof window.lucide.createIcons === 'function') window.lucide.createIcons();
        }

        function getIconForType(type) {
            if (type.includes('image')) return 'image';
            if (type.includes('pdf')) return 'file-text';
            if (type.includes('excel') || type.includes('spreadsheet')) return 'sheet';
            return 'file';
        }

        async function handleFileUpload(e) {
            const file = e.target.files[0];
            if (!file) return;

            const formData = new FormData();
            formData.append('file', file);
            formData.append('fileName', file.name);
            formData.append('fileType', file.type);

            try {
                await api(`/negotiations/${__negociacaoId}/custom-attachments`, {
                    method: 'POST',
                    body: formData
                });
                toast('Anexo enviado com sucesso', 'success');
                loadAttachments();
            } catch {
                toast('Erro ao enviar anexo', 'error');
            } finally {
                e.target.value = '';
            }
        }

        async function deleteAttachment(id) {
            const modal = document.getElementById('confirmAttachmentDeleteModal');
            const btnClose = document.getElementById('confirmAttachmentDeleteClose');
            const btnCancel = document.getElementById('confirmAttachmentDeleteCancel');
            const btnConfirm = document.getElementById('confirmAttachmentDeleteConfirm');

            if (!modal) {
                if (confirm('Deseja excluir este anexo?')) {
                    proceedDelete(id);
                }
                return;
            }

            const closeModal = () => {
                modal.classList.remove('show');
                // Clean up listeners to avoid duplicates
                btnConfirm.replaceWith(btnConfirm.cloneNode(true));
            };

            const openModal = () => {
                modal.classList.add('show');
                if (window.lucide && typeof window.lucide.createIcons === 'function') window.lucide.createIcons();
            };

            // Re-select confirm button after clone
            const newBtnConfirm = document.getElementById('confirmAttachmentDeleteConfirm');
            
            newBtnConfirm.addEventListener('click', () => {
                closeModal();
                proceedDelete(id);
            });
            
            // Add listeners for closing (using replaceWith to avoid duplicates not strictly necessary for close buttons but good practice if reusing)
             if (btnClose) {
                btnClose.onclick = closeModal;
            }
            if (btnCancel) {
                btnCancel.onclick = closeModal;
            }

            openModal();
        }

        async function proceedDelete(id) {
            try {
                await api(`/negotiations/${__negociacaoId}/custom-attachments/${id}`, { method: 'DELETE' });
                toast('Anexo excluído', 'success');
                loadAttachments();
            } catch {
                toast('Erro ao excluir anexo', 'error');
            }
        }

        document.addEventListener('DOMContentLoaded', async () => {
            const auth = localStorage.getItem('authUser');
            if (!auth) { window.location.href = 'login.html'; return; }
            try {
                const params = new URLSearchParams(window.location.search || '');
                const idParam = Number(params.get('id') || 0);
                if (!idParam) { window.location.href = 'negociar.html'; return; }
                __negociacaoId = idParam;
                await carregarTiposBackend();
                await carregarCatalogoCustomizado();
                construirMapaCustomizado();
                await carregarNegociacaoBasica();
                if (!__negociacaoInfo) { window.location.href = 'negociar.html'; return; }
                await carregarClienteBasico();
                renderClienteBasico();
                await carregarPropostaSalva();
                loadAttachments();
                bindEditModalEvents();
                const addLinhaBtn = document.getElementById('addLinhaBtn');
                const salvarBtn = document.getElementById('salvarBtn');
                const copiarBtn = document.getElementById('copiarBtn');
                const relatorioBtn = document.getElementById('relatorioBtn');
                const statusSel = document.getElementById('fStatus');
                const novaBtn = document.getElementById('novaBtn');
                try {
                    const u = JSON.parse(localStorage.getItem('authUser') || '{}');
                    const role = String(u && u.role ? u.role : '');
                    const status = (__negociacaoInfo && __negociacaoInfo.status) ? __negociacaoInfo.status : 'Em andamento';
                    __isLocked = (role !== 'admin' && status === 'Concluída');
                } catch { __isLocked = false; }
                if (addLinhaBtn) addLinhaBtn.addEventListener('click', adicionarLinha);
                if (salvarBtn) salvarBtn.addEventListener('click', salvarProposta);
                if (copiarBtn) copiarBtn.addEventListener('click', copiarProposta);
                if (relatorioBtn) relatorioBtn.addEventListener('click', gerarRelatorioPdf);
                if (statusSel) {
                    statusSel.value = (__negociacaoInfo && __negociacaoInfo.status) ? __negociacaoInfo.status : 'Em andamento';
                    statusSel.addEventListener('change', atualizarStatusNegociacao);
                    if (__isLocked) statusSel.disabled = true;
                }
                if (__isLocked) {
                    if (addLinhaBtn) addLinhaBtn.disabled = true;
                    if (salvarBtn) salvarBtn.disabled = true;
                    if (novaBtn) novaBtn.disabled = true;
                    renderTable();
                }
                if (novaBtn) {
                    const modal = document.getElementById('confirmResetModal');
                    const btnClose = document.getElementById('confirmResetClose');
                    const btnCancel = document.getElementById('confirmResetCancel');
                    const btnConfirm = document.getElementById('confirmResetConfirm');
                    const open = () => { if (modal) { modal.classList.add('show'); if (window.lucide && typeof window.lucide.createIcons === 'function') window.lucide.createIcons(); } };
                    const close = () => { if (modal) modal.classList.remove('show'); };
                    novaBtn.addEventListener('click', open);
                    if (btnClose) btnClose.addEventListener('click', close);
                    if (btnCancel) btnCancel.addEventListener('click', close);
                    if (btnConfirm) btnConfirm.addEventListener('click', () => { close(); novaProposta(); });
                }
                const anotacoesEl = document.getElementById('fAnotacoes');
                if (anotacoesEl) anotacoesEl.addEventListener('blur', () => salvarProposta());
                const fileInput = document.getElementById('fileInput');
                if (fileInput) fileInput.addEventListener('change', handleFileUpload);
                if (window.lucide && typeof window.lucide.createIcons === 'function') window.lucide.createIcons();
            } catch (e) {
                console.error(e);
                toast('Erro ao carregar negociação: ' + e.message, 'error');
            }
        });
    </script>
    <div id="toast" class="toast"></div>
    <div id="editLineModal" class="modal">
        <div class="modal-card" style="max-width: 900px; width: 95%;">
            <div class="modal-head">
                <div>Editar Linha</div>
                <button id="editLineClose" class="btn btn-ghost btn-icon"><i data-lucide="x"></i></button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="editLineId">
                
                <!-- 1. Dados da Linha -->
                <div class="section-block">
                    <div class="section-header">
                        <i data-lucide="phone" class="section-icon"></i>
                        <div>
                            <div class="section-title">Dados da Linha</div>
                            <div class="section-desc">Informações básicas do número</div>
                        </div>
                    </div>
                    <div class="grid-3">
                        <div>
                            <div class="label">DDD</div>
                            <select id="editDdd" class="select"></select>
                        </div>
                        <div>
                            <div class="label">Tipo</div>
                            <select id="editTipo" class="select"></select>
                        </div>
                        <div>
                            <div class="label">Número</div>
                            <input id="editNumero" type="text" class="input" placeholder="00000-0000" maxlength="10">
                        </div>
                    </div>
                </div>

                <!-- 2. Plano Atual -->
                <div class="section-block">
                    <div class="section-header">
                        <i data-lucide="file-text" class="section-icon"></i>
                        <div>
                            <div class="section-title">Plano Atual</div>
                            <div class="section-desc">O que o cliente já possui</div>
                        </div>
                    </div>
                    <div class="grid-2">
                        <div>
                            <div class="label">Plano Atual (Dados)</div>
                            <select id="editPlanoAtual" class="select"></select>
                        </div>
                        <div>
                            <div class="label">Preço Atual (R$)</div>
                            <input id="editPrecoAtual" type="number" step="0.01" class="input">
                        </div>
                    </div>
                </div>

                <!-- 3. Portabilidade -->
                <div class="section-block">
                    <div class="section-header">
                        <i data-lucide="arrow-left-right" class="section-icon"></i>
                        <div>
                            <div class="section-title">Portabilidade</div>
                            <div class="section-desc">Trazer número de outra operadora</div>
                        </div>
                    </div>
                    <div>
                        <div class="label">Deseja realizar portabilidade?</div>
                        <select id="editPortabilidade" class="select">
                            <option value="Não">Não</option>
                            <option value="Sim">Sim</option>
                        </select>
                    </div>
                    <div id="areaPortabilidadeDetails" class="grid-2" style="margin-top: 1rem; display: none;">
                        <div>
                            <div class="label">Operadora Doadora</div>
                            <select id="editOperadoraDoadora" class="select"></select>
                        </div>
                        <div>
                            <div class="label">Número a Portar</div>
                            <input id="editNumeroPortar" type="text" class="input" placeholder="00000-0000" maxlength="10">
                        </div>
                    </div>
                </div>

                <!-- 4. Novo Plano -->
                <div class="section-block">
                    <div class="section-header">
                        <i data-lucide="package" class="section-icon"></i>
                        <div>
                            <div class="section-title">Novo Plano</div>
                            <div class="section-desc">Configuração da nova oferta</div>
                        </div>
                    </div>
                    <div class="grid-2" style="margin-bottom: 1rem;">
                        <div>
                            <div class="label">Categoria</div>
                            <select id="editCategoria" class="select"></select>
                        </div>
                        <div>
                            <div class="label">Plano</div>
                            <select id="editPlano" class="select"></select>
                        </div>
                    </div>
                    <div class="grid-3" style="margin-bottom: 1rem;">
                        <div style="display:none;">
                            <div class="label">Pct</div>
                            <input id="editPct" type="text" class="input" readonly disabled style="background-color: #f3f4f6;">
                        </div>
                        <div>
                            <div class="label">Valor Plano (R$)</div>
                            <input id="editValorPlano" type="number" step="0.01" class="input">
                        </div>
                        <div>
                            <div class="label">Valor Não Fid. (R$)</div>
                            <input id="editValorNaoFid" type="number" step="0.01" class="input">
                        </div>
                        <div>
                            <div class="label">% Desc.</div>
                            <input id="editDesconto" type="number" step="0.01" class="input">
                        </div>
                    </div>
                    <div class="grid-2">
                        <div>
                            <div class="label">Valor c/Desc.</div>
                            <input id="editValorFinal" type="text" class="input" readonly disabled style="background-color: #e5e7eb; font-weight: 600; color: var(--primary);">
                        </div>
                        <div>
                            <div class="label">Economia</div>
                            <input id="editEconomia" type="text" class="input" readonly disabled style="background-color: #e5e7eb;">
                        </div>
                    </div>
                </div>

                <!-- 5. Aparelho -->
                <div class="section-block">
                    <div class="section-header">
                        <i data-lucide="smartphone" class="section-icon"></i>
                        <div>
                            <div class="section-title">Aparelho</div>
                            <div class="section-desc">Adicionar dispositivo à linha</div>
                        </div>
                    </div>
                    <div>
                        <div class="label">Incluir aparelho?</div>
                        <select id="editTemAparelho" class="select">
                            <option value="Não">Não</option>
                            <option value="Sim">Sim</option>
                        </select>
                    </div>
                    <div id="areaAparelhoDetails" style="margin-top: 1rem; display: none;">
                        <div class="grid-2" style="margin-bottom: 1rem;">
                            <div>
                                <div class="label">Tipo Aparelho</div>
                                <select id="editTipoAparelho" class="select"></select>
                            </div>
                            <div>
                                <div class="label">Modelo</div>
                                <input id="editModeloAparelho" type="text" class="input">
                            </div>
                        </div>
                        <div class="grid-2">
                            <div>
                                <div class="label">R$ Total Aparelho</div>
                                <input id="editValorAparelho" type="number" step="0.01" class="input">
                            </div>
                            <div>
                                <div class="label">R$ da Parcela</div>
                                <input id="editValorParcela" type="text" class="input" readonly disabled style="background-color: #f3f4f6;">
                            </div>
                        </div>
                    </div>
                </div>

            </div>
            <div class="modal-actions">
                <button id="editLineCancel" class="btn btn-ghost" type="button"><i data-lucide="x"></i><span>Cancelar</span></button>
                <button id="editLineSave" class="btn btn-primary" type="button"><i data-lucide="check"></i><span>Salvar</span></button>
            </div>
        </div>
    </div>
    <div id="confirmResetModal" class="modal">
        <div class="modal-card">
            <div class="modal-head"><div>Confirmar Reset</div><button id="confirmResetClose" class="btn btn-ghost btn-icon"><i data-lucide="x"></i></button></div>
            <div class="modal-body">
                <div class="label">Tem certeza que deseja resetar a proposta?</div>
                <div class="muted" style="margin-top:0.5rem;">Esta ação limpa todas as linhas atuais.</div>
            </div>
            <div class="modal-actions">
                <button id="confirmResetCancel" class="btn btn-ghost" type="button"><i data-lucide="x"></i><span>Cancelar</span></button>
                <button id="confirmResetConfirm" class="btn btn-ghost" type="button" style="border-color: rgba(239,68,68,0.35); color: #FCA5A5;"><i data-lucide="rotate-ccw"></i><span>Resetar</span></button>
            </div>
        </div>
    </div>
    <div id="confirmAttachmentDeleteModal" class="modal">
        <div class="modal-card">
            <div class="modal-head"><div>Excluir Anexo</div><button id="confirmAttachmentDeleteClose" class="btn btn-ghost btn-icon"><i data-lucide="x"></i></button></div>
            <div class="modal-body">
                <div class="label">Tem certeza que deseja excluir este anexo?</div>
                <div class="muted" style="margin-top:0.5rem;">Esta ação não poderá ser desfeita.</div>
            </div>
            <div class="modal-actions">
                <button id="confirmAttachmentDeleteCancel" class="btn btn-ghost" type="button"><i data-lucide="x"></i><span>Cancelar</span></button>
                <button id="confirmAttachmentDeleteConfirm" class="btn btn-ghost" type="button" style="border-color: rgba(239,68,68,0.35); color: #FCA5A5;"><i data-lucide="trash-2"></i><span>Excluir</span></button>
            </div>
        </div>
    </div>
    <script src="script.js"></script>
</body>
</html>
