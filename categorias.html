<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Categorias • Maxximus Telecom</title>
    <link rel="icon" href="data:,">
    <link rel="stylesheet" href="style.css">
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
</head>
<body>
    <main class="container">
        <div class="card">
            <div class="card-head">
                <div class="card-title">
                    <span>Oferta Padrão</span>
                    <span class="chip">Categorias</span>
                </div>
                <div class="muted">
                    <button id="novaCategoriaBtn" class="btn btn-primary" type="button"><i data-lucide="plus"></i><span>Nova categoria</span></button>
                </div>
            </div>
            <div class="card-body">
                <section class="section" style="margin-top: 20px;">
                    <div id="filtersCategorias" class="filters">
                        <div>
                            <div class="label">Nome</div>
                            <input id="fCatNome" class="input" type="text" placeholder="Nome da categoria" autocomplete="off">
                        </div>
                        <div>
                            <div class="label">Descrição</div>
                            <input id="fCatDesc" class="input" type="text" placeholder="Descrição" autocomplete="off">
                        </div>
                        <div style="display:flex; align-items:flex-end; gap:0.5rem;">
                            <button id="catBuscarBtn" class="btn btn-primary" type="button" title="Buscar"><i data-lucide="search"></i><span>Buscar</span></button>
                            <button id="catLimparBtn" class="btn btn-ghost" type="button" title="Limpar"><i data-lucide="rotate-ccw"></i><span>Limpar</span></button>
                        </div>
                    </div>
                </section>
                <section class="section" style="margin-top: 10px;">
                    <div style="display:flex; align-items:center; justify-content:space-between;">
                        <div class="label">Lista de categorias</div>
                        <div class="muted" id="catCountLabel">0 itens</div>
                    </div>
                    <div class="table-container" style="margin-top:0.6rem;">
                        <table>
                            <thead>
                                <tr>
                                    <th>Nome</th>
                                    <th>Descrição</th>
                                    <th>Tipo</th>
                                    <th class="col-actions" style="min-width:160px;">Ações</th>
                                </tr>
                            </thead>
                            <tbody id="catTbody">
                                <tr><td colspan="3">
                                    <div class="skeleton skel-row"></div>
                                    <div class="skeleton skel-row"></div>
                                    <div class="skeleton skel-row"></div>
                                    <div class="skeleton skel-row"></div>
                                </td></tr>
                            </tbody>
                        </table>
                    </div>
                </section>
            </div>
        </div>
    </main>
    <script>
        const API_BASE = 'https://others-maxximus-backend.pvuzyy.easypanel.host';
        async function api(path, options = {}) {
            const authRaw = localStorage.getItem('authUser');
            let headers = { 'Content-Type': 'application/json' };
            try {
                const u = JSON.parse(authRaw || '{}');
                if (u && u.id) headers['x-user-id'] = String(u.id);
                if (u && u.role) headers['x-user-role'] = String(u.role);
                if (u && u.name) headers['x-user-name'] = String(u.name);
            } catch {}
            const res = await fetch(API_BASE + path, { headers, ...options });
            if (!res.ok) {
                const err = await res.json().catch(() => ({}));
                throw new Error(err.error || ('HTTP ' + res.status));
            }
            return res.json();
        }
        function toast(msg, type) {
            const el = document.getElementById('toast');
            if (!el) return;
            el.textContent = msg;
            el.style.borderColor = type === 'error' ? 'rgba(239,68,68,0.35)' : 'rgba(16,185,129,0.35)';
            el.style.display = 'block';
            clearTimeout(window.__toastTimer);
            window.__toastTimer = setTimeout(() => { el.style.display = 'none'; }, 2500);
        }
        let __categorias = [];
        let __editingCatId = null;
        function tipoChipStyle(t) {
            const key = String(t || '').toLowerCase();
            if (key === 'novo') return 'border-color: rgba(16,185,129,0.35); background: rgba(16,185,129,0.12);';
            if (key === 'adtivo') return 'border-color: rgba(245,158,11,0.35); background: rgba(245,158,11,0.12);';
            if (key === 'renegociação' || key === 'renegociacao') return 'border-color: rgba(59,130,246,0.35); background: rgba(59,130,246,0.12);';
            return 'border-color: rgba(156,163,175,0.35); background: rgba(156,163,175,0.12);';
        }
        function renderCategoriasTable(list) {
            const tbody = document.getElementById('catTbody');
            const arr = Array.isArray(list) ? list : [];
            const countLabel = document.getElementById('catCountLabel');
            if (countLabel) countLabel.textContent = arr.length + ' ' + (arr.length === 1 ? 'item' : 'itens');
            tbody.innerHTML = arr.map(c => `
                <tr>
                    <td><span class="ellipsis">${c.nome || c.name || '-'}</span></td>
                    <td><span class="ellipsis">${c.descricao || c.description || '-'}</span></td>
                    <td><span class="chip" style="${tipoChipStyle(c.tipo)}">${c.tipo || '-'}</span></td>
                    <td class="col-actions">
                        <div class="table-actions">
                            <button type="button" class="btn btn-ghost btn-icon" title="Editar" onclick="abrirEditarCategoria(${c.id})"><i data-lucide="edit-3"></i></button>
                            <button type="button" class="btn btn-ghost btn-icon" title="Duplicar" onclick="abrirConfirmDuplicarCategoria(${c.id})"><i data-lucide="copy"></i></button>
                            <button type="button" class="btn btn-ghost btn-icon" title="Excluir" onclick="abrirConfirmExcluirCategoria(${c.id})" style="border-color: rgba(239,68,68,0.35); color: #FCA5A5;"><i data-lucide="trash-2"></i></button>
                        </div>
                    </td>
                </tr>
            `).join('') || '<tr><td colspan="4" class="muted">Sem resultados</td></tr>';
            if (window.lucide && typeof window.lucide.createIcons === 'function') window.lucide.createIcons();
        }
        async function carregarCategoriasList() {
            try {
                const list = await api('/categories', { method: 'GET' }).catch(() => []);
                __categorias = Array.isArray(list) ? list : [];
                renderCategoriasTable(__categorias);
            } catch {
                __categorias = [];
                renderCategoriasTable([]);
            }
        }
        function aplicarFiltroCategorias() {
            const nome = String(document.getElementById('fCatNome').value || '').trim().toUpperCase();
            const desc = String(document.getElementById('fCatDesc').value || '').trim().toUpperCase();
            let arr = (__categorias || []).slice();
            if (nome) arr = arr.filter(c => String(c.nome || c.name || '').toUpperCase().includes(nome));
            if (desc) arr = arr.filter(c => String(c.descricao || c.description || '').toUpperCase().includes(desc));
            renderCategoriasTable(arr);
        }
        function openModal() { document.getElementById('categoriaModal').classList.add('show'); }
        function closeModal() {
            const modal = document.getElementById('categoriaModal');
            if (modal) modal.classList.remove('show');
            __editingCatId = null;
            const nome = document.getElementById('mCatNome');
            const desc = document.getElementById('mCatDesc');
            const tipo = document.getElementById('mCatTipo');
            if (nome) nome.value = '';
            if (desc) desc.value = '';
            if (tipo) tipo.value = 'Novo';
        }
        window.detalharCategoria = function(id) {
            const c = (__categorias || []).find(x => Number(x.id) === Number(id));
            const msg = [
                'Categoria',
                'Nome: ' + (c?.nome || c?.name || '-'),
                'Descrição: ' + (c?.descricao || c?.description || '-')
            ].join('\n');
            alert(msg);
        };
        window.abrirEditarCategoria = function(id) {
            const c = (__categorias || []).find(x => Number(x.id) === Number(id));
            if (!c) return;
            __editingCatId = Number(c.id);
            document.getElementById('mCatNome').value = c.nome || c.name || '';
            document.getElementById('mCatDesc').value = c.descricao || c.description || '';
            const tipoEl = document.getElementById('mCatTipo');
            if (tipoEl) tipoEl.value = c.tipo || 'Novo';
            openModal();
            if (window.lucide && typeof window.lucide.createIcons === 'function') window.lucide.createIcons();
        };
        window.excluirCategoria = async function(id) {
            try {
                const ok = window.confirm('Confirmar exclusão?');
                if (!ok) return;
                await api('/categories/' + id, { method: 'DELETE' });
                toast('Categoria excluída', 'success');
                carregarCategoriasList();
            } catch {
                toast('Erro ao excluir categoria', 'error');
            }
        };
        async function salvarCategoriaModal() {
            try {
                const nome = String(document.getElementById('mCatNome').value || '').trim();
                const descricao = String(document.getElementById('mCatDesc').value || '').trim() || null;
                const tipo = String(document.getElementById('mCatTipo').value || 'Novo');
                if (!nome) { toast('Informe o nome da categoria', 'error'); return; }
                if (__editingCatId) {
                    await api('/categories/' + __editingCatId, { method: 'PUT', body: JSON.stringify({ nome, descricao, tipo }) });
                    toast('Categoria atualizada', 'success');
                } else {
                    await api('/categories', { method: 'POST', body: JSON.stringify({ nome, descricao, tipo }) });
                    toast('Categoria registrada', 'success');
                }
                closeModal();
                carregarCategoriasList();
            } catch {
                toast('Erro ao salvar categoria', 'error');
            }
        }
        document.addEventListener('DOMContentLoaded', () => {
            const auth = localStorage.getItem('authUser');
            if (!auth) { window.location.href = 'login.html'; return; }
            try {
                const u = JSON.parse(auth || '{}');
                const role = String(u.role || '').toLowerCase();
                if (role !== 'admin') { window.location.href = 'dashboard.html'; return; }
            } catch { window.location.href = 'dashboard.html'; return; }
            carregarCategoriasList();
            const novaBtn = document.getElementById('novaCategoriaBtn');
            if (novaBtn) {
                novaBtn.addEventListener('click', () => {
                    __editingCatId = null;
                    document.getElementById('mCatNome').value = '';
                    document.getElementById('mCatDesc').value = '';
                    openModal();
                    if (window.lucide && typeof window.lucide.createIcons === 'function') window.lucide.createIcons();
                });
            }
            const buscarBtn = document.getElementById('catBuscarBtn');
            const limparBtn = document.getElementById('catLimparBtn');
            if (buscarBtn) buscarBtn.addEventListener('click', aplicarFiltroCategorias);
            if (limparBtn) limparBtn.addEventListener('click', () => {
                document.getElementById('fCatNome').value = '';
                document.getElementById('fCatDesc').value = '';
                aplicarFiltroCategorias();
            });
            const mSalvar = document.getElementById('mCatSalvar');
            const mFechar = document.getElementById('mCatFechar');
            if (mSalvar) mSalvar.addEventListener('click', salvarCategoriaModal);
            if (mFechar) mFechar.addEventListener('click', closeModal);
            const confirmClose = document.getElementById('confirmDeleteClose');
            const confirmCancel = document.getElementById('confirmDeleteCancel');
            const confirmConfirm = document.getElementById('confirmDeleteConfirm');
            if (confirmClose) confirmClose.addEventListener('click', fecharConfirmExcluirCategoria);
            if (confirmCancel) confirmCancel.addEventListener('click', fecharConfirmExcluirCategoria);
            if (confirmConfirm) confirmConfirm.addEventListener('click', async () => {
                try {
                    const id = Number(confirmConfirm.dataset.id || 0);
                    if (!id) { toast('Categoria inválida', 'error'); return; }
                    await api('/categories/' + id, { method: 'DELETE' });
                    toast('Categoria excluída', 'success');
                    fecharConfirmExcluirCategoria();
                    carregarCategoriasList();
                } catch {
                    toast('Erro ao excluir categoria', 'error');
                }
            });
            const dupClose = document.getElementById('confirmDuplicateClose');
            const dupCancel = document.getElementById('confirmDuplicateCancel');
            const dupConfirm = document.getElementById('confirmDuplicateConfirm');
            if (dupClose) dupClose.addEventListener('click', fecharConfirmDuplicarCategoria);
            if (dupCancel) dupCancel.addEventListener('click', fecharConfirmDuplicarCategoria);
            if (dupConfirm) dupConfirm.addEventListener('click', async () => {
                try {
                    const id = Number(dupConfirm.dataset.id || 0);
                    if (!id) { toast('Categoria inválida', 'error'); return; }
                    const c = (__categorias || []).find(x => Number(x.id) === Number(id));
                    if (!c) { toast('Categoria não encontrada', 'error'); return; }
                    const nome = String(c.nome || c.name || '') + ' (cópia)';
                    const descricao = c.descricao || c.description || null;
                    const tipo = c.tipo || 'Novo';
                    await api('/categories', { method: 'POST', body: JSON.stringify({ nome, descricao, tipo }) });
                    toast('Categoria duplicada', 'success');
                    fecharConfirmDuplicarCategoria();
                    carregarCategoriasList();
                } catch {
                    toast('Erro ao duplicar categoria', 'error');
                }
            });
            if (window.lucide && typeof window.lucide.createIcons === 'function') window.lucide.createIcons();
        });
        function abrirConfirmExcluirCategoria(id) {
            try {
                const c = (__categorias || []).find(x => Number(x.id) === Number(id));
                const txt = document.getElementById('confirmDeleteText');
                if (txt) txt.textContent = `Deseja excluir a categoria "${c?.nome || c?.name || '-'}"?`;
                const btn = document.getElementById('confirmDeleteConfirm');
                if (btn) btn.dataset.id = String(id);
                const modal = document.getElementById('confirmDeleteModal');
                if (modal) modal.classList.add('show');
                if (window.lucide && typeof window.lucide.createIcons === 'function') window.lucide.createIcons();
            } catch {}
        }
        function fecharConfirmExcluirCategoria() {
            const btn = document.getElementById('confirmDeleteConfirm');
            if (btn) btn.dataset.id = '';
            const modal = document.getElementById('confirmDeleteModal');
            if (modal) modal.classList.remove('show');
        }
        function abrirConfirmDuplicarCategoria(id) {
            try {
                const c = (__categorias || []).find(x => Number(x.id) === Number(id));
                const txt = document.getElementById('confirmDuplicateText');
                if (txt) txt.textContent = `Deseja duplicar a categoria "${c?.nome || c?.name || '-'}"?`;
                const btn = document.getElementById('confirmDuplicateConfirm');
                if (btn) btn.dataset.id = String(id);
                const modal = document.getElementById('confirmDuplicateModal');
                if (modal) modal.classList.add('show');
                if (window.lucide && typeof window.lucide.createIcons === 'function') window.lucide.createIcons();
            } catch {}
        }
        function fecharConfirmDuplicarCategoria() {
            const btn = document.getElementById('confirmDuplicateConfirm');
            if (btn) btn.dataset.id = '';
            const modal = document.getElementById('confirmDuplicateModal');
            if (modal) modal.classList.remove('show');
        }
    </script>
    <div id="toast" class="toast"></div>
    <script src="script.js"></script>
    <div id="categoriaModal" class="modal">
        <div class="modal-card">
            <div class="modal-head"><div>Categoria</div><button id="mCatFechar" class="btn btn-ghost btn-icon"><i data-lucide="x"></i></button></div>
            <div class="modal-body">
                <div class="grid-2-modal">
                    <div class="field"><span class="label-inline">Nome</span><input id="mCatNome" class="input" type="text" placeholder="Nome da categoria"></div>
                    <div class="field"><span class="label-inline">Descrição</span><input id="mCatDesc" class="input" type="text" placeholder="Descrição (opcional)"></div>
                    <div class="field"><span class="label-inline">Tipo</span>
                        <select id="mCatTipo" class="select">
                            <option value="Novo">Novo</option>
                            <option value="Adtivo">Adtivo</option>
                            <option value="Renegociação">Renegociação</option>
                        </select>
                    </div>
                </div>
            </div>
            <div class="modal-actions">
                <button id="mCatSalvar" class="btn btn-primary" type="button"><i data-lucide="check"></i><span>Salvar</span></button>
            </div>
        </div>
    </div>
    <div id="confirmDeleteModal" class="modal">
        <div class="modal-card">
            <div class="modal-head"><div>Confirmar Exclusão</div><button id="confirmDeleteClose" class="btn btn-ghost btn-icon"><i data-lucide="x"></i></button></div>
            <div class="modal-body">
                <div class="label">Tem certeza que deseja excluir esta categoria?</div>
                <div id="confirmDeleteText" class="muted" style="margin-top:0.5rem;"></div>
            </div>
            <div class="modal-actions">
                <button id="confirmDeleteCancel" class="btn btn-ghost" type="button"><i data-lucide="x"></i><span>Cancelar</span></button>
                <button id="confirmDeleteConfirm" class="btn btn-ghost" type="button" style="border-color: rgba(239,68,68,0.35); color: #FCA5A5;"><i data-lucide="trash-2"></i><span>Excluir</span></button>
            </div>
        </div>
    </div>
    <div id="confirmDuplicateModal" class="modal">
        <div class="modal-card">
            <div class="modal-head"><div>Confirmar Duplicação</div><button id="confirmDuplicateClose" class="btn btn-ghost btn-icon"><i data-lucide="x"></i></button></div>
            <div class="modal-body">
                <div class="label">Deseja duplicar esta categoria?</div>
                <div id="confirmDuplicateText" class="muted" style="margin-top:0.5rem;"></div>
            </div>
            <div class="modal-actions">
                <button id="confirmDuplicateCancel" class="btn btn-ghost" type="button"><i data-lucide="x"></i><span>Cancelar</span></button>
                <button id="confirmDuplicateConfirm" class="btn btn-primary" type="button"><i data-lucide="copy"></i><span>Duplicar</span></button>
            </div>
        </div>
    </div>
</body>
</html>
