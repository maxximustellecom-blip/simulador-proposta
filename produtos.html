<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ofertas • Maxximus Telecom</title>
    <link rel="icon" href="data:,">
    <link rel="stylesheet" href="style.css">
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
</head>
<body>
    <main class="container">
        <div class="card">
            <div class="card-head">
                <div class="card-title">
                    <span>Ofertas</span>
                    <span class="chip">Padrão</span>
                </div>
                <div class="muted">
                    <button id="novoProdutoBtn" class="btn btn-primary" type="button"><i data-lucide="plus"></i><span>Nova oferta</span></button>
                </div>
            </div>
            <div class="card-body">
                <section class="section" style="margin-top: 20px;">
                    <div id="filtersProdutos" class="filters">
                        <div>
                            <div class="label">Tipo</div>
                            <select id="fProdTipo" class="select">
                                <option value="">Todos</option>
                                <option value="Novo">Novo</option>
                                <option value="Adtivo">Adtivo</option>
                                <option value="Renegociação">Renegociação</option>
                            </select>
                        </div>
                        <div>
                            <div class="label">Plano</div>
                            <select id="fProdCategoria" class="select"><option value="">Todas</option></select>
                        </div>
                        <div>
                            <div class="label">Nome</div>
                            <input id="fProdNome" class="input" type="text" placeholder="Nome da oferta" autocomplete="off">
                        </div>
                        <div style="display:flex; align-items:flex-end; gap:0.5rem; margin-left:auto; justify-content:flex-end;">
                            <button id="prodBuscarBtn" class="btn btn-primary" type="button" title="Buscar"><i data-lucide="search"></i><span>Buscar</span></button>
                            <button id="prodLimparBtn" class="btn btn-ghost" type="button" title="Limpar"><i data-lucide="rotate-ccw"></i><span>Limpar</span></button>
                        </div>
                    </div>
                </section>
                <section class="section" style="margin-top: 10px;">
                    <div style="display:flex; align-items:center; justify-content:space-between;">
                        <div class="label">Lista de produtos</div>
                        <div class="muted" id="prodCountLabel">0 itens</div>
                    </div>
                    <div class="table-container" style="margin-top:0.6rem;">
                        <table>
                            <thead>
                                <tr>
                                    <th>Plano</th>
                                    <th>Tipo</th>
                                    <th>Nome</th>
                                    <th>Preço&nbsp;(R$)</th>
                                    <th class="col-actions" style="min-width:160px;">Ações</th>
                                </tr>
                            </thead>
                            <tbody id="prodTbody">
                                <tr><td colspan="5">
                                    <div class="skeleton skel-row"></div>
                                    <div class="skeleton skel-row"></div>
                                    <div class="skeleton skel-row"></div>
                                    <div class="skeleton skel-row"></div>
                                </td></tr>
                            </tbody>
                        </table>
                    </div>
                </section>
            </div>
        </div>
    </main>
    <script>
        const API_BASE = 'https://others-maxximus-backend.pvuzyy.easypanel.host';
        async function api(path, options = {}) {
            const authRaw = localStorage.getItem('authUser');
            let headers = { 'Content-Type': 'application/json' };
            try {
                const u = JSON.parse(authRaw || '{}');
                if (u && u.id) headers['x-user-id'] = String(u.id);
                if (u && u.role) headers['x-user-role'] = String(u.role);
                if (u && u.name) headers['x-user-name'] = String(u.name);
            } catch {}
            const res = await fetch(API_BASE + path, { headers, ...options });
            if (!res.ok) {
                const err = await res.json().catch(() => ({}));
                throw new Error(err.error || ('HTTP ' + res.status));
            }
            return res.json();
        }
        function currency(v) {
            try { return (new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' })).format(Number(v || 0)); } catch { return 'R$ 0,00'; }
        }
        function toast(msg, type) {
            const el = document.getElementById('toast');
            if (!el) return;
            el.textContent = msg;
            el.style.borderColor = type === 'error' ? 'rgba(239,68,68,0.35)' : 'rgba(16,185,129,0.35)';
            el.style.display = 'block';
            clearTimeout(window.__toastTimer);
            window.__toastTimer = setTimeout(() => { el.style.display = 'none'; }, 2500);
        }
        let __categorias = [];
        let __categoriasIdx = {};
        let __produtos = [];
        let __editingProdId = null;
        function catOptionLabel(c) {
            const tipo = String(c && c.tipo ? c.tipo : '-');
            const nome = String(c ? (c.nome || c.name || '-') : '-');
            return `[${tipo}] ${nome}`;
        }
        async function carregarCategorias() {
            try {
                const list = await api('/categories', { method: 'GET' }).catch(() => []);
                __categorias = Array.isArray(list) ? list : [];
                __categoriasIdx = {};
                __categorias.forEach(c => { __categoriasIdx[Number(c.id)] = (c.nome || c.name || '-'); });
                const sel = document.getElementById('mProdCategoria');
                if (sel) sel.innerHTML = ['<option value="">Selecione</option>'].concat(__categorias.map(c => `<option value="${c.id}">${catOptionLabel(c)}</option>`)).join('');
                updateFiltroCategoriasOptions('');
                const tipoSel = document.getElementById('fProdTipo');
                if (tipoSel) {
                    tipoSel.addEventListener('change', () => {
                        updateFiltroCategoriasOptions(tipoSel.value || '');
                        const fsel = document.getElementById('fProdCategoria');
                        if (fsel) fsel.value = '';
                    });
                }
                const tipoModalSel = document.getElementById('mProdTipo');
                if (tipoModalSel) {
                    tipoModalSel.addEventListener('change', () => {
                        updateModalCategoriasOptions(tipoModalSel.value || '');
                        const msel = document.getElementById('mProdCategoria');
                        if (msel) msel.value = '';
                    });
                }
            } catch {
                __categorias = [];
                __categoriasIdx = {};
                const sel = document.getElementById('mProdCategoria');
                if (sel) sel.innerHTML = '<option value="">Erro ao carregar</option>';
                const fsel = document.getElementById('fProdCategoria');
                if (fsel) fsel.innerHTML = '<option value="">Erro ao carregar</option>';
            }
        }
        function updateFiltroCategoriasOptions(tipoVal = '') {
            const fsel = document.getElementById('fProdCategoria');
            if (!fsel) return;
            const base = ['<option value="">Todas</option>'];
            const filtered = (__categorias || []).filter(c => {
                if (!tipoVal) return true;
                return String(c.tipo || '').toLowerCase() === String(tipoVal).toLowerCase();
            });
            fsel.innerHTML = base.concat(filtered.map(c => `<option value="${c.id}">${catOptionLabel(c)}</option>`)).join('');
        }
        function updateModalCategoriasOptions(tipoVal = '') {
            const msel = document.getElementById('mProdCategoria');
            if (!msel) return;
            const base = ['<option value="">Selecione</option>'];
            const filtered = (__categorias || []).filter(c => {
                if (!tipoVal) return true;
                return String(c.tipo || '').toLowerCase() === String(tipoVal).toLowerCase();
            });
            msel.innerHTML = base.concat(filtered.map(c => `<option value="${c.id}">${catOptionLabel(c)}</option>`)).join('');
        }
        async function carregarProdutos() {
            try {
                const list = await api('/products', { method: 'GET' }).catch(() => []);
                __produtos = Array.isArray(list) ? list : [];
                renderProdutosTable(__produtos);
            } catch {
                __produtos = [];
                renderProdutosTable([]);
            }
        }
        function aplicarFiltroProdutos() {
            const cid = Number(document.getElementById('fProdCategoria').value || 0);
            const tipo = String(document.getElementById('fProdTipo').value || '');
            const nome = String(document.getElementById('fProdNome').value || '').trim().toUpperCase();
            let arr = (__produtos || []).slice();
            if (cid) arr = arr.filter(p => Number(p.categoria_id) === cid);
            if (tipo) arr = arr.filter(p => String(p.category && p.category.tipo ? p.category.tipo : '').toLowerCase() === String(tipo).toLowerCase());
            if (nome) arr = arr.filter(p => String(p.nome || p.name || '').toUpperCase().includes(nome));
            renderProdutosTable(arr);
        }
        function renderProdutosTable(list) {
            const tbody = document.getElementById('prodTbody');
            const arr = Array.isArray(list) ? list : [];
            const countLabel = document.getElementById('prodCountLabel');
            if (countLabel) countLabel.textContent = arr.length + ' ' + (arr.length === 1 ? 'item' : 'itens');
            function tipoChipStyle(t) {
                const key = String(t || '').toLowerCase();
                if (key === 'novo') return 'border-color: rgba(16,185,129,0.35); background: rgba(16,185,129,0.12);';
                if (key === 'adtivo') return 'border-color: rgba(245,158,11,0.35); background: rgba(245,158,11,0.12);';
                if (key === 'renegociação' || key === 'renegociacao') return 'border-color: rgba(59,130,246,0.35); background: rgba(59,130,246,0.12);';
                return 'border-color: rgba(156,163,175,0.35); background: rgba(156,163,175,0.12);';
            }
            tbody.innerHTML = arr.map(p => {
                const catName = (__categoriasIdx[Number(p.categoria_id)] ||
                    ((p && p.category && (p.category.nome || p.category.name)) ? (p.category.nome || p.category.name) : '-'));
                const tipoVal = (p && p.category && p.category.tipo) ? p.category.tipo : '-';
                return `
                <tr>
                    <td><span class="ellipsis">${catName}</span></td>
                    <td><span class="chip" style="${tipoChipStyle(tipoVal)}">${tipoVal}</span></td>
                    <td><span class="ellipsis">${p.nome || p.name || '-'}</span></td>
                    <td>${currency(p.preco)}</td>
                    <td class="col-actions">
                        <div class="table-actions">
                            <button type="button" class="btn btn-ghost btn-icon" title="Editar" onclick="abrirEditarProduto(${p.id})"><i data-lucide="edit-3"></i></button>
                            <button type="button" class="btn btn-ghost btn-icon" title="Duplicar" onclick="abrirConfirmDupProduto(${p.id})"><i data-lucide="copy"></i></button>
                            <button type="button" class="btn btn-ghost btn-icon" title="Excluir" onclick="abrirConfirmExcluirProduto(${p.id})" style="border-color: rgba(239,68,68,0.35); color: #FCA5A5;"><i data-lucide="trash-2"></i></button>
                        </div>
                    </td>
                </tr>
                `;
            }).join('') || '<tr><td colspan="5" class="muted">Sem resultados</td></tr>';
            if (window.lucide && typeof window.lucide.createIcons === 'function') window.lucide.createIcons();
        }
        function openModal() { document.getElementById('produtoModal').classList.add('show'); }
        function closeModal() {
            const modal = document.getElementById('produtoModal');
            if (modal) modal.classList.remove('show');
            __editingProdId = null;
            const cat = document.getElementById('mProdCategoria');
            const tipo = document.getElementById('mProdTipo');
            const nome = document.getElementById('mProdNome');
            const desc = document.getElementById('mProdDesc');
            const preco = document.getElementById('mProdPreco');
            if (tipo) tipo.value = '';
            updateModalCategoriasOptions('');
            if (cat) cat.value = '';
            if (nome) nome.value = '';
            if (desc) desc.value = '';
            if (preco) preco.value = '';
            const regiao = document.getElementById('regiao');
            if (regiao) regiao.value = '';
        }
        window.detalharProduto = function(id) {
            const p = (__produtos || []).find(x => Number(x.id) === Number(id));
            const msg = [
                'Produto',
                'Categoria: ' + (__categoriasIdx[Number(p?.categoria_id)] || '-'),
                'Nome: ' + (p?.nome || p?.name || '-'),
                'Descrição: ' + (p?.descricao || p?.description || '-'),
                'Preço: ' + currency(p?.preco)
            ].join('\n');
            alert(msg);
        };
        window.abrirEditarProduto = function(id) {
            const p = (__produtos || []).find(x => Number(x.id) === Number(id));
            if (!p) return;
            __editingProdId = Number(p.id);
            const tipoEl = document.getElementById('mProdTipo');
            if (tipoEl) tipoEl.value = (p.category && p.category.tipo) ? p.category.tipo : '';
            updateModalCategoriasOptions(tipoEl ? (tipoEl.value || '') : '');
            document.getElementById('mProdCategoria').value = String(p.categoria_id || '');
            document.getElementById('mProdNome').value = p.nome || p.name || '';
            document.getElementById('mProdDesc').value = p.descricao || p.description || '';
            document.getElementById('mProdPreco').value = String(p.preco || 0);
            document.getElementById('regiao').value = p.regiao || '';
            openModal();
            if (window.lucide && typeof window.lucide.createIcons === 'function') window.lucide.createIcons();
        };
        window.excluirProduto = async function(id) {
            try {
                const ok = window.confirm('Confirmar exclusão?');
                if (!ok) return;
                await api('/products/' + id, { method: 'DELETE' });
                toast('Produto excluído', 'success');
                carregarProdutos();
            } catch {
                toast('Erro ao excluir produto', 'error');
            }
        };
        async function salvarProdutoModal() {
            try {
                const categoria_id = Number(document.getElementById('mProdCategoria').value || 0);
                const nome = String(document.getElementById('mProdNome').value || '').trim();
                const descricao = String(document.getElementById('mProdDesc').value || '').trim() || null;
                const preco = Number(document.getElementById('mProdPreco').value || 0);
                const regiao = String(document.getElementById('regiao').value || '').trim() || null;
                if (!categoria_id || !nome || !(preco >= 0)) { toast('Preencha categoria, nome e preço', 'error'); return; }
                const body = JSON.stringify({ categoria_id, nome, descricao, preco, regiao });
                if (__editingProdId) {
                    await api('/products/' + __editingProdId, { method: 'PUT', body });
                    toast('Produto atualizado', 'success');
                } else {
                    await api('/products', { method: 'POST', body });
                    toast('Produto registrado', 'success');
                }
                closeModal();
                carregarProdutos();
            } catch {
                toast('Erro ao salvar produto', 'error');
            }
        }
        document.addEventListener('DOMContentLoaded', async () => {
            const auth = localStorage.getItem('authUser');
            if (!auth) { window.location.href = 'login.html'; return; }
            try {
                const u = JSON.parse(auth || '{}');
                const role = String(u.role || '').toLowerCase();
                if (role !== 'admin') { window.location.href = 'dashboard.html'; return; }
            } catch { window.location.href = 'dashboard.html'; return; }
            await carregarCategorias();
            await carregarRegioes();
            await carregarProdutos();
            const novoBtn = document.getElementById('novoProdutoBtn');
            if (novoBtn) {
                novoBtn.addEventListener('click', () => {
                    __editingProdId = null;
                    const tipoEl = document.getElementById('mProdTipo');
                    if (tipoEl) tipoEl.value = '';
                    updateModalCategoriasOptions('');
                    document.getElementById('mProdCategoria').value = '';
                    document.getElementById('mProdNome').value = '';
                    document.getElementById('mProdDesc').value = '';
                    document.getElementById('mProdPreco').value = '';
                    const r = document.getElementById('regiao');
                    if (r) r.value = '';
                    openModal();
                    if (window.lucide && typeof window.lucide.createIcons === 'function') window.lucide.createIcons();
                });
            }
            const buscarBtn = document.getElementById('prodBuscarBtn');
            const limparBtn = document.getElementById('prodLimparBtn');
            if (buscarBtn) buscarBtn.addEventListener('click', aplicarFiltroProdutos);
            if (limparBtn) limparBtn.addEventListener('click', () => {
                document.getElementById('fProdCategoria').value = '';
                document.getElementById('fProdNome').value = '';
                aplicarFiltroProdutos();
            });
            const mSalvar = document.getElementById('mProdSalvar');
            const mFechar = document.getElementById('mProdFechar');
            if (mSalvar) mSalvar.addEventListener('click', salvarProdutoModal);
            if (mFechar) mFechar.addEventListener('click', closeModal);
            const confirmClose = document.getElementById('confirmDeleteClose');
            const confirmCancel = document.getElementById('confirmDeleteCancel');
            const confirmConfirm = document.getElementById('confirmDeleteConfirm');
            if (confirmClose) confirmClose.addEventListener('click', fecharConfirmExcluirProduto);
            if (confirmCancel) confirmCancel.addEventListener('click', fecharConfirmExcluirProduto);
            if (confirmConfirm) confirmConfirm.addEventListener('click', async () => {
                try {
                    const id = Number(confirmConfirm.dataset.id || 0);
                    if (!id) { toast('Produto inválido', 'error'); return; }
                    await api('/products/' + id, { method: 'DELETE' });
                    toast('Produto excluído', 'success');
                    fecharConfirmExcluirProduto();
                    carregarProdutos();
                } catch {
                    toast('Erro ao excluir produto', 'error');
                }
            });

            const dupClose = document.getElementById('confirmDupClose');
            const dupCancel = document.getElementById('confirmDupCancel');
            const dupConfirm = document.getElementById('confirmDupConfirm');
            if (dupClose) dupClose.addEventListener('click', fecharConfirmDupProduto);
            if (dupCancel) dupCancel.addEventListener('click', fecharConfirmDupProduto);
            if (dupConfirm) dupConfirm.addEventListener('click', async () => {
                try {
                    const id = Number(dupConfirm.dataset.id || 0);
                    if (!id) { toast('Produto inválido', 'error'); return; }
                    
                    const p = (__produtos || []).find(x => Number(x.id) === id);
                    if (!p) { toast('Produto não encontrado', 'error'); return; }

                    const body = JSON.stringify({
                        categoria_id: p.categoria_id,
                        nome: (p.nome || p.name || '') + ' (Cópia)',
                        descricao: p.descricao || p.description,
                        preco: p.preco,
                        regiao: p.regiao
                    });

                    await api('/products', { method: 'POST', body });
                    toast('Produto duplicado', 'success');
                    fecharConfirmDupProduto();
                    carregarProdutos();
                } catch {
                    toast('Erro ao duplicar produto', 'error');
                }
            });

            if (window.lucide && typeof window.lucide.createIcons === 'function') window.lucide.createIcons();
        });
        function abrirConfirmExcluirProduto(id) {
            try {
                const p = (__produtos || []).find(x => Number(x.id) === Number(id));
                const txt = document.getElementById('confirmDeleteText');
                if (txt) txt.textContent = `Deseja excluir o produto "${p?.nome || p?.name || '-'}"?`;
                const btn = document.getElementById('confirmDeleteConfirm');
                if (btn) btn.dataset.id = String(id);
                const modal = document.getElementById('confirmDeleteModal');
                if (modal) modal.classList.add('show');
                if (window.lucide && typeof window.lucide.createIcons === 'function') window.lucide.createIcons();
            } catch {}
        }
        function fecharConfirmExcluirProduto() {
            const btn = document.getElementById('confirmDeleteConfirm');
            if (btn) btn.dataset.id = '';
            const modal = document.getElementById('confirmDeleteModal');
            if (modal) modal.classList.remove('show');
        }
        function abrirConfirmDupProduto(id) {
            try {
                const p = (__produtos || []).find(x => Number(x.id) === Number(id));
                const txt = document.getElementById('confirmDupText');
                if (txt) txt.textContent = `Deseja duplicar o produto "${p?.nome || p?.name || '-'}"?`;
                const btn = document.getElementById('confirmDupConfirm');
                if (btn) btn.dataset.id = String(id);
                const modal = document.getElementById('confirmDupModal');
                if (modal) modal.classList.add('show');
                if (window.lucide && typeof window.lucide.createIcons === 'function') window.lucide.createIcons();
            } catch {}
        }
        window.abrirConfirmDupProduto = abrirConfirmDupProduto;

        function fecharConfirmDupProduto() {
            const btn = document.getElementById('confirmDupConfirm');
            if (btn) btn.dataset.id = '';
            const modal = document.getElementById('confirmDupModal');
            if (modal) modal.classList.remove('show');
        }
        window.fecharConfirmDupProduto = fecharConfirmDupProduto;
        async function carregarRegioes() {
            const sel = document.getElementById('regiao');
            if (!sel) return;
            try {
                const list = await api('/regioes', { method: 'GET' }).catch(() => []);
                const regioes = Array.isArray(list) ? list : [];
                
                let html = '<option value="">Selecione</option>';
                
                regioes.forEach(r => {
                    let items = r.items;
                    if (typeof items === 'string') {
                        try { items = JSON.parse(items); } catch { items = []; }
                    }
                    if (!Array.isArray(items)) items = [];
                    
                    const values = items.map(i => i.v).join(',');
                    html += `<option value="${values}">${r.nome}</option>`;
                });
                
                sel.innerHTML = html;
            } catch {
                sel.innerHTML = '<option value="">Erro ao carregar</option>';
            }
        }
    </script>
    <div id="toast" class="toast"></div>
    <script src="script.js"></script>
    <div id="produtoModal" class="modal">
        <div class="modal-card">
            <div class="modal-head"><div>Oferta</div><button id="mProdFechar" class="btn btn-ghost btn-icon"><i data-lucide="x"></i></button></div>
            <div class="modal-body">
                <div class="grid-2-modal">
                    <div class="field"><span class="label-inline">Tipo</span>
                        <select id="mProdTipo" class="select">
                            <option value="">Todos</option>
                            <option value="Novo">Novo</option>
                            <option value="Adtivo">Adtivo</option>
                            <option value="Renegociação">Renegociação</option>
                        </select>
                    </div>
                    <div class="field"><span class="label-inline">Plano</span><select id="mProdCategoria" class="select"><option value="">Carregando...</option></select></div>
                    <div class="field"><span class="label-inline">Nome</span><input id="mProdNome" class="input" type="text" placeholder="Nome da oferta"></div>
                    <div class="field"><span class="label-inline">Descrição</span><input id="mProdDesc" class="input" type="text" placeholder="Descrição (opcional)"></div>
                    <div class="field"><span class="label-inline">Preço (R$)</span><input id="mProdPreco" class="input" type="number" step="0.01" min="0" placeholder="0,00"></div>
                    <div class="field"><span class="label-inline">Região (DDDs)</span>
                        <select id="regiao" name="regiao" class="select">
                            <option value="" selected>Carregando...</option>
                        </select>
                    </div>
            </div>
            <div class="modal-actions" style="padding: 1rem 0rem 0rem;">
                <button id="mProdSalvar" class="btn btn-primary" type="button"><i data-lucide="check"></i><span>Salvar</span></button>
            </div>
        </div>
    </div>
    </div>
    <div id="confirmDeleteModal" class="modal">
        <div class="modal-card">
            <div class="modal-head"><div>Confirmar Exclusão</div><button id="confirmDeleteClose" class="btn btn-ghost btn-icon"><i data-lucide="x"></i></button></div>
            <div class="modal-body">
                <div class="label">Tem certeza que deseja excluir este produto?</div>
                <div id="confirmDeleteText" class="muted" style="margin-top:0.5rem;"></div>
            </div>
            <div class="modal-actions">
                <button id="confirmDeleteCancel" class="btn btn-ghost" type="button"><i data-lucide="x"></i><span>Cancelar</span></button>
                <button id="confirmDeleteConfirm" class="btn btn-ghost" type="button" style="border-color: rgba(239,68,68,0.35); color: #FCA5A5;"><i data-lucide="trash-2"></i><span>Excluir</span></button>
            </div>
        </div>
    </div>
    <div id="confirmDupModal" class="modal">
        <div class="modal-card">
            <div class="modal-head"><div>Confirmar Cópia</div><button id="confirmDupClose" class="btn btn-ghost btn-icon"><i data-lucide="x"></i></button></div>
            <div class="modal-body">
                <div class="label">Deseja duplicar este produto?</div>
                <div id="confirmDupText" class="muted" style="margin-top:0.5rem;"></div>
            </div>
            <div class="modal-actions">
                <button id="confirmDupCancel" class="btn btn-ghost" type="button"><i data-lucide="x"></i><span>Cancelar</span></button>
                <button id="confirmDupConfirm" class="btn btn-primary" type="button"><i data-lucide="copy"></i><span>Duplicar</span></button>
            </div>
        </div>
    </div>
</body>
</html>
