<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tipos • Maxximus Telecom</title>
    <link rel="icon" href="data:,">
    <link rel="stylesheet" href="style.css">
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
</head>
<body>
    <main class="container">
        <div class="card">
            <div class="card-head">
                <div class="card-title">
                    <span>Tipos</span>
                    <span class="chip">Gerenciamento</span>
                </div>
                <div class="muted">
                    <button id="novoTipoBtn" class="btn btn-primary" type="button"><i data-lucide="plus"></i><span>Novo tipo</span></button>
                </div>
            </div>
            <div class="card-body">
                <section class="section" style="margin-top: 20px;">
                    <div id="filtersTipos" class="filters">
                        <div>
                            <div class="label">Nome</div>
                            <input id="fTipoNome" class="input" type="text" placeholder="Nome do tipo" autocomplete="off">
                        </div>
                        <div>
                            <div class="label">Descrição</div>
                            <input id="fTipoDesc" class="input" type="text" placeholder="Descrição" autocomplete="off">
                        </div>
                        <div style="display:flex; align-items:flex-end; gap:0.5rem;">
                            <button id="tipoBuscarBtn" class="btn btn-primary" type="button" title="Buscar"><i data-lucide="search"></i><span>Buscar</span></button>
                            <button id="tipoLimparBtn" class="btn btn-ghost" type="button" title="Limpar"><i data-lucide="rotate-ccw"></i><span>Limpar</span></button>
                        </div>
                    </div>
                </section>
                <section class="section" style="margin-top: 10px;">
                    <div style="display:flex; align-items:center; justify-content:space-between;">
                        <div class="label">Lista de tipos</div>
                        <div class="muted" id="tipoCountLabel">0 itens</div>
                    </div>
                    <div class="table-container" style="margin-top:0.6rem;">
                        <table>
                            <thead>
                                <tr>
                                    <th>Nome</th>
                                    <th>Descrição</th>
                                    <th class="col-actions" style="min-width:160px;">Ações</th>
                                </tr>
                            </thead>
                            <tbody id="tipoTbody">
                                <tr><td colspan="3">
                                    <div class="skeleton skel-row"></div>
                                    <div class="skeleton skel-row"></div>
                                    <div class="skeleton skel-row"></div>
                                    <div class="skeleton skel-row"></div>
                                </td></tr>
                            </tbody>
                        </table>
                    </div>
                </section>
            </div>
        </div>
    </main>
    <script>
        const API_BASE = 'https://others-maxximus-backend.pvuzyy.easypanel.host';
        async function api(path, options = {}) {
            const authRaw = localStorage.getItem('authUser');
            let headers = { 'Content-Type': 'application/json' };
            try {
                const u = JSON.parse(authRaw || '{}');
                if (u && u.id) headers['x-user-id'] = String(u.id);
                if (u && u.role) headers['x-user-role'] = String(u.role);
                if (u && u.name) headers['x-user-name'] = String(u.name);
            } catch {}
            const res = await fetch(API_BASE + path, { headers, ...options });
            if (!res.ok) {
                const err = await res.json().catch(() => ({}));
                throw new Error(err.error || ('HTTP ' + res.status));
            }
            return res.json();
        }
        function toast(msg, type) {
            const el = document.getElementById('toast');
            if (!el) return;
            el.textContent = msg;
            el.style.borderColor = type === 'error' ? 'rgba(239,68,68,0.35)' : 'rgba(16,185,129,0.35)';
            el.style.display = 'block';
            clearTimeout(window.__toastTimer);
            window.__toastTimer = setTimeout(() => { el.style.display = 'none'; }, 2500);
        }
        let __tipos = [];
        let __editingTipoId = null;

        function renderTiposTable(list) {
            const tbody = document.getElementById('tipoTbody');
            const arr = Array.isArray(list) ? list : [];
            const countLabel = document.getElementById('tipoCountLabel');
            if (countLabel) countLabel.textContent = arr.length + ' ' + (arr.length === 1 ? 'item' : 'itens');
            tbody.innerHTML = arr.map(c => `
                <tr>
                    <td><span class="ellipsis">${c.nome || c.name || '-'}</span></td>
                    <td><span class="ellipsis">${c.descricao || c.description || '-'}</span></td>
                    <td class="col-actions">
                        <div class="table-actions">
                            <button type="button" class="btn btn-ghost btn-icon" title="Editar" onclick="abrirEditarTipo(${c.id})"><i data-lucide="edit-3"></i></button>
                            <button type="button" class="btn btn-ghost btn-icon" title="Duplicar" onclick="abrirConfirmDuplicarTipo(${c.id})"><i data-lucide="copy"></i></button>
                            <button type="button" class="btn btn-ghost btn-icon" title="Excluir" onclick="abrirConfirmExcluirTipo(${c.id})" style="border-color: rgba(239,68,68,0.35); color: #FCA5A5;"><i data-lucide="trash-2"></i></button>
                        </div>
                    </td>
                </tr>
            `).join('') || '<tr><td colspan="3" class="muted">Sem resultados</td></tr>';
            if (window.lucide && typeof window.lucide.createIcons === 'function') window.lucide.createIcons();
        }
        async function carregarTiposList() {
            try {
                const list = await api('/types', { method: 'GET' }).catch(() => []);
                __tipos = Array.isArray(list) ? list : [];
                renderTiposTable(__tipos);
            } catch {
                __tipos = [];
                renderTiposTable([]);
            }
        }
        function aplicarFiltroTipos() {
            const nome = String(document.getElementById('fTipoNome').value || '').trim().toUpperCase();
            const desc = String(document.getElementById('fTipoDesc').value || '').trim().toUpperCase();
            let arr = (__tipos || []).slice();
            if (nome) arr = arr.filter(c => String(c.nome || c.name || '').toUpperCase().includes(nome));
            if (desc) arr = arr.filter(c => String(c.descricao || c.description || '').toUpperCase().includes(desc));
            renderTiposTable(arr);
        }
        function openModal() { document.getElementById('tipoModal').classList.add('show'); }
        function closeModal() {
            const modal = document.getElementById('tipoModal');
            if (modal) modal.classList.remove('show');
            __editingTipoId = null;
            const nome = document.getElementById('mTipoNome');
            const desc = document.getElementById('mTipoDesc');
            if (nome) nome.value = '';
            if (desc) desc.value = '';
        }
        window.abrirEditarTipo = function(id) {
            const c = (__tipos || []).find(x => Number(x.id) === Number(id));
            if (!c) return;
            __editingTipoId = Number(c.id);
            document.getElementById('mTipoNome').value = c.nome || c.name || '';
            document.getElementById('mTipoDesc').value = c.descricao || c.description || '';
            openModal();
            if (window.lucide && typeof window.lucide.createIcons === 'function') window.lucide.createIcons();
        };
        window.excluirTipo = async function(id) {
            try {
                const ok = window.confirm('Confirmar exclusão?');
                if (!ok) return;
                await api('/types/' + id, { method: 'DELETE' });
                toast('Tipo excluído', 'success');
                carregarTiposList();
            } catch {
                toast('Erro ao excluir tipo', 'error');
            }
        };
        async function salvarTipoModal() {
            try {
                const nome = String(document.getElementById('mTipoNome').value || '').trim();
                const descricao = String(document.getElementById('mTipoDesc').value || '').trim() || null;
                if (!nome) { toast('Informe o nome do tipo', 'error'); return; }
                if (__editingTipoId) {
                    await api('/types/' + __editingTipoId, { method: 'PUT', body: JSON.stringify({ nome, descricao }) });
                    toast('Tipo atualizado', 'success');
                } else {
                    await api('/types', { method: 'POST', body: JSON.stringify({ nome, descricao }) });
                    toast('Tipo registrado', 'success');
                }
                closeModal();
                carregarTiposList();
            } catch {
                toast('Erro ao salvar tipo', 'error');
            }
        }
        document.addEventListener('DOMContentLoaded', () => {
            const auth = localStorage.getItem('authUser');
            if (!auth) { window.location.href = 'login.html'; return; }
            try {
                const u = JSON.parse(auth || '{}');
                const role = String(u.role || '').toLowerCase();
                if (role !== 'admin') { window.location.href = 'dashboard.html'; return; }
            } catch { window.location.href = 'dashboard.html'; return; }
            carregarTiposList();
            const novaBtn = document.getElementById('novoTipoBtn');
            if (novaBtn) {
                novaBtn.addEventListener('click', () => {
                    __editingTipoId = null;
                    document.getElementById('mTipoNome').value = '';
                    document.getElementById('mTipoDesc').value = '';
                    openModal();
                    if (window.lucide && typeof window.lucide.createIcons === 'function') window.lucide.createIcons();
                });
            }
            const buscarBtn = document.getElementById('tipoBuscarBtn');
            const limparBtn = document.getElementById('tipoLimparBtn');
            if (buscarBtn) buscarBtn.addEventListener('click', aplicarFiltroTipos);
            if (limparBtn) limparBtn.addEventListener('click', () => {
                document.getElementById('fTipoNome').value = '';
                document.getElementById('fTipoDesc').value = '';
                aplicarFiltroTipos();
            });
            const mSalvar = document.getElementById('mTipoSalvar');
            const mFechar = document.getElementById('mTipoFechar');
            if (mSalvar) mSalvar.addEventListener('click', salvarTipoModal);
            if (mFechar) mFechar.addEventListener('click', closeModal);
            const confirmClose = document.getElementById('confirmDeleteClose');
            const confirmCancel = document.getElementById('confirmDeleteCancel');
            const confirmConfirm = document.getElementById('confirmDeleteConfirm');
            if (confirmClose) confirmClose.addEventListener('click', fecharConfirmExcluirTipo);
            if (confirmCancel) confirmCancel.addEventListener('click', fecharConfirmExcluirTipo);
            if (confirmConfirm) confirmConfirm.addEventListener('click', async () => {
                try {
                    const id = Number(confirmConfirm.dataset.id || 0);
                    if (!id) { toast('Tipo inválido', 'error'); return; }
                    await api('/types/' + id, { method: 'DELETE' });
                    toast('Tipo excluído', 'success');
                    fecharConfirmExcluirTipo();
                    carregarTiposList();
                } catch {
                    toast('Erro ao excluir tipo', 'error');
                }
            });
            const dupClose = document.getElementById('confirmDuplicateClose');
            const dupCancel = document.getElementById('confirmDuplicateCancel');
            const dupConfirm = document.getElementById('confirmDuplicateConfirm');
            if (dupClose) dupClose.addEventListener('click', fecharConfirmDuplicarTipo);
            if (dupCancel) dupCancel.addEventListener('click', fecharConfirmDuplicarTipo);
            if (dupConfirm) dupConfirm.addEventListener('click', async () => {
                try {
                    const id = Number(dupConfirm.dataset.id || 0);
                    if (!id) { toast('Tipo inválido', 'error'); return; }
                    const c = (__tipos || []).find(x => Number(x.id) === Number(id));
                    if (!c) { toast('Tipo não encontrado', 'error'); return; }
                    const nome = String(c.nome || c.name || '') + ' (cópia)';
                    const descricao = c.descricao || c.description || null;
                    await api('/types', { method: 'POST', body: JSON.stringify({ nome, descricao }) });
                    toast('Tipo duplicado', 'success');
                    fecharConfirmDuplicarTipo();
                    carregarTiposList();
                } catch {
                    toast('Erro ao duplicar tipo', 'error');
                }
            });
            if (window.lucide && typeof window.lucide.createIcons === 'function') window.lucide.createIcons();
        });
        function abrirConfirmExcluirTipo(id) {
            try {
                const c = (__tipos || []).find(x => Number(x.id) === Number(id));
                const txt = document.getElementById('confirmDeleteText');
                if (txt) txt.textContent = `Deseja excluir o tipo "${c?.nome || c?.name || '-'}"?`;
                const btn = document.getElementById('confirmDeleteConfirm');
                if (btn) btn.dataset.id = String(id);
                const modal = document.getElementById('confirmDeleteModal');
                if (modal) modal.classList.add('show');
                if (window.lucide && typeof window.lucide.createIcons === 'function') window.lucide.createIcons();
            } catch {}
        }
        function fecharConfirmExcluirTipo() {
            const btn = document.getElementById('confirmDeleteConfirm');
            if (btn) btn.dataset.id = '';
            const modal = document.getElementById('confirmDeleteModal');
            if (modal) modal.classList.remove('show');
        }
        function abrirConfirmDuplicarTipo(id) {
            try {
                const c = (__tipos || []).find(x => Number(x.id) === Number(id));
                const txt = document.getElementById('confirmDuplicateText');
                if (txt) txt.textContent = `Deseja duplicar o tipo "${c?.nome || c?.name || '-'}"?`;
                const btn = document.getElementById('confirmDuplicateConfirm');
                if (btn) btn.dataset.id = String(id);
                const modal = document.getElementById('confirmDuplicateModal');
                if (modal) modal.classList.add('show');
                if (window.lucide && typeof window.lucide.createIcons === 'function') window.lucide.createIcons();
            } catch {}
        }
        function fecharConfirmDuplicarTipo() {
            const btn = document.getElementById('confirmDuplicateConfirm');
            if (btn) btn.dataset.id = '';
            const modal = document.getElementById('confirmDuplicateModal');
            if (modal) modal.classList.remove('show');
        }
    </script>
    <div id="toast" class="toast"></div>
    <script src="script.js"></script>
    <div id="tipoModal" class="modal">
        <div class="modal-card">
            <div class="modal-head"><div>Tipo</div><button id="mTipoFechar" class="btn btn-ghost btn-icon"><i data-lucide="x"></i></button></div>
            <div class="modal-body">
                <div class="grid-2-modal">
                    <div class="field"><span class="label-inline">Nome</span><input id="mTipoNome" class="input" type="text" placeholder="Nome do tipo"></div>
                    <div class="field"><span class="label-inline">Descrição</span><input id="mTipoDesc" class="input" type="text" placeholder="Descrição (opcional)"></div>
                </div>
            </div>
            <div class="modal-actions">
                <button id="mTipoSalvar" class="btn btn-primary" type="button"><i data-lucide="check"></i><span>Salvar</span></button>
            </div>
        </div>
    </div>
    <div id="confirmDeleteModal" class="modal">
        <div class="modal-card">
            <div class="modal-head"><div>Confirmar Exclusão</div><button id="confirmDeleteClose" class="btn btn-ghost btn-icon"><i data-lucide="x"></i></button></div>
            <div class="modal-body">
                <div class="label">Tem certeza que deseja excluir este tipo?</div>
                <div id="confirmDeleteText" class="muted" style="margin-top:0.5rem;"></div>
            </div>
            <div class="modal-actions">
                <button id="confirmDeleteCancel" class="btn btn-ghost" type="button"><i data-lucide="x"></i><span>Cancelar</span></button>
                <button id="confirmDeleteConfirm" class="btn btn-ghost" type="button" style="border-color: rgba(239,68,68,0.35); color: #FCA5A5;"><i data-lucide="trash-2"></i><span>Excluir</span></button>
            </div>
        </div>
    </div>
    <div id="confirmDuplicateModal" class="modal">
        <div class="modal-card">
            <div class="modal-head"><div>Confirmar Duplicação</div><button id="confirmDuplicateClose" class="btn btn-ghost btn-icon"><i data-lucide="x"></i></button></div>
            <div class="modal-body">
                <div class="label">Tem certeza que deseja duplicar este tipo?</div>
                <div id="confirmDuplicateText" class="muted" style="margin-top:0.5rem;"></div>
            </div>
            <div class="modal-actions">
                <button id="confirmDuplicateCancel" class="btn btn-ghost" type="button"><i data-lucide="x"></i><span>Cancelar</span></button>
                <button id="confirmDuplicateConfirm" class="btn btn-ghost" type="button"><i data-lucide="copy"></i><span>Duplicar</span></button>
            </div>
        </div>
    </div>
</body>
</html>
