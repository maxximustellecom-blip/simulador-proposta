<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Perfis de Acesso • Maxximus Telecom</title>
    <link rel="icon" href="data:,">
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <main class="container">
        <div class="card">
            <div class="card-head">
                <div class="card-title">
                    <span>Perfis de Acesso</span>&nbsp;
                    <span class="chip">Somente Admin</span>
                </div>
                <div class="muted">
                    <button type="button" class="btn btn-primary" onclick="abrirCadastroPerfil()"><i data-lucide="plus-circle"></i><span>Novo Perfil</span></button>
                </div>
            </div>
            <div class="card-body">
                <section class="section" style="margin-top:1rem;">
                    <div id="profilesList" class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th>Nome do Perfil</th>
                                    <th>Descrição</th>
                                    <th class="col-actions">Ações</th>
                                </tr>
                            </thead>
                            <tbody id="profilesTbody"></tbody>
                        </table>
                    </div>
                </section>
            </div>
        </div>
    </main>
    <div id="cadastroPerfilModal" class="modal">
        <div class="modal-card">
            <div class="modal-head">
                <span>Cadastrar Perfil</span>
                <button type="button" class="btn btn-ghost btn-icon" onclick="fecharCadastroPerfil()"><i data-lucide="x"></i></button>
            </div>
            <div class="modal-body">
                <div class="grid-1">
                    <div>
                        <div class="label">Nome do Perfil</div>
                        <input id="pName" class="input" type="text" placeholder="Ex: Supervisor" autocomplete="off">
                    </div>
                    <div style="margin-top:0.75rem;">
                        <div class="label">Descrição</div>
                        <input id="pDesc" class="input" type="text" placeholder="Descrição do perfil" autocomplete="off">
                    </div>
                </div>
                
                <!-- Commission Config -->
                <div class="section" style="padding:0.8rem; margin-top:0.6rem; border-top:1px solid #e5e7eb; background: #fafafa; border-radius: 4px;">
                    <h4 style="font-size:0.85rem; font-weight:600; margin-bottom:0.8rem; color:#374151; margin-top: 0px;">Configuração de Comissionamento</h4>
                    
                    <div style="margin-bottom:1rem;">
                        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:0.25rem;">
                            <span class="label" style="font-size:0.75rem;">Tabela 1: Níveis e Fator</span>
                        </div>
                        <div class="table-container" style="max-height:150px; overflow-y:auto; border:1px solid #e5e7eb; border-radius:4px; background:#fff;">
                            <table class="table-compact">
                                <thead>
                                    <tr>
                                        <th style="width:15%">Nível</th>
                                        <th style="width:25%">Receita</th>
                                        <th style="width:25%">Elegibilidade</th>
                                        <th style="width:15%">% Fator</th>
                                        <th style="width:10%"></th>
                                    </tr>
                                </thead>
                                <tbody id="createLevelTableBody"></tbody>
                            </table>
                        </div>
                    </div>

                    <div>
                        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:0.25rem;">
                            <span class="label" style="font-size:0.75rem;">Tabela 2: Por Tipo de Produto</span>
                        </div>
                        <div class="table-container" style="max-height:150px; overflow-y:auto; border:1px solid #e5e7eb; border-radius:4px; background:#fff;">
                            <table class="table-compact">
                                <thead>
                                    <tr>
                                        <th style="width:15%">Nível</th>
                                        <th style="width:15%">Renov.</th>
                                        <th style="width:15%">U. Fibra</th>
                                        <th style="width:15%">WTTX</th>
                                        <th style="width:15%">M2M</th>
                                        <th style="width:15%">Controle</th>
                                    </tr>
                                </thead>
                                <tbody id="createProductTableBody"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-actions">
                <button type="button" class="btn btn-ghost" onclick="limparFormulario()">Limpar</button>
                <button type="button" class="btn btn-primary" onclick="salvarPerfil()">Cadastrar</button>
            </div>
        </div>
    </div>
    <div id="editPerfilModal" class="modal">
        <div class="modal-card">
            <div class="modal-head">
                <span>Editar Perfil</span>
                <button type="button" class="btn btn-ghost btn-icon" onclick="fecharEditarPerfil()"><i data-lucide="x"></i></button>
            </div>
            <div class="modal-body">
                <div class="section" style="padding:0.8rem;">
                    <div class="label">Nome do Perfil</div>
                    <input id="editPName" class="input" type="text" placeholder="Ex: Supervisor">
                </div>
                <div class="section" style="padding:0.8rem; margin-top:0.6rem;">
                    <div class="label">Descrição</div>
                    <input id="editPDesc" class="input" type="text" placeholder="Descrição do perfil">
                </div>

                <!-- Commission Config Edit -->
                <div class="section" style="padding:0.8rem; margin-top:0.6rem; border-top:1px solid #e5e7eb; background: #fafafa; border-radius: 4px;">
                    <h4 style="font-size:0.85rem; font-weight:600; margin-bottom:0.8rem; color:#374151; margin-top: 0px;">Configuração de Comissionamento</h4>
                    
                    <div style="margin-bottom:1rem;">
                        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:0.25rem;">
                            <span class="label" style="font-size:0.75rem;">Tabela 1: Níveis e Fator</span>
                        </div>
                        <div class="table-container" style="max-height:150px; overflow-y:auto; border:1px solid #e5e7eb; border-radius:4px; background:#fff;">
                            <table class="table-compact">
                                <thead>
                                    <tr>
                                        <th style="width:15%">Nível</th>
                                        <th style="width:25%">Receita</th>
                                        <th style="width:25%">Elegibilidade</th>
                                        <th style="width:20%">% Fator</th>
                                    </tr>
                                </thead>
                                <tbody id="editLevelTableBody"></tbody>
                            </table>
                        </div>
                    </div>

                    <div>
                        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:0.25rem;">
                            <span class="label" style="font-size:0.75rem;">Tabela 2: Por Tipo de Produto</span>
                        </div>
                        <div class="table-container" style="max-height:150px; overflow-y:auto; border:1px solid #e5e7eb; border-radius:4px; background:#fff;">
                            <table class="table-compact">
                                <thead>
                                    <tr>
                                        <th style="width:15%">Nível</th>
                                        <th style="width:18%">Renov.</th>
                                        <th style="width:18%">U. Fibra</th>
                                        <th style="width:18%">WTTX</th>
                                        <th style="width:16%">M2M</th>
                                        <th style="width:15%">Controle</th>
                                    </tr>
                                </thead>
                                <tbody id="editProductTableBody"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-actions">
                <button type="button" class="btn btn-ghost" onclick="fecharEditarPerfil()">Cancelar</button>
                <button type="button" class="btn btn-primary" onclick="salvarEdicaoPerfil()">Salvar</button>
            </div>
        </div>
    </div>
    <div id="deletePerfilModal" class="modal">
        <div class="modal-card">
            <div class="modal-head">
                <span>Confirmar exclusão</span>
                <button type="button" class="btn btn-ghost btn-icon" onclick="fecharExcluirPerfil()"><i data-lucide="x"></i></button>
            </div>
            <div class="modal-body">
                <div id="deletePerfilText" class="muted">Tem certeza que deseja excluir?</div>
            </div>
            <div class="modal-actions">
                <button type="button" class="btn btn-ghost" onclick="fecharExcluirPerfil()">Cancelar</button>
                <button type="button" class="btn btn-primary" onclick="confirmarExcluirPerfil()">Excluir</button>
            </div>
        </div>
    </div>
    <script src="script.js"></script>
    <div id="toast" class="toast"></div>
    <script>
        const API_BASE = 'https://others-maxximus-backend.pvuzyy.easypanel.host';
        async function api(path, options) {
            const auth = localStorage.getItem('authUser');
            let headers = { 'Content-Type': 'application/json' };
            try {
                const u = JSON.parse(auth || '{}');
                if (u && u.id) headers['x-user-id'] = String(u.id);
                if (u && u.role) headers['x-user-role'] = String(u.role);
                if (u && u.name) headers['x-user-name'] = String(u.name);
            } catch {}
            const res = await fetch(API_BASE + path, { headers, ...options });
            if (!res.ok) {
                const err = await res.json().catch(() => ({}));
                throw new Error(err.error || ('HTTP ' + res.status));
            }
            return res.json();
        }
        function toast(msg, type) {
            const el = document.getElementById('toast');
            el.textContent = msg;
            el.style.borderColor = type === 'error' ? 'rgba(239,68,68,0.35)' : 'rgba(16,185,129,0.35)';
            el.style.display = 'block';
            clearTimeout(window.__toastTimer);
            window.__toastTimer = setTimeout(() => { el.style.display = 'none'; }, 2500);
        }
        function isAdminUser() {
            try {
                const raw = localStorage.getItem('authUser');
                const u = JSON.parse(raw || '{}');
                return u && u.role === 'admin';
            } catch { return false; }
        }
        let __profilesCache = [];
        let __editProfileId = null;
        let __deleteProfileId = null;
        function abrirCadastroPerfil() {
            document.getElementById('cadastroPerfilModal').classList.add('show');
            populateCommissionTables('createLevelTableBody', 'createProductTableBody', null);
        }
        function fecharCadastroPerfil() {
            document.getElementById('cadastroPerfilModal').classList.remove('show');
            limparFormulario();
        }
        function renderProfilesTable(profiles) {
            const tbody = document.getElementById('profilesTbody');
            __profilesCache = Array.isArray(profiles) ? profiles.slice() : [];
            tbody.innerHTML = (__profilesCache || []).map(p => `
                <tr>
                    <td>${p.name}</td>
                    <td>${p.description || '-'}</td>
                    <td class="col-actions" style="min-width:140px;">
                        <button type="button" class="btn btn-ghost btn-icon" title="Editar" onclick="abrirEditarPerfil(${p.id})"><i data-lucide="edit-3"></i></button>
                        <button type="button" class="btn btn-primary btn-icon" title="Excluir" onclick="abrirExcluirPerfil(${p.id})"><i data-lucide='trash-2'></i></button>
                    </td>
                </tr>
            `).join('');
            if (window.lucide && typeof window.lucide.createIcons === 'function') { window.lucide.createIcons(); }
        }
        async function carregarPerfis() {
            try {
                const list = await api('/access-profiles', { method: 'GET' });
                renderProfilesTable(Array.isArray(list) ? list : []);
            } catch {
                renderProfilesTable([]);
            }
        }
        function getProfileById(id) {
            return (__profilesCache || []).find(p => Number(p.id) === Number(id));
        }
        function limparFormulario() {
            document.getElementById('pName').value = '';
            document.getElementById('pDesc').value = '';
        }
        function abrirEditarPerfil(id) {
            const p = getProfileById(id);
            if (!p) return;
            __editProfileId = Number(id);
            document.getElementById('editPName').value = p.name || '';
            document.getElementById('editPDesc').value = p.description || '';
            document.getElementById('editPerfilModal').classList.add('show');
            populateCommissionTables('editLevelTableBody', 'editProductTableBody', p.commission_config);
        }
        function fecharEditarPerfil() {
            __editProfileId = null;
            document.getElementById('editPerfilModal').classList.remove('show');
        }
        async function salvarEdicaoPerfil() {
            if (!__editProfileId) return;
            const name = (document.getElementById('editPName').value || '').trim();
            const description = (document.getElementById('editPDesc').value || '').trim();
            if (!name) { toast('Preencha o nome do perfil', 'error'); return; }
            
            const commission_config = getCommissionConfig('editLevelTableBody', 'editProductTableBody');

            try {
                await api('/access-profiles/' + __editProfileId, { 
                    method: 'PUT', 
                    body: JSON.stringify({ name, description, commission_config }) 
                });
                toast('Perfil atualizado', 'success');
                fecharEditarPerfil();
                await carregarPerfis();
            } catch {
                toast('Erro ao atualizar perfil', 'error');
            }
        }
        function abrirExcluirPerfil(id) {
            const p = getProfileById(id);
            if (!p) return;
            __deleteProfileId = Number(id);
            const el = document.getElementById('deletePerfilText');
            if (el) el.textContent = `Deseja excluir o perfil "${p.name}"?`;
            document.getElementById('deletePerfilModal').classList.add('show');
        }
        function fecharExcluirPerfil() {
            __deleteProfileId = null;
            document.getElementById('deletePerfilModal').classList.remove('show');
        }
        async function confirmarExcluirPerfil() {
            if (!__deleteProfileId) return;
            try {
                await api('/access-profiles/' + __deleteProfileId, { method: 'DELETE' });
                toast('Perfil excluído', 'success');
                fecharExcluirPerfil();
                await carregarPerfis();
            } catch {
                toast('Erro ao excluir perfil', 'error');
            }
        }

        // Commission Helper Functions
        const DEFAULT_COMMISSION_ROWS = ['BLUE', 'SILVER', 'PLATINUM', 'BLACK', 'BLACK+'];

        function addLevelRow(tbodyId, data = null) {
            const tbody = document.getElementById(tbodyId);
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td><span style="font-size:0.75rem; font-weight:500; padding-left:4px;">${data && data.name ? data.name : ''}</span><input type="hidden" value="${data && data.name ? data.name : ''}"></td>
                <td><input type="text" placeholder="R$..." value="${data && data.revenue !== undefined ? data.revenue : ''}"></td>
                <td><input type="text" placeholder="Condição" value="${data && data.eligibility !== undefined ? data.eligibility : ''}"></td>
                <td><input type="text" placeholder="%" value="${data && data.factor !== undefined ? data.factor : ''}"></td>
            `;
            tbody.appendChild(tr);
        }

        function addProductRow(tbodyId, data = null) {
            const tbody = document.getElementById(tbodyId);
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td><span style="font-size:0.75rem; font-weight:500; padding-left:4px;">${data && data.level_group ? data.level_group : ''}</span><input type="hidden" value="${data && data.level_group ? data.level_group : ''}"></td>
                <td><input type="text" placeholder="%" value="${data && data.renovacao !== undefined ? data.renovacao : ''}"></td>
                <td><input type="text" placeholder="%" value="${data && data.ultra_fibra !== undefined ? data.ultra_fibra : ''}"></td>
                <td><input type="text" placeholder="%" value="${data && data.wttx !== undefined ? data.wttx : ''}"></td>
                <td><input type="text" placeholder="%" value="${data && data.m2m !== undefined ? data.m2m : ''}"></td>
                <td><input type="text" placeholder="%" value="${data && data.controle !== undefined ? data.controle : ''}"></td>
            `;
            tbody.appendChild(tr);
        }

        function getCommissionConfig(levelTbodyId, productTbodyId) {
            const levels = [];
            document.querySelectorAll(`#${levelTbodyId} tr`).forEach(tr => {
                const inputs = tr.querySelectorAll('input');
                // input[0] is hidden name
                if (inputs.length > 0) {
                    levels.push({
                        name: inputs[0].value,
                        revenue: inputs[1].value,
                        eligibility: inputs[2].value,
                        factor: inputs[3].value
                    });
                }
            });

            const products = [];
            document.querySelectorAll(`#${productTbodyId} tr`).forEach(tr => {
                const inputs = tr.querySelectorAll('input');
                // input[0] is hidden level_group
                if (inputs.length > 0) {
                    products.push({
                        level_group: inputs[0].value,
                        renovacao: inputs[1].value,
                        ultra_fibra: inputs[2].value,
                        wttx: inputs[3].value,
                        m2m: inputs[4].value,
                        controle: inputs[5].value
                    });
                }
            });

            return { levels, products };
        }

        function populateCommissionTables(levelTbodyId, productTbodyId, config) {
            const levelBody = document.getElementById(levelTbodyId);
            const productBody = document.getElementById(productTbodyId);
            levelBody.innerHTML = '';
            productBody.innerHTML = '';
            
            if (typeof config === 'string') {
                try { config = JSON.parse(config); } catch (e) { console.error('Error parsing config', e); config = {}; }
            }

            // Merge defaults with config
            const levels = DEFAULT_COMMISSION_ROWS.map(name => {
                const existing = (config && config.levels) ? config.levels.find(l => l.name === name) : null;
                return existing || { name, revenue: '', eligibility: '', factor: '' };
            });
            
            const products = DEFAULT_COMMISSION_ROWS.map(name => {
                const existing = (config && config.products) ? config.products.find(p => p.level_group === name) : null;
                return existing || { level_group: name, renovacao: '', ultra_fibra: '', wttx: '', m2m: '', controle: '' };
            });

            levels.forEach(l => addLevelRow(levelTbodyId, l));
            products.forEach(p => addProductRow(productTbodyId, p));
        }
        async function salvarPerfil() {
            const name = (document.getElementById('pName').value || '').trim();
            const description = (document.getElementById('pDesc').value || '').trim();
            if (!name) {
                toast('Preencha o nome do perfil', 'error');
                return;
            }
            
            const commission_config = getCommissionConfig('createLevelTableBody', 'createProductTableBody');

            try {
                await api('/access-profiles', { 
                    method: 'POST', 
                    body: JSON.stringify({ name, description, commission_config }) 
                });
                toast('Perfil cadastrado', 'success');
                limparFormulario();
                try { document.getElementById('cadastroPerfilModal').classList.remove('show'); } catch {}
                await carregarPerfis();
            } catch (e) {
                toast('Erro ao cadastrar perfil', 'error');
            }
        }
        document.addEventListener('DOMContentLoaded', async () => {
            const auth = localStorage.getItem('authUser');
            if (!auth) { window.location.href = 'login.html'; return; }
            if (!isAdminUser()) { window.location.href = 'dashboard.html'; return; }
            try {
                const user = JSON.parse(auth);
                const label = document.getElementById('userNameLabel');
                if (label && user && user.name) label.textContent = user.name + ' • Admin';
            } catch {}
            const umb = document.getElementById('userMenuBtn');
            if (umb) {
                umb.addEventListener('click', () => {
                    const menu = document.getElementById('userMenu');
                    if (menu) menu.classList.toggle('show');
                });
            }
            const lb = document.getElementById('logoutBtn');
            if (lb) {
                lb.addEventListener('click', (e) => {
                    e.preventDefault();
                    localStorage.removeItem('authUser');
                    window.location.href = 'login.html';
                });
            }
            await carregarPerfis();
            if (window.lucide && typeof window.lucide.createIcons === 'function') { window.lucide.createIcons(); }
        });
    </script>
</body>
</html>