<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Perfis de Acesso • Maxximus Telecom</title>
    <link rel="icon" href="data:,">
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <main class="container">
        <div class="card">
            <div class="card-head">
                <div class="card-title">
                    <span>Perfis de Acesso</span>&nbsp;
                    <span class="chip">Somente Admin</span>
                </div>
                <div class="muted">
                    <button type="button" class="btn btn-primary" onclick="abrirCadastroPerfil()"><i data-lucide="plus-circle"></i><span>Novo Perfil</span></button>
                </div>
            </div>
            <div class="card-body">
                <section class="section" style="margin-top:1rem;">
                    <div id="profilesList" class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th>Nome do Perfil</th>
                                    <th>Descrição</th>
                                    <th class="col-actions">Ações</th>
                                </tr>
                            </thead>
                            <tbody id="profilesTbody"></tbody>
                        </table>
                    </div>
                </section>
            </div>
        </div>
    </main>
    <div id="cadastroPerfilModal" class="modal">
        <div class="modal-card">
            <div class="modal-head">
                <span>Cadastrar Perfil</span>
                <button type="button" class="btn btn-ghost btn-icon" onclick="fecharCadastroPerfil()"><i data-lucide="x"></i></button>
            </div>
            <div class="modal-body">
                <div class="grid-1">
                    <div>
                        <div class="label">Nome do Perfil</div>
                        <input id="pName" class="input" type="text" placeholder="Ex: Supervisor" autocomplete="off">
                    </div>
                    <div style="margin-top:0.75rem;">
                        <div class="label">Descrição</div>
                        <input id="pDesc" class="input" type="text" placeholder="Descrição do perfil" autocomplete="off">
                    </div>
                </div>
            </div>
            <div class="modal-actions">
                <button type="button" class="btn btn-ghost" onclick="limparFormulario()">Limpar</button>
                <button type="button" class="btn btn-primary" onclick="salvarPerfil()">Cadastrar</button>
            </div>
        </div>
    </div>
    <div id="editPerfilModal" class="modal">
        <div class="modal-card">
            <div class="modal-head">
                <span>Editar Perfil</span>
                <button type="button" class="btn btn-ghost btn-icon" onclick="fecharEditarPerfil()"><i data-lucide="x"></i></button>
            </div>
            <div class="modal-body">
                <div class="section" style="padding:0.8rem;">
                    <div class="label">Nome do Perfil</div>
                    <input id="editPName" class="input" type="text" placeholder="Ex: Supervisor">
                </div>
                <div class="section" style="padding:0.8rem; margin-top:0.6rem;">
                    <div class="label">Descrição</div>
                    <input id="editPDesc" class="input" type="text" placeholder="Descrição do perfil">
                </div>
            </div>
            <div class="modal-actions">
                <button type="button" class="btn btn-ghost" onclick="fecharEditarPerfil()">Cancelar</button>
                <button type="button" class="btn btn-primary" onclick="salvarEdicaoPerfil()">Salvar</button>
            </div>
        </div>
    </div>
    <div id="deletePerfilModal" class="modal">
        <div class="modal-card">
            <div class="modal-head">
                <span>Confirmar exclusão</span>
                <button type="button" class="btn btn-ghost btn-icon" onclick="fecharExcluirPerfil()"><i data-lucide="x"></i></button>
            </div>
            <div class="modal-body">
                <div id="deletePerfilText" class="muted">Tem certeza que deseja excluir?</div>
            </div>
            <div class="modal-actions">
                <button type="button" class="btn btn-ghost" onclick="fecharExcluirPerfil()">Cancelar</button>
                <button type="button" class="btn btn-primary" onclick="confirmarExcluirPerfil()">Excluir</button>
            </div>
        </div>
    </div>
    <script src="script.js"></script>
    <div id="toast" class="toast"></div>
    <script>
        const API_BASE = 'https://others-maxximus-backend.pvuzyy.easypanel.host';
        async function api(path, options) {
            const auth = localStorage.getItem('authUser');
            let headers = { 'Content-Type': 'application/json' };
            try {
                const u = JSON.parse(auth || '{}');
                if (u && u.id) headers['x-user-id'] = String(u.id);
                if (u && u.role) headers['x-user-role'] = String(u.role);
                if (u && u.name) headers['x-user-name'] = String(u.name);
            } catch {}
            const res = await fetch(API_BASE + path, { headers, ...options });
            if (!res.ok) {
                const err = await res.json().catch(() => ({}));
                throw new Error(err.error || ('HTTP ' + res.status));
            }
            return res.json();
        }
        function toast(msg, type) {
            const el = document.getElementById('toast');
            el.textContent = msg;
            el.style.borderColor = type === 'error' ? 'rgba(239,68,68,0.35)' : 'rgba(16,185,129,0.35)';
            el.style.display = 'block';
            clearTimeout(window.__toastTimer);
            window.__toastTimer = setTimeout(() => { el.style.display = 'none'; }, 2500);
        }
        function isAdminUser() {
            try {
                const raw = localStorage.getItem('authUser');
                const u = JSON.parse(raw || '{}');
                return u && u.role === 'admin';
            } catch { return false; }
        }
        let __profilesCache = [];
        let __editProfileId = null;
        let __deleteProfileId = null;
        function abrirCadastroPerfil() {
            document.getElementById('cadastroPerfilModal').classList.add('show');
        }
        function fecharCadastroPerfil() {
            document.getElementById('cadastroPerfilModal').classList.remove('show');
            limparFormulario();
        }
        function renderProfilesTable(profiles) {
            const tbody = document.getElementById('profilesTbody');
            __profilesCache = Array.isArray(profiles) ? profiles.slice() : [];
            tbody.innerHTML = (__profilesCache || []).map(p => `
                <tr>
                    <td>${p.name}</td>
                    <td>${p.description || '-'}</td>
                    <td class="col-actions" style="min-width:140px;">
                        <button type="button" class="btn btn-ghost btn-icon" title="Editar" onclick="abrirEditarPerfil(${p.id})"><i data-lucide="edit-3"></i></button>
                        <button type="button" class="btn btn-primary btn-icon" title="Excluir" onclick="abrirExcluirPerfil(${p.id})"><i data-lucide='trash-2'></i></button>
                    </td>
                </tr>
            `).join('');
            if (window.lucide && typeof window.lucide.createIcons === 'function') { window.lucide.createIcons(); }
        }
        async function carregarPerfis() {
            try {
                const list = await api('/access-profiles', { method: 'GET' });
                renderProfilesTable(Array.isArray(list) ? list : []);
            } catch {
                renderProfilesTable([]);
            }
        }
        function getProfileById(id) {
            return (__profilesCache || []).find(p => Number(p.id) === Number(id));
        }
        function limparFormulario() {
            document.getElementById('pName').value = '';
            document.getElementById('pDesc').value = '';
        }
        function abrirEditarPerfil(id) {
            const p = getProfileById(id);
            if (!p) return;
            __editProfileId = Number(id);
            document.getElementById('editPName').value = p.name || '';
            document.getElementById('editPDesc').value = p.description || '';
            document.getElementById('editPerfilModal').classList.add('show');
        }
        function fecharEditarPerfil() {
            __editProfileId = null;
            document.getElementById('editPerfilModal').classList.remove('show');
        }
        async function salvarEdicaoPerfil() {
            if (!__editProfileId) return;
            const name = (document.getElementById('editPName').value || '').trim();
            const description = (document.getElementById('editPDesc').value || '').trim();
            if (!name) { toast('Preencha o nome do perfil', 'error'); return; }
            try {
                await api('/access-profiles/' + __editProfileId, { method: 'PUT', body: JSON.stringify({ name, description }) });
                toast('Perfil atualizado', 'success');
                fecharEditarPerfil();
                await carregarPerfis();
            } catch {
                toast('Erro ao atualizar perfil', 'error');
            }
        }
        function abrirExcluirPerfil(id) {
            const p = getProfileById(id);
            if (!p) return;
            __deleteProfileId = Number(id);
            const el = document.getElementById('deletePerfilText');
            if (el) el.textContent = `Deseja excluir o perfil "${p.name}"?`;
            document.getElementById('deletePerfilModal').classList.add('show');
        }
        function fecharExcluirPerfil() {
            __deleteProfileId = null;
            document.getElementById('deletePerfilModal').classList.remove('show');
        }
        async function confirmarExcluirPerfil() {
            if (!__deleteProfileId) return;
            try {
                await api('/access-profiles/' + __deleteProfileId, { method: 'DELETE' });
                toast('Perfil excluído', 'success');
                fecharExcluirPerfil();
                await carregarPerfis();
            } catch {
                toast('Erro ao excluir perfil', 'error');
            }
        }
        async function salvarPerfil() {
            const name = (document.getElementById('pName').value || '').trim();
            const description = (document.getElementById('pDesc').value || '').trim();
            if (!name) {
                toast('Preencha o nome do perfil', 'error');
                return;
            }
            try {
                await api('/access-profiles', { method: 'POST', body: JSON.stringify({ name, description }) });
                toast('Perfil cadastrado', 'success');
                limparFormulario();
                try { document.getElementById('cadastroPerfilModal').classList.remove('show'); } catch {}
                await carregarPerfis();
            } catch (e) {
                toast('Erro ao cadastrar perfil', 'error');
            }
        }
        document.addEventListener('DOMContentLoaded', async () => {
            const auth = localStorage.getItem('authUser');
            if (!auth) { window.location.href = 'login.html'; return; }
            if (!isAdminUser()) { window.location.href = 'dashboard.html'; return; }
            try {
                const user = JSON.parse(auth);
                const label = document.getElementById('userNameLabel');
                if (label && user && user.name) label.textContent = user.name + ' • Admin';
            } catch {}
            const umb = document.getElementById('userMenuBtn');
            if (umb) {
                umb.addEventListener('click', () => {
                    const menu = document.getElementById('userMenu');
                    if (menu) menu.classList.toggle('show');
                });
            }
            const lb = document.getElementById('logoutBtn');
            if (lb) {
                lb.addEventListener('click', (e) => {
                    e.preventDefault();
                    localStorage.removeItem('authUser');
                    window.location.href = 'login.html';
                });
            }
            await carregarPerfis();
            if (window.lucide && typeof window.lucide.createIcons === 'function') { window.lucide.createIcons(); }
        });
    </script>
</body>
</html>
